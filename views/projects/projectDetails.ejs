<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= project.projectName %> - Project Details</title>
  <%- include('../partials/_head.ejs') %>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/dashboard.css">
  <style>
    body { font-family: 'DM Sans', sans-serif; background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%); }
    
    .main-card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 10px 15px -3px rgba(0,0,0,0.05);
      border: 1px solid rgba(226,232,240,0.8);
    }
    
    .stat-card {
      background: linear-gradient(135deg, #fff, #f8fafc);
      border-radius: 1rem;
      padding: 1.25rem;
      border: 1px solid #e2e8f0;
      transition: all 0.3s ease;
    }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
    
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white; font-weight: 600; padding: 0.625rem 1.25rem;
      border-radius: 0.625rem; box-shadow: 0 4px 14px rgba(59,130,246,0.3);
      transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem;
    }
    .btn-primary:hover { background: linear-gradient(135deg, #2563eb, #1d4ed8); transform: translateY(-1px); }
    
    .btn-secondary {
      background: #f1f5f9; color: #475569; font-weight: 600;
      padding: 0.625rem 1.25rem; border-radius: 0.625rem;
      border: 2px solid #e2e8f0; transition: all 0.3s ease;
      display: inline-flex; align-items: center; gap: 0.5rem;
    }
    .btn-secondary:hover { background: #e2e8f0; border-color: #cbd5e1; }
    
    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white; font-weight: 600; padding: 0.625rem 1.25rem;
      border-radius: 0.625rem; box-shadow: 0 4px 14px rgba(239,68,68,0.3);
      transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem;
    }
    .btn-danger:hover { background: linear-gradient(135deg, #dc2626, #b91c1c); transform: translateY(-1px); }
    
    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      border: 2px solid #e2e8f0;
      background: #f8fafc;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }
    .form-input:hover { border-color: #cbd5e1; background: #fff; }
    .form-input:focus { outline: none; border-color: #3b82f6; background: #fff; box-shadow: 0 0 0 4px rgba(59,130,246,0.1); }
    
    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table thead {
      background: linear-gradient(135deg, #1e40af, #3b82f6);
    }
    .data-table th {
      padding: 1rem 1.25rem;
      text-align: left;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: white;
    }
    .data-table th:first-child { border-top-left-radius: 0.75rem; }
    .data-table th:last-child { border-top-right-radius: 0.75rem; }
    
    .data-table tbody tr {
      border-bottom: 1px solid #f1f5f9;
      transition: background 0.15s ease;
    }
    .data-table tbody tr:hover { background: #f8fafc; }
    .data-table tbody tr:last-child { border-bottom: none; }
    
    .data-table td {
      padding: 1rem 1.25rem;
      font-size: 0.875rem;
      color: #374151;
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.625rem;
      border-radius: 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .badge-indigo { background: #e0e7ff; color: #3730a3; }
    .badge-purple { background: #f3e8ff; color: #7c3aed; }
    .badge-blue { background: #dbeafe; color: #1e40af; }
    .badge-green { background: #d1fae5; color: #065f46; }
    
    .action-btn {
      padding: 0.5rem;
      border-radius: 0.5rem;
      transition: all 0.2s ease;
    }
    .action-btn.edit { color: #3b82f6; }
    .action-btn.edit:hover { background: #eff6ff; color: #1d4ed8; }
    .action-btn.delete { color: #ef4444; }
    .action-btn.delete:hover { background: #fef2f2; color: #b91c1c; }
    
    .item-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 0.75rem;
      transition: all 0.3s ease;
    }
    .item-card:hover {
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    
    /* Unit Toggle Styles */
    .unit-toggle-btn {
      color: #374151;
      background: transparent;
      border: none;
      cursor: pointer;
    }
    
    .unit-toggle-btn.active {
      background: linear-gradient(135deg, #4f46e5, #4338ca);
      color: white;
      box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
    }
    
    .unit-toggle-btn:hover:not(.active) {
      background: #e5e7eb;
    }
    
    /* Window Preview Mini Styles - Matching Original Compose Window */
    .window-preview-mini {
      position: relative;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .window-preview-mini .aluminum-frame {
      width: 100%;
      height: 100%;
      background: linear-gradient(145deg, #909090 0%, #707070 20%, #585858 50%, #707070 80%, #909090 100%);
      border-radius: 2px;
      padding: 2px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .window-preview-mini .panel-container {
      display: flex;
      width: 100%;
      height: 100%;
      gap: 1px;
    }
    
    .window-preview-mini .panel-glass {
      flex: 1;
      background: linear-gradient(180deg, rgba(191,219,254,0.8) 0%, rgba(147,197,253,0.6) 50%, rgba(191,219,254,0.7) 100%);
      border-radius: 1px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    .window-preview-mini .panel-glass::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, transparent 50%);
      pointer-events: none;
    }
    
    .window-preview-mini .panel-glass.operable-glass {
      background: linear-gradient(180deg, rgba(186,230,253,0.75) 0%, rgba(147,197,253,0.55) 50%, rgba(186,230,253,0.65) 100%);
    }
    
    .window-preview-mini .panel-glass .panel-label {
      font-size: 8px;
      font-weight: bold;
      color: rgba(30,64,175,0.6);
      text-shadow: 0 1px 2px rgba(255,255,255,0.5);
      z-index: 1;
    }
    
    .window-preview-mini .panel-glass.operable-glass .panel-label {
      color: rgba(22,101,52,0.7);
    }
    
    .window-preview-mini .mullion {
      background: linear-gradient(145deg, #606060, #505050);
      flex-shrink: 0;
    }
    
    .window-preview-mini .mullion.horizontal {
      width: 2px;
      height: 100%;
    }
    
    .window-preview-mini .mullion.vertical {
      width: 100%;
      height: 2px;
    }
    
    /* Unit Toggle Styles */
    .unit-toggle-btn {
      color: #374151;
      background: transparent;
      border: none;
      cursor: pointer;
    }
    
    .unit-toggle-btn.active {
      background: linear-gradient(135deg, #4f46e5, #4338ca);
      color: white;
      box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
    }
    
    .unit-toggle-btn:hover:not(.active) {
      background: #e5e7eb;
    }
  </style>
</head>

<body class="min-h-screen flex flex-col">
  <%- include('../partials/_header.ejs') %>

  <main class="flex-grow container mx-auto px-4 py-8">
    <!-- Page Header -->
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-4">
        <!-- Company Logo Section -->
        <div class="company-logo-container">
          <% if (typeof companyLogo !== 'undefined' && companyLogo) { %>
            <img src="<%= companyLogo %>" alt="Company Logo" class="company-logo-image">
          <% } else { %>
            <div class="company-logo-placeholder">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
            </div>
          <% } %>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-gray-800"><%= project.projectName %></h1>
          <p class="text-gray-500 text-sm">
            <% if (project.clientName) { %>
              Client: <span class="font-medium"><%= project.clientName %></span>
            <% } else { %>
              No client specified
            <% } %>
          </p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <a href="/dashboard" class="btn-secondary">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          Back to Dashboard
        </a>
        <button onclick="openQuotePreview('<%= project._id %>')" class="btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
          Quote Preview
        </button>
        <a href="/projects/<%= project._id %>/export-pdf" class="btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Export to PDF
        </a>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="stat-card">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-indigo-100 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
            </svg>
          </div>
          <div>
            <p class="text-2xl font-bold text-gray-800"><%= windowItems.length %></p>
            <p class="text-xs text-gray-500">Window Items</p>
          </div>
        </div>
      </div>
      <div class="stat-card">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div>
            <p class="text-2xl font-bold text-gray-800" id="displayTotal">$<%= parseFloat(projectTotal).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></p>
            <p class="text-xs text-gray-500">Total Value</p>
          </div>
        </div>
      </div>
      <div class="stat-card">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </div>
          <div>
            <p class="text-sm font-bold text-gray-800">
              <%= project.createdAt ? new Date(project.createdAt).toLocaleDateString() : 'N/A' %>
            </p>
            <p class="text-xs text-gray-500">Created</p>
          </div>
        </div>
      </div>
      <div class="stat-card">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div>
            <p class="text-sm font-bold text-gray-800">
              <%= project.updatedAt ? new Date(project.updatedAt).toLocaleDateString() : 'N/A' %>
            </p>
            <p class="text-xs text-gray-500">Last Updated</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content: Two-column layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Add New Window Form -->
      <div class="lg:col-span-1">
        <div class="main-card p-6">
          <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            Add New Window
          </h3>
          
          <form action="/projects/<%= project._id %>/windows/new" method="GET" class="space-y-4">
            <!-- Window Reference -->
            <div>
              <label for="windowRef" class="form-label">Window Reference <span class="text-red-500">*</span></label>
              <input type="text" id="windowRef" name="windowRef" required class="form-input" placeholder="e.g., V1, W1, D1" maxlength="10">
              <p class="text-xs text-gray-500 mt-1">Enter a unique reference for this window</p>
            </div>
            
            <!-- Window System Selection -->
            <div>
              <label for="windowSystemId" class="form-label">Window System Type <span class="text-red-500">*</span></label>
              <select id="windowSystemId" name="windowSystemId" required class="form-input">
                <option value="">Select Window System</option>
                <% if (typeof windowSystems !== 'undefined' && windowSystems.length > 0) { %>
                  <% windowSystems.forEach(system => { %>
                    <option value="<%= system._id %>"><%= system.type %></option>
                  <% }) %>
                <% } else { %>
                  <option value="" disabled>No window systems available</option>
                <% } %>
              </select>
              <p class="text-xs text-gray-500 mt-1">Choose from pre-configured window systems</p>
            </div>
            
            <!-- Info Box -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <div class="flex items-start">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 mt-0.5 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div class="text-sm text-blue-800">
                  <p class="font-medium mb-1">Next Step:</p>
                  <p>You'll configure detailed specifications, dimensions, quantities, and pricing on the next page.</p>
                </div>
              </div>
            </div>
            
            <div class="pt-2">
              <button type="submit" class="btn-primary w-full flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                Add New Window
              </button>
            </div>
          </form>
        </div>
        
        <!-- Window Systems Info -->
        <div class="main-card p-4 mt-4">
          <h4 class="text-sm font-medium text-gray-700 mb-2">Available Window Systems:</h4>
          <% if (typeof windowSystems !== 'undefined' && windowSystems.length > 0) { %>
            <ul class="text-xs text-gray-600 space-y-1">
              <% windowSystems.slice(0, 3).forEach(system => { %>
                <li class="flex items-center">
                  <span class="w-2 h-2 bg-indigo-400 rounded-full mr-2"></span>
                  <%= system.type %>
                </li>
              <% }) %>
              <% if (windowSystems.length > 3) { %>
                <li class="text-gray-500 italic">+ <%= windowSystems.length - 3 %> more...</li>
              <% } %>
            </ul>
          <% } else { %>
            <p class="text-xs text-gray-500 italic">No window systems configured. Contact admin.</p>
          <% } %>
        </div>
      </div>
      
      <!-- Window Items List -->
      <div class="lg:col-span-2">
        <div class="main-card p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
              </svg>
              Window Items (<%= windowItems.length %>)
            </h3>
            <!-- Unit Toggle -->
            <div class="flex items-center gap-2">
              <span class="text-sm text-gray-600">Units:</span>
              <div class="flex bg-gray-100 rounded-lg p-1">
                <button id="unitToggleInches" onclick="switchUnits('inches')" class="unit-toggle-btn active px-3 py-1 rounded text-sm font-medium transition-colors">
                  in
                </button>
                <button id="unitToggleMm" onclick="switchUnits('mm')" class="unit-toggle-btn px-3 py-1 rounded text-sm font-medium transition-colors">
                  mm
                </button>
              </div>
            </div>
          </div>
          
          <% if (windowItems.length === 0) { %>
            <div class="text-center py-12 border-2 border-dashed border-gray-300 rounded-lg">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
              </svg>
              <p class="text-gray-600 font-medium mb-2">No window items added yet</p>
              <p class="text-gray-400 text-sm">Use the form to add your first window item</p>
            </div>
          <% } else { %>
            <!-- Mobile view: Cards -->
            <div class="lg:hidden space-y-4">
              <% windowItems.forEach((item, index) => { %>
                <div class="item-card">
                  <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                      <h4 class="font-medium text-gray-800"><%= item.itemName %></h4>
                      <div class="text-right">
                        <span class="font-bold text-green-600" data-price="<%= item.totalPrice %>">$<%= parseFloat(item.totalPrice).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="p-4">
                    <!-- Window Preview for Mobile -->
                    <div class="mb-4 flex justify-center">
                      <div class="window-preview-mini" 
                           data-item-id="<%= item._id %>"
                           data-width="<%= item.width %>"
                           data-height="<%= item.height %>"
                           data-panel-config="<%= item.windowSystem && item.windowSystem.panelConfiguration ? JSON.stringify(item.windowSystem.panelConfiguration) : '{}' %>"
                           style="width: 120px; height: 90px;">
                      </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-y-2 text-sm mb-4">
                      <div class="text-gray-500">Dimensions <span id="mobileDimensionsUnit">(in)</span>:</div>
                      <div class="text-gray-800 dimension-display" 
                           data-width-inches="<%= item.width %>" 
                           data-height-inches="<%= item.height %>">
                        <%= parseFloat(item.width).toFixed(2) %> × <%= parseFloat(item.height).toFixed(2) %>
                      </div>
                      
                      <div class="text-gray-500">Quantity:</div>
                      <div class="text-gray-800"><%= item.quantity %></div>
                      
                      <div class="text-gray-500">Unit Price:</div>
                      <div class="text-gray-800" data-price="<%= item.unitPrice %>">$<%= parseFloat(item.unitPrice).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></div>
                      
                      <% if (item.material) { %>
                        <div class="text-gray-500">Material:</div>
                        <div class="text-gray-800"><%= item.material %></div>
                      <% } %>
                      
                      <% if (item.color) { %>
                        <div class="text-gray-500">Color:</div>
                        <div class="text-gray-800"><%= item.color %></div>
                      <% } %>
                      
                      <% if (item.style) { %>
                        <div class="text-gray-500">Style:</div>
                        <div class="text-gray-800"><%= item.style %></div>
                      <% } %>
                    </div>
                    
                    <% if (item.description) { %>
                      <div class="text-sm mb-4 p-3 bg-gray-50 rounded-lg">
                        <div class="text-gray-500 mb-1 font-medium">Description:</div>
                        <div class="text-gray-700 whitespace-pre-wrap"><%= item.description %></div>
                      </div>
                    <% } %>
                    
                    <div class="flex justify-end space-x-2">
                      <a href="/projects/<%= project._id %>/windows/<%= item._id %>/edit" class="action-btn edit">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                      </a>
                      <form action="/projects/<%= project._id %>/items/<%= item._id %>/delete" method="POST" class="inline">
                        <button type="submit" class="action-btn delete" onclick="return confirm('Are you sure you want to delete this item?')">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                          </svg>
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              <% }) %>
            </div>
            
            <!-- Desktop view: Table -->
            <div class="hidden lg:block overflow-x-auto">
              <table class="data-table">
                <thead>
                  <tr>
                    <th class="w-32">Preview</th>
                    <th>Item Name</th>
                    <th id="dimensionsHeader">Dimensions (in)</th>
                    <th>Description</th>
                    <th class="text-center">Qty</th>
                    <th class="text-right">Unit Price</th>
                    <th class="text-right">Total</th>
                    <th class="text-center">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% windowItems.forEach((item, index) => { %>
                    <tr>
                      <td class="py-3">
                        <div class="window-preview-mini" 
                             data-item-id="<%= item._id %>"
                             data-width="<%= item.width %>"
                             data-height="<%= item.height %>"
                             data-panel-config="<%= item.windowSystem && item.windowSystem.panelConfiguration ? JSON.stringify(item.windowSystem.panelConfiguration) : '{}' %>"
                             style="width: 100px; height: 75px; margin: 0 auto;">
                        </div>
                      </td>
                      <td>
                        <div class="text-sm font-medium text-gray-900"><%= item.itemName %></div>
                      </td>
                      <td>
                        <div class="text-sm text-gray-900 dimension-display" 
                             data-width-inches="<%= item.width %>" 
                             data-height-inches="<%= item.height %>">
                          <%= parseFloat(item.width).toFixed(2) %> × <%= parseFloat(item.height).toFixed(2) %>
                        </div>
                      </td>
                      <td>
                        <% if (item.description) { %>
                          <div class="text-xs text-gray-600 max-w-xs" style="max-width: 300px;">
                            <%= item.description.length > 100 ? item.description.substring(0, 100) + '...' : item.description %>
                          </div>
                        <% } else { %>
                          <span class="text-gray-400 text-xs">—</span>
                        <% } %>
                      </td>
                      <td class="text-center">
                        <span class="badge badge-blue"><%= item.quantity %></span>
                      </td>
                      <td class="text-right">
                        <div class="text-sm text-gray-900" data-price="<%= item.unitPrice %>">$<%= parseFloat(item.unitPrice).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></div>
                      </td>
                      <td class="text-right">
                        <div class="text-sm font-medium text-green-600" data-price="<%= item.totalPrice %>">$<%= parseFloat(item.totalPrice).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></div>
                      </td>
                      <td>
                        <div class="flex items-center justify-center gap-1">
                          <a href="/projects/<%= project._id %>/windows/<%= item._id %>/edit" class="action-btn edit" title="Edit">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                          </a>
                          <form action="/projects/<%= project._id %>/items/<%= item._id %>/delete" method="POST" class="inline">
                            <button type="submit" class="action-btn delete" onclick="return confirm('Are you sure you want to delete this item?')" title="Delete">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                              </svg>
                            </button>
                          </form>
                        </div>
                      </td>
                    </tr>
                  <% }) %>
                  
                  <!-- Total Row -->
                  <tr class="bg-indigo-50 font-medium">
                    <td colspan="6" class="px-4 py-3 text-right text-gray-900">TOTAL:</td>
                    <td class="px-4 py-3 text-right text-green-700 font-bold text-lg" data-price="<%= projectTotal %>">$<%= parseFloat(projectTotal).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                    <td></td>
                  </tr>
                </tbody>
              </table>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </main>

  <%- include('../partials/_footer.ejs') %>

  <script>
    // Form validation
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.querySelector('form');
      const windowRefInput = document.getElementById('windowRef');
      const windowSystemSelect = document.getElementById('windowSystemId');
      
      if (form) {
        form.addEventListener('submit', (e) => {
          let isValid = true;
          
          if (!windowRefInput.value.trim()) {
            windowRefInput.classList.add('border-red-500');
            isValid = false;
          } else {
            windowRefInput.classList.remove('border-red-500');
          }
          
          if (!windowSystemSelect.value) {
            windowSystemSelect.classList.add('border-red-500');
            isValid = false;
          } else {
            windowSystemSelect.classList.remove('border-red-500');
          }
          
          if (!isValid) {
            e.preventDefault();
            alert('Please fill in all required fields.');
          }
        });
      }
      
      if (windowRefInput) {
        windowRefInput.addEventListener('input', () => {
          if (windowRefInput.value.trim()) {
            windowRefInput.classList.remove('border-red-500');
          }
        });
      }
      
      if (windowSystemSelect) {
        windowSystemSelect.addEventListener('change', () => {
          if (windowSystemSelect.value) {
            windowSystemSelect.classList.remove('border-red-500');
          }
        });
      }
      
      // Render window previews
      function renderWindowPreviews() {
        document.querySelectorAll('.window-preview-mini').forEach(preview => {
          const width = parseFloat(preview.dataset.width) || 0;
          const height = parseFloat(preview.dataset.height) || 0;
          const panelConfigStr = preview.dataset.panelConfig || '{}';
          
          try {
            const panelConfig = JSON.parse(panelConfigStr);
            const container = preview;
            container.innerHTML = '';
            
            // Create aluminum frame
            const frame = document.createElement('div');
            frame.className = 'aluminum-frame';
            
            const panelContainer = document.createElement('div');
            panelContainer.className = 'panel-container';
            
            // Set direction based on orientation
            if (panelConfig.orientation === 'vertical') {
              panelContainer.style.flexDirection = 'column';
            } else {
              panelContainer.style.flexDirection = 'row';
            }
            
            // Get panels and ratios
            const panels = panelConfig.panels || ['O'];
            const ratios = panelConfig.panelRatios || panels.map(() => 1);
            const totalRatio = ratios.reduce((a, b) => a + b, 0);
            
            // Render panels
            panels.forEach((panel, index) => {
              const isOperable = panel === 'X';
              const ratio = ratios[index] || 1;
              
              const panelDiv = document.createElement('div');
              panelDiv.className = `panel-glass ${isOperable ? 'operable-glass' : ''}`;
              panelDiv.style.flex = `${ratio} 0 0%`;
              
              const label = document.createElement('div');
              label.className = 'panel-label';
              label.textContent = panel;
              panelDiv.appendChild(label);
              
              panelContainer.appendChild(panelDiv);
              
              // Add mullion if not last panel
              if (index < panels.length - 1 && panelConfig.hasMullion) {
                const mullion = document.createElement('div');
                mullion.className = `mullion ${panelConfig.orientation === 'vertical' ? 'vertical' : 'horizontal'}`;
                panelContainer.appendChild(mullion);
              }
            });
            
            frame.appendChild(panelContainer);
            container.appendChild(frame);
          } catch (e) {
            // If no config, show simple placeholder
            container.innerHTML = `
              <div class="aluminum-frame" style="display: flex; align-items: center; justify-content: center;">
                <div class="panel-glass" style="width: 100%; height: 100%;">
                  <div class="panel-label" style="font-size: 10px;">Window</div>
                </div>
              </div>
            `;
          }
        });
      }
      
      // Initialize previews on load
      renderWindowPreviews();
      
      // Open quote preview in popup window
      window.openQuotePreview = function(projectId) {
        const width = 1000;
        const height = 700;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;
        window.open(
          `/projects/${projectId}/quote-preview`,
          'QuotePreview',
          `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes,toolbar=no,menubar=no,location=no`
        );
      };
    });
    
    // Unit conversion functions (global scope)
    function inchesToMm(inches) {
      return inches * 25.4;
    }
    
    function mmToInches(mm) {
      return mm / 25.4;
    }
    
    // Switch between units (global scope - accessible from onclick)
    window.switchUnits = function(unit) {
      // Update toggle buttons
      const inchesBtn = document.getElementById('unitToggleInches');
      const mmBtn = document.getElementById('unitToggleMm');
      const dimensionsHeader = document.getElementById('dimensionsHeader');
      const mobileUnit = document.getElementById('mobileDimensionsUnit');
      
      if (!inchesBtn || !mmBtn) return; // Exit if buttons don't exist
      
      if (unit === 'inches') {
        inchesBtn.classList.add('active', 'bg-indigo-600', 'text-white');
        inchesBtn.classList.remove('text-gray-700');
        mmBtn.classList.remove('active', 'bg-indigo-600', 'text-white');
        mmBtn.classList.add('text-gray-700');
        if (dimensionsHeader) dimensionsHeader.textContent = 'Dimensions (in)';
        if (mobileUnit) mobileUnit.textContent = '(in)';
      } else {
        mmBtn.classList.add('active', 'bg-indigo-600', 'text-white');
        mmBtn.classList.remove('text-gray-700');
        inchesBtn.classList.remove('active', 'bg-indigo-600', 'text-white');
        inchesBtn.classList.add('text-gray-700');
        if (dimensionsHeader) dimensionsHeader.textContent = 'Dimensions (mm)';
        if (mobileUnit) mobileUnit.textContent = '(mm)';
      }
      
      // Update all dimension displays
      document.querySelectorAll('.dimension-display').forEach(display => {
        const widthInches = parseFloat(display.dataset.widthInches);
        const heightInches = parseFloat(display.dataset.heightInches);
        
        if (isNaN(widthInches) || isNaN(heightInches)) return;
        
        if (unit === 'inches') {
          display.textContent = `${widthInches.toFixed(2)} × ${heightInches.toFixed(2)}`;
        } else {
          const widthMm = inchesToMm(widthInches);
          const heightMm = inchesToMm(heightInches);
          display.textContent = `${Math.round(widthMm)} × ${Math.round(heightMm)}`;
        }
      });
      
      // Save preference
      localStorage.setItem('dimensionUnit', unit);
    };
    
    // Load saved unit preference on page load
    document.addEventListener('DOMContentLoaded', () => {
      const savedUnit = localStorage.getItem('dimensionUnit') || 'inches';
      if (savedUnit) {
        // Small delay to ensure DOM is ready
        setTimeout(() => {
          if (window.switchUnits) {
            window.switchUnits(savedUnit);
          }
        }, 100);
      }
    });
  </script>
</body>
</html>
