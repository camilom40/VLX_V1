<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= project.projectName %> - Project Details</title>
  <%- include('../partials/_head.ejs') %>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/dashboard.css">
  <style>
    body { font-family: 'DM Sans', sans-serif; background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%); }
    
    .main-card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 10px 15px -3px rgba(0,0,0,0.05);
      border: 1px solid rgba(226,232,240,0.8);
    }
    
    .stat-card {
      background: linear-gradient(135deg, #fff, #f8fafc);
      border-radius: 1rem;
      padding: 1.25rem;
      border: 1px solid #e2e8f0;
      transition: all 0.3s ease;
    }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
    
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white; font-weight: 600; padding: 0.625rem 1.25rem;
      border-radius: 0.625rem; box-shadow: 0 4px 14px rgba(59,130,246,0.3);
      transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem;
    }
    .btn-primary:hover { background: linear-gradient(135deg, #2563eb, #1d4ed8); transform: translateY(-1px); }
    
    .btn-secondary {
      background: #f1f5f9; color: #475569; font-weight: 600;
      padding: 0.625rem 1.25rem; border-radius: 0.625rem;
      border: 2px solid #e2e8f0; transition: all 0.3s ease;
      display: inline-flex; align-items: center; gap: 0.5rem;
    }
    .btn-secondary:hover { background: #e2e8f0; border-color: #cbd5e1; }
    
    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white; font-weight: 600; padding: 0.625rem 1.25rem;
      border-radius: 0.625rem; box-shadow: 0 4px 14px rgba(239,68,68,0.3);
      transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem;
    }
    .btn-danger:hover { background: linear-gradient(135deg, #dc2626, #b91c1c); transform: translateY(-1px); }
    
    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      border: 2px solid #e2e8f0;
      background: #f8fafc;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }
    .form-input:hover { border-color: #cbd5e1; background: #fff; }
    .form-input:focus { outline: none; border-color: #3b82f6; background: #fff; box-shadow: 0 0 0 4px rgba(59,130,246,0.1); }
    
    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
    }
    
    .data-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: white;
    }
    .data-table thead {
      background: linear-gradient(135deg, #1e40af, #3b82f6);
      position: sticky;
      top: 0;
      z-index: 20;
    }
    .data-table th {
      padding: 0.875rem 1rem;
      text-align: left;
      font-weight: 600;
      color: white;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    }
    .data-table th:first-child { border-top-left-radius: 0.5rem; }
    .data-table th:last-child { border-top-right-radius: 0.5rem; }
    .data-table tbody tr {
      border-bottom: 1px solid #e5e7eb;
      transition: all 0.2s ease;
      background: white;
    }
    .data-table tbody tr:hover { 
      background: #f8fafc; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    .data-table tbody tr:last-child { border-bottom: none; }
    .data-table td {
      padding: 0.875rem 1rem;
      vertical-align: middle;
      background: inherit;
      font-size: 0.875rem;
      color: #374151;
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.625rem;
      border-radius: 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .badge-indigo { background: #e0e7ff; color: #3730a3; }
    .badge-purple { background: #f3e8ff; color: #7c3aed; }
    .badge-blue { background: #dbeafe; color: #1e40af; }
    .badge-green { background: #d1fae5; color: #065f46; }
    
    .action-btn {
      padding: 0.375rem;
      border-radius: 0.5rem;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      min-width: 32px;
      min-height: 32px;
    }
    .action-btn svg {
      width: 18px;
      height: 18px;
    }
    .action-btn.edit { 
      color: #3b82f6; 
      background: transparent;
    }
    .action-btn.edit:hover { 
      background: #eff6ff; 
      color: #1d4ed8; 
      transform: scale(1.1);
    }
    .action-btn.duplicate { 
      color: #6366f1; 
      background: transparent;
    }
    .action-btn.duplicate:hover { 
      background: #eef2ff; 
      color: #4f46e5; 
      transform: scale(1.1);
    }
    .action-btn.delete { 
      color: #ef4444; 
      background: transparent;
    }
    .action-btn.delete:hover { 
      background: #fef2f2; 
      color: #b91c1c; 
      transform: scale(1.1);
    }
    
    .item-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 0.75rem;
      transition: all 0.3s ease;
    }
    .item-card:hover {
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    
    /* Unit Toggle Styles */
    .unit-toggle-btn {
      color: #374151;
      background: transparent;
      border: none;
      cursor: pointer;
    }
    
    .unit-toggle-btn.active {
      background: linear-gradient(135deg, #4f46e5, #4338ca);
      color: white;
      box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
    }
    
    .unit-toggle-btn:hover:not(.active) {
      background: #e5e7eb;
    }
    
    /* Window Preview Mini Styles - Matching Original Compose Window */
    .window-preview-mini {
      position: relative;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .window-preview-mini .aluminum-frame {
      width: 100%;
      height: 100%;
      background: linear-gradient(145deg, #909090 0%, #707070 20%, #585858 50%, #707070 80%, #909090 100%);
      border-radius: 2px;
      padding: 2px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .window-preview-mini .panel-container {
      display: flex;
      width: 100%;
      height: 100%;
      gap: 1px;
    }
    
    .window-preview-mini .panel-glass {
      flex: 1;
      background: linear-gradient(180deg, rgba(191,219,254,0.8) 0%, rgba(147,197,253,0.6) 50%, rgba(191,219,254,0.7) 100%);
      border-radius: 1px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    .window-preview-mini .panel-glass::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, transparent 50%);
      pointer-events: none;
    }
    
    .window-preview-mini .panel-glass.operable-glass {
      background: linear-gradient(180deg, rgba(186,230,253,0.75) 0%, rgba(147,197,253,0.55) 50%, rgba(186,230,253,0.65) 100%);
    }
    
    .window-preview-mini .panel-glass .panel-label {
      font-size: 8px;
      font-weight: bold;
      color: rgba(30,64,175,0.6);
      text-shadow: 0 1px 2px rgba(255,255,255,0.5);
      z-index: 1;
    }
    
    .window-preview-mini .panel-glass.operable-glass .panel-label {
      color: rgba(22,101,52,0.7);
    }
    
    .window-preview-mini .mullion {
      background: linear-gradient(145deg, #606060, #505050);
      flex-shrink: 0;
    }
    
    .window-preview-mini .mullion.horizontal {
      width: 2px;
      height: 100%;
    }
    
    .window-preview-mini .mullion.vertical {
      width: 100%;
      height: 2px;
    }
    
    /* Unit Toggle Styles */
    .unit-toggle-btn {
      color: #374151;
      background: transparent;
      border: none;
      cursor: pointer;
    }
    
    .unit-toggle-btn.active {
      background: linear-gradient(135deg, #4f46e5, #4338ca);
      color: white;
      box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
    }
    
    .unit-toggle-btn:hover:not(.active) {
      background: #e5e7eb;
    }
  </style>
</head>

<body class="min-h-screen flex flex-col" data-exchange-rate="<%= typeof exchangeRate !== 'undefined' && exchangeRate ? exchangeRate : 4000 %>">
  <%- include('../partials/_header.ejs') %>

  <main role="main" class="container mx-auto mt-6 px-4 flex-grow mb-16">
    <!-- Back to Dashboard Button -->
    <div class="mb-4">
      <a href="/dashboard" class="btn-secondary inline-flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to Dashboard
      </a>
    </div>

    <!-- Project Header -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
        <div>
          <div class="flex flex-wrap items-center gap-3 mb-2">
            <h2 class="text-2xl sm:text-3xl font-bold text-gray-800"><%= project.projectName %></h2>
            <% if (project.quoteNumber) { %>
              <span class="px-4 py-1.5 text-sm font-bold bg-gray-800 text-white rounded border border-gray-700 whitespace-nowrap tracking-wide">
                <%= project.quoteNumber %>
              </span>
            <% } %>
          </div>
          <p class="text-gray-600 mb-4">
            <span class="font-medium">Client:</span> <%= project.clientName || 'Not specified' %>
          </p>
          <div class="flex flex-col xs:flex-row space-y-2 xs:space-y-0 xs:space-x-4 text-sm text-gray-500">
            <div class="flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <span>Created: <%= project.createdAt ? new Date(project.createdAt).toLocaleDateString() : 'N/A' %></span>
            </div>
            <div class="flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>Updated: <%= project.updatedAt ? new Date(project.updatedAt).toLocaleDateString() : 'N/A' %></span>
            </div>
          </div>
        </div>
        
        <div class="mt-4 md:mt-0">
          <div class="bg-blue-50 rounded-lg px-6 py-4 border border-blue-100" data-project-total="<%= projectTotal %>">
            <div class="text-blue-800 text-xl font-bold" id="displayTotal">$<%= projectTotal %></div>
            <div class="text-blue-600 text-sm">Total Project Value</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content: Window Items Table -->
    <div>
        <div class="main-card p-6">
          <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-4">
            <h3 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
              </svg>
              Window Items (<%= windowItems.length %>)
            </h3>
            <div class="flex items-center gap-3">
              <!-- Add Window Button -->
              <button onclick="openAddWindowModal()" class="btn-primary flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                Add Window
              </button>
            </div>
          </div>
          
          <% if (windowItems.length === 0) { %>
            <div class="text-center py-12 border-2 border-dashed border-gray-300 rounded-lg">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
              </svg>
              <p class="text-gray-600 font-medium mb-2">No window items added yet</p>
              <p class="text-gray-400 text-sm">Use the form to add your first window item</p>
            </div>
          <% } else { %>
            <!-- Mobile view: Cards -->
            <div class="lg:hidden space-y-4">
              <% windowItems.forEach((item, index) => { %>
                <div class="item-card">
                  <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                      <h4 class="font-medium text-gray-800"><%= item.itemName %></h4>
                      <div class="text-right">
                        <span class="font-bold text-green-600" data-price="<%= item.totalPrice %>"><!-- Price will be formatted by JavaScript --></span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="p-4">
                    <!-- Window Preview for Mobile -->
                    <div class="mb-4 flex justify-center">
                      <div class="window-preview-mini" 
                           data-item-id="<%= item._id %>"
                           data-width="<%= item.width %>"
                           data-height="<%= item.height %>"
                           data-panel-config="<%= item.windowSystem && item.windowSystem.panelConfiguration ? JSON.stringify(item.windowSystem.panelConfiguration) : '{}' %>"
                           style="width: 120px; height: 90px;">
                      </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-y-2 text-sm mb-4">
                      <div class="text-gray-500">Dimensions <span id="mobileDimensionsUnit">(in)</span>:</div>
                      <div class="text-gray-800 dimension-display" 
                           data-width-inches="<%= item.width %>" 
                           data-height-inches="<%= item.height %>"
                           data-mobile="true">
                        <%= parseFloat(item.width).toFixed(2) %> × <%= parseFloat(item.height).toFixed(2) %> <span class="dimension-unit">in</span>
                      </div>
                      
                      <div class="text-gray-500">Quantity:</div>
                      <div class="text-gray-800"><%= item.quantity %></div>
                      
                      <div class="text-gray-500">Unit Price:</div>
                      <div class="text-gray-800" data-price="<%= item.unitPrice %>"><!-- Price will be formatted by JavaScript --></div>
                      
                      <% if (item.material) { %>
                        <div class="text-gray-500">Material:</div>
                        <div class="text-gray-800"><%= item.material %></div>
                      <% } %>
                      
                      <% if (item.color) { %>
                        <div class="text-gray-500">Color:</div>
                        <div class="text-gray-800"><%= item.color %></div>
                      <% } %>
                      
                      <% if (item.style) { %>
                        <div class="text-gray-500">Style:</div>
                        <div class="text-gray-800"><%= item.style %></div>
                      <% } %>
                    </div>
                    
                    <% if (item.description) { %>
                      <div class="text-sm mb-4 p-3 bg-gray-50 rounded-lg">
                        <div class="text-gray-500 mb-1 font-medium">Description:</div>
                        <div class="text-gray-700 whitespace-pre-wrap"><%= item.description %></div>
                      </div>
                    <% } %>
                    
                    <div class="flex justify-end space-x-2">
                      <a href="/projects/<%= project._id %>/windows/<%= item._id %>/edit" class="action-btn edit">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                      </a>
                      <form action="/projects/<%= project._id %>/items/<%= item._id %>/delete" method="POST" class="inline">
                        <button type="submit" class="action-btn delete" onclick="return confirm('Are you sure you want to delete this item?')">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                          </svg>
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              <% }) %>
            </div>
            
            <!-- Desktop view: Table -->
            <div class="hidden lg:block overflow-x-auto rounded-lg border border-gray-200 shadow-sm" style="min-width: 100%; -webkit-overflow-scrolling: touch;">
              <table class="data-table" style="min-width: 1200px;">
                <thead>
                  <tr>
                    <th class="w-16">Item</th>
                    <th class="w-48">Preview</th>
                    <th class="min-w-48">Description</th>
                    <th class="text-center w-20">Qty</th>
                    <th class="text-right w-32">Unit Price</th>
                    <th class="text-right w-32">Total</th>
                    <th class="text-center w-28 whitespace-nowrap">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% windowItems.forEach((item, index) => { 
                    // Parse glass information from description
                    let glassType = '—';
                    let glassColor = '—';
                    let lowE = 'NO';
                    let missileType = '—';
                    let glassDescription = '';
                    let flangeSize = 'N/A';
                    
                    if (item.description) {
                      // Extract Glass Type
                      const glassTypeMatch = item.description.match(/Glass Type:\s*([^-]+)/);
                      if (glassTypeMatch) {
                        glassType = glassTypeMatch[1].trim();
                      }
                      
                      // Extract full glass description (after the dash)
                      const glassDescMatch = item.description.match(/Glass Type:\s*[^-]+-\s*(.+?)(?:\n|$)/);
                      if (glassDescMatch) {
                        glassDescription = glassDescMatch[1].trim();
                      }
                      
                      // Extract Flange information
                      const flangeMatch = item.description.match(/Flanged:\s*([^\n]+)/);
                      if (flangeMatch) {
                        flangeSize = flangeMatch[1].trim().replace(/\n/g, '').trim();
                        // Remove any trailing quotes and add a single quote
                        flangeSize = flangeSize.replace(/"+$/, '') + '"';
                      }
                    }
                    
                    // Get color from item.color (Aluminum Color)
                    const aluminumColor = item.color && item.color !== 'Various' ? item.color : '—';
                    
                    // Get window system type
                    const windowSystemType = item.style || item.windowSystem?.type || '—';
                  %>
                    <tr>
                      <td class="py-3">
                        <div class="text-sm font-semibold text-gray-900"><%= item.itemName %></div>
                      </td>
                      <td class="py-3">
                        <div class="window-preview-mini" 
                             data-item-id="<%= item._id %>"
                             data-width="<%= item.width %>"
                             data-height="<%= item.height %>"
                             data-panel-config="<%= item.windowSystem && item.windowSystem.panelConfiguration ? JSON.stringify(item.windowSystem.panelConfiguration) : '{}' %>"
                             style="width: 160px; height: 120px; margin: 0 auto;">
                        </div>
                      </td>
                      <td class="py-3">
                        <div class="text-xs text-gray-700 space-y-1.5">
                          <div class="flex items-start gap-2">
                            <span class="text-xs font-semibold text-gray-900 w-28 flex-shrink-0">Dimensions:</span>
                            <span class="text-xs font-medium text-gray-900 dimension-display" 
                                  data-width-inches="<%= item.width %>" 
                                  data-height-inches="<%= item.height %>">
                              <span>Width: <%= parseFloat(item.width).toFixed(2) %> <span class="dimension-unit">in</span></span>
                              <span class="mx-1.5 text-gray-400">×</span>
                              <span>Height: <%= parseFloat(item.height).toFixed(2) %> <span class="dimension-unit">in</span></span>
                            </span>
                          </div>
                          
                          <div class="flex items-start gap-2">
                            <span class="text-xs font-semibold text-gray-900 w-28 flex-shrink-0">Missile Impact:</span>
                            <span class="text-xs text-gray-700"><%= missileType %></span>
                          </div>
                          
                          <div class="flex items-start gap-2">
                            <span class="text-xs font-semibold text-gray-900 w-28 flex-shrink-0">Aluminum Color:</span>
                            <span class="text-xs text-gray-700"><%= aluminumColor %></span>
                          </div>
                          
                          <div class="flex items-start gap-2">
                            <span class="text-xs font-semibold text-gray-900 w-28 flex-shrink-0">Glass Type:</span>
                            <span class="text-xs text-gray-700"><%= glassType %></span>
                          </div>
                          
                          <% if (glassDescription) { %>
                          <div class="flex items-start gap-2">
                            <span class="text-xs font-semibold text-gray-900 w-28 flex-shrink-0">Glass Description:</span>
                            <span class="text-xs text-gray-700"><%= glassDescription %></span>
                          </div>
                          <% } %>
                          
                          <div class="flex items-start gap-2">
                            <span class="text-xs font-semibold text-gray-900 w-28 flex-shrink-0">Glass Color:</span>
                            <span class="text-xs text-gray-700"><%= glassColor %></span>
                          </div>
                          
                          <div class="flex items-start gap-2">
                            <span class="text-xs font-semibold text-gray-900 w-28 flex-shrink-0">Low E:</span>
                            <span class="text-xs text-gray-700"><%= lowE %></span>
                          </div>
                          
                          <div class="flex items-start gap-2">
                            <span class="text-xs font-semibold text-gray-900 w-28 flex-shrink-0">Flanged:</span>
                            <span class="text-xs <%= flangeSize === 'N/A' ? 'text-gray-400' : 'text-gray-700' %>"><%= flangeSize %></span>
                          </div>
                        </div>
                      </td>
                      <td class="text-center py-3">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-md bg-blue-100 text-blue-800 font-semibold text-sm"><%= item.quantity %></span>
                      </td>
                      <td class="text-right py-3">
                        <div class="text-sm font-medium text-gray-900" data-price="<%= item.unitPrice %>"><!-- Price will be formatted by JavaScript --></div>
                      </td>
                      <td class="text-right py-3">
                        <div class="text-sm font-bold text-green-700" data-price="<%= item.totalPrice %>"><!-- Price will be formatted by JavaScript --></div>
                      </td>
                      <td class="whitespace-nowrap">
                        <div class="flex items-center justify-center gap-1 flex-nowrap">
                          <a href="/projects/<%= project._id %>/windows/<%= item._id %>/edit" class="action-btn edit flex-shrink-0" title="Edit">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                          </a>
                          <form action="/projects/<%= project._id %>/items/<%= item._id %>/duplicate" method="POST" class="inline flex-shrink-0">
                            <button type="submit" class="action-btn duplicate" title="Duplicate">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                              </svg>
                            </button>
                          </form>
                          <form action="/projects/<%= project._id %>/items/<%= item._id %>/delete" method="POST" class="inline flex-shrink-0">
                            <button type="submit" class="action-btn delete" onclick="return confirm('Are you sure you want to delete this item?')" title="Delete">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                              </svg>
                            </button>
                          </form>
                        </div>
                      </td>
                    </tr>
                  <% }) %>
                  
                  <!-- Total Row -->
                  <tr class="bg-gradient-to-r from-indigo-50 to-blue-50 font-medium border-t-2 border-indigo-200">
                    <td colspan="4" class="px-4 py-3 text-right text-gray-900 font-semibold">TOTAL:</td>
                    <td class="px-4 py-3 text-right text-green-700 font-bold text-lg" data-price="<%= projectTotal %>">$<%= parseFloat(projectTotal).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                    <td class="px-4 py-3"></td>
                  </tr>
                </tbody>
              </table>
            </div>
          <% } %>
        </div>
    </div>

    <!-- Add Window Modal -->
    <div id="addWindowModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
              </svg>
              Add New Window
            </h3>
            <button onclick="closeAddWindowModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          
          <form action="/projects/<%= project._id %>/windows/new" method="GET" class="space-y-4">
            <!-- Window Reference -->
            <div>
              <label for="modalWindowRef" class="block text-sm font-medium text-gray-700 mb-1">
                Window Reference <span class="text-red-500">*</span>
              </label>
              <input type="text" id="modalWindowRef" name="windowRef" required 
                     class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" 
                     placeholder="e.g., V1, W1" maxlength="10">
            </div>
            
            <!-- Window System Selection -->
            <div>
              <label for="modalWindowSystemId" class="block text-sm font-medium text-gray-700 mb-1">
                Window System <span class="text-red-500">*</span>
              </label>
              <select id="modalWindowSystemId" name="windowSystemId" required 
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                <option value="">Select System</option>
                <% if (typeof windowSystems !== 'undefined' && windowSystems.length > 0) { %>
                  <% windowSystems.forEach(system => { %>
                    <option value="<%= system._id %>"><%= system.type %></option>
                  <% }) %>
                <% } else { %>
                  <option value="" disabled>No systems available</option>
                <% } %>
              </select>
            </div>
            
            <div class="flex gap-3 pt-2">
              <button type="button" onclick="closeAddWindowModal()" class="btn-secondary flex-1">
                Cancel
              </button>
              <button type="submit" class="btn-primary flex-1 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                Add Window
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    </div>
    
    <!-- Optional Project Costs -->
    <div class="bg-white rounded-lg shadow-sm p-6 mt-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Optional Project Costs</h3>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-gray-50 rounded-lg p-4">
          <label class="flex items-center space-x-3">
            <input type="checkbox" id="includeSeaFreight" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" onchange="calculateProjectTotal()">
            <div>
              <div class="text-sm font-medium text-gray-900">Sea Freight</div>
              <div class="text-xs text-gray-500">Applied to entire project</div>
            </div>
          </label>
        </div>
        
        <div class="bg-gray-50 rounded-lg p-4">
          <label class="flex items-center space-x-3">
            <input type="checkbox" id="includeLandFreight" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" onchange="calculateProjectTotal()">
            <div>
              <div class="text-sm font-medium text-gray-900">Land Freight</div>
              <div class="text-xs text-gray-500">Applied to entire project</div>
            </div>
          </label>
        </div>
        
        <div class="bg-gray-50 rounded-lg p-4">
          <label class="flex items-center space-x-3">
            <input type="checkbox" id="includeAdminExpenses" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" onchange="calculateProjectTotal()">
            <div>
              <div class="text-sm font-medium text-gray-900">Administrative Expenses</div>
              <div class="text-xs text-gray-500">Applied to entire project</div>
            </div>
          </label>
        </div>
      </div>
      
      <!-- Cost Breakdown -->
      <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
        <h4 class="text-lg font-medium text-gray-800 mb-3">Cost Breakdown</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div class="space-y-2">
            <div class="flex justify-between">
              <span class="text-gray-600">Base Project Cost:</span>
              <span class="font-medium" id="baseProjectCost">$<%= projectTotal %></span>
            </div>
            <div class="flex justify-between" id="seaFreightRow" style="display: none;">
              <span class="text-gray-600">Sea Freight:</span>
              <span class="font-medium" id="seaFreightAmount">$0.00</span>
            </div>
            <div class="flex justify-between" id="landFreightRow" style="display: none;">
              <span class="text-gray-600">Land Freight:</span>
              <span class="font-medium" id="landFreightAmount">$0.00</span>
            </div>
          </div>
          <div class="space-y-2">
            <div class="flex justify-between" id="adminExpensesRow" style="display: none;">
              <span class="text-gray-600">Administrative Expenses:</span>
              <span class="font-medium" id="adminExpensesAmount">$0.00</span>
            </div>
            <hr class="border-gray-300">
            <div class="flex justify-between text-lg font-bold">
              <span class="text-gray-800">Final Total:</span>
              <span class="text-green-600" id="finalProjectTotal">$<%= projectTotal %></span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="mt-6 flex flex-col sm:flex-row flex-wrap justify-end gap-3">
      <a href="/dashboard" class="btn-secondary w-full sm:w-auto">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        <span class="hidden sm:inline">Back to Projects</span>
        <span class="sm:hidden">Back</span>
      </a>
      
      <!-- Preview Quote Button -->
      <button type="button" onclick="openQuotePreview('<%= project._id %>')" class="btn-secondary w-full sm:w-auto">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
        </svg>
        <span class="hidden sm:inline">Preview Quote</span>
        <span class="sm:hidden">Preview</span>
      </button>
      
      <!-- PDF Export Button -->
      <a href="/projects/<%= project._id %>/quote-pdf?unit=inches" class="btn-primary w-full sm:w-auto">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <span class="hidden sm:inline">Export as PDF</span>
        <span class="sm:hidden">Export PDF</span>
      </a>
    </div>
  </main>

  <%- include('../partials/_footer.ejs') %>

  <script>
    // Cost settings from server (stored in USD in database)
    const costSettings = {
      seaFreight: <%= costSettings && costSettings.seaFreight ? costSettings.seaFreight : 0 %>,
      landFreight: <%= costSettings && costSettings.landFreight ? costSettings.landFreight : 0 %>,
      administrativeExpenses: <%= costSettings && costSettings.administrativeExpenses ? costSettings.administrativeExpenses : 0 %>
    };
    
    // Exchange rate from server (default to 4000 if not provided)
    const exchangeRateElement = document.querySelector('[data-exchange-rate]');
    const exchangeRate = exchangeRateElement ? parseFloat(exchangeRateElement.getAttribute('data-exchange-rate')) : 4000;
    
    // Use global currency preference from header
    let currentCurrency = window.globalPreferences?.currency || 'COP';
    
    // Set exchange rate in global preferences if available
    if (window.globalPreferences) {
      window.globalPreferences.exchangeRate = exchangeRate;
    }
    
    // Get project total from data attribute (initialized after DOM loads)
    let baseProjectTotal = 0;
    
    // Format numbers with commas based on current currency
    // IMPORTANT: amount is in USD (stored in database), convert for display
    function formatCurrency(amount, currency = null) {
      const currencyToUse = currency || currentCurrency;
      
      if (currencyToUse === 'USD') {
        // Amount is already in USD, display as-is
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }).format(amount);
      } else {
        // Convert USD to COP for display
        const amountCOP = amount * exchangeRate;
        return new Intl.NumberFormat('es-CO', {
          style: 'currency',
          currency: 'COP',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(amountCOP);
      }
    }
    
    // Update currency when global preference changes
    function updateCurrencyFromGlobal() {
      if (window.globalPreferences) {
        currentCurrency = window.globalPreferences.currency || 'COP';
        updateAllPrices();
      }
    }
    
    // Update all price displays on the page
    function updateAllPrices() {
      // Update project total display
      const projectTotalElement = document.querySelector('[data-project-total]');
      if (projectTotalElement) {
        const total = parseFloat(projectTotalElement.getAttribute('data-project-total')) || 0;
        document.getElementById('displayTotal').textContent = formatCurrency(total);
      }
      
      // Update all price elements with data-price attribute
      const itemPrices = document.querySelectorAll('[data-price]');
      itemPrices.forEach(element => {
        const price = parseFloat(element.getAttribute('data-price'));
        if (!isNaN(price)) {
          element.textContent = formatCurrency(price);
        }
      });
      
      // Recalculate project total with optional costs
      calculateProjectTotal();
    }
    
    // Calculate project total with optional costs
    function calculateProjectTotal() {
      let total = baseProjectTotal;
      
      const includeSeaFreight = document.getElementById('includeSeaFreight')?.checked;
      const includeLandFreight = document.getElementById('includeLandFreight')?.checked;
      const includeAdminExpenses = document.getElementById('includeAdminExpenses')?.checked;
      
      let seaFreightAmount = 0;
      let landFreightAmount = 0;
      let adminExpensesAmount = 0;
      
      if (includeSeaFreight) {
        // Sea freight is a fixed dollar amount (stored in USD in database)
        seaFreightAmount = parseFloat(costSettings.seaFreight) || 0;
        total += seaFreightAmount;
        const seaFreightRow = document.getElementById('seaFreightRow');
        const seaFreightAmountEl = document.getElementById('seaFreightAmount');
        if (seaFreightRow) seaFreightRow.style.display = 'flex';
        if (seaFreightAmountEl) seaFreightAmountEl.textContent = formatCurrency(seaFreightAmount);
      } else {
        const seaFreightRow = document.getElementById('seaFreightRow');
        if (seaFreightRow) seaFreightRow.style.display = 'none';
      }
      
      if (includeLandFreight) {
        // Land freight is a fixed dollar amount (stored in USD in database)
        landFreightAmount = parseFloat(costSettings.landFreight) || 0;
        total += landFreightAmount;
        const landFreightRow = document.getElementById('landFreightRow');
        const landFreightAmountEl = document.getElementById('landFreightAmount');
        if (landFreightRow) landFreightRow.style.display = 'flex';
        if (landFreightAmountEl) landFreightAmountEl.textContent = formatCurrency(landFreightAmount);
      } else {
        const landFreightRow = document.getElementById('landFreightRow');
        if (landFreightRow) landFreightRow.style.display = 'none';
      }
      
      if (includeAdminExpenses) {
        // Administrative expenses is a fixed dollar amount (stored in USD in database)
        adminExpensesAmount = parseFloat(costSettings.administrativeExpenses) || 0;
        total += adminExpensesAmount;
        const adminExpensesRow = document.getElementById('adminExpensesRow');
        const adminExpensesAmountEl = document.getElementById('adminExpensesAmount');
        if (adminExpensesRow) adminExpensesRow.style.display = 'flex';
        if (adminExpensesAmountEl) adminExpensesAmountEl.textContent = formatCurrency(adminExpensesAmount);
      } else {
        const adminExpensesRow = document.getElementById('adminExpensesRow');
        if (adminExpensesRow) adminExpensesRow.style.display = 'none';
      }
      
      // Update displays
      const displayTotal = document.getElementById('displayTotal');
      const finalProjectTotal = document.getElementById('finalProjectTotal');
      if (displayTotal) displayTotal.textContent = formatCurrency(total);
      if (finalProjectTotal) finalProjectTotal.textContent = formatCurrency(total);
    }
    
    // Format all existing prices on page load
    function formatExistingPrices() {
      // Format base project cost
      const baseProjectCostEl = document.getElementById('baseProjectCost');
      if (baseProjectCostEl) {
        baseProjectCostEl.textContent = formatCurrency(baseProjectTotal);
      }
      
      // Format individual item prices
      const itemPrices = document.querySelectorAll('[data-price]');
      itemPrices.forEach(element => {
        const price = parseFloat(element.getAttribute('data-price'));
        if (!isNaN(price)) {
          element.textContent = formatCurrency(price);
        }
      });
      
      // Initial calculation
      calculateProjectTotal();
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Get project total from data attribute
      const projectTotalElement = document.querySelector('[data-project-total]');
      baseProjectTotal = projectTotalElement ? parseFloat(projectTotalElement.getAttribute('data-project-total')) || 0 : 0;
      
      // Format existing prices with commas (already called above)
      
      // Modal functions
      function openAddWindowModal() {
        const modal = document.getElementById('addWindowModal');
        if (modal) {
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
        }
      }
      
      function closeAddWindowModal() {
        const modal = document.getElementById('addWindowModal');
        if (modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = '';
          // Reset form
          const form = modal.querySelector('form');
          if (form) {
            form.reset();
            // Remove error classes
            const inputs = form.querySelectorAll('input, select');
            inputs.forEach(input => input.classList.remove('border-red-500'));
          }
        }
      }
      
      // Close modal when clicking outside
      const modal = document.getElementById('addWindowModal');
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeAddWindowModal();
          }
        });
      }
      
      // Simple form validation for window reference and system selection
      const addWindowForm = document.querySelector('form[action*="/windows/new"]');
      const windowRefInput = document.getElementById('modalWindowRef');
      const windowSystemSelect = document.getElementById('modalWindowSystemId');
      
      if (addWindowForm) {
        addWindowForm.addEventListener('submit', (e) => {
          let isValid = true;
          
          // Validate window reference
          if (!windowRefInput || !windowRefInput.value.trim()) {
            if (windowRefInput) windowRefInput.classList.add('border-red-500');
            isValid = false;
          } else {
            windowRefInput.classList.remove('border-red-500');
          }
          
          // Validate window system selection
          if (!windowSystemSelect || !windowSystemSelect.value) {
            if (windowSystemSelect) windowSystemSelect.classList.add('border-red-500');
            isValid = false;
          } else {
            windowSystemSelect.classList.remove('border-red-500');
          }
          
          if (!isValid) {
            e.preventDefault();
            alert('Please fill in all required fields.');
          }
        });
      }
      
      if (windowRefInput) {
        windowRefInput.addEventListener('input', () => {
          if (windowRefInput.value.trim()) {
            windowRefInput.classList.remove('border-red-500');
          }
        });
      }
      
      if (windowSystemSelect) {
        windowSystemSelect.addEventListener('change', () => {
          if (windowSystemSelect.value) {
            windowSystemSelect.classList.remove('border-red-500');
          }
        });
      }
      
      // Make functions globally available
      window.openAddWindowModal = openAddWindowModal;
      window.closeAddWindowModal = closeAddWindowModal;
      
      // Render window previews
      function renderWindowPreviews() {
        document.querySelectorAll('.window-preview-mini').forEach(preview => {
          const width = parseFloat(preview.dataset.width) || 0;
          const height = parseFloat(preview.dataset.height) || 0;
          const panelConfigStr = preview.dataset.panelConfig || '{}';
          
          try {
            const panelConfig = JSON.parse(panelConfigStr);
            const container = preview;
            container.innerHTML = '';
            
            // Create aluminum frame
            const frame = document.createElement('div');
            frame.className = 'aluminum-frame';
            
            const panelContainer = document.createElement('div');
            panelContainer.className = 'panel-container';
            
            // Get panels and ratios
            const panels = panelConfig.panels || ['O'];
            const ratios = panelConfig.panelRatios || panels.map(() => 1);
            const operationType = panelConfig.operationType || 'sliding';
            
            // Special handling for Single Hung
            if (operationType === 'single-hung') {
              panelContainer.style.flexDirection = 'column'; // Always vertical
              
              panels.forEach((panel, index) => {
                const isOperable = panel === 'X';
                const ratio = ratios[index] || 1;
                const isTopSash = index === 0;
                const isBottomSash = index === panels.length - 1;
                
                const panelDiv = document.createElement('div');
                panelDiv.className = `panel-glass ${isOperable ? 'operable-glass' : ''}`;
                panelDiv.style.flex = `${ratio} 0 0%`;
                panelDiv.style.position = 'relative';
                
                // Add Single Hung specific elements
                if (isOperable && isBottomSash) {
                  // Bottom operable sash - add lift handles
                  const handles = document.createElement('div');
                  handles.style.cssText = 'position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); display: flex; gap: 3px;';
                  handles.innerHTML = `
                    <div style="width: 8px; height: 1px; background: linear-gradient(180deg, #808080, #d0d0d0, #808080); border-radius: 1px;"></div>
                    <div style="width: 8px; height: 1px; background: linear-gradient(180deg, #808080, #d0d0d0, #808080); border-radius: 1px;"></div>
                  `;
                  panelDiv.appendChild(handles);
                  
                  // Sash lock at top
                  const lock = document.createElement('div');
                  lock.style.cssText = 'position: absolute; top: 1px; left: 50%; transform: translateX(-50%); width: 4px; height: 2px; background: linear-gradient(180deg, #808080, #b0b0b0, #808080); border-radius: 1px;';
                  panelDiv.appendChild(lock);
                }
                
                // Panel label
                const label = document.createElement('div');
                label.className = 'panel-label';
                label.textContent = panel;
                panelDiv.appendChild(label);
                
                panelContainer.appendChild(panelDiv);
                
                // Add meeting rail between sashes (after each panel except the last)
                if (index < panels.length - 1) {
                  const meetingRail = document.createElement('div');
                  meetingRail.className = 'mullion vertical';
                  meetingRail.style.cssText = 'flex-shrink: 0; height: 4px; width: 100%; background: linear-gradient(180deg, #505050, #707070, #808080, #707070, #505050); box-shadow: 0 1px 2px rgba(0,0,0,0.2);';
                  panelContainer.appendChild(meetingRail);
                }
              });
            }
            // Special handling for Casement
            else if (operationType === 'casement') {
              const orientation = panelConfig.orientation || 'horizontal';
              panelContainer.style.flexDirection = orientation === 'vertical' ? 'column' : 'row';
              
              panels.forEach((panel, index) => {
                const isOperable = panel === 'X';
                const ratio = ratios[index] || 1;
                const hingeOnLeft = index % 2 === 0;
                
                const panelDiv = document.createElement('div');
                panelDiv.className = `panel-glass ${isOperable ? 'operable-glass' : ''}`;
                panelDiv.style.flex = `${ratio} 0 0%`;
                panelDiv.style.position = 'relative';
                
                if (isOperable) {
                  // Hinge
                  const hinge = document.createElement('div');
                  hinge.style.cssText = `position: absolute; ${hingeOnLeft ? 'left' : 'right'}: 1px; top: 50%; transform: translateY(-50%); width: 2px; height: 60%; background: linear-gradient(180deg, #505050, #707070, #505050); border-radius: 1px;`;
                  panelDiv.appendChild(hinge);
                  
                  // Handle
                  const handle = document.createElement('div');
                  handle.style.cssText = `position: absolute; ${hingeOnLeft ? 'right' : 'left'}: 2px; top: 50%; transform: translateY(-50%); width: 3px; height: 4px; background: #808080; border-radius: 1px;`;
                  panelDiv.appendChild(handle);
                }
                
                const label = document.createElement('div');
                label.className = 'panel-label';
                label.textContent = panel;
                panelDiv.appendChild(label);
                
                panelContainer.appendChild(panelDiv);
              });
            }
            // Special handling for Sliding
            else if (operationType === 'sliding') {
              const orientation = panelConfig.orientation || 'horizontal';
              panelContainer.style.flexDirection = orientation === 'vertical' ? 'column' : 'row';
              
              panels.forEach((panel, index) => {
                const isOperable = panel === 'X';
                const ratio = ratios[index] || 1;
                
                const panelDiv = document.createElement('div');
                panelDiv.className = `panel-glass ${isOperable ? 'operable-glass' : ''}`;
                panelDiv.style.flex = `${ratio} 0 0%`;
                panelDiv.style.position = 'relative';
                
                if (isOperable) {
                  // Handle
                  const handle = document.createElement('div');
                  handle.style.cssText = 'position: absolute; right: 2px; top: 50%; transform: translateY(-50%); width: 3px; height: 4px; background: #808080; border-radius: 1px;';
                  panelDiv.appendChild(handle);
                }
                
                const label = document.createElement('div');
                label.className = 'panel-label';
                label.textContent = panel;
                panelDiv.appendChild(label);
                
                panelContainer.appendChild(panelDiv);
              });
            }
            // Default rendering for other types
            else {
              // Set direction based on orientation
              if (panelConfig.orientation === 'vertical') {
                panelContainer.style.flexDirection = 'column';
              } else {
                panelContainer.style.flexDirection = 'row';
              }
              
              // Render panels
              panels.forEach((panel, index) => {
                const isOperable = panel === 'X';
                const ratio = ratios[index] || 1;
                
                const panelDiv = document.createElement('div');
                panelDiv.className = `panel-glass ${isOperable ? 'operable-glass' : ''}`;
                panelDiv.style.flex = `${ratio} 0 0%`;
                
                const label = document.createElement('div');
                label.className = 'panel-label';
                label.textContent = panel;
                panelDiv.appendChild(label);
                
                panelContainer.appendChild(panelDiv);
              });
            }
            
            // Add mullions if configured (for non-special types)
            if (panelConfig.hasMullion && panels.length > 1 && 
                operationType !== 'single-hung' && operationType !== 'casement' && operationType !== 'sliding') {
              const orientation = panelConfig.orientation || 'horizontal';
              // Insert mullions between panels
              for (let i = panelContainer.children.length - 1; i > 0; i--) {
                const mullion = document.createElement('div');
                mullion.className = `mullion ${orientation === 'vertical' ? 'vertical' : 'horizontal'}`;
                panelContainer.insertBefore(mullion, panelContainer.children[i]);
              }
            }
            
            frame.appendChild(panelContainer);
            container.appendChild(frame);
          } catch (e) {
            // If no config, show simple placeholder
            container.innerHTML = `
              <div class="aluminum-frame" style="display: flex; align-items: center; justify-content: center;">
                <div class="panel-glass" style="width: 100%; height: 100%;">
                  <div class="panel-label" style="font-size: 10px;">Window</div>
                </div>
              </div>
            `;
          }
        });
      }
      
      // Initialize previews on load
      renderWindowPreviews();
      
      // Open quote preview in popup window
      window.openQuotePreview = function(projectId) {
        const width = 1000;
        const height = 700;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;
        window.open(
          `/projects/${projectId}/quote-preview`,
          'QuotePreview',
          `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes,toolbar=no,menubar=no,location=no`
        );
      };
    });
    
    // Unit conversion functions (global scope)
    function inchesToMm(inches) {
      return inches * 25.4;
    }
    
    function mmToInches(mm) {
      return mm / 25.4;
    }
    
    // Update dimensions based on global unit preference
    function updateDimensionsFromGlobal() {
      const unit = window.globalPreferences?.unit || 'inches';
      const mobileUnit = document.getElementById('mobileDimensionsUnit');
      
      if (mobileUnit) {
        mobileUnit.textContent = unit === 'inches' ? '(in)' : '(mm)';
      }
      
      // Update all dimension displays
      document.querySelectorAll('.dimension-display').forEach(display => {
        const widthInches = parseFloat(display.dataset.widthInches);
        const heightInches = parseFloat(display.dataset.heightInches);
        const isMobile = display.dataset.mobile === 'true';
        
        if (isNaN(widthInches) || isNaN(heightInches)) return;
        
        if (isMobile) {
          // Mobile format: "X × Y unit"
          if (unit === 'inches') {
            display.innerHTML = `${widthInches.toFixed(2)} × ${heightInches.toFixed(2)} <span class="dimension-unit">in</span>`;
          } else {
            const widthMm = inchesToMm(widthInches);
            const heightMm = inchesToMm(heightInches);
            display.innerHTML = `${Math.round(widthMm)} × ${Math.round(heightMm)} <span class="dimension-unit">mm</span>`;
          }
        } else {
          // Desktop format: <span>Width: ... <span class="dimension-unit">in</span></span> | <span>Height: ... <span class="dimension-unit">in</span></span>
          const allSpans = Array.from(display.children);
          let widthSpan = null;
          let heightSpan = null;
          
          // Find spans that contain "Width:" or "Height:" text
          allSpans.forEach(span => {
            if (span.textContent && span.textContent.trim().startsWith('Width:')) {
              widthSpan = span;
            } else if (span.textContent && span.textContent.trim().startsWith('Height:')) {
              heightSpan = span;
            }
          });
          
          if (unit === 'inches') {
            if (widthSpan) {
              widthSpan.innerHTML = `Width: ${widthInches.toFixed(2)} <span class="dimension-unit">in</span>`;
            }
            if (heightSpan) {
              heightSpan.innerHTML = `Height: ${heightInches.toFixed(2)} <span class="dimension-unit">in</span>`;
            }
          } else {
            const widthMm = inchesToMm(widthInches);
            const heightMm = inchesToMm(heightInches);
            if (widthSpan) {
              widthSpan.innerHTML = `Width: ${Math.round(widthMm)} <span class="dimension-unit">mm</span>`;
            }
            if (heightSpan) {
              heightSpan.innerHTML = `Height: ${Math.round(heightMm)} <span class="dimension-unit">mm</span>`;
            }
          }
        }
      });
    }
    
    // Initialize and listen to global preference changes
    document.addEventListener('DOMContentLoaded', () => {
      // Wait for global preferences to be available
      function initializePrices() {
        if (window.globalPreferences) {
          currentCurrency = window.globalPreferences.currency || 'COP';
          updateAllPrices();
        } else {
          // Wait a bit and try again
          setTimeout(initializePrices, 100);
        }
      }
      
      // Initialize from global preferences
      initializePrices();
      updateDimensionsFromGlobal();
      
      // Listen to global preference changes
      window.addEventListener('currencyChanged', (event) => {
        currentCurrency = event.detail.currency;
        updateAllPrices();
      });
      
      window.addEventListener('unitChanged', (event) => {
        updateDimensionsFromGlobal();
      });
    });
  </script>
</body>
</html>
