<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configure Window: <%= windowRef %> - <%= project.projectName %></title>
  <%- include('../partials/_head.ejs') %>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/dashboard.css">
  <style>
    .component-card {
      transition: all 0.2s ease;
    }
    .component-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    /* Unit Toggle Styling */
    .unit-toggle {
      color: #6b7280;
      background-color: transparent;
    }
    .unit-toggle.active {
      color: #ffffff;
      background-color: #3b82f6;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    .unit-toggle:hover:not(.active) {
      color: #374151;
      background-color: #e5e7eb;
    }
    
    /* Window Preview Styles */
    #windowPreview {
      position: relative;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border: 3px solid #475569;
      border-radius: 8px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    .preset-btn {
      transition: all 0.2s ease;
    }
    
    .preset-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .preset-btn:active {
      transform: translateY(0);
    }
    
    /* Dimension label styles */
    #widthLabel, #heightLabel {
      font-weight: 500;
      z-index: 10;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      #windowPreview {
        max-width: 200px;
        max-height: 150px;
      }
    }
    
    /* Enhanced Window Preview Styles */
    .panel-glass {
      position: relative;
      overflow: hidden;
    }
    
    .glass-effect {
      background: linear-gradient(180deg, 
        rgba(191,219,254,0.8) 0%, 
        rgba(147,197,253,0.6) 50%, 
        rgba(191,219,254,0.7) 100%);
    }
    
    .glass-effect::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, 
        rgba(96,165,250,0.25) 0%, 
        rgba(147,197,253,0.15) 30%, 
        transparent 60%);
      pointer-events: none;
    }
    
    .glass-effect::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, 
        rgba(255,255,255,0.5) 0%, 
        rgba(255,255,255,0.2) 20%, 
        transparent 40%);
      pointer-events: none;
    }
    
    .fixed-glass .glass-effect {
      box-shadow: inset 0 0 20px rgba(30,64,175,0.1);
    }
    
    .operable-glass .glass-effect {
      box-shadow: inset 0 0 20px rgba(30,64,175,0.1);
    }
    
    .aluminum-mullion {
      background: linear-gradient(90deg, #606060 0%, #808080 30%, #909090 50%, #808080 70%, #606060 100%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.3), inset 0 -1px 0 rgba(0,0,0,0.2);
    }
    
    .aluminum-frame {
      background: linear-gradient(145deg, #707070 0%, #585858 20%, #484848 50%, #585858 80%, #707070 100%);
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col" 
      data-cost-settings="<%= typeof costSettings !== 'undefined' ? JSON.stringify(costSettings) : '{}' %>"
      data-exchange-rate="<%= typeof exchangeRate !== 'undefined' && exchangeRate ? exchangeRate : 4000 %>"
      data-panel-configuration="<%= typeof selectedWindowSystem !== 'undefined' && selectedWindowSystem.panelConfiguration ? JSON.stringify(selectedWindowSystem.panelConfiguration) : '{}' %>"
      data-window-system="<%= typeof selectedWindowSystem !== 'undefined' ? JSON.stringify({
        profiles: selectedWindowSystem.profiles.map(p => ({
          profileId: p.profile ? p.profile._id.toString() : null,
          profileName: p.profile ? p.profile.name : null,
          pricePerMeter: p.profile ? p.profile.pricePerMeter : 0,
          currency: p.profile ? (p.profile.currency || 'USD') : 'USD',
          quantity: p.quantity || 1,
          quantityEquation: p.quantityEquation || null,
          orientation: p.orientation || 'horizontal',
          lengthDiscount: p.lengthDiscount || 0,
          lengthEquation: p.lengthEquation || null,
          showToUser: p.showToUser || false
        })),
        accessories: selectedWindowSystem.accessories.map(a => ({
          accessoryId: a.accessory ? a.accessory._id.toString() : null,
          accessoryName: a.accessory ? a.accessory.name : null,
          price: a.accessory ? a.accessory.price : 0,
          currency: a.accessory ? (a.accessory.currency || 'USD') : 'USD',
          unit: a.unit || 'piece',
          quantity: a.quantity || 1,
          showToUser: a.showToUser || false
        })),
        glassWidthEquation: selectedWindowSystem.glassWidthEquation || null,
        glassHeightEquation: selectedWindowSystem.glassHeightEquation || null
      }) : '{}' %>"
      data-is-edit="<%= typeof isEdit !== 'undefined' && isEdit ? 'true' : 'false' %>">
  <%- include('../partials/_header.ejs') %>

  <main role="main" class="container mx-auto mt-6 px-4 flex-grow mb-16">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
      <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center">
        <div class="flex-1">
          <div class="flex items-center space-x-2 mb-2">
            <a href="/projects/<%= project._id %>" class="text-gray-500 hover:text-gray-700 mr-2" title="Back to Project">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
              </svg>
            </a>
            <div class="flex justify-between items-center">
              <h2 class="text-2xl font-bold text-gray-800"><%= (typeof isEdit !== 'undefined' && isEdit) ? 'Edit' : 'Configure' %> Window: <span class="text-blue-600"><%= windowRef %></span></h2>
            </div>
            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full"><%= selectedWindowSystem.type %></span>
          </div>
          <p class="text-gray-600">Project: <span class="font-medium"><%= project.projectName %></span></p>
          <p class="text-sm text-gray-500">Client: <%= project.clientName || 'Not specified' %></p>
        </div>
        
        <div class="mt-4 lg:mt-0 flex flex-col gap-2">
          <div class="bg-green-50 rounded-lg px-6 py-4 border border-green-100">
            <div class="text-green-800 text-xl font-bold" id="totalPrice">$0.00</div>
            <div class="text-green-600 text-sm">Estimated Total</div>
          </div>
          <div class="flex gap-2">
            <button type="button" onclick="showCalculationDetails()" class="bg-blue-500 hover:bg-blue-600 text-white text-sm px-4 py-2 rounded-lg transition-colors flex items-center justify-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              Show Calculation Details
            </button>
            <button type="button" onclick="showWorkshopDetails()" class="bg-green-500 hover:bg-green-600 text-white text-sm px-4 py-2 rounded-lg transition-colors flex items-center justify-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
              </svg>
              Workshop
            </button>
          </div>
        </div>
      </div>
    </div>

    <form id="windowConfigForm" action="<%= (typeof isEdit !== 'undefined' && isEdit && existingWindow) ? `/projects/${project._id}/windows/${existingWindow._id}/update` : `/projects/${project._id}/windows/save` %>" method="POST" class="space-y-6" data-project-id="<%= project._id %>" data-current-window-id="<%= (typeof isEdit !== 'undefined' && isEdit && existingWindow) ? existingWindow._id : '' %>">
      <input type="hidden" name="windowSystemId" value="<%= selectedWindowSystem._id %>">
      <input type="hidden" id="currentUnit" name="currentUnit" value="inches">
      
      <!-- Window Reference/Item Name Field -->
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6 w-full">
        <label for="windowRef" class="block text-sm font-semibold text-gray-700 mb-2">
          Window Reference / Item Name <span class="text-red-500">*</span>
        </label>
        <input type="text" id="windowRef" name="windowRef" required 
               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
               placeholder="e.g., V1, W1, D1" 
               maxlength="50"
               value="<%= windowRef %>">
        <p class="text-xs text-gray-500 mt-1.5">Enter a unique reference name for this window item</p>
        <div id="nameError" class="text-xs text-red-600 mt-1.5 hidden"></div>
        <div id="nameSuccess" class="text-xs text-green-600 mt-1.5 hidden">✓ Name is available</div>
      </div>
      
      <!-- Edit Mode Notice -->
      <% if (typeof isEdit !== 'undefined' && isEdit) { %>
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
          <div class="flex items-start">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-600 mt-0.5 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.962-.833-2.732 0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z" />
            </svg>
            <div class="text-sm text-yellow-800">
              <p class="font-medium mb-1">Edit Mode:</p>
              <p>Basic dimensions and glass type are pre-filled. For detailed component configurations (profiles, accessories), please review and adjust the default settings as needed. The pricing will update automatically as you make changes.</p>
            </div>
          </div>
        </div>
      <% } %>

      <!-- Basic Specifications -->
      <div class="bg-white rounded-lg shadow-sm p-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Window Specifications</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Left Column: Dimensions -->
          <div>
            <div class="flex justify-between items-center mb-4">
              <h4 class="text-lg font-medium text-gray-700">Dimensions & Quantity</h4>
              
              <!-- Unit Toggle Switch -->
              <div class="flex items-center space-x-3">
                <span class="text-sm text-gray-600">Current Unit: <span id="currentUnitDisplay" class="font-semibold">in</span></span>
              </div>
            </div>
            
            <div class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label for="width" class="form-label">Width (<span id="widthUnit">in</span>) *</label>
                  <input type="number" id="width" name="width" step="0.01" min="0" required 
                         class="form-input w-full" placeholder="0.00" 
                         value="<%= (typeof isEdit !== 'undefined' && isEdit && existingWindow) ? existingWindow.width : '' %>"
                         onchange="if(typeof window.calculatePricing==='function')window.calculatePricing(); updateWindowPreview()">
                </div>
                <div>
                  <label for="height" class="form-label">Height (<span id="heightUnit">in</span>) *</label>
                  <input type="number" id="height" name="height" step="0.01" min="0" required 
                         class="form-input w-full" placeholder="0.00" 
                         value="<%= (typeof isEdit !== 'undefined' && isEdit && existingWindow) ? existingWindow.height : '' %>"
                         onchange="if(typeof window.calculatePricing==='function')window.calculatePricing(); updateWindowPreview()">
                </div>
              </div>
              
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label for="quantity" class="form-label">Quantity *</label>
                  <input type="number" id="quantity" name="quantity" min="1" 
                         value="<%= (typeof isEdit !== 'undefined' && isEdit && existingWindow) ? existingWindow.quantity : '1' %>" required 
                         class="form-input w-full" onchange="if(typeof window.calculatePricing==='function')window.calculatePricing()">
                </div>
                <div>
                  <!-- Missile Type Selection (if window system supports missile types AND has glass) - Must be selected first -->
                  <% 
                    // Check if system has glass configuration (glass equations defined)
                    const systemHasGlassConfig = (selectedWindowSystem.glassWidthEquation && selectedWindowSystem.glassWidthEquation.trim()) || 
                                                 (selectedWindowSystem.glassHeightEquation && selectedWindowSystem.glassHeightEquation.trim());
                    
                    // Show missile type selection if the window system supports LMI or SMI AND has glass
                    // We check supportsLMI/supportsSMI flags, and optionally if glasses are configured
                    const hasMissileTypes = systemHasGlassConfig && 
                                           selectedWindowSystem.missileImpactConfiguration && 
                                           (selectedWindowSystem.missileImpactConfiguration.supportsLMI || 
                                            selectedWindowSystem.missileImpactConfiguration.supportsSMI);
                    
                    // In edit mode, try to determine the missile type from the selected glass
                    // Use passed template variables if available, otherwise extract from description
                    // Initialize with passed values or empty strings
                    // Use intermediate variables to avoid conflicts - access template vars via eval to avoid temporal dead zone
                    let editModeMissileType = '';
                    let editModeGlassId = '';
                    
                    // Check if template variables were passed from the route using eval to avoid TDZ
                    try {
                      const templateMissile = eval('preSelectedMissileType');
                      const templateGlass = eval('preSelectedGlassId');
                      if (templateMissile) editModeMissileType = templateMissile;
                      if (templateGlass) editModeGlassId = templateGlass;
                    } catch(e) {
                      // Template variables not passed - will extract from description if needed
                    }
                    
                    // Only try to extract from description if we don't already have the glass ID from the route
                    if (!editModeGlassId && hasMissileTypes && typeof isEdit !== 'undefined' && isEdit && existingWindow && existingWindow.description) {
                        // First, try to extract missile type from description
                        const missilePatterns = [
                          /Missile Impact:\s*Large Missile Impact \(LMI\)/i,  // "Missile Impact: Large Missile Impact (LMI)"
                          /Missile Impact:\s*Small Missile Impact \(SMI\)/i,  // "Missile Impact: Small Missile Impact (SMI)"
                          /Missile Impact:\s*LMI/i,                            // "Missile Impact: LMI"
                          /Missile Impact:\s*SMI/i,                            // "Missile Impact: SMI"
                        ];
                        
                        for (const pattern of missilePatterns) {
                          if (pattern.test(existingWindow.description)) {
                            if (pattern.source.includes('LMI') || pattern.source.includes('Large')) {
                              editModeMissileType = 'LMI';
                            } else if (pattern.source.includes('SMI') || pattern.source.includes('Small')) {
                              editModeMissileType = 'SMI';
                            }
                            break;
                          }
                        }
                        
                        // Try to extract glass type from description - multiple patterns
                        let glassTypeFromDesc = '';
                        const patterns = [
                          /Glass Type:\s*([^-]+?)(?:\s*-|$)/,  // "Glass Type: TYPE - description"
                          /Glass Type:\s*([^\n]+)/,             // "Glass Type: TYPE\n"
                          /Glass:\s*([^-]+?)(?:\s*-|$)/,       // "Glass: TYPE - description"
                        ];
                        
                        for (const pattern of patterns) {
                          const match = existingWindow.description.match(pattern);
                          if (match) {
                            glassTypeFromDesc = match[1].trim();
                            break;
                          }
                        }
                        
                        if (glassTypeFromDesc) {
                          // Find the glass in allGlasses - try exact match first, then partial
                          let selectedGlassObj = allGlasses.find(g => g.glass_type === glassTypeFromDesc);
                          if (!selectedGlassObj) {
                            // Try partial match
                            selectedGlassObj = allGlasses.find(g => glassTypeFromDesc.includes(g.glass_type) || g.glass_type.includes(glassTypeFromDesc));
                          }
                          
                          if (selectedGlassObj) {
                            editModeGlassId = selectedGlassObj._id.toString();
                            const glassIdStr = selectedGlassObj._id.toString();
                            
                            // Check if this glass is in LMI or SMI arrays
                            const isLMI = selectedWindowSystem.missileImpactConfiguration && 
                                         selectedWindowSystem.missileImpactConfiguration.lmiGlasses &&
                                         selectedWindowSystem.missileImpactConfiguration.lmiGlasses.some(g => {
                                           const gId = (g && g._id) ? g._id.toString() : g.toString();
                                           return gId === glassIdStr;
                                         });
                            const isSMI = selectedWindowSystem.missileImpactConfiguration && 
                                         selectedWindowSystem.missileImpactConfiguration.smiGlasses &&
                                         selectedWindowSystem.missileImpactConfiguration.smiGlasses.some(g => {
                                           const gId = (g && g._id) ? g._id.toString() : g.toString();
                                           return gId === glassIdStr;
                                         });
                            
                            if (isLMI && !isSMI) {
                              editModeMissileType = 'LMI';
                            } else if (isSMI && !isLMI) {
                              editModeMissileType = 'SMI';
                            } else if (isLMI && isSMI) {
                              // Glass is in both - check description for missile type hint
                              if (existingWindow.description.includes('LMI') || existingWindow.description.includes('Large Missile')) {
                                editModeMissileType = 'LMI';
                              } else if (existingWindow.description.includes('SMI') || existingWindow.description.includes('Small Missile')) {
                                editModeMissileType = 'SMI';
                              }
                            }
                          }
                        }
                    }
                    
                    // Set final variables for use in the rest of the template
                    // These are safe to declare as const because template variable access was isolated in IIFE above
                    const preSelectedMissileType = editModeMissileType;
                    const preSelectedGlassId = editModeGlassId;
                  %>
                  <% if (hasMissileTypes) { %>
                    <label for="missileType" class="form-label">Missile Impact Type *</label>
                    <select id="missileType" name="missileType" required class="form-input w-full" onchange="filterGlassesByMissileType()">
                      <option value="">Select Missile Type First</option>
                      <% if (selectedWindowSystem.missileImpactConfiguration && selectedWindowSystem.missileImpactConfiguration.supportsLMI) { %>
                        <option value="LMI" <%= preSelectedMissileType === 'LMI' ? 'selected' : '' %>>Large Missile Impact (LMI)</option>
                      <% } %>
                      <% if (selectedWindowSystem.missileImpactConfiguration && selectedWindowSystem.missileImpactConfiguration.supportsSMI) { %>
                        <option value="SMI" <%= preSelectedMissileType === 'SMI' ? 'selected' : '' %>>Small Missile Impact (SMI)</option>
                      <% } %>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Select missile type to see available glasses</p>
                  <% } else { %>
                    <!-- Placeholder to maintain grid layout when no missile types or no glass -->
                    <div></div>
                  <% } %>
                </div>
              </div>
              
              <!-- Glass Type Selection - Below Missile Type (only if system has glass configuration) -->
              <%
                // Check if system has glass configuration (glass equations defined)
                const systemHasGlass = (selectedWindowSystem.glassWidthEquation && selectedWindowSystem.glassWidthEquation.trim()) || 
                                       (selectedWindowSystem.glassHeightEquation && selectedWindowSystem.glassHeightEquation.trim());
              %>
              <% if (systemHasGlass) { %>
              <div class="mt-4" id="glassTypeSection">
                <label for="glassType" class="form-label">Glass Type *</label>
                <%
                  // Determine if glass should be disabled
                  const glassDisabled = hasMissileTypes && !preSelectedMissileType;
                %>
                <select id="glassType" name="glassType" required class="form-input w-full" onchange="if(typeof window.calculatePricing==='function')window.calculatePricing()"
                        <%= glassDisabled ? 'disabled' : '' %>
                        <% if (typeof preSelectedGlassId !== 'undefined' && preSelectedGlassId) { %>data-pre-selected-glass-id="<%= preSelectedGlassId %>"<% } %>>
                  <option value="">
                    <%= glassDisabled 
                        ? 'Please select missile type first' 
                        : 'Select Glass Type' %>
                  </option>
                  <% allGlasses.forEach(glass => { %>
                    <% 
                      let isSelected = false;
                      if ((typeof isEdit !== 'undefined' && isEdit) && existingWindow) {
                        // Use pre-selected glass ID if available, otherwise try to match from description
                        if (preSelectedGlassId && glass._id.toString() === preSelectedGlassId) {
                          isSelected = true;
                        } else if (existingWindow.description) {
                          // Fallback: try to match glass type from description
                          isSelected = existingWindow.description.includes(glass.glass_type);
                        }
                      }
                      // Add data attributes for missile type filtering
                      const glassIdStr = glass._id.toString();
                      const isLMI = selectedWindowSystem.missileImpactConfiguration && 
                                   selectedWindowSystem.missileImpactConfiguration.lmiGlasses &&
                                   selectedWindowSystem.missileImpactConfiguration.lmiGlasses.some(g => g && g._id && g._id.toString() === glassIdStr);
                      const isSMI = selectedWindowSystem.missileImpactConfiguration && 
                                   selectedWindowSystem.missileImpactConfiguration.smiGlasses &&
                                   selectedWindowSystem.missileImpactConfiguration.smiGlasses.some(g => g && g._id && g._id.toString() === glassIdStr);
                    %>
                    <option value="<%= glass._id %>" 
                            data-price="<%= glass.pricePerSquareMeter %>" 
                            data-type="<%= glass.glass_type %>"
                            data-lmi="<%= isLMI ? 'true' : 'false' %>"
                            data-smi="<%= isSMI ? 'true' : 'false' %>"
                            <%= isSelected ? 'selected' : '' %>>
                      <%= glass.glass_type %> - <%= glass.description %>
                    </option>
                  <% }) %>
                </select>
                <% if (selectedWindowSystem.missileImpactConfiguration && 
                       (selectedWindowSystem.missileImpactConfiguration.supportsLMI || 
                        selectedWindowSystem.missileImpactConfiguration.supportsSMI)) { %>
                  <p class="text-xs text-gray-500 mt-1">Glass options will appear after selecting a missile type</p>
                <% } %>
              </div>
              <% } else { %>
              <!-- No glass for this system - add hidden field to indicate no glass -->
              <input type="hidden" id="glassType" name="glassType" value="">
              <% } %>
              
              <!-- Flange Option (if trimable) -->
              <% if (selectedWindowSystem.flangeConfiguration && selectedWindowSystem.flangeConfiguration.hasFlange && selectedWindowSystem.flangeConfiguration.isTrimable) { %>
                <div class="mt-4">
                  <label class="flex items-center space-x-3 cursor-pointer">
                    <%
                      // Check if flange was included in saved window
                      let includeFlangeChecked = false;
                      if (typeof isEdit !== 'undefined' && isEdit && existingWindow) {
                        includeFlangeChecked = existingWindow.includeFlange === true;
                      }
                    %>
                    <input type="checkbox" id="includeFlange" name="includeFlange" 
                           class="h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                           <%= includeFlangeChecked ? 'checked' : '' %>>
                    <div>
                      <span class="text-sm font-medium text-gray-700">Include Flange</span>
                      <p class="text-xs text-gray-500">Flanged: <%= selectedWindowSystem.flangeConfiguration.flangeSize || 'N/A' %>&quot;</p>
                    </div>
                  </label>
                </div>
              <% } %>
            </div>
          </div>
          
          <!-- Right Column: System Info -->
          <div>
            <h4 class="text-lg font-medium text-gray-700 mb-4">System Information</h4>
            <div class="bg-gray-50 rounded-lg p-4 space-y-3">
              <div class="flex justify-between">
                <span class="text-gray-600">Window System:</span>
                <span class="font-medium"><%= selectedWindowSystem.type %></span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Total Profiles:</span>
                <span class="font-medium"><%= selectedWindowSystem.profiles.length %></span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">User-Configurable:</span>
                <span class="font-medium text-green-600"><%= userConfigurableProfiles.length %> profiles</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Total Accessories:</span>
                <span class="font-medium"><%= selectedWindowSystem.accessories.length %></span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">User-Configurable:</span>
                <span class="font-medium text-green-600"><%= userConfigurableAccessories.length %> accessories</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Glass Restrictions:</span>
                <span class="font-medium"><%= selectedWindowSystem.glassRestrictions ? selectedWindowSystem.glassRestrictions.length : 0 %></span>
              </div>
            </div>
            
            <!-- Glass Restrictions -->
            <% if (selectedWindowSystem.glassRestrictions && selectedWindowSystem.glassRestrictions.length > 0) { %>
              <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <h5 class="text-sm font-medium text-yellow-800 mb-2">Glass Restrictions:</h5>
                <% selectedWindowSystem.glassRestrictions.forEach(restriction => { %>
                  <div class="text-xs text-yellow-700 mb-2">
                    <strong>Type <%= restriction.type %>:</strong> Max <%= restriction.width %>" × <%= restriction.height %>"
                  </div>
                <% }) %>
              </div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Window Visual Preview -->
      <div class="bg-white rounded-lg shadow-sm p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold text-gray-800">Window Visual Preview</h3>
          
          <!-- Unit Toggle for Preview -->
          <div class="flex items-center space-x-2">
            <span class="text-sm text-gray-600">Units: <span id="previewUnitDisplay" class="font-semibold">in</span></span>
          </div>
        </div>
        
        <div class="flex flex-col items-center">
          <div class="relative rounded-lg p-6 min-h-[300px] w-full max-w-lg">
            
            <!-- Dynamic Panel Preview -->
            <div id="dynamicWindowPreview" class="relative mx-auto my-4 transition-all duration-300 ease-in-out flex justify-center items-center" style="width: 320px; height: 240px;">
              <!-- Aluminum Frame -->
              <div class="p-2 rounded-sm shadow-lg aluminum-frame w-full h-full">
                <!-- Glass Area -->
                <div id="panelContainer" class="flex overflow-hidden rounded-sm w-full h-full">
                  <!-- Preview panels will be generated by JavaScript -->
                </div>
              </div>
              
              <!-- Dimension Labels -->
              <div id="widthLabel" class="absolute -bottom-10 left-1/2 transform -translate-x-1/2 text-sm font-medium text-gray-700 bg-white px-3 py-1 rounded-full border shadow-sm whitespace-nowrap">
                <i class="fas fa-arrows-alt-h mr-1 text-blue-500"></i>
                <span id="widthValue">0</span> <span id="widthUnitLabel">in</span>
              </div>
              <div id="heightLabel" class="absolute -right-16 top-1/2 transform -translate-y-1/2 rotate-90 text-sm font-medium text-gray-700 bg-white px-3 py-1 rounded-full border shadow-sm whitespace-nowrap">
                <i class="fas fa-arrows-alt-v mr-1 text-blue-500"></i>
                <span id="heightValue">0</span> <span id="heightUnitLabel">in</span>
              </div>
            </div>
            
            <!-- Panel Ratios Display -->
            <div id="panelRatiosDisplay" class="text-center mt-12 mb-2">
              <span id="ratioLabel" class="text-xs text-gray-500 font-medium"></span>
            </div>
            
            <!-- Window Type Label -->
            <div class="text-center">
              <span class="inline-block bg-indigo-100 text-indigo-800 px-4 py-2 rounded-full text-sm font-medium">
                <i class="fas fa-window-maximize mr-2"></i>
                <%= selectedWindowSystem.type %>
              </span>
              <p class="text-xs text-gray-500 mt-2">
                <% const panelString = (selectedWindowSystem.panelConfiguration?.panels || ['O', 'O']).join(''); %>
                <%= panelString %> Configuration • 
                <%= (selectedWindowSystem.panelConfiguration?.operationType || 'fixed').charAt(0).toUpperCase() + (selectedWindowSystem.panelConfiguration?.operationType || 'fixed').slice(1).replace('-', ' ') %>
              </p>
            </div>
            
            <!-- Legend -->
            <div class="flex justify-center gap-6 mt-4 text-xs">
              <div class="flex items-center">
                <div class="w-4 h-4 rounded mr-2" style="background: linear-gradient(180deg, rgba(191,219,254,0.8) 0%, rgba(147,197,253,0.6) 100%); border: 1px solid rgba(30,64,175,0.3);"></div>
                <span class="text-gray-600">X = Operable</span>
              </div>
              <div class="flex items-center">
                <div class="w-4 h-4 rounded mr-2" style="background: linear-gradient(180deg, rgba(191,219,254,0.8) 0%, rgba(147,197,253,0.6) 100%); border: 1px solid rgba(30,64,175,0.3);"></div>
                <span class="text-gray-600">O = Fixed</span>
              </div>
            </div>
          </div>
          
          <!-- Dimensions and Calculations -->
          <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4 w-full max-w-md">
            <div class="bg-gray-50 rounded-lg p-3 text-center">
              <div class="text-lg font-bold text-gray-800" id="areaDisplay">0.00</div>
              <div class="text-xs text-gray-600">Area (<span id="areaUnitLabel">sq ft</span>)</div>
            </div>
            <div class="bg-gray-50 rounded-lg p-3 text-center">
              <div class="text-lg font-bold text-gray-800" id="perimeterDisplay">0.00</div>
              <div class="text-xs text-gray-600">Perimeter (<span id="perimeterUnitLabel">ft</span>)</div>
            </div>
            <div class="bg-gray-50 rounded-lg p-3 text-center">
              <div class="text-lg font-bold text-gray-800" id="aspectRatioDisplay">0.00</div>
              <div class="text-xs text-gray-600">Aspect Ratio</div>
            </div>
            <div class="bg-gray-50 rounded-lg p-3 text-center">
              <div class="text-lg font-bold text-gray-800" id="glassAreaDisplay">0.00</div>
              <div class="text-xs text-gray-600">Glass Area (<span id="glassAreaUnitLabel">sq ft</span>)</div>
            </div>
          </div>
          
          <!-- Quick Size Presets -->
          <div class="mt-4">
            <h5 class="text-sm font-medium text-gray-700 mb-2">Quick Size Presets:</h5>
            <div class="flex flex-wrap gap-2">
              <button type="button" class="preset-btn bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded text-sm" onclick="setPresetSize(36, 60)">36" × 60"</button>
              <button type="button" class="preset-btn bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded text-sm" onclick="setPresetSize(48, 72)">48" × 72"</button>
              <button type="button" class="preset-btn bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded text-sm" onclick="setPresetSize(60, 84)">60" × 84"</button>
              <button type="button" class="preset-btn bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded text-sm" onclick="setPresetSize(72, 96)">72" × 96"</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Components Configuration -->
      <div class="bg-white rounded-lg shadow-sm p-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Components Configuration</h3>
        
        <!-- Profiles Section -->
        <div class="mb-8">
          <h4 class="text-lg font-medium text-gray-700 mb-4">Profiles (Based on <%= selectedWindowSystem.type %>)</h4>
          
          <div id="profilesContainer" class="space-y-4">
            <% if (userConfigurableProfiles.length > 0) { %>
              <% userConfigurableProfiles.forEach((profileItem, index) => { %>
                <div class="component-card border border-gray-200 rounded-lg p-4">
                  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div>
                      <label class="form-label">Profile</label>
                      <select name="profiles[<%= index %>][profileId]" class="form-input w-full profile-select" onchange="if(typeof window.calculatePricing==='function')window.calculatePricing()">
                        <% 
                          // Determine which profile should be selected
                          let selectedProfileId = null;
                          if (typeof isEdit !== 'undefined' && isEdit && typeof savedProfileSelections !== 'undefined' && savedProfileSelections && savedProfileSelections[index]) {
                            // Use saved profile selection from existingWindow
                            selectedProfileId = savedProfileSelections[index].profileId;
                          } else if (profileItem.profile && profileItem.profile._id) {
                            // Fallback to default profile from window system
                            selectedProfileId = profileItem.profile._id.toString();
                          }
                        %>
                        <% allProfiles.forEach(profile => { %>
                          <option value="<%= profile._id %>" 
                                  data-price="<%= profile.pricePerMeter %>"
                                  data-currency="<%= profile.currency || 'USD' %>"
                                  data-weight="<%= profile.weight %>"
                                  <%= selectedProfileId && selectedProfileId === profile._id.toString() ? 'selected' : '' %>>
                            <%= profile.name %> - <%= profile.color %>
                          </option>
                        <% }) %>
                      </select>
                    </div>
                    <div>
                      <label class="form-label">Quantity</label>
                      <% 
                        let profileQuantity = 1;
                        if (typeof isEdit !== 'undefined' && isEdit && typeof savedProfileSelections !== 'undefined' && savedProfileSelections && savedProfileSelections[index]) {
                          profileQuantity = savedProfileSelections[index].quantity || 1;
                        } else if (profileItem.quantity) {
                          profileQuantity = profileItem.quantity;
                        }
                      %>
                      <input type="number" name="profiles[<%= index %>][quantity]" 
                             value="<%= profileQuantity %>" 
                             min="1" class="form-input w-full" onchange="if(typeof window.calculatePricing==='function')window.calculatePricing()">
                    </div>
                    <div>
                      <label class="form-label">Orientation</label>
                      <% 
                        let profileOrientation = 'horizontal';
                        if (typeof isEdit !== 'undefined' && isEdit && typeof savedProfileSelections !== 'undefined' && savedProfileSelections && savedProfileSelections[index]) {
                          profileOrientation = savedProfileSelections[index].orientation || 'horizontal';
                        } else if (profileItem.orientation) {
                          profileOrientation = profileItem.orientation;
                        }
                      %>
                      <select name="profiles[<%= index %>][orientation]" class="form-input w-full">
                        <option value="horizontal" <%= profileOrientation === 'horizontal' ? 'selected' : '' %>>Horizontal</option>
                        <option value="vertical" <%= profileOrientation === 'vertical' ? 'selected' : '' %>>Vertical</option>
                      </select>
                    </div>
                    <div>
                      <label class="form-label">Length Discount (in)</label>
                      <% 
                        let profileLengthDiscount = 0;
                        if (typeof isEdit !== 'undefined' && isEdit && typeof savedProfileSelections !== 'undefined' && savedProfileSelections && savedProfileSelections[index]) {
                          profileLengthDiscount = savedProfileSelections[index].lengthDiscount || 0;
                        } else if (profileItem.lengthDiscount !== undefined) {
                          profileLengthDiscount = profileItem.lengthDiscount;
                        }
                      %>
                      <input type="number" name="profiles[<%= index %>][lengthDiscount]" value="<%= profileLengthDiscount %>" 
                             step="0.01" class="form-input w-full" onchange="if(typeof window.calculatePricing==='function')window.calculatePricing()">
                    </div>
                  </div>
                </div>
              <% }) %>
            <% } else { %>
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <p class="text-blue-800 text-sm">
                  <i class="fas fa-info-circle mr-2"></i>
                  All profiles for this window system are automatically configured. No user input required.
                </p>
              </div>
            <% } %>
          </div>
        </div>

        <!-- Accessories Section -->
        <div class="mb-8">
          <h4 class="text-lg font-medium text-gray-700 mb-4">Accessories</h4>
          
          <div id="accessoriesContainer" class="space-y-6">
            <% if (accessoryChoiceGroups.length > 0 || individualAccessories.length > 0) { %>
              
              <!-- Choice Groups (e.g., handles, locks) -->
              <% accessoryChoiceGroups.forEach((group, groupIndex) => { %>
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                  <div class="flex items-center justify-between mb-4">
                    <h5 class="text-lg font-medium text-gray-800 capitalize"><%= group.name %></h5>
                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                      <%= group.selectionType === 'single' ? 'Choose One' : 'Multiple Choice' %>
                    </span>
                  </div>
                  
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <% group.accessories.forEach((accessoryItem, accessoryIndex) => { %>
                      <% const accessory = allAccessories.find(a => a._id.toString() === accessoryItem.accessory._id.toString()) %>
                      <% if (accessory) { %>
                                                 <div class="choice-option border border-gray-300 rounded-lg p-4 hover:border-blue-400 hover:bg-blue-50 transition-colors cursor-pointer" 
                              data-group="<%= group.name %>" 
                              data-selection-type="<%= group.selectionType %>" 
                              data-accessory-id="<%= accessoryItem.accessory._id %>"
                              onclick="selectChoice(this)">
                          <div class="flex items-start justify-between">
                            <!-- Image Section -->
                            <% if (accessory.image && accessory.image.trim() !== '') { %>
                              <div class="flex-shrink-0 mr-4">
                                <img src="/uploads/accessories/<%= accessory.image %>" 
                                     alt="<%= accessory.name %>" 
                                     class="w-16 h-16 object-cover rounded-lg shadow-sm border border-gray-200">
                              </div>
                            <% } %>
                            
                            <div class="flex-1">
                              <div class="flex items-center mb-2">
                                <%
                                  // Check if this accessory was saved in edit mode
                                  let isAccessoryChecked = accessoryItem.isDefault;
                                  if (typeof isEdit !== 'undefined' && isEdit && typeof savedAccessorySelections !== 'undefined' && savedAccessorySelections) {
                                    const accId = accessoryItem.accessory._id.toString();
                                    const savedAcc = savedAccessorySelections[accId];
                                    if (savedAcc && savedAcc.componentGroup === group.name) {
                                      isAccessoryChecked = true;
                                    }
                                  }
                                %>
                                <input type="<%= group.selectionType === 'single' ? 'radio' : 'checkbox' %>" 
                                       name="choiceGroup_<%= group.name %>" 
                                       value="<%= accessoryItem.accessory._id %>"
                                       class="mr-2"
                                       <%= isAccessoryChecked ? 'checked' : '' %>
                                       onchange="handleChoiceGroupChange(this)">
                                <h6 class="font-medium text-gray-800"><%= accessory.name %></h6>
                                <% if (accessoryItem.isDefault) { %>
                                  <span class="ml-2 text-yellow-500">⭐</span>
                                <% } %>
                              </div>
                              <p class="text-sm text-gray-600 mb-2">
                                <% if (accessory.referenceNumber) { %>
                                  <span class="font-medium">Ref:</span> <%= accessory.referenceNumber %><br>
                                <% } %>
                                <% if (accessory.providerName) { %>
                                  <span class="font-medium">Provider:</span> <%= accessory.providerName %><br>
                                <% } %>
                                <%= accessory.description || 'High-quality window accessory' %>
                              </p>
                              <div class="text-sm font-medium text-green-600">
                                $<%= accessory.price.toFixed(2) %>/<%= accessory.unit %>
                              </div>
                            </div>
                          </div>
                          
                          <div class="mt-3 pt-3 border-t border-gray-200">
                            <label class="block text-xs text-gray-600 mb-1">Quantity:</label>
                            <%
                              // Get saved quantity if in edit mode
                              let savedQuantity = 1;
                              if (typeof isEdit !== 'undefined' && isEdit && typeof savedAccessorySelections !== 'undefined' && savedAccessorySelections) {
                                const accId = accessoryItem.accessory._id.toString();
                                const savedAcc = savedAccessorySelections[accId];
                                if (savedAcc && savedAcc.componentGroup === group.name) {
                                  savedQuantity = savedAcc.quantity || 1;
                                }
                              }
                            %>
                            <input type="number" 
                                   name="accessories_choice_<%= group.name %>_<%= accessoryItem.accessory._id %>_quantity" 
                                   value="<%= savedQuantity %>" 
                                   min="1" 
                                   class="form-input w-full text-sm" 
                                   onchange="if(typeof window.calculatePricing==='function')window.calculatePricing()" 
                                   oninput="if(typeof window.calculatePricing==='function')window.calculatePricing()">
                          </div>
                          
                          <!-- Hidden fields to store accessory info -->
                          <input type="hidden" name="accessories_choice_<%= group.name %>_<%= accessoryItem.accessory._id %>_price" value="<%= accessory.price %>">
                          <input type="hidden" name="accessories_choice_<%= group.name %>_<%= accessoryItem.accessory._id %>_unit" value="<%= accessory.unit %>">
                        </div>
                      <% } %>
                    <% }) %>
                  </div>
                </div>
              <% }) %>
              
              <!-- Individual Accessories (quantity-based) -->
              <% if (individualAccessories.length > 0) { %>
                <div class="space-y-4">
                  <h5 class="text-lg font-medium text-gray-700">Additional Accessories</h5>
                  <% individualAccessories.forEach((accessoryItem, index) => { %>
                    <div class="component-card border border-gray-200 rounded-lg p-4">
                      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                          <label class="form-label">Accessory</label>
                          <div class="relative">
                            <select name="accessories[<%= index %>][accessoryId]" class="form-input w-full accessory-select" data-index="<%= index %>" onchange="if(typeof window.calculatePricing==='function')window.calculatePricing(); updateAccessoryInfo(this)">
                              <% allAccessories.forEach(accessory => { %>
                                <option value="<%= accessory._id %>" 
                                        data-price="<%= accessory.price %>"
                                        data-unit="<%= accessory.unit %>"
                                        data-image="<%= accessory.image || '' %>"
                                        data-reference="<%= accessory.referenceNumber || '' %>"
                                        data-provider="<%= accessory.providerName || '' %>"
                                        <%= accessoryItem.accessory && accessoryItem.accessory._id.toString() === accessory._id.toString() ? 'selected' : '' %>>
                                  <%= accessory.name %> - $<%= accessory.price %>/<%= accessory.unit %>
                                  <% if (accessory.referenceNumber) { %> (Ref: <%= accessory.referenceNumber %>)<% } %>
                                </option>
                              <% }) %>
                            </select>
                            
                            <!-- Accessory preview -->
                            <div id="accessoryPreview_<%= index %>" class="mt-2 hidden">
                              <div class="flex items-center space-x-3 p-2 bg-gray-50 rounded-lg">
                                <img id="accessoryImage_<%= index %>" src="" alt="" class="w-12 h-12 object-cover rounded border">
                                <div class="text-sm">
                                  <div id="accessoryDetails_<%= index %>" class="text-gray-600"></div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div>
                          <label class="form-label">Quantity</label>
                          <%
                            // Get saved quantity if in edit mode
                            let savedIndividualQuantity = 1;
                            if (typeof isEdit !== 'undefined' && isEdit && typeof savedAccessorySelections !== 'undefined' && savedAccessorySelections && accessoryItem.accessory) {
                              const accId = accessoryItem.accessory._id.toString();
                              const savedAcc = savedAccessorySelections[accId];
                              if (savedAcc && !savedAcc.componentGroup) {
                                savedIndividualQuantity = savedAcc.quantity || 1;
                              }
                            }
                          %>
                          <input type="number" name="accessories[<%= index %>][quantity]" 
                                 value="<%= savedIndividualQuantity %>" 
                                 min="1" class="form-input w-full" onchange="if(typeof window.calculatePricing==='function')window.calculatePricing()">
                        </div>
                        <div>
                          <label class="form-label">Unit</label>
                          <input type="text" name="accessories[<%= index %>][unit]" value="<%= accessoryItem.unit %>" 
                                 class="form-input w-full bg-gray-100" readonly>
                        </div>
                      </div>
                    </div>
                  <% }) %>
                </div>
              <% } %>
              
            <% } else { %>
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <p class="text-blue-800 text-sm">
                  <i class="fas fa-info-circle mr-2"></i>
                  All accessories for this window system are automatically configured. No user input required.
                </p>
              </div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Muntin Configuration Section -->
      <% if (selectedWindowSystem.muntinConfiguration && selectedWindowSystem.muntinConfiguration.enabled) { %>
        <div class="bg-white rounded-lg shadow-sm p-6">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">Muntin Configuration</h3>
          
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <p class="text-blue-800 text-sm">
              <i class="fas fa-info-circle mr-2"></i>
              Configure ornamental muntins for this window. Muntins are decorative dividers that create multiple panes within a single glass unit.
            </p>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Muntin Type -->
            <div>
              <label class="form-label">Muntin Type</label>
              <%
                let savedMuntinType = selectedWindowSystem.muntinConfiguration.muntinType;
                if (typeof isEdit !== 'undefined' && isEdit && existingWindow && existingWindow.muntinConfiguration && existingWindow.muntinConfiguration.muntinType) {
                  savedMuntinType = existingWindow.muntinConfiguration.muntinType;
                }
              %>
              <select name="muntinType" id="muntinType" class="form-input w-full" onchange="updateMuntinPreview()">
                <option value="colonial" <%= savedMuntinType === 'colonial' ? 'selected' : '' %>>Colonial</option>
                <option value="geometric" <%= savedMuntinType === 'geometric' ? 'selected' : '' %>>Geometric</option>
                <option value="custom" <%= savedMuntinType === 'custom' ? 'selected' : '' %>>Custom</option>
              </select>
            </div>
            
            <!-- Horizontal Divisions -->
            <div>
              <label class="form-label">Horizontal Divisions</label>
              <%
                let savedMuntinHorizontal = selectedWindowSystem.muntinConfiguration.horizontalDivisions;
                if (typeof isEdit !== 'undefined' && isEdit && existingWindow && existingWindow.muntinConfiguration && existingWindow.muntinConfiguration.horizontalDivisions) {
                  savedMuntinHorizontal = existingWindow.muntinConfiguration.horizontalDivisions;
                }
              %>
              <input type="number" name="muntinHorizontal" id="muntinHorizontal" 
                     value="<%= savedMuntinHorizontal %>" 
                     min="1" max="10" class="form-input w-full" onchange="updateMuntinPreview()">
            </div>
            
            <!-- Vertical Divisions -->
            <div>
              <label class="form-label">Vertical Divisions</label>
              <%
                let savedMuntinVertical = selectedWindowSystem.muntinConfiguration.verticalDivisions;
                if (typeof isEdit !== 'undefined' && isEdit && existingWindow && existingWindow.muntinConfiguration && existingWindow.muntinConfiguration.verticalDivisions) {
                  savedMuntinVertical = existingWindow.muntinConfiguration.verticalDivisions;
                }
              %>
              <input type="number" name="muntinVertical" id="muntinVertical" 
                     value="<%= savedMuntinVertical %>" 
                     min="1" max="10" class="form-input w-full" onchange="updateMuntinPreview()">
            </div>
            
            <!-- Spacing -->
            <div>
              <label class="form-label">Spacing (inches)</label>
              <%
                let savedMuntinSpacing = selectedWindowSystem.muntinConfiguration.spacing;
                if (typeof isEdit !== 'undefined' && isEdit && existingWindow && existingWindow.muntinConfiguration && existingWindow.muntinConfiguration.spacing) {
                  savedMuntinSpacing = existingWindow.muntinConfiguration.spacing;
                }
              %>
              <input type="number" name="muntinSpacing" id="muntinSpacing" 
                     value="<%= savedMuntinSpacing %>" 
                     min="0" step="0.1" class="form-input w-full" onchange="updateMuntinPreview()">
            </div>
            
            <!-- Muntin Profile (if available) -->
            <% if (selectedWindowSystem.muntinConfiguration.muntinProfile) { %>
              <div>
                <label class="form-label">Muntin Profile</label>
                <select name="muntinProfile" id="muntinProfile" class="form-input w-full">
                  <% allProfiles.forEach(profile => { %>
                    <% if (profile.isMuntin) { %>
                      <option value="<%= profile._id %>" 
                              data-price="<%= profile.pricePerMeter %>"
                              <%= selectedWindowSystem.muntinConfiguration.muntinProfile && selectedWindowSystem.muntinConfiguration.muntinProfile.toString() === profile._id.toString() ? 'selected' : '' %>>
                        <%= profile.name %> - <%= profile.muntinType.charAt(0).toUpperCase() + profile.muntinType.slice(1) %>
                      </option>
                    <% } %>
                  <% }) %>
                </select>
              </div>
            <% } %>
          </div>
          
          <!-- Muntin Preview -->
          <div class="mt-6 p-4 bg-gray-50 rounded-lg">
            <h4 class="text-sm font-medium text-gray-700 mb-3">Muntin Preview:</h4>
            <div class="flex items-center justify-center">
              <div id="muntinPreviewGrid" class="w-48 h-48 border-2 border-gray-300 bg-blue-50 relative rounded">
                <!-- Preview grid will be generated here -->
              </div>
            </div>
            <p class="text-xs text-gray-500 mt-2 text-center" id="muntinPreviewText">
              <%= selectedWindowSystem.muntinConfiguration.horizontalDivisions %>x<%= selectedWindowSystem.muntinConfiguration.verticalDivisions %> 
              <%= selectedWindowSystem.muntinConfiguration.muntinType.charAt(0).toUpperCase() + selectedWindowSystem.muntinConfiguration.muntinType.slice(1) %> Grid
            </p>
          </div>
        </div>
      <% } %>

      <!-- Pricing Summary -->
      <div class="bg-white rounded-lg shadow-sm p-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Pricing Summary</h3>
        
        <% if (typeof isEdit !== 'undefined' && isEdit && existingWindow) { %>
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
          <div class="text-sm text-yellow-800">
            <p class="font-medium mb-1">Saved Values (from database):</p>
            <div class="grid grid-cols-2 gap-2 text-xs">
              <div>Unit Price: <span class="font-semibold" data-price="<%= existingWindow.unitPrice %>"><!-- Will be formatted --></span></div>
              <div>Total Price: <span class="font-semibold" data-price="<%= existingWindow.totalPrice %>"><!-- Will be formatted --></span></div>
              <div>Quantity: <span class="font-semibold"><%= existingWindow.quantity %></span></div>
            </div>
          </div>
        </div>
        <% } %>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h4 class="text-lg font-medium text-gray-700 mb-4">Cost Breakdown</h4>
            <div class="space-y-3">
              <div class="flex justify-between">
                <span class="text-gray-600">Base Materials:</span>
                <span class="font-medium" id="baseMaterialsCost">$0.00</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Glass Cost:</span>
                <span class="font-medium" id="glassCost">$0.00</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Accessories:</span>
                <span class="font-medium" id="accessoriesCost">$0.00</span>
              </div>
              <div class="flex justify-between" id="muntinCostRow" style="display: none;">
                <span class="text-gray-600">Muntins:</span>
                <span class="font-medium" id="muntinCost">$0.00</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Additional Costs:</span>
                <span class="font-medium" id="additionalCosts">$0.00</span>
              </div>
              <hr class="border-gray-300">
              <div class="flex justify-between">
                <span class="text-gray-600">Unit Price:</span>
                <span class="font-medium" id="unitPriceDisplay">$0.00</span>
              </div>
              <div class="flex justify-between text-lg font-bold">
                <span class="text-gray-800">Total Price:</span>
                <span class="text-green-600" id="finalTotalPrice">$0.00</span>
              </div>
            </div>
          </div>
          
          <div>
            <h4 class="text-lg font-medium text-gray-700 mb-4">Additional Information</h4>
            <div>
              <label for="notes" class="form-label">Notes (Optional)</label>
              <textarea id="notes" name="notes" rows="4" class="form-input w-full" 
                        placeholder="Any special requirements or notes for this window..."><%= 
                          ((typeof isEdit !== 'undefined' && isEdit) && existingWindow) ? 
                          (existingWindow.notes || (() => {
                            // Fallback: try to extract from description if notes field doesn't exist
                            if (existingWindow.description) {
                              const desc = existingWindow.description;
                              const notesMatch = desc.match(/Notes: (.+)$/m);
                              return notesMatch ? notesMatch[1] : '';
                            }
                            return '';
                          })()) : '' 
                        %></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex justify-between items-center">
        <a href="/projects/<%= project._id %>" class="btn-secondary">
          ← Back to Project
        </a>
        
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-medium">
          <%= (typeof isEdit !== 'undefined' && isEdit) ? 'Update Window Configuration' : 'Save Window Configuration' %>
        </button>
      </div>
    </form>
  </main>

  <%- include('../partials/_footer.ejs') %>

  <script>
    // Initialize variables from server data (read from data attributes to avoid EJS syntax in JavaScript)
    const costSettingsElement = document.querySelector('[data-cost-settings]');
    const costSettings = costSettingsElement ? JSON.parse(costSettingsElement.getAttribute('data-cost-settings')) : {};
    
    const exchangeRateElement = document.querySelector('[data-exchange-rate]');
    const exchangeRateValue = exchangeRateElement ? parseFloat(exchangeRateElement.getAttribute('data-exchange-rate')) : 4000;
    
    // Panel configuration from the window system
    const panelConfigElement = document.querySelector('[data-panel-configuration]');
    const panelConfiguration = panelConfigElement ? JSON.parse(panelConfigElement.getAttribute('data-panel-configuration')) : {};
    const panelConfig = panelConfiguration.panels || ['O', 'O'];
    const panelRatios = panelConfiguration.panelRatios || panelConfig.map(() => 1);
    const orientation = panelConfiguration.orientation || 'horizontal';
    const operationType = panelConfiguration.operationType || 'fixed';
    const showLogo = panelConfiguration.showLogo !== false;
    const frenchDoorConfig = panelConfiguration.frenchDoor || null;

    // Store all original glass options
    let allGlassOptions = [];
    
    // Initialize glass options storage when DOM is ready
    function initializeGlassOptions() {
      const glassSelect = document.getElementById('glassType');
      // Only initialize if glassType is a SELECT element (not hidden input)
      if (glassSelect && glassSelect.tagName === 'SELECT' && allGlassOptions.length === 0) {
        // Store all original options (excluding the placeholder)
        allGlassOptions = Array.from(glassSelect.options)
          .filter(opt => opt.value !== '')
          .map(opt => {
            let text = opt.text;
            const type = opt.getAttribute('data-type');
            
            // If text is corrupted (shows price like "$45.00"), reconstruct from data-type
            const textIsPrice = text && /^\$?\d+\.?\d*$/.test(text.trim());
            const textHasFormat = text && text.includes(' - ');
            
            if ((textIsPrice || !textHasFormat) && type) {
              // Text is corrupted - reconstruct from type attribute
              text = type;
            }
            
            return {
              value: opt.value,
              text: text,
              price: opt.getAttribute('data-price'),
              type: type,
              lmi: opt.getAttribute('data-lmi'),
              smi: opt.getAttribute('data-smi'),
              selected: opt.selected
            };
          });
        
        // Fix corrupted option text in the DOM immediately
        allGlassOptions.forEach(optData => {
          const option = glassSelect.querySelector(`option[value="${optData.value}"]`);
          if (option) {
            const currentText = option.textContent.trim();
            const textIsPrice = /^\$?\d+\.?\d*$/.test(currentText);
            // If current text is a price and we have a proper text stored, fix it
            if (textIsPrice && optData.text && !/^\$?\d+\.?\d*$/.test(optData.text.trim())) {
              option.textContent = optData.text;
            }
          }
        });
        
        console.log('Initialized glass options:', allGlassOptions.length);
      }
    }
    
    // Fix glass option text immediately if corrupted (must run before other code)
    function fixGlassOptionTexts() {
      const glassSelect = document.getElementById('glassType');
      // Only run if glassType is a SELECT element (not hidden input)
      if (!glassSelect || glassSelect.tagName !== 'SELECT') return;
      
      // Fix all options that have price as text instead of glass name
      Array.from(glassSelect.options).forEach(option => {
        if (!option.value) return; // Skip placeholder
        
        const currentText = option.textContent.trim();
        const textIsPrice = /^\$?\d+\.?\d*$/.test(currentText);
        const dataType = option.getAttribute('data-type');
        const dataPrice = option.getAttribute('data-price');
        
        // If text is a price and we have a type, fix it immediately
        // Also check if text matches the price value
        if (textIsPrice && dataType) {
          option.textContent = dataType;
          console.log('Fixed glass option text from', currentText, 'to', dataType);
        } else if (dataPrice && currentText === '$' + parseFloat(dataPrice).toFixed(2)) {
          // Text matches the price format exactly
          option.textContent = dataType || 'Glass';
          console.log('Fixed glass option text from price', currentText, 'to', dataType);
        }
      });
    }
    
    // Use MutationObserver to watch for changes to the glass select and fix them
    function setupGlassOptionTextWatcher() {
      const glassSelect = document.getElementById('glassType');
      // Only run if glassType is a SELECT element (not hidden input)
      if (!glassSelect || glassSelect.tagName !== 'SELECT') return;
      
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'childList' || mutation.type === 'characterData') {
            // Options changed, fix any corrupted text
            fixGlassOptionTexts();
          }
        });
      });
      
      observer.observe(glassSelect, {
        childList: true,
        subtree: true,
        characterData: true
      });
      
      // Also fix immediately
      setTimeout(fixGlassOptionTexts, 0);
      setTimeout(fixGlassOptionTexts, 100);
      setTimeout(fixGlassOptionTexts, 500);
    }
    
    // Run fix immediately
    fixGlassOptionTexts();
    
    // Run initialization when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        fixGlassOptionTexts(); // Fix again after DOM is fully loaded
        initializeGlassOptions();
        setupGlassOptionTextWatcher(); // Watch for changes
        // If in edit mode and missile type is pre-selected, filter glasses automatically
        setTimeout(function() {
          handleEditModeMissileType();
          fixGlassOptionTexts(); // Fix after filtering
        }, 100);
      });
    } else {
      // DOM is already ready
      fixGlassOptionTexts(); // Fix again to be sure
      initializeGlassOptions();
      setupGlassOptionTextWatcher(); // Watch for changes
      // If in edit mode and missile type is pre-selected, filter glasses automatically
      setTimeout(function() {
        handleEditModeMissileType();
        fixGlassOptionTexts(); // Fix after filtering
      }, 100);
    }
    
    // Handle edit mode: if missile type is pre-selected, filter glasses
    function handleEditModeMissileType() {
      const missileTypeSelect = document.getElementById('missileType');
      const glassSelect = document.getElementById('glassType');
      
      // Only run if both elements exist and glassType is a SELECT (not hidden input)
      if (!missileTypeSelect || !glassSelect || glassSelect.tagName !== 'SELECT') return;
      
      // Get pre-selected glass ID from data attribute (passed from server)
      const preSelectedGlassId = glassSelect.getAttribute('data-pre-selected-glass-id');
      
      // Check if a missile type option is selected (has selected attribute or value)
      const hasSelectedValue = missileTypeSelect.value && missileTypeSelect.value !== '';
      
      if (hasSelectedValue) {
        // Missile type is already selected (edit mode), filter glasses
        // Store the currently selected glass before filtering, prefer preSelectedGlassId from server
        const currentSelectedValue = preSelectedGlassId || glassSelect.value;
        
        // Filter glasses based on pre-selected missile type
        filterGlassesByMissileType(currentSelectedValue);
        
        // After filtering, restore the selection if it exists
        setTimeout(() => {
          if (currentSelectedValue) {
            const option = glassSelect.querySelector(`option[value="${currentSelectedValue}"]`);
            if (option) {
              glassSelect.value = currentSelectedValue;
              if(typeof window.calculatePricing==='function')window.calculatePricing(); // Recalculate with restored selection
            }
          }
        }, 100);
      }
    }
    
    // Filter glasses based on selected missile type
    function filterGlassesByMissileType(preSelectedGlassIdValue) {
      const missileTypeSelect = document.getElementById('missileType');
      const missileType = missileTypeSelect?.value;
      const glassSelect = document.getElementById('glassType');
      
      // Only run if glassType is a SELECT element (not hidden input)
      if (!glassSelect || glassSelect.tagName !== 'SELECT') return;
      
      // Get pre-selected glass ID from data attribute or parameter
      const preSelectedGlassId = preSelectedGlassIdValue || glassSelect.getAttribute('data-pre-selected-glass-id');
      
      // Check if missile type selection is required (window system supports missile types)
      const missileTypeRequired = missileTypeSelect !== null;
      
      if (missileTypeRequired) {
        // Store the currently selected glass value before filtering (for edit mode)
        // Prefer preSelectedGlassId from server, then fall back to current value
        const currentSelectedGlass = preSelectedGlassId || glassSelect.value;
        
        // Enable/disable glass select based on missile type selection
        if (!missileType) {
          glassSelect.disabled = true;
          glassSelect.innerHTML = '<option value="">Please select missile type first</option>';
          if(typeof window.calculatePricing==='function')window.calculatePricing(); // Recalculate with no glass
          return;
        }
        
        // Enable the glass select
        glassSelect.disabled = false;
        
        // Clear current options
        glassSelect.innerHTML = '<option value="">Select Glass Type</option>';
        
        // Ensure we have stored options
        if (allGlassOptions.length === 0) {
          initializeGlassOptions();
        }
        
        // If still no options, try to get from current DOM as fallback
        if (allGlassOptions.length === 0) {
          // Try to reconstruct from any remaining options in the DOM
          const remainingOptions = document.querySelectorAll('#glassType option[data-lmi]');
          if (remainingOptions.length > 0) {
            allGlassOptions = Array.from(remainingOptions).map(opt => ({
              value: opt.value,
              text: opt.text,
              price: opt.getAttribute('data-price'),
              type: opt.getAttribute('data-type'),
              lmi: opt.getAttribute('data-lmi'),
              smi: opt.getAttribute('data-smi')
            }));
          }
        }
        
        // Filter and add options based on missile type
        allGlassOptions.forEach(optionData => {
          if (!optionData.value) return; // Skip placeholder
          
          // Check if this glass is available for the selected missile type
          const isAvailable = optionData[missileType.toLowerCase()] === 'true';
          if (isAvailable) {
            const newOption = document.createElement('option');
            newOption.value = optionData.value;
            
            // Preserve the original text format (glass_type - description)
            // If text is corrupted (shows price like "$45.00") or missing, reconstruct from data-type attribute
            const textIsPrice = optionData.text && /^\$?\d+\.?\d*$/.test(optionData.text.trim());
            const textHasFormat = optionData.text && optionData.text.includes(' - ');
            
            if (textHasFormat && !textIsPrice) {
              // Text is in correct format (glass_type - description), use it
              newOption.textContent = optionData.text;
            } else if (optionData.type) {
              // Text is corrupted or missing - reconstruct from type
              // We lose the description, but at least show the glass type name
              newOption.textContent = optionData.type;
            } else {
              // Fallback to text if type is not available
              newOption.textContent = optionData.text || 'Glass';
            }
            
            newOption.setAttribute('data-price', optionData.price || '0');
            newOption.setAttribute('data-type', optionData.type || '');
            newOption.setAttribute('data-lmi', optionData.lmi || 'false');
            newOption.setAttribute('data-smi', optionData.smi || 'false');
            
            // Restore selection if this was the previously selected glass (edit mode)
            // Check both currentSelectedGlass and preSelectedGlassId with proper string comparison
            const optionValueStr = optionData.value.toString();
            const selectedValueStr = currentSelectedGlass ? currentSelectedGlass.toString() : '';
            
            const shouldSelect = selectedValueStr && (
              optionValueStr === selectedValueStr ||
              optionValueStr === currentSelectedGlass ||
              (preSelectedGlassId && optionValueStr === preSelectedGlassId.toString())
            );
            
            if (shouldSelect) {
              newOption.selected = true;
            }
            
            glassSelect.appendChild(newOption);
          }
        });
      } else {
        // No missile type required - glass select should already be enabled and populated
        // Just ensure it's enabled
        glassSelect.disabled = false;
      }
      
      // Recalculate pricing
      calculatePricing();
    }
    
    // Currency conversion functions
    // ALL INTERNAL CALCULATIONS MUST BE IN USD
    function convertToUSD(price, currency, exchangeRate) {
      if (currency === 'USD') return price;
      if (currency === 'COP') return price / exchangeRate;
      return price; // fallback
    }
    
    function convertToCOP(price, currency, exchangeRate) {
      if (currency === 'COP') return price;
      if (currency === 'USD') return price * exchangeRate;
      return price; // fallback
    }

    // Helper function to evaluate profile length equation safely (result in inches)
    function evaluateLengthEquation(equation, width, height, inputUnit = 'inches') {
      if (!equation || typeof equation !== 'string') {
        console.warn('evaluateLengthEquation: Invalid equation input', equation);
        return null;
      }
      
      try {
        // Calculate derived values (width and height are already in inches at this point)
        const perimeter = 2 * (width + height);
        const area = width * height;
        
        // Replace variable names with actual values (safe string replacement)
        // Normalize the equation: remove extra spaces, but preserve structure
        let expression = equation.trim().replace(/\s+/g, ' '); // Replace multiple spaces with single space
        
        // If input was in mm, numeric constants in the equation are likely also in mm
        // We need to convert them to inches to match the width/height units
        // This is a heuristic: if we see numbers that look like they could be mm (e.g., 38, 76, etc.)
        // and the input unit is mm, we should convert them
        // However, this is complex to detect automatically, so we'll use a simpler approach:
        // The equation should be written assuming the input values are in the same units as the constants
        // Since we always convert to inches, numeric constants should be in inches too
        // BUT: if the user wrote the equation thinking in mm, we need to handle that
        
        // Numeric constants in equations are always assumed to be in mm (standard unit for window manufacturing)
        // We need to convert them to inches to match the width/height units (which are already in inches)
        // This applies regardless of the input unit, because equations are written with mm constants
        // However, we need to be smart: only convert standalone numbers or numbers in arithmetic expressions
        // For example: "height-(38*2)" should become "height-((38/25.4)*2)" = "height-(1.496*2)"
        // NOT "height-(1.496*0.07874)" which would be wrong (2 is a multiplier, not a measurement)
        // Always convert numeric constants from mm to inches
        {
          // Strategy: Find all numeric expressions (numbers and their arithmetic operations)
          // and wrap them in parentheses with division by 25.4
          // But we need to avoid converting numbers that are part of variable names
          
          // First, protect variable names by temporarily replacing them
          const variableNames = ['width', 'height', 'perimeter', 'area'];
          const placeholders = {};
          variableNames.forEach((varName, index) => {
            const placeholder = `__VAR${index}__`;
            placeholders[placeholder] = varName;
            // Use word boundaries to match whole variable names only
            expression = expression.replace(new RegExp(`\\b${varName}\\b`, 'gi'), placeholder);
          });
          
          // Now convert numeric constants, but NOT multipliers in multiplication/division
          // Strategy: Only convert numbers that are:
          // - Standalone (not part of * or / operations as the second operand)
          // - The first operand in * or / (the measurement value)
          // - Part of + or - operations (all operands are measurements)
          
          // Convert numeric constants, but skip numbers that are multipliers (right side of * or /)
          expression = expression.replace(/\b(\d+\.?\d*)\b/g, (match, number, offset, fullString) => {
            const numValue = parseFloat(number);
            if (isNaN(numValue)) {
              return match;
            }
            
            // Check if preceded by a letter (part of variable name - but we already replaced variables)
            if (offset > 0) {
              const beforeChar = fullString[offset - 1];
              if (/[a-zA-Z_]/.test(beforeChar)) {
                return match; // Don't convert (shouldn't happen after variable replacement, but safety check)
              }
            }
            
            // Check if this number is a multiplier (right operand in * or /)
            // Example: "38*2" - we convert 38 (measurement) but not 2 (multiplier)
            // Note: This assumes the user writes equations as "measurement*multiplier" not "multiplier*measurement"
            if (offset > 0) {
              // Look at characters before this number
              const beforeText = fullString.substring(Math.max(0, offset - 5), offset).trim();
              // Check if immediately preceded by * or / (with optional whitespace)
              if (beforeText.endsWith('*') || beforeText.endsWith('/')) {
                // This is a multiplier (right operand), don't convert it
                // Example: "38*2" -> we'll convert 38 to 1.496, keep 2 as 2
                // Result: "1.496*2" = "2.992" ✓
                return match;
              }
            }
            
            // This is a measurement value, convert mm to inches
            const converted = numValue / 25.4;
            return converted.toString();
          });
          
          // Restore variable names
          Object.keys(placeholders).forEach(placeholder => {
            expression = expression.replace(new RegExp(placeholder, 'g'), placeholders[placeholder]);
          });
          
        }
        
        // Replace variable names with their values (using word boundaries to avoid partial matches)
        // Replace in order: perimeter and area first (longer names), then width and height
        // Use parentheses to ensure proper evaluation
        expression = expression.replace(/\bperimeter\b/gi, `(${perimeter})`);
        expression = expression.replace(/\barea\b/gi, `(${area})`);
        expression = expression.replace(/\bwidth\b/gi, `(${width})`);
        expression = expression.replace(/\bheight\b/gi, `(${height})`);
        
        // Use Function constructor for safe evaluation
        // Wrap in try-catch to handle any evaluation errors
        let result;
        try {
          result = Function('"use strict"; return (' + expression + ')')();
        } catch (evalError) {
          console.error('evaluateLengthEquation - Evaluation error:', evalError.message, 'Expression:', expression);
          return null;
        }
        
        // Ensure result is a valid number (in inches)
        if (typeof result === 'number' && !isNaN(result) && isFinite(result)) {
          const finalResult = Math.max(0, result); // Ensure non-negative
          // Only warn about negative results when dimensions are actually provided (not initial 0 values)
          if (result < 0 && (width > 0 || height > 0)) {
            console.warn('evaluateLengthEquation: Result is negative, clamping to 0. Original:', result, 'Equation:', equation, 'Width:', width, 'Height:', height);
          }
          return finalResult;
        }
        
        console.warn('evaluateLengthEquation: Invalid result', result, 'Type:', typeof result, 'IsNaN:', isNaN(result), 'IsFinite:', isFinite(result));
        return null;
      } catch (error) {
        console.error('Error evaluating length equation:', equation, 'Error:', error);
        return null;
      }
    }

    // Exchange rate from server (default to 4000 if not provided)
    // Note: exchangeRateValue is already defined above, so we use that
    // const exchangeRate = <%= exchangeRate || 4000 %>; // Already defined as exchangeRateValue
    
    // Use global currency preference from header
    let currentCurrency = window.globalPreferences?.currency || 'COP';
    
    // Set exchange rate in global preferences if available
    if (window.globalPreferences) {
      window.globalPreferences.exchangeRate = exchangeRateValue;
    }
    
      // Format numbers with commas based on current currency
      // IMPORTANT: amount is in USD (internal calculation), convert for display
    function formatCurrency(amount, currency = null) {
      const currencyToUse = currency || currentCurrency;
      
      if (currencyToUse === 'USD') {
        // Amount is already in USD, display as-is
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }).format(amount);
      } else {
        // Convert USD to COP for display
        const amountCOP = amount * exchangeRateValue;
        return new Intl.NumberFormat('es-CO', {
          style: 'currency',
          currency: 'COP',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(amountCOP);
      }
    }
    
    // Update currency when global preference changes
    function updateCurrencyFromGlobal() {
      if (window.globalPreferences) {
        currentCurrency = window.globalPreferences.currency || 'COP';
        if(typeof window.calculatePricing==='function')window.calculatePricing();
      }
    }

    // OLD calculatePricing function removed - using calculatePricingWithUnits instead

    // Current unit state - use global preference
    // In edit mode, always start with inches since stored values are in inches
    // In new mode, use global preference
    const isEditMode = document.body.getAttribute('data-is-edit') === 'true';
    let currentUnit = isEditMode ? 'inches' : (window.globalPreferences?.unit || 'inches');
    
    // Unit conversion functions
    function inchesToMm(inches) {
      return inches * 25.4;
    }
    
    function mmToInches(mm) {
      return mm / 25.4;
    }
    
    // Update units from global preference
    function updateUnitsFromGlobal(eventUnit = null) {
      // Use event unit if provided, otherwise get from global preferences
      const newUnit = eventUnit || window.globalPreferences?.unit || 'inches';
      switchUnits(newUnit, false); // false = don't update global preference (it's already set)
    }
    
    // Switch between units (called from global preference changes or internally)
    function switchUnits(newUnit, updateGlobal = false) {
      // In edit mode, we still allow unit display changes for the UI,
      // but we need to track that values are stored in inches
      // Values are stored in inches, but we can display them in the selected unit
      // Don't prevent the unit change, just handle conversion properly
      
      if (updateGlobal && window.setGlobalUnit) {
        window.setGlobalUnit(newUnit);
      }
      const widthInput = document.getElementById('width');
      const heightInput = document.getElementById('height');
      const widthUnitSpan = document.getElementById('widthUnit');
      const heightUnitSpan = document.getElementById('heightUnit');
      const lengthDiscountInputs = document.querySelectorAll('input[name*="lengthDiscount"]');
      const currentUnitDisplay = document.getElementById('currentUnitDisplay');
      const previewUnitDisplay = document.getElementById('previewUnitDisplay');
      
      // Get current values
      const currentWidth = parseFloat(widthInput.value) || 0;
      const currentHeight = parseFloat(heightInput.value) || 0;
      
      // Convert values if switching units
      if (currentUnit !== newUnit && (currentWidth || currentHeight)) {
        let newWidth, newHeight;
        
        if (newUnit === 'mm' && currentUnit === 'inches') {
          newWidth = inchesToMm(currentWidth);
          newHeight = inchesToMm(currentHeight);
        } else if (newUnit === 'inches' && currentUnit === 'mm') {
          newWidth = mmToInches(currentWidth);
          newHeight = mmToInches(currentHeight);
        } else {
          newWidth = currentWidth;
          newHeight = currentHeight;
        }
        
        // Update input values
        widthInput.value = newWidth ? newWidth.toFixed(2) : '';
        heightInput.value = newHeight ? newHeight.toFixed(2) : '';
        
        // Convert length discount values
        lengthDiscountInputs.forEach(input => {
          const currentValue = parseFloat(input.value) || 0;
          if (currentValue) {
            let newValue;
            if (newUnit === 'mm' && currentUnit === 'inches') {
              newValue = inchesToMm(currentValue);
            } else if (newUnit === 'inches' && currentUnit === 'mm') {
              newValue = mmToInches(currentValue);
            } else {
              newValue = currentValue;
            }
            input.value = newValue.toFixed(2);
          }
        });
      }
      
      // Update unit labels
      const unitAbbr = newUnit === 'inches' ? 'in' : 'mm';
      if (widthUnitSpan) widthUnitSpan.textContent = unitAbbr;
      if (heightUnitSpan) heightUnitSpan.textContent = unitAbbr;
      if (currentUnitDisplay) currentUnitDisplay.textContent = unitAbbr;
      if (previewUnitDisplay) previewUnitDisplay.textContent = unitAbbr;
      
      // Update preview unit labels
      const widthUnitLabels = document.querySelectorAll('#widthUnitLabel');
      const heightUnitLabels = document.querySelectorAll('#heightUnitLabel');
      widthUnitLabels.forEach(label => {
        label.textContent = unitAbbr;
      });
      heightUnitLabels.forEach(label => {
        label.textContent = unitAbbr;
      });
      
      // Update length discount labels
      const lengthDiscountLabels = document.querySelectorAll('label[for*="lengthDiscount"], .form-label');
      lengthDiscountLabels.forEach(label => {
        if (label.textContent.includes('Length Discount')) {
          label.innerHTML = `Length Discount (${unitAbbr})`;
        }
      });
      
      // Update current unit
      currentUnit = newUnit;
      
      // Update hidden input
      const currentUnitInput = document.getElementById('currentUnit');
      if (currentUnitInput) {
        currentUnitInput.value = newUnit;
      }
      
      // Reset conversion flag when unit changes (new values need conversion)
      dimensionsConverted = false;
      
      // Update preview to reflect unit changes
      if (typeof updateWindowPreview === 'function') {
        updateWindowPreview();
      }
      
      // Recalculate pricing
      if (typeof window.calculatePricing === 'function') {
        window.calculatePricing();
      }
    }
    
    // Modified calculatePricing function to handle unit conversion
    function calculatePricingWithUnits() {
      // Get window system data from data attribute
      const windowSystemData = JSON.parse(document.body.getAttribute('data-window-system') || '{}');
      
      // Get current unit from hidden input or global variable (ensure we have the latest value)
      const currentUnitInput = document.getElementById('currentUnit');
      // Priority: hidden input > currentUnit variable > global preferences > default to inches
      const activeUnit = currentUnitInput?.value || currentUnit || (window.globalPreferences?.unit || localStorage.getItem('globalUnit') || 'inches');
      
      // Normalize unit value (handle 'mm' vs 'millimeters', 'inches' vs 'in')
      const normalizedUnit = activeUnit === 'mm' || activeUnit === 'millimeters' ? 'mm' : 'inches';
      
      // Unit detection complete
      
      // Get values from input fields
      // CRITICAL: In edit mode, when page first loads, values are in inches (from database)
      // The activeUnit variable tells us how the user is currently viewing/entering values
      const widthInput = document.getElementById('width');
      const heightInput = document.getElementById('height');
      let width = parseFloat(widthInput?.value) || 0;
      let height = parseFloat(heightInput?.value) || 0;
      const quantity = parseInt(document.getElementById('quantity').value) || 1;
      
      // Store display values for modal
      const widthDisplay = widthInput?.value || '0';
      const heightDisplay = heightInput?.value || '0';
      
      // Debug logging (only in edit mode)
        if (isEditMode) {
          console.log('=== calculatePricing DEBUG ===');
          console.log('activeUnit:', activeUnit);
          console.log('normalizedUnit:', normalizedUnit);
          console.log('currentUnit variable:', currentUnit);
          console.log('currentUnit input value:', currentUnitInput?.value);
          console.log('width input value:', widthInput?.value, 'parsed:', width);
          console.log('height input value:', heightInput?.value, 'parsed:', height);
        }
      
      // Convert to inches for calculations (since backend expects inches)
      // If normalizedUnit is 'mm', the input values are in mm (user entered them in mm), so convert them
      // If normalizedUnit is 'inches', the input values are already in inches
      if (normalizedUnit === 'mm') {
        const widthBefore = width;
        const heightBefore = height;
        width = mmToInches(width);
        height = mmToInches(height);
        if (isEditMode) {
          console.log('Converted from mm: width', widthBefore, 'mm ->', width, 'inches, height', heightBefore, 'mm ->', height, 'inches');
        }
      } else {
        if (isEditMode) {
          console.log('Using inches directly: width', width, 'inches, height', height, 'inches');
        }
      }
      
      // Calculate square footage (convert inches to square meters: 1 sqm = 1550 sq inches)
      const areaInches = width * height;
      const areaSquareMeters = areaInches / 1550;
      const perimeterInches = 2 * (width + height);
      const perimeterMeters = perimeterInches * 0.0254;
      
      // ALL INTERNAL CALCULATIONS IN USD
      let totalCost = 0;
      
      // Glass cost - CONVERT TO USD
      // Calculate actual glass dimensions using equations if available
      let glassWidthInches = width; // Default to window width
      let glassHeightInches = height; // Default to window height
      
      if (windowSystemData.glassWidthEquation) {
        const calculatedWidth = evaluateLengthEquation(windowSystemData.glassWidthEquation, width, height, normalizedUnit);
        if (calculatedWidth !== null && calculatedWidth > 0) {
          glassWidthInches = calculatedWidth;
        }
      }
      
      if (windowSystemData.glassHeightEquation) {
        const calculatedHeight = evaluateLengthEquation(windowSystemData.glassHeightEquation, width, height, normalizedUnit);
        if (calculatedHeight !== null && calculatedHeight > 0) {
          glassHeightInches = calculatedHeight;
        }
      }
      
      // Calculate glass area using actual glass dimensions
      const glassAreaInches = glassWidthInches * glassHeightInches;
      const glassAreaSquareMeters = glassAreaInches / 1550;
      
      let glassCost = 0;
      let glassName = 'N/A';
      let glassPrice = 0;
      let glassCurrency = 'USD';
      let glassPriceUSD = 0;
      
      const glassSelect = document.getElementById('glassType');
      // Check if glassSelect is a select element (not a hidden input) and has a value
      if (glassSelect && glassSelect.tagName === 'SELECT' && glassSelect.value) {
        const selectedGlass = glassSelect.options[glassSelect.selectedIndex];
        if (selectedGlass) {
          glassPrice = parseFloat(selectedGlass.getAttribute('data-price')) || 0;
          glassCurrency = selectedGlass.getAttribute('data-currency') || 'USD';
          glassName = selectedGlass.text || 'N/A';
          
          // Only calculate if glass has a valid price
          if (glassPrice > 0) {
            glassPriceUSD = convertToUSD(glassPrice, glassCurrency, exchangeRateValue);
            glassCost = glassPriceUSD * glassAreaSquareMeters;
            totalCost += glassCost;
          }
        }
      }
      
      // Profile costs - CONVERT TO USD
      let profilesCost = 0;
      const profileDetails = [];
      const profileSelects = document.querySelectorAll('.profile-select');
      
      // Filter windowSystemData.profiles to only get user-configurable profiles (showToUser: true)
      const userConfigurableProfilesFromData = (windowSystemData.profiles || []).filter(p => p.showToUser === true);
      
      profileSelects.forEach((select, index) => {
        const selectedProfile = select.options[select.selectedIndex];
        const pricePerMeter = parseFloat(selectedProfile?.getAttribute('data-price')) || 0;
        const profileCurrency = selectedProfile?.getAttribute('data-currency') || 'COP';
        const profileName = selectedProfile?.text || `Profile ${index + 1}`;
        const pricePerMeterUSD = convertToUSD(pricePerMeter, profileCurrency, exchangeRateValue);
        const qty = parseInt(select.closest('.component-card').querySelector('input[name*="quantity"]').value) || 1;
        
        // Get the corresponding profile item from window system to get equation
        // Use the index to match with user-configurable profiles array
        const profileItem = userConfigurableProfilesFromData[index];
        
        // Calculate profile length using equation
        let lengthMeters = 0;
        if (profileItem && profileItem.lengthEquation) {
          const lengthInches = evaluateLengthEquation(profileItem.lengthEquation, width, height, normalizedUnit);
          
          if (lengthInches !== null && !isNaN(lengthInches) && lengthInches > 0) {
            lengthMeters = lengthInches * 0.0254;
          }
        }
        
        const profileCost = pricePerMeterUSD * lengthMeters * qty;
        profilesCost += profileCost;
        
        // Calculate adjusted length (perimeter - length discount)
        const lengthDiscountMeters = 0; // Length discount is now handled by equations
        const adjustedLength = lengthMeters; // For now, adjusted length equals calculated length
        
        profileDetails.push({
          name: profileName,
          priceOriginal: pricePerMeter,
          currency: profileCurrency,
          priceUSD: pricePerMeterUSD,
          quantity: qty,
          lengthMeters: lengthMeters,
          lengthDiscount: 0, // Length discount is now handled by equations
          adjustedLength: adjustedLength,
          perimeterMeters: perimeterMeters,
          cost: profileCost
        });
      });
      
      // Add auto-managed profiles (from window system, showToUser: false)
      if (windowSystemData.profiles && Array.isArray(windowSystemData.profiles)) {
        windowSystemData.profiles.forEach((profileItem) => {
          if (!profileItem.showToUser && profileItem.profileId && profileItem.pricePerMeter > 0) {
            const pricePerMeterUSD = convertToUSD(profileItem.pricePerMeter, profileItem.currency || 'USD', exchangeRateValue);
            const qty = profileItem.quantity || 1;
            
            // Calculate profile length using equation
            let lengthMeters = 0;
            if (profileItem.lengthEquation) {
              const lengthInches = evaluateLengthEquation(profileItem.lengthEquation, width, height, normalizedUnit);
              if (lengthInches !== null && lengthInches > 0) {
                lengthMeters = lengthInches * 0.0254;
              }
            }
            
            const profileCost = pricePerMeterUSD * lengthMeters * qty;
            profilesCost += profileCost;
            
            // Calculate adjusted length (same as lengthMeters since we use equations now)
            const adjustedLength = lengthMeters;
            
            profileDetails.push({
              name: profileItem.profileName || 'Auto Profile',
              priceOriginal: profileItem.pricePerMeter,
              currency: profileItem.currency || 'USD',
              priceUSD: pricePerMeterUSD,
              quantity: qty,
              lengthMeters: lengthMeters,
              lengthDiscount: 0, // Length discount is now handled by equations
              adjustedLength: adjustedLength,
              perimeterMeters: perimeterMeters || 0,
              cost: profileCost,
              isUserConfigurable: false
            });
          }
        });
      }
      
      totalCost += profilesCost;
      
      // Accessory costs - CONVERT TO USD
      // Include both user-configurable (from dropdowns/choices) and auto-managed (from window system)
      let accessoriesCost = 0;
      const accessoryDetails = [];
      
      // 1. Individual accessories (dropdown selects)
      const accessorySelects = document.querySelectorAll('.accessory-select');
      accessorySelects.forEach(select => {
        const selectedAccessory = select.options[select.selectedIndex];
        const price = parseFloat(selectedAccessory?.getAttribute('data-price')) || 0;
        const accessoryCurrency = selectedAccessory?.getAttribute('data-currency') || 'USD';
        const accessoryName = selectedAccessory?.text || 'Accessory';
        const priceUSD = convertToUSD(price, accessoryCurrency, exchangeRateValue);
        const qty = parseInt(select.closest('.component-card').querySelector('input[name*="quantity"]').value) || 1;
        const accessoryCost = priceUSD * qty;
        accessoriesCost += accessoryCost;
        
        accessoryDetails.push({
          name: accessoryName,
          priceOriginal: price,
          currency: accessoryCurrency,
          priceUSD: priceUSD,
          quantity: qty,
          cost: accessoryCost,
          isUserConfigurable: true
        });
      });
      
      // Choice group accessories (radio buttons and checkboxes)
      const checkedChoices = document.querySelectorAll('input[name^="choiceGroup_"]:checked');
      
      checkedChoices.forEach(choice => {
        const accessoryId = choice.value;
        const groupName = choice.name.replace('choiceGroup_', '');
        
        // Find the corresponding price and quantity inputs
        const priceInputSelector = `input[name="accessories_choice_${groupName}_${accessoryId}_price"]`;
        const quantityInputSelector = `input[name="accessories_choice_${groupName}_${accessoryId}_quantity"]`;
        const currencyInputSelector = `input[name="accessories_choice_${groupName}_${accessoryId}_currency"]`;
        const priceInput = document.querySelector(priceInputSelector);
        const quantityInput = document.querySelector(quantityInputSelector);
        const currencyInput = document.querySelector(currencyInputSelector);
        
        if (priceInput && quantityInput) {
          const price = parseFloat(priceInput.value) || 0;
          const accessoryCurrency = currencyInput?.value || 'COP';
          const priceUSD = convertToUSD(price, accessoryCurrency, exchangeRateValue);
          const qty = parseInt(quantityInput.value) || 1;
          const accessoryCost = priceUSD * qty;
          accessoriesCost += accessoryCost;
          
          // Try to get accessory name from label or nearby element
          const label = document.querySelector(`label[for="${choice.id}"]`) || choice.closest('label');
          const accessoryName = label?.textContent?.trim() || `Accessory ${accessoryId}`;
          
          accessoryDetails.push({
            name: accessoryName,
            priceOriginal: price,
            currency: accessoryCurrency,
            priceUSD: priceUSD,
            quantity: qty,
            cost: accessoryCost,
            isUserConfigurable: true
          });
        }
      });
      
      // Add auto-managed accessories (from window system, showToUser: false)
      if (windowSystemData.accessories && Array.isArray(windowSystemData.accessories)) {
        windowSystemData.accessories.forEach((accessoryItem) => {
          if (!accessoryItem.showToUser && accessoryItem.accessoryId && accessoryItem.price > 0) {
            const priceUSD = convertToUSD(accessoryItem.price, accessoryItem.currency || 'USD', exchangeRateValue);
            const qty = accessoryItem.quantity || 1;
            const accessoryCost = priceUSD * qty;
            accessoriesCost += accessoryCost;
            
            accessoryDetails.push({
              name: accessoryItem.accessoryName || 'Auto Accessory',
              priceOriginal: accessoryItem.price,
              currency: accessoryItem.currency || 'USD',
              priceUSD: priceUSD,
              quantity: qty,
              cost: accessoryCost,
              isUserConfigurable: false
            });
          }
        });
      }
      
      totalCost += accessoriesCost;
      
      // Muntin costs - CONVERT TO USD
      let muntinCost = 0;
      let muntinDetails = null;
      const muntinProfileSelect = document.getElementById('muntinProfile');
      if (muntinProfileSelect) {
        const selectedMuntinProfile = muntinProfileSelect.options[muntinProfileSelect.selectedIndex];
        const muntinPricePerMeter = parseFloat(selectedMuntinProfile?.getAttribute('data-price')) || 0;
        const muntinCurrency = selectedMuntinProfile?.getAttribute('data-currency') || 'COP';
        const muntinName = selectedMuntinProfile?.text || 'N/A';
        const muntinPricePerMeterUSD = convertToUSD(muntinPricePerMeter, muntinCurrency, exchangeRateValue);
        
        // Calculate muntin length based on divisions
        const horizontalDivisions = parseInt(document.getElementById('muntinHorizontal')?.value) || 0;
        const verticalDivisions = parseInt(document.getElementById('muntinVertical')?.value) || 0;
        
        if (horizontalDivisions > 0 && verticalDivisions > 0) {
          // Calculate total muntin length
          const horizontalMuntins = horizontalDivisions - 1; // Number of horizontal bars
          const verticalMuntins = verticalDivisions - 1; // Number of vertical bars
          
          const horizontalLength = horizontalMuntins * width * 0.0254; // Convert to meters
          const verticalLength = verticalMuntins * height * 0.0254; // Convert to meters
          
          const totalMuntinLength = horizontalLength + verticalLength;
          muntinCost = muntinPricePerMeterUSD * totalMuntinLength;
          
          muntinDetails = {
            name: muntinName,
            priceOriginal: muntinPricePerMeter,
            currency: muntinCurrency,
            priceUSD: muntinPricePerMeterUSD,
            horizontal: horizontalDivisions,
            vertical: verticalDivisions,
            length: totalMuntinLength,
            cost: muntinCost
          };
        }
      }
      totalCost += muntinCost;
      
      // Apply per-window cost settings (as percentages)
      // All costs are in USD at this point
      const baseCost = totalCost;
      const additionalCosts = baseCost * (
        (costSettings.packaging / 100) +
        (costSettings.labor / 100) +
        (costSettings.indirectCosts / 100)
      );
      
      const costPerWindow = baseCost + additionalCosts; // Cost per single window
      const finalTotal = costPerWindow * quantity; // Total for all windows (costPerWindow × quantity)
      
      // Debug logging
      console.log('=== FRONTEND PRICING CALCULATION ===');
      console.log('glassCost:', glassCost);
      console.log('profilesCost:', profilesCost);
      console.log('accessoriesCost:', accessoriesCost);
      console.log('muntinCost:', muntinCost);
      console.log('baseCost:', baseCost);
      console.log('additionalCosts:', additionalCosts);
      console.log('costPerWindow:', costPerWindow);
      console.log('quantity:', quantity);
      console.log('finalTotal:', finalTotal);
      console.log('=== END FRONTEND CALCULATION ===');
      
      // Store calculation details for modal
      calculationDetails = {
        exchangeRate: exchangeRateValue,
        widthInches: width,
        heightInches: height,
        widthDisplay: widthDisplay + (currentUnit === 'mm' ? ' mm' : ' in'),
        heightDisplay: heightDisplay + (currentUnit === 'mm' ? ' mm' : ' in'),
        quantity: quantity,
        areaInches: areaInches,
        areaSquareMeters: areaSquareMeters,
        perimeterInches: perimeterInches,
        perimeterMeters: perimeterMeters,
        glassName: glassName,
        glassPriceOriginal: glassPrice,
        glassCurrency: glassCurrency,
        glassPriceUSD: glassPriceUSD,
        glassCost: glassCost,
        glassWidthInches: glassWidthInches,
        glassHeightInches: glassHeightInches,
        glassAreaInches: glassAreaInches,
        glassAreaSquareMeters: glassAreaSquareMeters,
        glassWidthEquation: windowSystemData.glassWidthEquation || null,
        glassHeightEquation: windowSystemData.glassHeightEquation || null,
        profiles: profileDetails,
        profilesCost: profilesCost,
        accessories: accessoryDetails,
        accessoriesCost: accessoriesCost,
        muntinCost: muntinCost,
        muntinDetails: muntinDetails,
        baseCost: baseCost,
        costSettings: {
          packaging: costSettings.packaging,
          labor: costSettings.labor,
          indirectCosts: costSettings.indirectCosts
        },
        additionalCosts: additionalCosts,
        costPerWindow: costPerWindow,
        finalTotal: finalTotal,
        displayCurrency: currentCurrency,
        displayTotal: formatCurrency(finalTotal)
      };
      
      // Show/hide muntin cost row and update value
      const muntinCostRow = document.getElementById('muntinCostRow');
      if (muntinCostRow) {
        if (muntinCost > 0) {
          muntinCostRow.style.display = 'flex';
          document.getElementById('muntinCost').textContent = formatCurrency(muntinCost);
        } else {
          muntinCostRow.style.display = 'none';
        }
      }
      
      // Update displays with comma formatting (formatCurrency will convert USD to display currency)
      document.getElementById('totalPrice').textContent = formatCurrency(finalTotal);
      // Base Materials should show the total of profiles (not including glass/accessories separately shown)
      // Or we could show total base cost - for now, showing profiles cost as "Base Materials"
      document.getElementById('baseMaterialsCost').textContent = formatCurrency(profilesCost);
      document.getElementById('glassCost').textContent = formatCurrency(glassCost);
      document.getElementById('accessoriesCost').textContent = formatCurrency(accessoriesCost);
      document.getElementById('additionalCosts').textContent = formatCurrency(additionalCosts);
      document.getElementById('finalTotalPrice').textContent = formatCurrency(finalTotal);
      // Also display unit price (cost per window) - this should match the table's unit price column
      const unitPrice = quantity > 0 ? costPerWindow : 0;
      const unitPriceDisplayEl = document.getElementById('unitPriceDisplay');
      if (unitPriceDisplayEl) {
        unitPriceDisplayEl.textContent = formatCurrency(unitPrice);
      }
    }
    
    // Override the original calculatePricing function
    window.calculatePricing = calculatePricingWithUnits;

    // Real-time name validation
    let nameCheckTimeout;
    const windowRefInput = document.getElementById('windowRef');
    const nameErrorDiv = document.getElementById('nameError');
    const nameSuccessDiv = document.getElementById('nameSuccess');
    const submitButton = document.querySelector('#windowConfigForm button[type="submit"]') || 
                         document.querySelector('#windowConfigForm input[type="submit"]') ||
                         document.querySelector('button[type="submit"]');
    let isNameValid = true;
    
    // Get current window ID and project ID from form data attributes
    const windowConfigForm = document.getElementById('windowConfigForm');
    const currentWindowId = windowConfigForm ? windowConfigForm.getAttribute('data-current-window-id') : null;
    const projectId = windowConfigForm ? windowConfigForm.getAttribute('data-project-id') : '';
    
    if (windowRefInput) {
      windowRefInput.addEventListener('input', function() {
        const name = this.value.trim();
        
        // Clear previous timeout
        clearTimeout(nameCheckTimeout);
        
        // Hide messages while typing
        if (nameErrorDiv) nameErrorDiv.classList.add('hidden');
        if (nameSuccessDiv) nameSuccessDiv.classList.add('hidden');
        
        // Reset validation state
        isNameValid = true;
        if (submitButton) submitButton.disabled = false;
        if (windowRefInput) windowRefInput.classList.remove('border-red-500');
        
        // If name is empty, don't check
        if (!name) {
          return;
        }
        
        // Debounce: wait 500ms after user stops typing
        nameCheckTimeout = setTimeout(async function() {
          try {
            const excludeParam = currentWindowId ? `&excludeId=${currentWindowId}` : '';
            const response = await fetch(`/projects/${projectId}/check-item-name?name=${encodeURIComponent(name)}${excludeParam}`);
            const data = await response.json();
            
            if (data.exists) {
              // Name already exists
              isNameValid = false;
              if (nameErrorDiv) {
                nameErrorDiv.textContent = data.message || `An item with the name "${name}" already exists in this project.`;
                nameErrorDiv.classList.remove('hidden');
              }
              if (nameSuccessDiv) nameSuccessDiv.classList.add('hidden');
              if (windowRefInput) {
                windowRefInput.classList.add('border-red-500');
                // Scroll to the input field and focus it
                windowRefInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => windowRefInput.focus(), 300);
              }
              if (submitButton) submitButton.disabled = true;
            } else {
              // Name is available
              isNameValid = true;
              if (nameErrorDiv) nameErrorDiv.classList.add('hidden');
              if (nameSuccessDiv) nameSuccessDiv.classList.remove('hidden');
              if (windowRefInput) windowRefInput.classList.remove('border-red-500');
              if (submitButton) submitButton.disabled = false;
            }
          } catch (error) {
            console.error('Error checking name:', error);
            // On error, allow submission (server will validate)
            isNameValid = true;
            if (nameErrorDiv) nameErrorDiv.classList.add('hidden');
            if (nameSuccessDiv) nameSuccessDiv.classList.add('hidden');
            if (submitButton) submitButton.disabled = false;
          }
        }, 500);
      });
    }
    
    // Track if dimensions have been converted to prevent double conversion
    let dimensionsConverted = false;
    
    // Helper function to convert dimensions from mm to inches if needed
    function convertDimensionsToInches() {
      // Don't convert twice - if already converted and unit input says 'inches', skip
      const currentUnitInput = document.getElementById('currentUnit');
      if (dimensionsConverted && currentUnitInput && currentUnitInput.value === 'inches') {
        console.log('✅ Dimensions already converted, skipping');
        return;
      }
      
      const widthInput = document.getElementById('width');
      const heightInput = document.getElementById('height');
      const lengthDiscountInputs = document.querySelectorAll('input[name*="lengthDiscount"]');
      
      // Check unit from multiple sources: display label (source of truth), hidden input, variable
      const widthUnitSpan = document.getElementById('widthUnit');
      const currentUnitDisplay = document.getElementById('currentUnitDisplay');
      
      // The displayed unit label is the most reliable source of truth
      const displayedUnit = widthUnitSpan?.textContent?.toLowerCase() || 
                           currentUnitDisplay?.textContent?.toLowerCase() || 
                           currentUnitInput?.value || 
                           currentUnit || 
                           'in';
      
      // Normalize: 'mm' or 'millimeters' = mm, everything else = inches
      const isMm = displayedUnit === 'mm' || displayedUnit === 'millimeters';
      
      console.log('=== CONVERTING DIMENSIONS TO INCHES ===');
      console.log('widthUnitSpan text:', widthUnitSpan?.textContent);
      console.log('currentUnitDisplay text:', currentUnitDisplay?.textContent);
      console.log('currentUnit variable:', currentUnit);
      console.log('currentUnit input value:', currentUnitInput?.value);
      console.log('displayedUnit (source of truth):', displayedUnit);
      console.log('isMm:', isMm);
      console.log('widthInput.value before conversion:', widthInput?.value);
      console.log('heightInput.value before conversion:', heightInput?.value);
      
      if (isMm) {
        // Convert width and height
        if (widthInput && widthInput.value) {
          const originalValue = parseFloat(widthInput.value);
          if (!isNaN(originalValue) && originalValue > 0) {
            const convertedValue = mmToInches(originalValue);
            widthInput.value = convertedValue.toFixed(2);
            console.log('✅ Converted width:', originalValue, 'mm ->', convertedValue, 'inches');
          }
        }
        if (heightInput && heightInput.value) {
          const originalValue = parseFloat(heightInput.value);
          if (!isNaN(originalValue) && originalValue > 0) {
            const convertedValue = mmToInches(originalValue);
            heightInput.value = convertedValue.toFixed(2);
            console.log('✅ Converted height:', originalValue, 'mm ->', convertedValue, 'inches');
          }
        }
        
        // Convert length discounts
        lengthDiscountInputs.forEach(input => {
          if (input.value) {
            const originalValue = parseFloat(input.value);
            if (!isNaN(originalValue) && originalValue > 0) {
              input.value = mmToInches(originalValue).toFixed(2);
            }
          }
        });
        
        // Update the unit tracker to inches so backend knows it's receiving inches
        if (currentUnitInput) {
          currentUnitInput.value = 'inches';
        }
        dimensionsConverted = true;
        console.log('✅ Dimensions converted to inches, currentUnit input set to "inches"');
      } else {
        dimensionsConverted = true; // Mark as processed even if no conversion needed
        console.log('✅ Dimensions already in inches, no conversion needed');
      }
    }
    
    // Form submission handler to ensure backend gets inches and validate name
    let isSubmitting = false;
    const form = document.getElementById('windowConfigForm');
    const formSubmitHandler = function(e) {
      // If we're already in the process of submitting after validation, allow it
      if (isSubmitting) {
        return true;
      }
      
      // CRITICAL: Convert dimensions FIRST, before any async operations
      // This ensures the values are converted even if async validation fails
      convertDimensionsToInches();
      
      // Prevent submission if name is invalid
      if (!isNameValid) {
        e.preventDefault();
        // Scroll to the top of the page first to show the error
        window.scrollTo({ top: 0, behavior: 'smooth' });
        setTimeout(() => {
          // Show error message
          if (nameErrorDiv) {
            nameErrorDiv.classList.remove('hidden');
          }
          // Then scroll to the name field and focus it
          if (windowRefInput) {
            windowRefInput.scrollIntoView({ behavior: 'smooth', block: 'start' });
            setTimeout(() => {
              windowRefInput.focus();
            }, 200);
          }
        }, 100);
        return false;
      }
      
      // Double-check name one more time before submitting (in case validation hasn't completed)
      const name = windowRefInput ? windowRefInput.value.trim() : '';
      if (name) {
        // Cancel submission and check name
        e.preventDefault();
        const excludeParam = currentWindowId ? `&excludeId=${currentWindowId}` : '';
        fetch(`/projects/${projectId}/check-item-name?name=${encodeURIComponent(name)}${excludeParam}`)
          .then(response => response.json())
          .then(data => {
            if (data.exists) {
              // Name exists, show error and scroll to top
              isNameValid = false;
              if (nameErrorDiv) {
                nameErrorDiv.textContent = data.message || `An item with the name "${name}" already exists in this project.`;
                nameErrorDiv.classList.remove('hidden');
              }
              if (nameSuccessDiv) nameSuccessDiv.classList.add('hidden');
              if (windowRefInput) {
                windowRefInput.classList.add('border-red-500');
                // Scroll to top of page first to show the error
                window.scrollTo({ top: 0, behavior: 'smooth' });
                setTimeout(() => {
                  // Then scroll to the name field and focus it
                  windowRefInput.scrollIntoView({ behavior: 'smooth', block: 'start' });
                  setTimeout(() => {
                    windowRefInput.focus();
                  }, 200);
                }, 100);
              }
              if (submitButton) submitButton.disabled = true;
            } else {
              // Name is valid, proceed with submission (dimensions already converted above)
              isNameValid = true;
              isSubmitting = true;
              
              // Remove event listener temporarily to prevent loop, then submit
              form.removeEventListener('submit', formSubmitHandler);
              form.submit();
            }
          })
          .catch(error => {
            console.error('Error checking name:', error);
            // On error, allow submission (server will validate)
            // Dimensions already converted above
            isSubmitting = true;
            form.removeEventListener('submit', formSubmitHandler);
            form.submit();
          });
        return false;
      }
      
      // If no name validation needed, dimensions already converted above
      // Form will submit normally with converted values
    };
    
    form.addEventListener('submit', formSubmitHandler);

    // Choice group functions
    function selectChoice(choiceCard) {
      const input = choiceCard.querySelector('input[type="radio"], input[type="checkbox"]');
      if (input) {
        if (input.type === 'radio') {
          input.checked = true;
          handleChoiceGroupChange(input);
        } else if (input.type === 'checkbox') {
          input.checked = !input.checked;
          handleChoiceGroupChange(input);
        }
      }
    }

    function handleChoiceGroupChange(input) {
      const choiceCard = input.closest('.choice-option');
      const group = input.name.replace('choiceGroup_', '');
      
      // Update card styling
      updateChoiceCardStyling(choiceCard, input.checked);
      
      // For radio buttons, uncheck others in the same group
      if (input.type === 'radio') {
        const otherRadios = document.querySelectorAll(`input[name="${input.name}"]`);
        otherRadios.forEach(radio => {
          if (radio !== input) {
            const otherCard = radio.closest('.choice-option');
            updateChoiceCardStyling(otherCard, false);
          }
        });
      }
      
      // Recalculate pricing
      calculatePricing();
    }

    function updateChoiceCardStyling(choiceCard, isSelected) {
      if (!choiceCard) return;
      
      if (isSelected) {
        choiceCard.classList.add('border-blue-500', 'bg-blue-50');
        choiceCard.classList.remove('border-gray-300', 'hover:border-blue-400', 'hover:bg-blue-50');
      } else {
        choiceCard.classList.remove('border-blue-500', 'bg-blue-50');
        choiceCard.classList.add('border-gray-300', 'hover:border-blue-400', 'hover:bg-blue-50');
      }
    }

    // Initialize choice group visual states
    function initializeChoiceGroups() {
      const allChoiceInputs = document.querySelectorAll('input[name^="choiceGroup_"]');
      allChoiceInputs.forEach(input => {
        const choiceCard = input.closest('.choice-option');
        updateChoiceCardStyling(choiceCard, input.checked);
      });
    }

    // Window Preview Rendering Functions
    function renderWindowPreview() {
      const container = document.getElementById('panelContainer');
      const ratioLabel = document.getElementById('ratioLabel');
      if (!container) return;
      
      container.innerHTML = '';
      container.style.flexDirection = orientation === 'vertical' ? 'column' : 'row';
      
      // Check if this is a French door
      if (operationType === 'french-door' && frenchDoorConfig) {
        renderFrenchDoorPreview(container, ratioLabel);
        return;
      }
      
      // Check if this is a Casement
      if (operationType === 'casement') {
        renderCasementPreview(container, ratioLabel);
        return;
      }
      
      // Check if this is Sliding/Roller
      if (operationType === 'sliding') {
        renderSlidingPreview(container, ratioLabel);
        return;
      }
      
      // Check if this is Single Hung
      if (operationType === 'single-hung') {
        renderSingleHungPreview(container, ratioLabel);
        return;
      }
      
      // Calculate total ratio
      const totalRatio = panelRatios.reduce((a, b) => a + b, 0);
      
      // Render each panel
      panelConfig.forEach((type, index) => {
        const isOperable = type === 'X';
        const ratio = panelRatios[index] || 1;
        
        // Create panel
        const panel = document.createElement('div');
        panel.className = `relative flex items-center justify-center panel-glass ${isOperable ? 'operable-glass' : 'fixed-glass'}`;
        panel.style.flex = `${ratio} 0 0%`;
        panel.style.minWidth = orientation === 'horizontal' ? '40px' : 'auto';
        panel.style.minHeight = orientation === 'vertical' ? '40px' : 'auto';
        
        panel.innerHTML = `
          <div class="absolute inset-0 glass-effect"></div>
          <div class="relative z-10 flex flex-col items-center">
            <span class="text-xl font-bold drop-shadow-sm" style="color: rgba(30,64,175,0.7);">${type}</span>
          </div>
          ${isOperable ? getOperationIndicator(operationType, orientation) : ''}
          ${showLogo ? '<div class="absolute bottom-1 right-1 pointer-events-none" style="font-size: 6px; font-weight: 600; color: rgba(30,64,175,0.35); letter-spacing: 0.5px;">VITRALUX</div>' : ''}
        `;
        
        container.appendChild(panel);
        
        // Add mullion between panels
        if (index < panelConfig.length - 1) {
          const mullion = document.createElement('div');
          mullion.className = 'aluminum-mullion flex-shrink-0';
          if (orientation === 'horizontal') {
            mullion.style.width = '6px';
            mullion.style.alignSelf = 'stretch';
          } else {
            mullion.style.height = '6px';
            mullion.style.width = '100%';
          }
          container.appendChild(mullion);
        }
      });
      
      // Update ratio label
      if (ratioLabel && panelRatios.length > 0) {
        const percentages = panelRatios.map(r => Math.round((r / totalRatio) * 100));
        ratioLabel.textContent = percentages.join('% | ') + '%';
      }
    }
    
    function getOperationIndicator(opType, orient) {
      const iconClass = 'absolute bottom-2 left-1/2 transform -translate-x-1/2 text-blue-600 opacity-60';
      
      switch(opType) {
        case 'sliding':
          return `<div class="${iconClass}"><i class="fas fa-arrows-alt-${orient === 'horizontal' ? 'h' : 'v'} text-sm"></i></div>`;
        case 'single-hung':
        case 'double-hung':
          return `<div class="${iconClass}"><i class="fas fa-arrows-alt-v text-sm"></i></div>`;
        case 'casement':
          return `<div class="absolute top-2 right-2 text-blue-600 opacity-60"><i class="fas fa-door-open text-sm"></i></div>`;
        case 'awning':
          return `<div class="absolute top-2 left-1/2 transform -translate-x-1/2 text-blue-600 opacity-60"><i class="fas fa-caret-up"></i></div>`;
        case 'hopper':
          return `<div class="${iconClass}"><i class="fas fa-caret-down"></i></div>`;
        case 'french-door':
          return `<div class="${iconClass}"><i class="fas fa-door-open text-sm"></i></div>`;
        default:
          return '';
      }
    }
    
    function renderFrenchDoorPreview(container, ratioLabel) {
      container.style.flexDirection = 'column';
      
      const hasTransom = frenchDoorConfig.transom !== 'none';
      const leftSideliteCount = frenchDoorConfig.leftSidelites || 0;
      const rightSideliteCount = frenchDoorConfig.rightSidelites || 0;
      const isDouble = frenchDoorConfig.doorType === 'double';
      const transomOverDoorOnly = frenchDoorConfig.transom === 'over-door';
      const hingeSide = frenchDoorConfig.hingeSide || 'left';
      
      // Create glass panel helper
      function createGlassPanel(type, isTransom = false, label = '') {
        const panel = document.createElement('div');
        panel.className = 'relative flex items-center justify-center panel-glass fixed-glass';
        panel.innerHTML = `
          <div class="absolute inset-0 glass-effect"></div>
          ${!isTransom ? `<div class="relative z-10 flex flex-col items-center">
            <span class="text-lg font-bold drop-shadow-sm" style="color: rgba(30,64,175,0.7);">${type}</span>
            ${label ? `<span class="text-xs" style="color: rgba(30,64,175,0.5);">${label}</span>` : ''}
          </div>` : '<span class="text-xs text-blue-600/60 font-medium">TRANSOM</span>'}
          ${showLogo && !isTransom ? '<div class="absolute bottom-1 right-1 pointer-events-none" style="font-size: 6px; font-weight: 600; color: rgba(30,64,175,0.35);">VITRALUX</div>' : ''}
        `;
        return panel;
      }
      
      // Create door panel helper
      function createDoorPanel(position) {
        const panel = document.createElement('div');
        panel.className = 'relative flex items-center justify-center panel-glass operable-glass';
        
        let handleSide, hingeSidePos;
        if (position === 'single') {
          hingeSidePos = hingeSide;
          handleSide = hingeSide === 'left' ? 'right' : 'left';
        } else if (position === 'left') {
          hingeSidePos = 'left';
          handleSide = 'right';
        } else {
          hingeSidePos = 'right';
          handleSide = 'left';
        }
        
        panel.innerHTML = `
          <div class="absolute inset-0 glass-effect"></div>
          <div class="absolute ${handleSide === 'right' ? 'right-2' : 'left-2'} top-1/2 transform -translate-y-1/2 w-1.5 h-6 rounded-full" style="background: linear-gradient(90deg, #a0a0a0, #d0d0d0, #a0a0a0);"></div>
          <div class="absolute ${hingeSidePos === 'right' ? 'right-0.5' : 'left-0.5'} top-3 w-1 h-3 rounded-sm" style="background: #808080;"></div>
          <div class="absolute ${hingeSidePos === 'right' ? 'right-0.5' : 'left-0.5'} bottom-3 w-1 h-3 rounded-sm" style="background: #808080;"></div>
          <div class="relative z-10 flex flex-col items-center">
            <span class="text-xl font-bold drop-shadow-sm" style="color: rgba(22,101,52,0.8);">X</span>
            <span class="text-xs" style="color: rgba(22,101,52,0.6);">Door</span>
          </div>
          ${showLogo ? '<div class="absolute bottom-1 right-1 pointer-events-none" style="font-size: 6px; font-weight: 600; color: rgba(30,64,175,0.35);">VITRALUX</div>' : ''}
        `;
        return panel;
      }
      
      // Create aluminum mullion helper
      function createMullion(direction) {
        const mullion = document.createElement('div');
        mullion.className = 'aluminum-mullion flex-shrink-0';
        if (direction === 'vertical') {
          mullion.style.width = '6px';
          mullion.style.alignSelf = 'stretch';
        } else {
          mullion.style.height = '6px';
          mullion.style.width = '100%';
        }
        return mullion;
      }
      
      // Handle "over-door" transom with full height sidelites
      if (hasTransom && transomOverDoorOnly && (leftSideliteCount > 0 || rightSideliteCount > 0)) {
        const mainRow = document.createElement('div');
        mainRow.className = 'flex w-full flex-1';
        mainRow.style.minHeight = '160px';
        
        // Left sidelites (full height)
        for (let i = 0; i < leftSideliteCount; i++) {
          const sidelite = createGlassPanel('O', false, 'Sidelite');
          sidelite.style.flex = '0.4 0 0%';
          mainRow.appendChild(sidelite);
          mainRow.appendChild(createMullion('vertical'));
        }
        
        // Door section with transom
        const doorSection = document.createElement('div');
        doorSection.className = 'flex flex-col';
        doorSection.style.flex = isDouble ? '2 0 0%' : '1 0 0%';
        
        // Transom
        const transomRow = document.createElement('div');
        transomRow.className = 'flex w-full';
        transomRow.style.height = '50px';
        const transom = createGlassPanel('O', true);
        transom.style.flex = '1';
        transomRow.appendChild(transom);
        doorSection.appendChild(transomRow);
        doorSection.appendChild(createMullion('horizontal'));
        
        // Doors
        const doorsRow = document.createElement('div');
        doorsRow.className = 'flex w-full flex-1';
        if (isDouble) {
          const leftDoor = createDoorPanel('left');
          leftDoor.style.flex = '1';
          doorsRow.appendChild(leftDoor);
          doorsRow.appendChild(createMullion('vertical'));
          const rightDoor = createDoorPanel('right');
          rightDoor.style.flex = '1';
          doorsRow.appendChild(rightDoor);
        } else {
          const door = createDoorPanel('single');
          door.style.flex = '1';
          doorsRow.appendChild(door);
        }
        doorSection.appendChild(doorsRow);
        mainRow.appendChild(doorSection);
        
        // Right sidelites (full height)
        for (let i = 0; i < rightSideliteCount; i++) {
          mainRow.appendChild(createMullion('vertical'));
          const sidelite = createGlassPanel('O', false, 'Sidelite');
          sidelite.style.flex = '0.4 0 0%';
          mainRow.appendChild(sidelite);
        }
        
        container.appendChild(mainRow);
      } else {
        // Standard layout
        if (hasTransom && !transomOverDoorOnly) {
          const transomRow = document.createElement('div');
          transomRow.className = 'flex w-full';
          transomRow.style.height = '50px';
          
          for (let i = 0; i < leftSideliteCount; i++) {
            const t = createGlassPanel('O', true);
            t.style.flex = '0.4';
            transomRow.appendChild(t);
            transomRow.appendChild(createMullion('vertical'));
          }
          
          const doorTransom = createGlassPanel('O', true);
          doorTransom.style.flex = isDouble ? '2' : '1';
          transomRow.appendChild(doorTransom);
          
          for (let i = 0; i < rightSideliteCount; i++) {
            transomRow.appendChild(createMullion('vertical'));
            const t = createGlassPanel('O', true);
            t.style.flex = '0.4';
            transomRow.appendChild(t);
          }
          
          container.appendChild(transomRow);
          container.appendChild(createMullion('horizontal'));
        }
        
        // Door row
        const doorRow = document.createElement('div');
        doorRow.className = 'flex w-full flex-1';
        doorRow.style.minHeight = '120px';
        
        for (let i = 0; i < leftSideliteCount; i++) {
          const sidelite = createGlassPanel('O', false, 'Sidelite');
          sidelite.style.flex = '0.4 0 0%';
          doorRow.appendChild(sidelite);
          doorRow.appendChild(createMullion('vertical'));
        }
        
        if (isDouble) {
          const leftDoor = createDoorPanel('left');
          leftDoor.style.flex = '1';
          doorRow.appendChild(leftDoor);
          doorRow.appendChild(createMullion('vertical'));
          const rightDoor = createDoorPanel('right');
          rightDoor.style.flex = '1';
          doorRow.appendChild(rightDoor);
        } else {
          const door = createDoorPanel('single');
          door.style.flex = '1';
          doorRow.appendChild(door);
        }
        
        for (let i = 0; i < rightSideliteCount; i++) {
          doorRow.appendChild(createMullion('vertical'));
          const sidelite = createGlassPanel('O', false, 'Sidelite');
          sidelite.style.flex = '0.4 0 0%';
          doorRow.appendChild(sidelite);
        }
        
        container.appendChild(doorRow);
      }
      
      // Update ratio label for French door
      if (ratioLabel) {
        const doorDesc = isDouble ? 'Double' : 'Single';
        let extras = [];
        const totalSidelites = leftSideliteCount + rightSideliteCount;
        if (totalSidelites > 0) {
          extras.push(`${totalSidelites} Sidelite${totalSidelites > 1 ? 's' : ''}`);
        }
        if (hasTransom) {
          extras.push(transomOverDoorOnly ? 'Transom (Over Door)' : 'Transom');
        }
        ratioLabel.textContent = `${doorDesc} French Door${extras.length > 0 ? ' + ' + extras.join(' + ') : ''}`;
      }
    }
    
    // Render Casement window preview with hinges and handles
    function renderCasementPreview(container, ratioLabel) {
      container.style.flexDirection = orientation === 'vertical' ? 'column' : 'row';
      
      // Calculate total ratio
      const totalRatio = panelRatios.reduce((a, b) => a + b, 0);
      
      panelConfig.forEach((type, index) => {
        const isOperable = type === 'X';
        const ratio = panelRatios[index] || 1;
        const panel = document.createElement('div');
        panel.className = `relative flex items-center justify-center panel-glass ${isOperable ? 'operable-glass' : 'fixed-glass'}`;
        panel.style.flex = `${ratio} 0 0%`;
        panel.style.minWidth = orientation === 'horizontal' ? '40px' : 'auto';
        panel.style.minHeight = orientation === 'vertical' ? '40px' : 'auto';
        
        // Determine hinge and handle positions for casement
        // Alternate hinge sides for multi-panel casements
        const hingeOnLeft = index % 2 === 0;
        
        let casementHardware = '';
        if (isOperable) {
          if (orientation === 'horizontal') {
            // Horizontal layout - hinges on left or right side
            casementHardware = `
              <!-- Hinges (3 hinges on the hinge side) -->
              <div class="absolute ${hingeOnLeft ? 'left-0.5' : 'right-0.5'} top-2 w-1 h-2 rounded-sm" style="background: linear-gradient(90deg, #707070, #a0a0a0, #707070); box-shadow: 0 1px 2px rgba(0,0,0,0.3);"></div>
              <div class="absolute ${hingeOnLeft ? 'left-0.5' : 'right-0.5'} top-1/2 transform -translate-y-1/2 w-1 h-2 rounded-sm" style="background: linear-gradient(90deg, #707070, #a0a0a0, #707070); box-shadow: 0 1px 2px rgba(0,0,0,0.3);"></div>
              <div class="absolute ${hingeOnLeft ? 'left-0.5' : 'right-0.5'} bottom-2 w-1 h-2 rounded-sm" style="background: linear-gradient(90deg, #707070, #a0a0a0, #707070); box-shadow: 0 1px 2px rgba(0,0,0,0.3);"></div>
              
              <!-- Handle/Crank on opposite side -->
              <div class="absolute ${hingeOnLeft ? 'right-2' : 'left-2'} top-1/2 transform -translate-y-1/2 flex flex-col items-center">
                <div class="w-1 h-5 rounded-full" style="background: linear-gradient(90deg, #909090, #c0c0c0, #909090); box-shadow: 1px 1px 2px rgba(0,0,0,0.3);"></div>
                <div class="w-2.5 h-1 rounded-full mt-0.5" style="background: linear-gradient(180deg, #909090, #c0c0c0, #909090); box-shadow: 1px 1px 2px rgba(0,0,0,0.3);"></div>
              </div>
              
              <!-- Swing direction indicator -->
              <div class="absolute ${hingeOnLeft ? 'right-0' : 'left-0'} top-1 ${hingeOnLeft ? 'border-r-2' : 'border-l-2'} border-green-500/40 h-2 w-2" style="border-radius: ${hingeOnLeft ? '0 100% 100% 0' : '100% 0 0 100%'};"></div>
              <div class="absolute ${hingeOnLeft ? 'right-0' : 'left-0'} bottom-1 ${hingeOnLeft ? 'border-r-2' : 'border-l-2'} border-green-500/40 h-2 w-2" style="border-radius: ${hingeOnLeft ? '0 100% 100% 0' : '100% 0 0 100%'};"></div>
            `;
          } else {
            // Vertical layout - hinges on top or bottom
            const hingeOnTop = index % 2 === 0;
            casementHardware = `
              <!-- Hinges (3 hinges on the hinge side) -->
              <div class="absolute ${hingeOnTop ? 'top-0.5' : 'bottom-0.5'} left-2 h-1 w-2 rounded-sm" style="background: linear-gradient(180deg, #707070, #a0a0a0, #707070); box-shadow: 0 1px 2px rgba(0,0,0,0.3);"></div>
              <div class="absolute ${hingeOnTop ? 'top-0.5' : 'bottom-0.5'} left-1/2 transform -translate-x-1/2 h-1 w-2 rounded-sm" style="background: linear-gradient(180deg, #707070, #a0a0a0, #707070); box-shadow: 0 1px 2px rgba(0,0,0,0.3);"></div>
              <div class="absolute ${hingeOnTop ? 'top-0.5' : 'bottom-0.5'} right-2 h-1 w-2 rounded-sm" style="background: linear-gradient(180deg, #707070, #a0a0a0, #707070); box-shadow: 0 1px 2px rgba(0,0,0,0.3);"></div>
              
              <!-- Handle on opposite side -->
              <div class="absolute ${hingeOnTop ? 'bottom-2' : 'top-2'} left-1/2 transform -translate-x-1/2 flex items-center">
                <div class="h-1 w-5 rounded-full" style="background: linear-gradient(180deg, #909090, #c0c0c0, #909090); box-shadow: 1px 1px 2px rgba(0,0,0,0.3);"></div>
              </div>
              
              <!-- Swing direction indicator -->
              <div class="absolute ${hingeOnTop ? 'bottom-0' : 'top-0'} left-1 ${hingeOnTop ? 'border-b-2' : 'border-t-2'} border-green-500/40 h-2 w-2" style="border-radius: ${hingeOnTop ? '0 0 100% 100%' : '100% 100% 0 0'};"></div>
              <div class="absolute ${hingeOnTop ? 'bottom-0' : 'top-0'} right-1 ${hingeOnTop ? 'border-b-2' : 'border-t-2'} border-green-500/40 h-2 w-2" style="border-radius: ${hingeOnTop ? '0 0 100% 100%' : '100% 100% 0 0'};"></div>
            `;
          }
        }
        
        panel.innerHTML = `
          <div class="absolute inset-0 glass-effect"></div>
          ${isOperable ? casementHardware : ''}
          ${showLogo ? '<div class="absolute bottom-1 right-1 pointer-events-none" style="font-size: 6px; font-weight: 600; color: rgba(30,64,175,0.35); letter-spacing: 0.5px;">VITRALUX</div>' : ''}
          <div class="relative z-10 flex flex-col items-center">
            <span class="text-xl font-bold drop-shadow-sm" style="color: ${isOperable ? 'rgba(22,101,52,0.7)' : 'rgba(30,64,175,0.7)'};">${type}</span>
          </div>
        `;
        
        container.appendChild(panel);
        
        // Add mullion between panels
        if (index < panelConfig.length - 1) {
          const mullion = document.createElement('div');
          mullion.className = 'aluminum-mullion flex-shrink-0';
          if (orientation === 'horizontal') {
            mullion.style.width = '6px';
            mullion.style.alignSelf = 'stretch';
          } else {
            mullion.style.height = '6px';
            mullion.style.width = '100%';
          }
          container.appendChild(mullion);
        }
      });
      
      // Update ratio label
      if (ratioLabel) {
        const percentages = panelRatios.map(r => Math.round((r / totalRatio) * 100));
        const configString = panelConfig.join('');
        const operableCount = panelConfig.filter(p => p === 'X').length;
        ratioLabel.textContent = `${configString} Casement (${operableCount} Operable) - ${percentages.join('% | ')}%`;
      }
    }
    
    // Render Sliding/Roller window preview with handles
    function renderSlidingPreview(container, ratioLabel) {
      container.style.flexDirection = orientation === 'vertical' ? 'column' : 'row';
      
      // Calculate total ratio
      const totalRatio = panelRatios.reduce((a, b) => a + b, 0);
      
      panelConfig.forEach((type, index) => {
        const isOperable = type === 'X';
        const ratio = panelRatios[index] || 1;
        const panel = document.createElement('div');
        panel.className = `relative flex items-center justify-center panel-glass ${isOperable ? 'operable-glass' : 'fixed-glass'}`;
        panel.style.flex = `${ratio} 0 0%`;
        panel.style.minWidth = orientation === 'horizontal' ? '40px' : 'auto';
        panel.style.minHeight = orientation === 'vertical' ? '40px' : 'auto';
        
        // Determine handle position for sliding windows
        let slidingHandle = '';
        if (isOperable) {
          if (orientation === 'horizontal') {
            // Place handle on the outer edge (away from meeting rail)
            const hasFixedOnLeft = index > 0 && panelConfig[index - 1] === 'O';
            const hasFixedOnRight = index < panelConfig.length - 1 && panelConfig[index + 1] === 'O';
            const handleOnRight = hasFixedOnLeft || (!hasFixedOnRight && index > 0);
            
            slidingHandle = `
              <!-- Sliding handle (vertical bar) -->
              <div class="absolute ${handleOnRight ? 'right-1.5' : 'left-1.5'} top-1/2 transform -translate-y-1/2">
                <div class="w-1 h-8 rounded-full" style="background: linear-gradient(90deg, #808080, #d0d0d0, #808080); box-shadow: 1px 1px 3px rgba(0,0,0,0.3);"></div>
              </div>
              <!-- Rail indicators -->
              <div class="absolute top-0.5 left-1 right-1 h-0.5 rounded-full" style="background: linear-gradient(90deg, #606060, #909090, #606060);"></div>
              <div class="absolute bottom-0.5 left-1 right-1 h-0.5 rounded-full" style="background: linear-gradient(90deg, #606060, #909090, #606060);"></div>
            `;
          } else {
            // Vertical sliding
            slidingHandle = `
              <!-- Sliding handle (horizontal bar) -->
              <div class="absolute bottom-1.5 left-1/2 transform -translate-x-1/2">
                <div class="h-1 w-8 rounded-full" style="background: linear-gradient(180deg, #808080, #d0d0d0, #808080); box-shadow: 1px 1px 3px rgba(0,0,0,0.3);"></div>
              </div>
              <!-- Rail indicators -->
              <div class="absolute left-0.5 top-1 bottom-1 w-0.5 rounded-full" style="background: linear-gradient(180deg, #606060, #909090, #606060);"></div>
              <div class="absolute right-0.5 top-1 bottom-1 w-0.5 rounded-full" style="background: linear-gradient(180deg, #606060, #909090, #606060);"></div>
            `;
          }
        }
        
        // Sliding direction indicator
        const slidingIndicator = isOperable ? (
          orientation === 'horizontal' 
            ? '<div class="absolute bottom-1 left-1/2 transform -translate-x-1/2 text-green-600 opacity-70"><i class="fas fa-arrows-alt-h text-xs"></i></div>'
            : '<div class="absolute right-1 top-1/2 transform -translate-y-1/2 text-green-600 opacity-70"><i class="fas fa-arrows-alt-v text-xs"></i></div>'
        ) : '';
        
        panel.innerHTML = `
          <div class="absolute inset-0 glass-effect"></div>
          ${isOperable ? slidingHandle : ''}
          ${showLogo ? '<div class="absolute bottom-1 right-1 pointer-events-none" style="font-size: 6px; font-weight: 600; color: rgba(30,64,175,0.35); letter-spacing: 0.5px;">VITRALUX</div>' : ''}
          <div class="relative z-10 flex flex-col items-center">
            <span class="text-xl font-bold drop-shadow-sm" style="color: ${isOperable ? 'rgba(22,101,52,0.7)' : 'rgba(30,64,175,0.7)'};">${type}</span>
          </div>
          ${slidingIndicator}
        `;
        
        container.appendChild(panel);
        
        // Add mullion between panels
        if (index < panelConfig.length - 1) {
          const mullion = document.createElement('div');
          mullion.className = 'aluminum-mullion flex-shrink-0';
          if (orientation === 'horizontal') {
            mullion.style.width = '6px';
            mullion.style.alignSelf = 'stretch';
          } else {
            mullion.style.height = '6px';
            mullion.style.width = '100%';
          }
          container.appendChild(mullion);
        }
      });
      
      // Update ratio label
      if (ratioLabel) {
        const percentages = panelRatios.map(r => Math.round((r / totalRatio) * 100));
        const configString = panelConfig.join('');
        const operableCount = panelConfig.filter(p => p === 'X').length;
        ratioLabel.textContent = `${configString} Sliding (${operableCount} Operable) - ${percentages.join('% | ')}%`;
      }
    }
    
    // Render Single Hung window preview with proper sash appearance
    function renderSingleHungPreview(container, ratioLabel) {
      container.style.flexDirection = 'column'; // Single hung is always vertical
      
      const totalRatio = panelRatios.reduce((a, b) => a + b, 0);
      
      panelConfig.forEach((type, index) => {
        const isOperable = type === 'X';
        const ratio = panelRatios[index] || 1;
        
        const panel = document.createElement('div');
        panel.className = `relative flex items-center justify-center panel-glass ${isOperable ? 'operable-glass' : 'fixed-glass'}`;
        panel.style.flex = `${ratio} 0 0%`;
        panel.style.minHeight = '50px';
        
        let sashHardware = '';
        
        if (isOperable) {
          // Operable sash - has lift handles and slides up
          sashHardware = `
            <!-- Lift handles at bottom -->
            <div class="absolute bottom-1.5 left-1/2 transform -translate-x-1/2 flex items-center gap-4">
              <div class="w-6 h-1 rounded-full" style="background: linear-gradient(180deg, #808080, #d0d0d0, #808080); box-shadow: 0 1px 2px rgba(0,0,0,0.3);"></div>
              <div class="w-6 h-1 rounded-full" style="background: linear-gradient(180deg, #808080, #d0d0d0, #808080); box-shadow: 0 1px 2px rgba(0,0,0,0.3);"></div>
            </div>
            <!-- Sash lock at top -->
            <div class="absolute top-1 left-1/2 transform -translate-x-1/2">
              <div class="w-3 h-1.5 rounded-sm" style="background: linear-gradient(180deg, #808080, #b0b0b0, #808080);"></div>
            </div>
            <!-- Up arrow indicator -->
            <div class="absolute right-1 top-1/2 transform -translate-y-1/2 text-green-600 opacity-70">
              <i class="fas fa-arrow-up text-xs"></i>
            </div>
            <!-- Rail grooves -->
            <div class="absolute left-0.5 top-1 bottom-1 w-0.5 rounded-full" style="background: linear-gradient(180deg, #505050, #707070, #505050);"></div>
            <div class="absolute right-0.5 top-1 bottom-1 w-0.5 rounded-full" style="background: linear-gradient(180deg, #505050, #707070, #505050);"></div>
          `;
        } else {
          // Fixed sash - just rail grooves
          sashHardware = `
            <div class="absolute left-0.5 top-1 bottom-1 w-0.5 rounded-full" style="background: linear-gradient(180deg, #606060, #808080, #606060);"></div>
            <div class="absolute right-0.5 top-1 bottom-1 w-0.5 rounded-full" style="background: linear-gradient(180deg, #606060, #808080, #606060);"></div>
          `;
        }
        
        panel.innerHTML = `
          <div class="absolute inset-0 glass-effect"></div>
          ${sashHardware}
          ${showLogo ? '<div class="absolute bottom-1 right-1 pointer-events-none" style="font-size: 6px; font-weight: 600; color: rgba(30,64,175,0.35);">VITRALUX</div>' : ''}
          <div class="relative z-10 flex flex-col items-center">
            <span class="text-xl font-bold drop-shadow-sm" style="color: ${isOperable ? 'rgba(22,101,52,0.7)' : 'rgba(30,64,175,0.7)'};">${type}</span>
          </div>
        `;
        
        container.appendChild(panel);
        
        // Add meeting rail between sashes
        if (index < panelConfig.length - 1) {
          const meetingRail = document.createElement('div');
          meetingRail.className = 'aluminum-mullion flex-shrink-0';
          meetingRail.style.height = '8px';
          meetingRail.style.width = '100%';
          meetingRail.style.background = 'linear-gradient(180deg, #505050, #707070, #808080, #707070, #505050)';
          meetingRail.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
          container.appendChild(meetingRail);
        }
      });
      
      // Update ratio label
      if (ratioLabel) {
        const percentages = panelRatios.map(r => Math.round((r / totalRatio) * 100));
        const configString = panelConfig.join('');
        ratioLabel.textContent = `${configString} Single Hung - ${percentages.join('% | ')}%`;
      }
    }
    
    // Window Preview Functions
    function updateWindowPreview() {
      const width = parseFloat(document.getElementById('width').value) || 0;
      const height = parseFloat(document.getElementById('height').value) || 0;
      const currentUnit = document.getElementById('currentUnit').value;
      
      // Update dimension labels
      const widthLabels = document.querySelectorAll('#widthValue');
      const heightLabels = document.querySelectorAll('#heightValue');
      const widthUnitLabels = document.querySelectorAll('#widthUnitLabel');
      const heightUnitLabels = document.querySelectorAll('#heightUnitLabel');
      
      widthLabels.forEach(label => {
        label.textContent = width.toFixed(2);
      });
      
      heightLabels.forEach(label => {
        label.textContent = height.toFixed(2);
      });
      
      widthUnitLabels.forEach(label => {
        label.textContent = currentUnit === 'mm' ? 'mm' : 'in';
      });
      
      heightUnitLabels.forEach(label => {
        label.textContent = currentUnit === 'mm' ? 'mm' : 'in';
      });
      
      // Adjust height label position based on unit (metric values are longer)
      const heightLabel = document.getElementById('heightLabel');
      if (heightLabel) {
        if (currentUnit === 'mm') {
          heightLabel.classList.remove('-right-16');
          heightLabel.classList.add('-right-20');
        } else {
          heightLabel.classList.remove('-right-20');
          heightLabel.classList.add('-right-16');
        }
      }
      
      // Update dynamic preview dimensions proportionally
      const dynamicPreview = document.getElementById('dynamicWindowPreview');
      if (dynamicPreview && width > 0 && height > 0) {
        const maxWidth = 320;
        const maxHeight = 240;
        const aspectRatio = width / height;
        
        let displayWidth, displayHeight;
        if (aspectRatio > maxWidth / maxHeight) {
          // Width constrained
          displayWidth = maxWidth;
          displayHeight = maxWidth / aspectRatio;
        } else {
          // Height constrained
          displayHeight = maxHeight;
          displayWidth = maxHeight * aspectRatio;
        }
        
        // Ensure minimum dimensions
        displayWidth = Math.max(150, displayWidth);
        displayHeight = Math.max(100, displayHeight);
        
        dynamicPreview.style.width = displayWidth + 'px';
        dynamicPreview.style.height = displayHeight + 'px';
      }
      
      // Update calculations
      updateCalculations(width, height, currentUnit);
    }
    
    function updateCalculations(width, height, unit) {
      let widthInches = width;
      let heightInches = height;
      
      if (unit === 'mm') {
        widthInches = mmToInches(width);
        heightInches = mmToInches(height);
      }
      
      // Calculate aspect ratio (unitless)
      const aspectRatio = widthInches > 0 ? heightInches / widthInches : 0;
      
      // Calculate values in imperial (sq ft and ft)
      const areaSqFt = (widthInches * heightInches) / 144;
      const perimeterFt = (2 * (widthInches + heightInches)) / 12;
      const glassAreaSqFt = areaSqFt * 0.9;
      
      // Calculate values in metric (sq m and m)
      // 1 inch = 0.0254 m, 1 sq ft = 0.092903 sq m
      const areaSqM = areaSqFt * 0.092903;
      const perimeterM = perimeterFt * 0.3048;
      const glassAreaSqM = glassAreaSqFt * 0.092903;
      
      // Update displays based on current unit
      if (unit === 'mm') {
        // Display in metric (no decimals)
        document.getElementById('areaDisplay').textContent = Math.round(areaSqM);
        document.getElementById('perimeterDisplay').textContent = Math.round(perimeterM);
        document.getElementById('glassAreaDisplay').textContent = Math.round(glassAreaSqM);
        document.getElementById('areaUnitLabel').textContent = 'sq m';
        document.getElementById('perimeterUnitLabel').textContent = 'm';
        document.getElementById('glassAreaUnitLabel').textContent = 'sq m';
      } else {
        // Display in imperial (with 2 decimals)
        document.getElementById('areaDisplay').textContent = areaSqFt.toFixed(2);
        document.getElementById('perimeterDisplay').textContent = perimeterFt.toFixed(2);
        document.getElementById('glassAreaDisplay').textContent = glassAreaSqFt.toFixed(2);
        document.getElementById('areaUnitLabel').textContent = 'sq ft';
        document.getElementById('perimeterUnitLabel').textContent = 'ft';
        document.getElementById('glassAreaUnitLabel').textContent = 'sq ft';
      }
      
      // Aspect ratio is always unitless
      document.getElementById('aspectRatioDisplay').textContent = aspectRatio.toFixed(2);
    }
    
    function setPresetSize(width, height) {
      document.getElementById('width').value = width;
      document.getElementById('height').value = height;
      updateWindowPreview();
      if(typeof window.calculatePricing==='function')window.calculatePricing();
    }
    
    // Override the original calculatePricing function to also update preview
    const originalCalculatePricing = window.calculatePricing;
    window.calculatePricing = function() {
      if (originalCalculatePricing) {
        originalCalculatePricing();
      }
      updateWindowPreview();
    };
    
    // Override the switchUnits function to also update preview
    const originalSwitchUnits = window.switchUnits;
    window.switchUnits = function(unit) {
      if (originalSwitchUnits) {
        originalSwitchUnits(unit);
      }
      updateWindowPreview();
    };

    // Muntin Preview Function
    function updateMuntinPreview() {
      const horizontal = parseInt(document.getElementById('muntinHorizontal')?.value) || 1;
      const vertical = parseInt(document.getElementById('muntinVertical')?.value) || 1;
      const type = document.getElementById('muntinType')?.value || 'colonial';
      const previewGrid = document.getElementById('muntinPreviewGrid');
      const previewText = document.getElementById('muntinPreviewText');
      
      if (!previewGrid || !previewText) return;
      
      // Generate preview grid
      previewGrid.innerHTML = '';
      const cellWidth = 100 / horizontal;
      const cellHeight = 100 / vertical;
      
      for (let i = 0; i < horizontal; i++) {
        for (let j = 0; j < vertical; j++) {
          const cell = document.createElement('div');
          cell.style.position = 'absolute';
          cell.style.left = (i * cellWidth) + '%';
          cell.style.top = (j * cellHeight) + '%';
          cell.style.width = cellWidth + '%';
          cell.style.height = cellHeight + '%';
          cell.style.border = '1px solid #6b7280';
          cell.style.backgroundColor = '#e5e7eb';
          previewGrid.appendChild(cell);
        }
      }
      
      // Update preview text
      const typeLabel = type.charAt(0).toUpperCase() + type.slice(1);
      previewText.textContent = `${horizontal}x${vertical} ${typeLabel} Grid`;
      
      // Update pricing when muntin settings change
      if(typeof window.calculatePricing==='function')window.calculatePricing();
    }
    
    // Initialize calculations
    document.addEventListener('DOMContentLoaded', function() {
      // In edit mode, convert stored inch values to display unit based on global preference FIRST
      if (isEditMode) {
        // Values are stored in inches in the database
        // Get the global unit preference and convert for display
        const globalUnit = window.globalPreferences?.unit || 'inches';
        const widthInput = document.getElementById('width');
        const heightInput = document.getElementById('height');
        
        if (widthInput && widthInput.value && globalUnit === 'mm') {
          // Convert stored inches to mm for display
          const widthInches = parseFloat(widthInput.value);
          widthInput.value = inchesToMm(widthInches).toFixed(2);
        }
        
        if (heightInput && heightInput.value && globalUnit === 'mm') {
          // Convert stored inches to mm for display
          const heightInches = parseFloat(heightInput.value);
          heightInput.value = inchesToMm(heightInches).toFixed(2);
        }
        
        // Set currentUnit to match global preference (for display)
        currentUnit = globalUnit;
        const currentUnitInput = document.getElementById('currentUnit');
        if (currentUnitInput) {
          currentUnitInput.value = globalUnit;
        }
        
        // Update unit labels based on global preference
        const unitAbbr = globalUnit === 'inches' ? 'in' : 'mm';
        const widthUnitSpan = document.getElementById('widthUnit');
        const heightUnitSpan = document.getElementById('heightUnit');
        const currentUnitDisplay = document.getElementById('currentUnitDisplay');
        const previewUnitDisplay = document.getElementById('previewUnitDisplay');
        if (widthUnitSpan) widthUnitSpan.textContent = unitAbbr;
        if (heightUnitSpan) heightUnitSpan.textContent = unitAbbr;
        if (currentUnitDisplay) currentUnitDisplay.textContent = unitAbbr;
        if (previewUnitDisplay) previewUnitDisplay.textContent = unitAbbr;
        
        // Update preview unit labels
        const widthUnitLabels = document.querySelectorAll('#widthUnitLabel');
        const heightUnitLabels = document.querySelectorAll('#heightUnitLabel');
        widthUnitLabels.forEach(label => {
          label.textContent = unitAbbr;
        });
        heightUnitLabels.forEach(label => {
          label.textContent = unitAbbr;
        });
      } else {
        // Initialize from global preferences (new mode)
        updateCurrencyFromGlobal();
        updateUnitsFromGlobal();
      }
      
      // Initialize from global preferences (after edit mode setup if applicable)
      if (isEditMode) {
        updateCurrencyFromGlobal();
      }
      
      // Listen to global preference changes
      window.addEventListener('currencyChanged', (event) => {
        currentCurrency = event.detail.currency;
        if(typeof window.calculatePricing==='function')window.calculatePricing();
      });
      
      window.addEventListener('unitChanged', (event) => {
        // Get the unit from the event detail
        const newUnit = event.detail.unit || 'inches';
        updateUnitsFromGlobal(newUnit);
      });
      
      initializeChoiceGroups();
      renderWindowPreview(); // Render the panel preview based on configuration
      
      // Format saved values display in edit mode
      if (isEditMode) {
        const savedPriceElements = document.querySelectorAll('[data-price]');
        if (savedPriceElements.length > 0) {
          // Format all data-price attributes in the saved values box
          savedPriceElements.forEach(el => {
            const price = parseFloat(el.getAttribute('data-price')) || 0;
            if (price > 0) {
              el.textContent = formatCurrency(price);
            }
          });
        }
        
        // Note: We no longer override calculated prices with saved values
        // The saved values are shown in the yellow info box for reference
        // The main price display should always show the current calculated price
        // based on the user's selections (which calculatePricing() handles)
      }
      
      // Calculate pricing AFTER unit is properly set
      // In edit mode, calculate with restored selections to verify they match saved values
      // Use setTimeout to ensure all initialization is complete
      setTimeout(function() {
        // In edit mode, verify that selections are restored before calculating
        if (isEditMode) {
          // Check if profile selects have valid selections
          const profileSelects = document.querySelectorAll('.profile-select');
          let allProfilesSelected = true;
          profileSelects.forEach(select => {
            if (!select.value || select.value === '') {
              allProfilesSelected = false;
            }
          });
          
          // Only calculate if selections are restored, otherwise wait a bit more
          if (allProfilesSelected || profileSelects.length === 0) {
            if(typeof window.calculatePricing==='function')window.calculatePricing();
            updateWindowPreview(); // Update dimensions
          } else {
            // Wait a bit more for selections to be restored
            setTimeout(function() {
              if(typeof window.calculatePricing==='function')window.calculatePricing();
              updateWindowPreview();
            }, 300);
          }
        } else {
          // In new mode, calculate immediately
          if(typeof window.calculatePricing==='function')window.calculatePricing();
          updateWindowPreview(); // Update dimensions
        }
      }, 200); // Initial timeout to ensure all form elements are populated
      
      // Initialize muntin preview if muntin configuration exists
      if (document.getElementById('muntinPreviewGrid')) {
        updateMuntinPreview();
      }
    });

    // Store calculation details for the modal
    let calculationDetails = null;

    // Function to show calculation details modal
    function showCalculationDetails() {
      // Always run calculation first to ensure details are up-to-date
      if (typeof window.calculatePricing === 'function') {
        window.calculatePricing();
        // Wait a moment for calculation to complete and populate calculationDetails
        setTimeout(() => {
          if (!calculationDetails) {
            // Check if window has minimum required data
            const width = parseFloat(document.getElementById('width')?.value) || 0;
            const height = parseFloat(document.getElementById('height')?.value) || 0;
            if (width === 0 || height === 0) {
              alert('Please enter window dimensions (width and height) first to see calculation details.');
              return;
            }
            // If calculation still didn't populate, show error
            alert('Unable to calculate pricing. Please check that all required fields are filled.');
            return;
          }
          const modal = document.getElementById('calculationModal');
          if (modal) {
            modal.classList.remove('hidden');
            populateCalculationModal();
          } else {
            alert('Calculation modal not found. Please refresh the page.');
          }
        }, 200);
      } else {
        alert('Calculation function not available. Please refresh the page.');
      }
    }
    
    // Make showCalculationDetails globally accessible
    window.showCalculationDetails = showCalculationDetails;

    // Function to close the modal
    function closeCalculationModal() {
      const modal = document.getElementById('calculationModal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    // Helper function to format COP value
    function formatCOP(usdAmount, exchangeRate) {
      const copAmount = usdAmount * exchangeRate;
      return new Intl.NumberFormat('es-CO', {
        style: 'currency',
        currency: 'COP',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(copAmount);
    }

    // Function to populate the modal with calculation details
    function populateCalculationModal() {
      if (!calculationDetails) return;

      const details = calculationDetails;
      const modalContent = document.getElementById('calculationModalContent');
      const rate = details.exchangeRate;
      
      let html = `
        <div class="space-y-4">
          <!-- Exchange Rate -->
          <div class="bg-blue-50 p-3 rounded-lg">
            <div class="text-sm font-semibold text-blue-800 mb-2">Exchange Rate</div>
            <div class="text-sm text-gray-700">1 USD = ${rate.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} COP</div>
          </div>

          <!-- Dimensions -->
          <div class="bg-gray-50 p-3 rounded-lg">
            <div class="text-sm font-semibold text-gray-800 mb-2">Dimensions (Internal Calculation in Inches)</div>
            <div class="text-sm text-gray-700 space-y-1">
              <div>Width: ${details.widthInches.toFixed(2)} in (${details.widthDisplay})</div>
              <div>Height: ${details.heightInches.toFixed(2)} in (${details.heightDisplay})</div>
              <div>Quantity: ${details.quantity}</div>
            </div>
          </div>

          <!-- Area Calculations -->
          <div class="bg-gray-50 p-3 rounded-lg">
            <div class="text-sm font-semibold text-gray-800 mb-2">Area Calculations</div>
            <div class="text-sm text-gray-700 space-y-1">
              <div>Area (sq inches): ${details.areaInches.toFixed(2)}</div>
              <div>Area (sq meters): ${details.areaSquareMeters.toFixed(4)}</div>
              <div>Perimeter (inches): ${details.perimeterInches.toFixed(2)}</div>
              <div>Perimeter (meters): ${details.perimeterMeters.toFixed(4)}</div>
            </div>
          </div>

          <!-- Glass Cost -->
          <div class="bg-green-50 p-3 rounded-lg">
            <div class="text-sm font-semibold text-green-800 mb-2">Glass Cost</div>
            <div class="text-sm text-gray-700 space-y-1">
              <div>Glass Type: ${details.glassName || 'N/A'}</div>
              <div>Price (${details.glassCurrency}): ${details.glassPriceOriginal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
              <div>Price (USD): $${details.glassPriceUSD.toFixed(2)}</div>
              <div>Area (sq m): ${details.areaSquareMeters.toFixed(4)}</div>
              <div class="font-semibold">Glass Cost (USD): $${details.glassCost.toFixed(2)}</div>
              <div class="font-semibold text-green-700">Glass Cost (COP): ${formatCOP(details.glassCost, rate)}</div>
              <div class="text-xs text-gray-600">Formula: ${details.glassPriceUSD.toFixed(2)} × ${details.areaSquareMeters.toFixed(4)} = $${details.glassCost.toFixed(2)}</div>
            </div>
          </div>

          <!-- Profile Costs -->
          <div class="bg-purple-50 p-3 rounded-lg">
            <div class="text-sm font-semibold text-purple-800 mb-2">Profile Costs</div>
            <div class="text-sm text-gray-700 space-y-2">
              ${details.profiles.map((profile, idx) => `
                <div class="border-b border-purple-200 pb-2 ${idx === details.profiles.length - 1 ? 'border-b-0 pb-0' : ''}">
                  <div class="font-medium">Profile ${idx + 1}: ${profile.name}</div>
                  <div class="ml-4 space-y-1 text-xs">
                    <div>Price per meter (USD): $${profile.priceUSD.toFixed(2)}</div>
                    <div>Price per meter (COP): ${formatCOP(profile.priceUSD, rate)}</div>
                    <div>Quantity: ${profile.quantity}</div>
                    <div>Length: ${(profile.lengthMeters || 0).toFixed(4)} m</div>
                    ${profile.perimeterMeters ? `<div>Perimeter: ${profile.perimeterMeters.toFixed(4)} m</div>` : ''}
                    <div class="font-semibold">Cost (USD): $${profile.cost.toFixed(2)}</div>
                    <div class="font-semibold text-purple-700">Cost (COP): ${formatCOP(profile.cost, rate)}</div>
                    <div class="text-xs text-gray-600">Formula: $${profile.priceUSD.toFixed(2)} × ${(profile.lengthMeters || 0).toFixed(4)} × ${profile.quantity} = $${profile.cost.toFixed(2)}</div>
                  </div>
                </div>
              `).join('')}
              <div class="font-semibold mt-2 pt-2 border-t border-purple-300">Total Profiles Cost (USD): $${details.profilesCost.toFixed(2)}</div>
              <div class="font-semibold text-purple-700">Total Profiles Cost (COP): ${formatCOP(details.profilesCost, rate)}</div>
            </div>
          </div>

          <!-- Accessory Costs -->
          <div class="bg-yellow-50 p-3 rounded-lg">
            <div class="text-sm font-semibold text-yellow-800 mb-2">Accessory Costs</div>
            <div class="text-sm text-gray-700 space-y-2">
              ${details.accessories.length > 0 ? details.accessories.map((acc, idx) => `
                <div class="border-b border-yellow-200 pb-2 ${idx === details.accessories.length - 1 ? 'border-b-0 pb-0' : ''}">
                  <div class="font-medium">${acc.name}</div>
                  <div class="ml-4 space-y-1 text-xs">
                    <div>Price (${acc.currency}): ${acc.priceOriginal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    <div>Price (USD): $${acc.priceUSD.toFixed(2)}</div>
                    <div>Quantity: ${acc.quantity}</div>
                    <div class="font-semibold">Cost (USD): $${acc.cost.toFixed(2)}</div>
                    <div class="font-semibold text-yellow-700">Cost (COP): ${formatCOP(acc.cost, rate)}</div>
                    <div class="text-xs text-gray-600">Formula: $${acc.priceUSD.toFixed(2)} × ${acc.quantity} = $${acc.cost.toFixed(2)}</div>
                  </div>
                </div>
              `).join('') : '<div class="text-gray-500 italic">No accessories selected</div>'}
              <div class="font-semibold mt-2 pt-2 border-t border-yellow-300">Total Accessories Cost (USD): $${details.accessoriesCost.toFixed(2)}</div>
              <div class="font-semibold text-yellow-700">Total Accessories Cost (COP): ${formatCOP(details.accessoriesCost, rate)}</div>
            </div>
          </div>

          ${details.muntinCost > 0 && details.muntinDetails ? `
          <!-- Muntin Cost -->
          <div class="bg-indigo-50 p-3 rounded-lg">
            <div class="text-sm font-semibold text-indigo-800 mb-2">Muntin Cost</div>
            <div class="text-sm text-gray-700 space-y-1">
              <div>Muntin Profile: ${details.muntinDetails.name || 'N/A'}</div>
              <div>Price (${details.muntinDetails.currency}): ${details.muntinDetails.priceOriginal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
              <div>Price (USD): $${details.muntinDetails.priceUSD.toFixed(2)}</div>
              <div>Horizontal Divisions: ${details.muntinDetails.horizontal}</div>
              <div>Vertical Divisions: ${details.muntinDetails.vertical}</div>
              <div>Total Muntin Length: ${details.muntinDetails.length.toFixed(4)} m</div>
              <div class="font-semibold">Muntin Cost (USD): $${details.muntinDetails.cost.toFixed(2)}</div>
              <div class="font-semibold text-indigo-700">Muntin Cost (COP): ${formatCOP(details.muntinDetails.cost, rate)}</div>
              <div class="text-xs text-gray-600">Formula: $${details.muntinDetails.priceUSD.toFixed(2)} × ${details.muntinDetails.length.toFixed(4)} = $${details.muntinDetails.cost.toFixed(2)}</div>
            </div>
          </div>
          ` : ''}

          <!-- Base Cost Summary -->
          <div class="bg-gray-100 p-3 rounded-lg">
            <div class="text-sm font-semibold text-gray-800 mb-2">Base Cost Summary</div>
            <div class="text-sm text-gray-700 space-y-1">
              <div class="grid grid-cols-2 gap-2">
                <div>Glass Cost (USD): $${details.glassCost.toFixed(2)}</div>
                <div class="text-gray-600">COP: ${formatCOP(details.glassCost, rate)}</div>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <div>Profiles Cost (USD): $${details.profilesCost.toFixed(2)}</div>
                <div class="text-gray-600">COP: ${formatCOP(details.profilesCost, rate)}</div>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <div>Accessories Cost (USD): $${details.accessoriesCost.toFixed(2)}</div>
                <div class="text-gray-600">COP: ${formatCOP(details.accessoriesCost, rate)}</div>
              </div>
              ${details.muntinCost > 0 ? `
              <div class="grid grid-cols-2 gap-2">
                <div>Muntin Cost (USD): $${details.muntinCost.toFixed(2)}</div>
                <div class="text-gray-600">COP: ${formatCOP(details.muntinCost, rate)}</div>
              </div>
              ` : ''}
              <div class="font-semibold pt-2 border-t border-gray-300 grid grid-cols-2 gap-2">
                <div>Base Cost (USD): $${details.baseCost.toFixed(2)}</div>
                <div class="text-gray-700">COP: ${formatCOP(details.baseCost, rate)}</div>
              </div>
            </div>
          </div>

          <!-- Additional Costs -->
          <div class="bg-orange-50 p-3 rounded-lg">
            <div class="text-sm font-semibold text-orange-800 mb-2">Additional Costs (Percentages)</div>
            <div class="text-sm text-gray-700 space-y-1">
              <div>Packaging: ${details.costSettings.packaging}%</div>
              <div>Labor: ${details.costSettings.labor}%</div>
              <div>Indirect Costs: ${details.costSettings.indirectCosts}%</div>
              <div>Total Percentage: ${(details.costSettings.packaging + details.costSettings.labor + details.costSettings.indirectCosts).toFixed(2)}%</div>
              <div class="font-semibold grid grid-cols-2 gap-2">
                <div>Additional Costs (USD): $${details.additionalCosts.toFixed(2)}</div>
                <div class="text-orange-700">COP: ${formatCOP(details.additionalCosts, rate)}</div>
              </div>
              <div class="text-xs text-gray-600">Formula: $${details.baseCost.toFixed(2)} × ${((details.costSettings.packaging + details.costSettings.labor + details.costSettings.indirectCosts) / 100).toFixed(4)} = $${details.additionalCosts.toFixed(2)}</div>
            </div>
          </div>

          <!-- Final Totals -->
          <div class="bg-green-100 p-3 rounded-lg border-2 border-green-300">
            <div class="text-sm font-semibold text-green-800 mb-2">Final Calculation</div>
            <div class="text-sm text-gray-700 space-y-1">
              <div class="grid grid-cols-2 gap-2">
                <div>Base Cost (USD): $${details.baseCost.toFixed(2)}</div>
                <div class="text-gray-600">COP: ${formatCOP(details.baseCost, rate)}</div>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <div>Additional Costs (USD): $${details.additionalCosts.toFixed(2)}</div>
                <div class="text-gray-600">COP: ${formatCOP(details.additionalCosts, rate)}</div>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <div>Cost per Window (USD): $${details.costPerWindow.toFixed(2)}</div>
                <div class="text-gray-600">COP: ${formatCOP(details.costPerWindow, rate)}</div>
              </div>
              <div>Quantity: ${details.quantity}</div>
              <div class="font-bold text-lg pt-2 border-t border-green-400">
                <div class="grid grid-cols-1 gap-1">
                  <div>Total Price (USD): $${details.finalTotal.toFixed(2)}</div>
                  <div class="text-green-700">Total Price (COP): ${formatCOP(details.finalTotal, rate)}</div>
                </div>
              </div>
              <div class="text-xs text-gray-600">Formula: $${details.costPerWindow.toFixed(2)} × ${details.quantity} = $${details.finalTotal.toFixed(2)}</div>
            </div>
          </div>
        </div>
      `;

      modalContent.innerHTML = html;
    }

    // Function to show workshop details modal
    function showWorkshopDetails() {
      // Always run calculation first to ensure details are up-to-date
      if (typeof window.calculatePricing === 'function') {
        window.calculatePricing();
        // Wait a moment for calculation to complete and populate calculationDetails
        setTimeout(() => {
          if (!calculationDetails) {
            // Check if window has minimum required data
            const width = parseFloat(document.getElementById('width')?.value) || 0;
            const height = parseFloat(document.getElementById('height')?.value) || 0;
            if (width === 0 || height === 0) {
              alert('Please enter window dimensions (width and height) first to see workshop details.');
              return;
            }
            // If calculation still didn't populate, show error
            alert('Unable to calculate pricing. Please check that all required fields are filled.');
            return;
          }
          const modal = document.getElementById('workshopModal');
          if (modal) {
            modal.classList.remove('hidden');
            populateWorkshopModal();
          } else {
            alert('Workshop modal not found. Please refresh the page.');
          }
        }, 200);
      } else {
        alert('Calculation function not available. Please refresh the page.');
      }
    }
    
    // Make showWorkshopDetails globally accessible
    window.showWorkshopDetails = showWorkshopDetails;

    // Function to close the workshop modal
    function closeWorkshopModal() {
      const modal = document.getElementById('workshopModal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    // Function to populate the workshop modal with production information
    function populateWorkshopModal() {
      if (!calculationDetails) return;

      const details = calculationDetails;
      const modalContent = document.getElementById('workshopModalContent');
      
      // Get current unit for display
      const currentUnit = document.getElementById('currentUnit')?.value || 'inches';
      const unitLabel = currentUnit === 'mm' ? 'mm' : 'in';
      
      // Get window dimensions
      const width = parseFloat(document.getElementById('width')?.value) || 0;
      const height = parseFloat(document.getElementById('height')?.value) || 0;
      const quantity = parseInt(document.getElementById('quantity')?.value) || 1;
      
      // Get glass information (check if glassType is a select element)
      const glassSelect = document.getElementById('glassType');
      let glassName = 'N/A (No Glass)';
      if (glassSelect && glassSelect.tagName === 'SELECT' && glassSelect.value) {
        const selectedGlass = glassSelect.options[glassSelect.selectedIndex];
        glassName = selectedGlass?.text || 'N/A';
      }
      
      let html = `
        <div class="space-y-4">
          <!-- Window Information -->
          <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
            <div class="text-lg font-bold text-blue-900 mb-3">Window Information</div>
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div>
                <span class="font-semibold text-gray-700">Window Reference:</span>
                <span class="ml-2 text-gray-900">${document.getElementById('windowRef')?.value || 'N/A'}</span>
              </div>
              <div>
                <span class="font-semibold text-gray-700">Quantity:</span>
                <span class="ml-2 text-gray-900 font-bold text-lg">${quantity}</span>
              </div>
              <div>
                <span class="font-semibold text-gray-700">Width:</span>
                <span class="ml-2 text-gray-900">${width.toFixed(2)} ${unitLabel}</span>
              </div>
              <div>
                <span class="font-semibold text-gray-700">Height:</span>
                <span class="ml-2 text-gray-900">${height.toFixed(2)} ${unitLabel}</span>
              </div>
            </div>
          </div>

          <!-- Glass Production -->
          <div class="bg-green-50 p-4 rounded-lg border border-green-200">
            <div class="text-lg font-bold text-green-900 mb-3">Glass Production</div>
            <div class="space-y-2 text-sm">
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <span class="font-semibold text-gray-700">Glass Type:</span>
                  <span class="ml-2 text-gray-900">${glassName}</span>
                </div>
                <div>
                  <span class="font-semibold text-gray-700">Quantity:</span>
                  <span class="ml-2 text-gray-900 font-bold">${quantity}</span>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <span class="font-semibold text-gray-700">Glass Width:</span>
                  <span class="ml-2 text-gray-900">${currentUnit === 'mm' ? ((details.glassWidthInches || width) * 25.4).toFixed(2) : (details.glassWidthInches || width).toFixed(2)} ${unitLabel}</span>
                  ${details.glassWidthEquation ? `<div class="text-xs text-gray-500 mt-1">Equation: ${details.glassWidthEquation}</div>` : ''}
                </div>
                <div>
                  <span class="font-semibold text-gray-700">Glass Height:</span>
                  <span class="ml-2 text-gray-900">${currentUnit === 'mm' ? ((details.glassHeightInches || height) * 25.4).toFixed(2) : (details.glassHeightInches || height).toFixed(2)} ${unitLabel}</span>
                  ${details.glassHeightEquation ? `<div class="text-xs text-gray-500 mt-1">Equation: ${details.glassHeightEquation}</div>` : ''}
                </div>
              </div>
              <div>
                <span class="font-semibold text-gray-700">Area per unit:</span>
                <span class="ml-2 text-gray-900">${(details.glassAreaSquareMeters || details.areaSquareMeters || 0).toFixed(4)} m²</span>
              </div>
            </div>
          </div>

          <!-- Profiles Production -->
          <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
            <div class="text-lg font-bold text-purple-900 mb-3">Profiles Production</div>
            <div class="space-y-3">
              ${details.profiles.length > 0 ? details.profiles.map((profile, idx) => {
                // Convert length to inches for display if needed
                const lengthInches = (profile.lengthMeters || 0) / 0.0254;
                const lengthMM = (profile.lengthMeters || 0) * 1000;
                return `
                  <div class="bg-white p-3 rounded border border-purple-300">
                    <div class="font-semibold text-purple-800 mb-2">${profile.name}</div>
                    <div class="grid grid-cols-3 gap-3 text-sm">
                      <div>
                        <span class="text-gray-600">Quantity:</span>
                        <span class="ml-2 font-bold text-lg">${profile.quantity}</span>
                      </div>
                      <div>
                        <span class="text-gray-600">Length (m):</span>
                        <span class="ml-2 font-semibold">${(profile.lengthMeters || 0).toFixed(4)}</span>
                      </div>
                      <div>
                        <span class="text-gray-600">Length (${unitLabel}):</span>
                        <span class="ml-2 font-semibold">${currentUnit === 'mm' ? lengthMM.toFixed(2) : lengthInches.toFixed(2)}</span>
                      </div>
                    </div>
                    ${quantity > 1 ? `
                      <div class="mt-2 pt-2 border-t border-purple-200 text-xs text-gray-600">
                        <span class="font-semibold">Total Length (${quantity} units):</span>
                        <span class="ml-2">${((profile.lengthMeters || 0) * profile.quantity * quantity).toFixed(4)} m</span>
                      </div>
                    ` : ''}
                  </div>
                `;
              }).join('') : '<div class="text-gray-500 italic text-sm">No profiles configured</div>'}
            </div>
          </div>

          <!-- Accessories Production -->
          <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
            <div class="text-lg font-bold text-yellow-900 mb-3">Accessories Production</div>
            <div class="space-y-2">
              ${details.accessories.length > 0 ? details.accessories.map((acc, idx) => `
                <div class="bg-white p-3 rounded border border-yellow-300">
                  <div class="grid grid-cols-2 gap-3 text-sm">
                    <div>
                      <span class="font-semibold text-gray-700">${acc.name}</span>
                    </div>
                    <div>
                      <span class="text-gray-600">Quantity:</span>
                      <span class="ml-2 font-bold text-lg">${acc.quantity}</span>
                      ${quantity > 1 ? `<span class="text-xs text-gray-500 ml-2">(${acc.quantity * quantity} total for ${quantity} units)</span>` : ''}
                    </div>
                  </div>
                </div>
              `).join('') : '<div class="text-gray-500 italic text-sm">No accessories configured</div>'}
            </div>
          </div>

          ${details.muntinCost > 0 && details.muntinDetails ? `
          <!-- Muntins Production -->
          <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
            <div class="text-lg font-bold text-indigo-900 mb-3">Muntins Production</div>
            <div class="space-y-2 text-sm">
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <span class="font-semibold text-gray-700">Profile:</span>
                  <span class="ml-2 text-gray-900">${details.muntinDetails.name || 'N/A'}</span>
                </div>
                <div>
                  <span class="font-semibold text-gray-700">Quantity:</span>
                  <span class="ml-2 text-gray-900 font-bold">${quantity}</span>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <span class="font-semibold text-gray-700">Horizontal Divisions:</span>
                  <span class="ml-2 text-gray-900">${details.muntinDetails.horizontal || 'N/A'}</span>
                </div>
                <div>
                  <span class="font-semibold text-gray-700">Vertical Divisions:</span>
                  <span class="ml-2 text-gray-900">${details.muntinDetails.vertical || 'N/A'}</span>
                </div>
              </div>
              <div>
                <span class="font-semibold text-gray-700">Total Length:</span>
                <span class="ml-2 text-gray-900">${(details.muntinDetails.length || 0).toFixed(4)} m</span>
              </div>
            </div>
          </div>
          ` : ''}

          <!-- Summary -->
          <div class="bg-gray-100 p-4 rounded-lg border border-gray-300">
            <div class="text-lg font-bold text-gray-900 mb-2">Production Summary</div>
            <div class="text-sm space-y-1 text-gray-700">
              <div>Total Units to Produce: <span class="font-bold text-lg">${quantity}</span></div>
              <div>Total Profiles: <span class="font-semibold">${details.profiles.reduce((sum, p) => sum + (p.quantity || 0), 0) * quantity}</span></div>
              <div>Total Accessories: <span class="font-semibold">${details.accessories.reduce((sum, a) => sum + (a.quantity || 0), 0) * quantity}</span></div>
              <div>Total Glass Panels: <span class="font-semibold">${quantity}</span></div>
            </div>
          </div>
        </div>
      `;

      modalContent.innerHTML = html;
    }
  </script>

  <!-- Calculation Details Modal -->
  <div id="calculationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
      <div class="bg-blue-600 text-white px-6 py-4 flex justify-between items-center">
        <h2 class="text-xl font-bold">Detailed Calculation Breakdown</h2>
        <button onclick="closeCalculationModal()" class="text-white hover:text-gray-200 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="overflow-y-auto p-6 flex-1" id="calculationModalContent">
        <!-- Content will be populated by JavaScript -->
      </div>
      <div class="bg-gray-100 px-6 py-4 flex justify-end">
        <button onclick="closeCalculationModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Workshop Modal -->
  <div id="workshopModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
      <div class="bg-green-600 text-white px-6 py-4 flex justify-between items-center">
        <h2 class="text-xl font-bold">Workshop Production Details</h2>
        <button onclick="closeWorkshopModal()" class="text-white hover:text-gray-200 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="overflow-y-auto p-6 flex-1" id="workshopModalContent">
        <!-- Content will be populated by JavaScript -->
      </div>
      <div class="bg-gray-100 px-6 py-4 flex justify-end">
        <button onclick="closeWorkshopModal()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Close modals when clicking outside -->
  <script>
    document.getElementById('calculationModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeCalculationModal();
      }
    });
    
    document.getElementById('workshopModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeWorkshopModal();
      }
    });
  </script>
</body>
</html>
 