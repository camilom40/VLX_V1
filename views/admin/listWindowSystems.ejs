<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/_head.ejs') %>
  <title>Window Systems</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Window Card Preview */
    .window-card {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: all 0.3s ease;
      border: 1px solid #e5e7eb;
    }
    .window-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    /* Preview Styles */
    .preview-container {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      padding: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 140px;
    }
    .window-preview {
      border-radius: 6px;
      overflow: hidden;
      background: linear-gradient(145deg, #707070, #505050);
      padding: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .window-preview-glass {
      width: 120px;
      height: 90px;
      display: flex;
      background: linear-gradient(180deg, rgba(186,230,253,0.85) 0%, rgba(147,197,253,0.7) 50%, rgba(186,230,253,0.8) 100%);
      border-radius: 3px;
      position: relative;
    }
    .window-preview-glass::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, transparent 50%);
      pointer-events: none;
    }
    .preview-panel {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: rgba(30,64,175,0.6);
      position: relative;
    }
    .preview-panel.operable {
      color: rgba(22,101,52,0.7);
    }
    .preview-mullion {
      width: 4px;
      background: linear-gradient(180deg, #606060, #909090, #606060);
      flex-shrink: 0;
    }
    .preview-mullion-h {
      height: 4px;
      width: 100%;
      background: linear-gradient(90deg, #606060, #909090, #606060);
      flex-shrink: 0;
    }
    
    /* Operation Type Badge */
    .operation-badge {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 4px 8px;
      border-radius: 6px;
    }
    .operation-badge.sliding { background: #dbeafe; color: #1e40af; }
    .operation-badge.casement { background: #dcfce7; color: #166534; }
    .operation-badge.fixed { background: #f3f4f6; color: #4b5563; }
    .operation-badge.single-hung { background: #fef3c7; color: #92400e; }
    .operation-badge.french-door { background: #fce7f3; color: #9d174d; }
    
    /* Search Input */
    .search-input {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px 16px 12px 44px;
      width: 100%;
      max-width: 400px;
      font-size: 14px;
      transition: all 0.2s;
    }
    .search-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      background: white;
      border-radius: 16px;
      border: 2px dashed #e5e7eb;
    }
  </style>
  <script>
    async function handleImportFormSubmit(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      try {
        const response = await fetch('/admin/import-window-systems', {
          method: 'POST',
          body: formData
        });
        const result = await response.json();
        alert(result.message);
        if (response.ok) {
          location.reload();
        }
      } catch (error) {
        console.error('Failed to import data:', error);
        alert('Failed to import data');
        location.reload();
      }
    }

    async function deleteWindowSystem(id, name) {
      if (confirm(`Are you sure you want to delete "${name}"?`)) {
        try {
          const response = await fetch(`/admin/delete/${id}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
            },
          });
          const result = await response.json();
          if (response.ok) {
            location.reload();
          } else {
            alert(result.message || 'Failed to delete');
          }
        } catch (error) {
          console.error('Error deleting window system:', error);
          alert('Failed to delete window system');
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('searchInput');
      searchInput.addEventListener('keyup', function() {
        const filter = searchInput.value.toLowerCase();
        const cards = document.querySelectorAll('.window-card');
        let visibleCount = 0;
        cards.forEach(card => {
          const text = card.innerText.toLowerCase();
          if (text.includes(filter)) {
            card.style.display = '';
            visibleCount++;
          } else {
            card.style.display = 'none';
          }
        });
        document.getElementById('resultCount').textContent = visibleCount;
      });
    });
  </script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <%- include('../partials/_header.ejs') %>
  
  <div class="container mx-auto px-4 py-8 flex-grow">
    
    <!-- Page Header -->
    <div class="mb-8">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">Window Systems</h1>
          <p class="text-gray-500 mt-1">Manage your window system templates</p>
        </div>
        <a href="/admin/compose-window" class="inline-flex items-center px-5 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-lg shadow-blue-500/30 transition-all">
          <i class="fas fa-plus mr-2"></i>
          New Window System
        </a>
      </div>
      
      <!-- Search and Actions Bar -->
      <div class="flex flex-wrap items-center justify-between gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
        <div class="relative flex-1 max-w-md">
          <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
          <input type="text" id="searchInput" placeholder="Search window systems..." class="search-input">
        </div>
        
        <div class="flex items-center gap-3">
          <span class="text-sm text-gray-500">
            <span id="resultCount"><%= windowSystems.length %></span> systems
          </span>
          
          <div class="h-6 w-px bg-gray-200"></div>
          
          <a href="/admin/export-window-systems" class="inline-flex items-center px-4 py-2 bg-emerald-50 hover:bg-emerald-100 text-emerald-700 font-medium rounded-lg transition-colors text-sm">
            <i class="fas fa-file-export mr-2"></i>Export
          </a>
          
          <form id="import-form" onsubmit="handleImportFormSubmit(event)" method="POST" enctype="multipart/form-data" class="flex items-center gap-2">
            <label class="inline-flex items-center px-4 py-2 bg-gray-50 hover:bg-gray-100 text-gray-700 font-medium rounded-lg cursor-pointer transition-colors text-sm">
              <i class="fas fa-file-import mr-2"></i>Import
              <input type="file" name="file" accept=".xlsx" class="hidden" onchange="this.form.submit()">
            </label>
          </form>
        </div>
      </div>
    </div>
    
    <!-- Window Systems Grid -->
    <% if (windowSystems.length > 0) { %>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        <% windowSystems.forEach(function(windowSystem) { %>
          <% 
            const panelConfig = windowSystem.panelConfiguration || {};
            const panels = panelConfig.panels || ['O', 'O'];
            const orientation = panelConfig.orientation || 'horizontal';
            const operationType = panelConfig.operationType || 'sliding';
            const isVertical = orientation === 'vertical';
            const isFrenchDoor = operationType === 'french-door';
            
            // Get operation badge class
            let badgeClass = 'sliding';
            if (operationType === 'casement') badgeClass = 'casement';
            else if (operationType === 'fixed') badgeClass = 'fixed';
            else if (operationType === 'single-hung') badgeClass = 'single-hung';
            else if (operationType === 'french-door') badgeClass = 'french-door';
            
            // Format operation type for display
            let operationDisplay = operationType.replace('-', ' ');
            operationDisplay = operationDisplay.charAt(0).toUpperCase() + operationDisplay.slice(1);
          %>
          <div class="window-card">
            <!-- Preview -->
            <div class="preview-container">
              <div class="window-preview">
                <div class="window-preview-glass" style="flex-direction: <%= isVertical ? 'column' : 'row' %>;">
                  <% if (isFrenchDoor) { %>
                    <div class="preview-panel operable">
                      <i class="fas fa-door-open text-2xl" style="color: rgba(107,114,128,0.6);"></i>
                    </div>
                  <% } else { %>
                    <% panels.forEach((panel, idx) => { %>
                      <div class="preview-panel <%= panel === 'X' ? 'operable' : '' %>">
                        <%= panel %>
                      </div>
                      <% if (idx < panels.length - 1) { %>
                        <div class="<%= isVertical ? 'preview-mullion-h' : 'preview-mullion' %>"></div>
                      <% } %>
                    <% }); %>
                  <% } %>
                </div>
              </div>
            </div>
            
            <!-- Card Content -->
            <div class="p-4">
              <div class="flex items-start justify-between mb-3">
                <h3 class="font-semibold text-gray-900 text-lg leading-tight"><%= windowSystem.type %></h3>
              </div>
              
              <div class="flex items-center gap-2 mb-4">
                <span class="operation-badge <%= badgeClass %>"><%= operationDisplay %></span>
                <span class="text-xs text-gray-400 font-mono"><%= panels.join('') %></span>
              </div>
              
              <!-- Actions -->
              <div class="flex items-center gap-2 pt-3 border-t border-gray-100">
                <a href="/admin/edit/<%= windowSystem._id %>" class="flex-1 inline-flex items-center justify-center px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition-colors text-sm">
                  <i class="fas fa-edit mr-1.5"></i>Edit
                </a>
                <button type="button" onclick="deleteWindowSystem('<%= windowSystem._id %>', '<%= windowSystem.type.replace(/'/g, "\\'") %>')" class="inline-flex items-center justify-center px-3 py-2 bg-red-100 hover:bg-red-200 text-red-700 font-medium rounded-lg transition-colors text-sm border border-red-200">
                  <i class="fas fa-trash-alt mr-1.5"></i>Delete
                </button>
              </div>
            </div>
          </div>
        <% }); %>
      </div>
    <% } else { %>
      <!-- Empty State -->
      <div class="empty-state">
        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
          <i class="fas fa-window-maximize text-3xl text-gray-400"></i>
        </div>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">No Window Systems Yet</h3>
        <p class="text-gray-500 mb-6 max-w-md mx-auto">
          Create your first window system template to start building quotes.
        </p>
        <a href="/admin/compose-window" class="inline-flex items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition-colors">
          <i class="fas fa-plus mr-2"></i>
          Create Window System
        </a>
      </div>
    <% } %>
    
    <!-- Back Button -->
    <div class="mt-8 text-center">
      <a href="/admin" class="inline-flex items-center px-5 py-2.5 text-gray-600 hover:text-gray-900 font-medium transition-colors">
        <i class="fas fa-arrow-left mr-2"></i>
        Back to Admin Console
      </a>
    </div>
    
  </div>

  <%- include('../partials/_footer.ejs') %>
</body>
</html>
