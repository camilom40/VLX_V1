<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/_head.ejs') %>
  <title>Global Cost Settings</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .pattern-bg {
      background-color: #f8fafc;
      background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
      background-size: 20px 20px;
    }
    
    body { font-family: 'DM Sans', sans-serif; }
    
    .main-card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      border: 1px solid #e5e7eb;
      transition: all 0.3s ease;
      overflow: hidden;
      position: relative;
    }
    
    .main-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(to right, #3b82f6, #60a5fa);
    }
    
    .form-section {
      background: white;
      border-radius: 0.75rem;
      padding: 1.25rem;
      margin-bottom: 1rem;
      border: 1px solid #e5e7eb;
      transition: all 0.3s ease;
    }
    .form-section:hover { 
      border-color: #cbd5e1; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transform: translateY(-2px);
    }
    .form-section.!mb-0 { margin-bottom: 0; }
    
    .section-icon {
      width: 2.25rem; height: 2.25rem;
      border-radius: 0.625rem;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    
    .form-input {
      width: 100%;
      padding: 0.75rem 2.5rem 0.75rem 2.75rem;
      border-radius: 0.5rem;
      border: 2px solid #e5e7eb;
      background: #f9fafb;
      color: #1f2937;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }
    .form-input:hover { border-color: #d1d5db; background: #fff; }
    .form-input:focus { outline: none; border-color: #3b82f6; background: #fff; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    
    .input-with-icon { position: relative; width: 100%; }
    .input-icon {
      position: absolute; left: 0.875rem; top: 50%; transform: translateY(-50%);
      color: #64748b; pointer-events: none; z-index: 10; transition: color 0.2s;
    }
    .input-with-icon:focus-within .input-icon { color: #3b82f6; }
    .input-icon svg { width: 1.125rem; height: 1.125rem; }
    .currency-suffix {
      position: absolute; right: 0.875rem; top: 50%; transform: translateY(-50%);
      color: #64748b; pointer-events: none; z-index: 10; font-size: 0.9rem; font-weight: 500;
    }
    .input-with-icon:focus-within .currency-suffix { color: #3b82f6; }
    
    select.form-input {
      appearance: none; cursor: pointer; padding-right: 2.5rem;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.125rem;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
      color: white; font-weight: 600; padding: 0.75rem 1.75rem;
      border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(59,130,246,0.3);
      transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem;
      border: none;
    }
    .btn-primary:hover { 
      background: linear-gradient(135deg, #2563eb, #3b82f6); 
      box-shadow: 0 10px 15px -3px rgba(59,130,246,0.4); 
      transform: translateY(-2px); 
    }
    
    .btn-secondary {
      background: white; color: #4b5563; font-weight: 600;
      padding: 0.75rem 1.25rem; border-radius: 0.5rem;
      border: 2px solid #e5e7eb; transition: all 0.3s ease;
      display: inline-flex; align-items: center; gap: 0.5rem;
    }
    .btn-secondary:hover { 
      background: #f9fafb; 
      border-color: #d1d5db; 
      transform: translateY(-1px);
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }
    
    .required-badge {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      color: #92400e; font-size: 0.6rem; font-weight: 700;
      padding: 0.2rem 0.4rem; border-radius: 0.3rem;
      margin-left: 0.4rem; text-transform: uppercase; letter-spacing: 0.05em;
    }
    
    .help-text { color: #64748b; font-size: 0.75rem; margin-top: 0.375rem; }
    
    .currency-display {
      background: linear-gradient(135deg, #eff6ff, #dbeafe);
      border: 2px solid #3b82f6;
      border-radius: 0.75rem;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(59,130,246,0.1);
    }
  </style>
  <script>
    // Server data passed to client
    var currentExchangeRateValue = <%= currentExchangeRate || 4000 %>;
    // Database stores all values in USD
    var valuesInUSD = {
      seaFreight: <%= costSettings ? (costSettings.seaFreight || 0) : 0 %>,
      landFreight: <%= costSettings ? (costSettings.landFreight || 0) : 0 %>,
      packaging: <%= costSettings ? (costSettings.packaging || 0) : 0 %>,
      labor: <%= costSettings ? (costSettings.labor || 0) : 0 %>,
      indirectCosts: <%= costSettings ? (costSettings.indirectCosts || 0) : 0 %>,
      administrativeExpenses: <%= costSettings ? (costSettings.administrativeExpenses || 0) : 0 %>
    };
    
    // Store current USD values (will be updated when user edits)
    window.storedUSDValues = JSON.parse(JSON.stringify(valuesInUSD));
    
    // Helper function to format numbers with commas
    function formatNumberWithCommas(number, isPercentage = false) {
      if (isPercentage) {
        return number.toString();
      }
      // Format with commas, handling decimals
      const numStr = number.toString();
      const parts = numStr.split('.');
      parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      return parts.join('.');
    }
    
    // Simple currency update function - uses global currency preference
    // Database stores values in USD, so we convert for display
    function updateCurrencyLabels() {
      // Get currency from global preference
      var currency = window.globalPreferences?.currency || localStorage.getItem('globalCurrency') || 'COP';
      var exchangeRate = currentExchangeRateValue;
      var previousCurrency = window.lastSelectedCurrency;
      
      // Initialize previousCurrency if not set
      if (!previousCurrency) {
        previousCurrency = currency;
      }
      
      // Update hidden currency field
      var currencyInput = document.getElementById('currency');
      if (currencyInput) {
        currencyInput.value = currency;
      }
      
      // Update labels and convert values
      var currencyFields = ['seaFreight', 'landFreight', 'administrativeExpenses'];
      var percentageFields = ['packaging', 'labor', 'indirectCosts'];
      
      // Update labels for all fields
      var allFields = currencyFields.concat(percentageFields);
      for (var i = 0; i < allFields.length; i++) {
        var fieldId = allFields[i];
        var label = document.getElementById(fieldId + '-currency');
        var suffix = document.getElementById(fieldId + '-suffix');
        var isPercentage = percentageFields.includes(fieldId);
        
        if (label) {
          // For percentage fields, don't show currency
          if (isPercentage) {
            label.textContent = 'Enter percentage value';
          } else {
            label.textContent = 'Enter amount in ' + currency;
          }
        }
        
        // Update currency suffix in input field
        if (suffix && !isPercentage) {
          suffix.textContent = currency;
        } else if (suffix && isPercentage) {
          suffix.textContent = '%';
        }
      }
      
      // Only convert currency fields when currency changes
      if (previousCurrency !== currency) {
        for (var i = 0; i < currencyFields.length; i++) {
          var fieldId = currencyFields[i];
          var input = document.getElementById(fieldId);
          
          if (input) {
            // Get current displayed value
            var currentDisplayValue = parseFloat(input.value.replace(/[^0-9.-]/g, ''));
            
            // If we have a valid value, first convert it back to USD
            if (!isNaN(currentDisplayValue) && currentDisplayValue > 0) {
              var valueInUSD;
              
              // Convert current displayed value back to USD
              if (previousCurrency === 'COP') {
                valueInUSD = currentDisplayValue / exchangeRate;
              } else {
                valueInUSD = currentDisplayValue;
              }
              
              // Update stored USD value
              window.storedUSDValues[fieldId] = valueInUSD;
            }
            
            // Now convert from USD to display currency
            var usdValue = window.storedUSDValues[fieldId] || 0;
            var displayValue;
            
            if (currency === 'COP') {
              displayValue = usdValue * exchangeRate;
            } else {
              displayValue = usdValue;
            }
            
            // Update input with converted value (formatted with commas)
            if (currency === 'USD') {
              input.value = formatNumberWithCommas(displayValue.toFixed(2), false);
            } else {
              input.value = formatNumberWithCommas(Math.round(displayValue).toString(), false);
            }
          }
        }
      }
      
      // Percentage fields are NEVER converted - they stay exactly as they are
      
      // Show notification
      if (previousCurrency !== currency) {
        var notification = document.createElement('div');
        notification.style.cssText = 'position:fixed;top:20px;right:20px;background:#2563eb;color:white;padding:12px;border-radius:8px;z-index:1000;';
        notification.textContent = 'Currency changed to ' + currency;
        document.body.appendChild(notification);
        
        setTimeout(function() {
          if (notification.parentNode) {
            document.body.removeChild(notification);
          }
        }, 3000);
      }
      
      window.lastSelectedCurrency = currency;
      updateCostImpact();
    }
    
    // Update stored USD values when user edits fields
    function updateStoredUSDValue(fieldId, displayValue, currency) {
      var exchangeRate = currentExchangeRateValue;
      if (currency === 'COP') {
        window.storedUSDValues[fieldId] = displayValue / exchangeRate;
      } else {
        window.storedUSDValues[fieldId] = displayValue;
      }
    }

    function updateTime() {
      const now = new Date();
      const timeElement = document.getElementById('current-time');
      if (timeElement) {
        timeElement.textContent = now.toLocaleString();
      }
    }

    function formatCurrency(value) {
      if (!value || value === '') return '';
      const number = parseFloat(value.toString().replace(/[^0-9.-]+/g, ""));
      if (isNaN(number)) return '';
      return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function formatInput(event) {
      const input = event.target;
      // Remove commas and other non-numeric characters except decimal point
      let value = input.value.replace(/[^0-9.]/g, '');
      
      // Prevent multiple decimal points
      const parts = value.split('.');
      if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
      }
      
      // Update the input value (allows multi-digit input, no commas while typing)
      input.value = value;
      
      // Update stored USD value (only for currency fields, not percentages)
      const numericValue = parseFloat(value);
      if (!isNaN(numericValue)) {
        const isPercentage = ['packaging', 'labor', 'indirectCosts'].includes(input.id);
        if (!isPercentage) {
          const currency = window.globalPreferences?.currency || localStorage.getItem('globalCurrency') || 'COP';
          updateStoredUSDValue(input.id, numericValue, currency);
        } else {
          // For percentage fields, store directly (they're already in the correct format)
          window.storedUSDValues[input.id] = numericValue;
        }
      }
      
      // Update cost impact when value changes
      updateCostImpact();
    }
    
    function formatInputOnBlur(event) {
      const input = event.target;
      const value = input.value.replace(/[^0-9.-]+/g, '');
      if (value && value !== '') {
        const number = parseFloat(value);
        if (!isNaN(number)) {
          // For percentage fields (packaging, labor, indirectCosts), don't add commas
          const isPercentage = ['packaging', 'labor', 'indirectCosts'].includes(input.id);
          if (isPercentage) {
            input.value = number.toString();
          } else {
            // Format with commas for currency fields
            // Handle decimal places
            const parts = number.toString().split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            input.value = parts.join('.');
          }
        }
      }
    }
    
    function cleanCurrency(value) {
      return parseFloat(value.replace(/[$,]/g, ''));
    }

    function cleanFormValues() {
      // Convert currency fields to USD before submitting
      const currencyFields = ['seaFreight', 'landFreight', 'administrativeExpenses'];
      const percentageFields = ['packaging', 'labor', 'indirectCosts'];
      const currency = window.globalPreferences?.currency || localStorage.getItem('globalCurrency') || 'COP';
      const exchangeRate = currentExchangeRateValue;
      
      // Convert currency fields to USD
      currencyFields.forEach(field => {
        const input = document.getElementById(field);
        if (input) {
          // Get current displayed value
          const displayValue = parseFloat(input.value.replace(/[^0-9.-]/g, ''));
          
          if (!isNaN(displayValue)) {
            // Convert to USD
            let usdValue;
            if (currency === 'COP') {
              usdValue = displayValue / exchangeRate;
            } else {
              usdValue = displayValue;
            }
            
            // Set the USD value in the form (will be submitted)
            input.value = usdValue.toString();
          } else {
            input.value = cleanCurrency(input.value);
          }
        }
      });
      
      // Percentage fields stay as-is (no conversion needed)
      percentageFields.forEach(field => {
        const input = document.getElementById(field);
        if (input) {
          // Just clean the value (remove commas)
          const value = input.value.replace(/[^0-9.-]/g, '');
          input.value = value;
        }
      });
    }

    // Cost impact calculator - shows general cost impact
    function calculateCostImpact() {
      // Get current cost settings (remove commas and parse)
      function getNumericValue(id) {
        const el = document.getElementById(id);
        if (!el) return 0;
        const value = el.value.toString().replace(/[^0-9.-]+/g, '');
        return parseFloat(value) || 0;
      }
      
      const packaging = getNumericValue('packaging');
      const labor = getNumericValue('labor');
      const indirectCosts = getNumericValue('indirectCosts');
      const seaFreight = getNumericValue('seaFreight');
      const landFreight = getNumericValue('landFreight');
      const administrativeExpenses = getNumericValue('administrativeExpenses');
      
      return {
        packagingPercent: packaging,
        laborPercent: labor,
        indirectPercent: indirectCosts,
        seaFreight: seaFreight,
        landFreight: landFreight,
        administrativeExpenses: administrativeExpenses,
        totalPercentage: packaging + labor + indirectCosts
      };
    }
    
    function updateCostImpact() {
      const impact = calculateCostImpact();
      const currency = window.globalPreferences?.currency || localStorage.getItem('globalCurrency') || 'COP';
      
      // Update packaging impact
      const packagingImpactEl = document.getElementById('packaging-impact');
      const packagingContainer = document.getElementById('packaging-impact-container');
      if (packagingImpactEl && packagingContainer) {
        if (impact.packagingPercent > 0) {
          packagingImpactEl.textContent = `Adds ${impact.packagingPercent}% to base cost of each window`;
          packagingContainer.style.display = 'block';
        } else {
          packagingContainer.style.display = 'none';
        }
      }
      
      // Update labor impact
      const laborImpactEl = document.getElementById('labor-impact');
      const laborContainer = document.getElementById('labor-impact-container');
      if (laborImpactEl && laborContainer) {
        if (impact.laborPercent > 0) {
          laborImpactEl.textContent = `Adds ${impact.laborPercent}% to base cost of each window`;
          laborContainer.style.display = 'block';
        } else {
          laborContainer.style.display = 'none';
        }
      }
      
      // Update indirect costs impact
      const indirectImpactEl = document.getElementById('indirect-impact');
      const indirectContainer = document.getElementById('indirect-impact-container');
      if (indirectImpactEl && indirectContainer) {
        if (impact.indirectPercent > 0) {
          indirectImpactEl.textContent = `Adds ${impact.indirectPercent}% to base cost of each window`;
          indirectContainer.style.display = 'block';
        } else {
          indirectContainer.style.display = 'none';
        }
      }
      
      // Update total impact summary
      const totalImpactEl = document.getElementById('total-impact');
      if (totalImpactEl) {
        let summaryHtml = '<div class="text-sm text-gray-700 mb-2 font-semibold">Cost Settings Summary:</div>';
        
        // Per-Window Percentages Section
        summaryHtml += `<div class="text-xs text-gray-600 mb-3 pl-2 border-l-2 border-blue-300">
          <div class="font-semibold mb-1 text-blue-700">Per-Window Costs (Percentages):</div>`;
        
        if (impact.packagingPercent > 0 || impact.laborPercent > 0 || impact.indirectPercent > 0) {
          if (impact.packagingPercent > 0) {
            summaryHtml += `<div>• Packaging: <span class="font-semibold">${impact.packagingPercent}%</span> of base cost</div>`;
          }
          if (impact.laborPercent > 0) {
            summaryHtml += `<div>• Labor: <span class="font-semibold">${impact.laborPercent}%</span> of base cost</div>`;
          }
          if (impact.indirectPercent > 0) {
            summaryHtml += `<div>• Indirect Costs: <span class="font-semibold">${impact.indirectPercent}%</span> of base cost</div>`;
          }
          if (impact.totalPercentage > 0) {
            summaryHtml += `<div class="font-semibold mt-1 text-blue-800">Total: ${impact.totalPercentage}% added to each window's base cost</div>`;
          }
        } else {
          summaryHtml += `<div class="text-gray-400 italic">No percentages set</div>`;
        }
        
        summaryHtml += `</div>`;
        
        // Per-Container Dollar Amounts Section
        summaryHtml += `<div class="text-xs text-gray-600 mb-2 pl-2 border-l-2 border-green-300">
          <div class="font-semibold mb-1 text-green-700">Per-Container Costs (Fixed Amounts):</div>`;
        
        if (impact.seaFreight > 0 || impact.landFreight > 0 || impact.administrativeExpenses > 0) {
          if (impact.seaFreight > 0) {
            const formatted = formatNumberWithCommas(Math.round(impact.seaFreight));
            summaryHtml += `<div>• Sea Freight: <span class="font-semibold">${formatted} ${currency}</span> per container</div>`;
          }
          if (impact.landFreight > 0) {
            const formatted = formatNumberWithCommas(Math.round(impact.landFreight));
            summaryHtml += `<div>• Land Freight: <span class="font-semibold">${formatted} ${currency}</span> per container</div>`;
          }
          if (impact.administrativeExpenses > 0) {
            const formatted = formatNumberWithCommas(Math.round(impact.administrativeExpenses));
            summaryHtml += `<div>• Administrative Expenses: <span class="font-semibold">${formatted} ${currency}</span> per container</div>`;
          }
        } else {
          summaryHtml += `<div class="text-gray-400 italic">No amounts set</div>`;
        }
        
        summaryHtml += `</div>`;
        
        summaryHtml += `<div class="text-xs text-gray-500 mt-2 italic border-t pt-2">These settings apply to all window quotations.</div>`;
        
        totalImpactEl.innerHTML = summaryHtml;
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Initialize with global currency preference
      var currency = window.globalPreferences?.currency || localStorage.getItem('globalCurrency') || 'COP';
      
      // Convert initial values from USD to display currency
      var exchangeRate = currentExchangeRateValue;
      var currencyFields = ['seaFreight', 'landFreight', 'administrativeExpenses'];
      var percentageFields = ['packaging', 'labor', 'indirectCosts'];
      
      // Convert currency fields
      currencyFields.forEach(function(fieldId) {
        var input = document.getElementById(fieldId);
        if (input) {
          var usdValue = window.storedUSDValues[fieldId] || 0;
          var displayValue;
          
          if (currency === 'COP') {
            displayValue = usdValue * exchangeRate;
          } else {
            displayValue = usdValue;
          }
          
          // Set display value (formatted with commas)
          if (currency === 'USD') {
            input.value = formatNumberWithCommas(displayValue.toFixed(2), false);
          } else {
            input.value = formatNumberWithCommas(Math.round(displayValue).toString(), false);
          }
        }
      });
      
      // Display percentage fields as-is (no conversion, use stored value directly)
      percentageFields.forEach(function(fieldId) {
        var input = document.getElementById(fieldId);
        if (input) {
          // Get the stored value (which is the percentage, not USD)
          var value = window.storedUSDValues[fieldId];
          // If value exists and is not zero, use it; otherwise keep what's in the input
          if (value !== undefined && value !== null && value !== '') {
            input.value = value.toString();
          }
          // If input already has a value, don't overwrite it
        }
      });
      
      window.lastSelectedCurrency = currency;
      updateCurrencyLabels();
      
      // Listen to global currency changes
      window.addEventListener('currencyChanged', function(event) {
        var newCurrency = event.detail.currency;
        updateCurrencyLabels();
      });
      
      // Add blur handlers for formatting
      const inputs = ['packaging', 'labor', 'indirectCosts', 'seaFreight', 'landFreight', 'administrativeExpenses'];
      inputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
          input.addEventListener('blur', formatInputOnBlur);
          input.addEventListener('input', formatInput);
        }
      });
      
      // Initialize cost impact
      updateCostImpact();
      
      // Initialize time display
      updateTime();
      setInterval(updateTime, 1000);
    });

    async function handleImportFormSubmit(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      try {
        const response = await fetch('/admin/import-settings', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();
        showNotification(result.message, response.ok ? 'success' : 'error');
        if (response.ok) {
          setTimeout(() => {
            location.reload();
          }, 1500);
        }
      } catch (error) {
        console.error('Failed to import data:', error);
        showNotification('Failed to import data: ' + error.message, 'error');
      }
    }

    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} transition-all duration-300 flex items-center z-50`;
      
      const icon = document.createElement('span');
      icon.className = 'mr-2';
      icon.innerHTML = type === 'success' 
        ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>'
        : '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>';
      
      notification.appendChild(icon);
      notification.appendChild(document.createTextNode(message));
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.transform = 'translateY(10px)';
        setTimeout(() => {
          notification.style.opacity = '0';
          notification.style.transform = 'translateY(-10px)';
          setTimeout(() => {
            if (notification.parentNode) {
              document.body.removeChild(notification);
            }
          }, 300);
        }, 4000);
      }, 10);
    }
  </script>
</head>
<body class="pattern-bg min-h-screen flex flex-col">
  <%- include('../partials/_header.ejs') %>
  
  <main class="flex-grow container mx-auto px-4 py-10">
    <div class="max-w-4xl mx-auto">
      <!-- Page Header -->
      <div class="text-center mb-8">
        <div class="flex justify-center mb-4">
          <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-3 rounded-xl shadow-lg transform rotate-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </div>
        </div>
        <h1 class="text-4xl font-bold text-gray-800 mb-2" style="position: relative; display: inline-block;">
          Global Cost Settings
          <span style="position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 80px; height: 4px; background: linear-gradient(to right, #3b82f6, #60a5fa); border-radius: 2px;"></span>
        </h1>
        <p class="mt-6 text-gray-600 max-w-xl mx-auto">Configure system-wide pricing and currency settings</p>
      </div>
      
      <!-- Back Button -->
      <div class="flex justify-end mb-6">
        <a href="/admin" class="btn-secondary">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          Back to Admin Console
        </a>
      </div>

      <!-- Action Buttons -->
      <div class="flex flex-wrap gap-3 mb-6">
        <a href="/admin/export-settings" class="btn-secondary">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
          </svg>
          Export to Excel
        </a>
        
        <form id="import-form" onsubmit="handleImportFormSubmit(event)" method="POST" enctype="multipart/form-data" class="inline-block">
          <label for="import-file" class="btn-secondary cursor-pointer">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
            </svg>
            Import from Excel
          </label>
          <input type="file" id="import-file" name="file" accept=".xlsx" class="hidden" onchange="if(this.files.length) this.form.requestSubmit()">
        </form>
      </div>

      <!-- Success/Error Messages -->
      <% if (typeof success !== 'undefined' && success) { %>
        <div class="mb-6 bg-green-50 border-2 border-green-200 text-green-800 px-4 py-3 rounded-lg flex items-center">
          <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
          </svg>
          <span>Settings saved successfully!</span>
        </div>
      <% } %>
      
      <% if (typeof error !== 'undefined' && error) { %>
        <div class="mb-6 bg-red-50 border-2 border-red-200 text-red-800 px-4 py-3 rounded-lg flex items-center">
          <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
          </svg>
          <span><%= error %></span>
        </div>
      <% } %>

      <!-- Main Form Card -->
      <div class="main-card p-6 mb-5">
        <form method="POST" action="/admin/settings" onsubmit="cleanFormValues()">
          <!-- Hidden currency field - uses global currency preference -->
          <input type="hidden" id="currency" name="currency" value="<%= costSettings.currency || 'COP' %>">
          
          <!-- Currency Settings Row -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <!-- Exchange Rate Display -->
            <div class="form-section !mb-0">
              <div class="flex items-center gap-2.5 mb-3">
                <div class="section-icon bg-green-100 text-green-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                  </svg>
                </div>
                <div>
                  <label class="font-semibold text-gray-800 text-sm">Exchange Rate (USD to COP)</label>
                </div>
              </div>
              <div class="currency-display">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm text-gray-600">Current Rate:</span>
                  <span class="font-bold text-lg text-indigo-700">$1 USD = $<%= (currentExchangeRate || costSettings.exchangeRate || 4000).toLocaleString() %> COP</span>
                </div>
                <p class="text-xs text-gray-500">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  Last updated: <span id="current-time"><%= new Date().toLocaleString() %></span>
                </p>
              </div>
              <p class="help-text">Automatically updated from live market data</p>
            </div>
          </div>

          <!-- Transportation Costs Row -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <!-- Sea Freight -->
            <div class="form-section !mb-0">
              <div class="flex items-center gap-2.5 mb-3">
                <div class="section-icon bg-cyan-100 text-cyan-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 10l2-4h14l2 4M3 10v8h18v-8M5 18h2m10 0h2" />
                  </svg>
                </div>
                <div>
                  <label for="seaFreight" class="font-semibold text-gray-800 text-sm">Sea Freight Per Container</label>
                  <span class="required-badge">Required</span>
                </div>
              </div>
              <div class="input-with-icon">
                <div class="input-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1" />
                  </svg>
                </div>
                <input type="text" id="seaFreight" name="seaFreight" value="<%= costSettings ? costSettings.seaFreight : '' %>" required class="form-input">
              </div>
              <p class="help-text">Cost of shipping one container by sea</p>
              <p id="seaFreight-currency" class="text-xs text-blue-600 font-medium mt-1">Enter amount in <%= costSettings.currency || 'COP' %></p>
            </div>
            
            <!-- Land Freight -->
            <div class="form-section !mb-0">
              <div class="flex items-center gap-2.5 mb-3">
                <div class="section-icon bg-cyan-100 text-cyan-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h8m-8 0a2 2 0 100 4m0-4v10m0 0H6a2 2 0 01-2-2V9a2 2 0 012-2h2m8 0v10m0 0h2a2 2 0 002-2V9a2 2 0 00-2-2h-2" />
                  </svg>
                </div>
                <div>
                  <label for="landFreight" class="font-semibold text-gray-800 text-sm">Land Freight Per Container</label>
                  <span class="required-badge">Required</span>
                </div>
              </div>
              <div class="input-with-icon">
                <div class="input-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1" />
                  </svg>
                </div>
                <input type="text" id="landFreight" name="landFreight" value="<%= costSettings ? costSettings.landFreight : '' %>" required class="form-input">
                <span id="landFreight-suffix" class="currency-suffix"></span>
              </div>
              <p class="help-text">Cost of transporting one container by land</p>
              <p id="landFreight-currency" class="text-xs text-blue-600 font-medium mt-1">Enter amount in <%= costSettings.currency || 'COP' %></p>
            </div>
          </div>

          <!-- Manufacturing Costs Row -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <!-- Packaging -->
            <div class="form-section !mb-0">
              <div class="flex items-center gap-2.5 mb-3">
                <div class="section-icon bg-green-100 text-green-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                  </svg>
                </div>
                <div>
                  <label for="packaging" class="font-semibold text-gray-800 text-sm">Packaging Cost Per Window</label>
                  <span class="required-badge">Required</span>
                </div>
              </div>
              <div class="input-with-icon">
                <div class="input-icon" style="font-size: 1rem; font-weight: 600; color: #64748b;">
                  %
                </div>
                <input type="text" id="packaging" name="packaging" value="<%= costSettings ? costSettings.packaging : '' %>" required class="form-input">
              </div>
              <p class="help-text">Percentage of base cost added for packaging (e.g., 5 = 5%)</p>
              <p id="packaging-currency" class="text-xs text-blue-600 font-medium mt-1">Enter percentage value</p>
              <div id="packaging-impact-container" class="mt-2 p-2 bg-blue-50 border border-blue-200 rounded text-xs" style="display: none;">
                <span class="font-semibold text-blue-800">Cost Impact: </span>
                <span id="packaging-impact" class="text-blue-600"></span>
              </div>
            </div>
            
            <!-- Labor -->
            <div class="form-section !mb-0">
              <div class="flex items-center gap-2.5 mb-3">
                <div class="section-icon bg-green-100 text-green-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                </div>
                <div>
                  <label for="labor" class="font-semibold text-gray-800 text-sm">Labor MOF Per Window</label>
                  <span class="required-badge">Required</span>
                </div>
              </div>
              <div class="input-with-icon">
                <div class="input-icon" style="font-size: 1rem; font-weight: 600; color: #64748b;">
                  %
                </div>
                <input type="text" id="labor" name="labor" value="<%= costSettings ? costSettings.labor : '' %>" required class="form-input">
              </div>
              <p class="help-text">Percentage of base cost added for labor (e.g., 15 = 15%)</p>
              <p id="labor-currency" class="text-xs text-blue-600 font-medium mt-1">Enter percentage value</p>
              <div id="labor-impact-container" class="mt-2 p-2 bg-green-50 border border-green-200 rounded text-xs" style="display: none;">
                <span class="font-semibold text-green-800">Cost Impact: </span>
                <span id="labor-impact" class="text-green-600"></span>
              </div>
            </div>
          </div>

          <!-- Indirect Costs Row -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <!-- Indirect Costs -->
            <div class="form-section !mb-0">
              <div class="flex items-center gap-2.5 mb-3">
                <div class="section-icon bg-green-100 text-green-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                  </svg>
                </div>
                <div>
                  <label for="indirectCosts" class="font-semibold text-gray-800 text-sm">Indirect Costs CIF Per Window</label>
                  <span class="required-badge">Required</span>
                </div>
              </div>
              <div class="input-with-icon">
                <div class="input-icon" style="font-size: 1rem; font-weight: 600; color: #64748b;">
                  %
                </div>
                <input type="text" id="indirectCosts" name="indirectCosts" value="<%= costSettings ? costSettings.indirectCosts : '' %>" required class="form-input">
              </div>
              <p class="help-text">Percentage of base cost added for indirect costs (e.g., 10 = 10%)</p>
              <p id="indirectCosts-currency" class="text-xs text-blue-600 font-medium mt-1">Enter percentage value</p>
              <div id="indirect-impact-container" class="mt-2 p-2 bg-purple-50 border border-purple-200 rounded text-xs" style="display: none;">
                <span class="font-semibold text-purple-800">Cost Impact: </span>
                <span id="indirect-impact" class="text-purple-600"></span>
              </div>
            </div>
            
            <!-- Administrative Expenses -->
            <div class="form-section !mb-0">
              <div class="flex items-center gap-2.5 mb-3">
                <div class="section-icon bg-purple-100 text-purple-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                </div>
                <div>
                  <label for="administrativeExpenses" class="font-semibold text-gray-800 text-sm">Administrative Expenses Per Container</label>
                  <span class="required-badge">Required</span>
                </div>
              </div>
              <div class="input-with-icon">
                <div class="input-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1" />
                  </svg>
                </div>
                <input type="text" id="administrativeExpenses" name="administrativeExpenses" value="<%= costSettings ? costSettings.administrativeExpenses : '' %>" required class="form-input">
                <span id="administrativeExpenses-suffix" class="currency-suffix"></span>
              </div>
              <p class="help-text">Administrative and overhead costs per container</p>
              <p id="administrativeExpenses-currency" class="text-xs text-blue-600 font-medium mt-1">Enter amount in <%= costSettings.currency || 'COP' %></p>
            </div>
          </div>

          <!-- Total Cost Impact Summary -->
          <div class="form-section bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 mb-4">
            <div class="flex items-center gap-2.5 mb-3">
              <div class="section-icon bg-blue-500 text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
              </div>
              <div>
                <label class="font-semibold text-gray-800 text-base">Total Cost Impact Preview</label>
              </div>
            </div>
            <div id="total-impact" class="p-3 bg-white rounded-lg border border-blue-200">
              <div class="text-sm text-gray-600">Enter values above to see cost impact</div>
            </div>
            <p class="help-text mt-2">These general cost settings will be applied to all window quotations</p>
          </div>

          <!-- Form Actions -->
          <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
            <a href="/admin" class="btn-secondary">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
              Cancel
            </a>
            <button type="submit" class="btn-primary">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
              Save Settings
            </button>
          </div>
        </form>
      </div>
    </div>
  </main>
  
  <%- include('../partials/_footer.ejs') %>
</body>
</html>
