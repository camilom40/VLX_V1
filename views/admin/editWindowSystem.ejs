<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/_head.ejs') %>
  <title>Edit Window System - <%= windowSystem.type %></title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Step Navigation */
    .step-nav {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 2rem;
    }
    .step-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 12px;
      background: #f3f4f6;
      color: #6b7280;
      font-weight: 500;
      transition: all 0.3s;
      cursor: pointer;
    }
    .step-item:hover {
      background: #e5e7eb;
    }
    .step-item.active {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    .step-item.completed {
      background: #dcfce7;
      color: #166534;
    }
    .step-number {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      background: rgba(255,255,255,0.2);
    }
    .step-item.active .step-number {
      background: rgba(255,255,255,0.3);
    }
    .step-item.completed .step-number {
      background: #166534;
      color: white;
    }
    
    /* Form Sections */
    .form-section {
      display: none;
    }
    .form-section.active {
      display: block;
    }
    
    /* Live Preview Styles */
    .preview-frame {
      background: linear-gradient(145deg, #707070, #505050);
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .preview-glass {
      background: linear-gradient(180deg, rgba(147,197,253,0.7) 0%, rgba(96,165,250,0.5) 50%, rgba(147,197,253,0.6) 100%);
      border-radius: 4px;
      position: relative;
      min-height: 200px;
    }
    .preview-glass::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, transparent 50%);
      pointer-events: none;
      border-radius: 4px;
    }
    .preview-panel {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      transition: all 0.3s;
    }
    .preview-mullion {
      background: linear-gradient(180deg, #606060, #909090, #606060);
      flex-shrink: 0;
      cursor: col-resize;
      position: relative;
    }
    .preview-mullion-h {
      background: linear-gradient(90deg, #606060, #909090, #606060);
      flex-shrink: 0;
      cursor: row-resize;
      position: relative;
    }
    .panel-label {
      font-size: 24px;
      font-weight: 700;
      color: rgba(30,64,175,0.5);
      text-shadow: 0 1px 2px rgba(255,255,255,0.5);
    }
    .panel-label.operable {
      color: rgba(22,101,52,0.6);
    }
    
    /* Glass Logo */
    .glass-logo {
      position: absolute;
      bottom: 8px;
      right: 8px;
      font-size: 8px;
      font-weight: 700;
      color: rgba(255,255,255,0.6);
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      letter-spacing: 1px;
      z-index: 5;
    }
    
    /* Panel Toggle Button */
    .panel-toggle {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.6);
      background: rgba(255,255,255,0.2);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      color: rgba(0,0,0,0.5);
      transition: all 0.2s;
      z-index: 10;
    }
    .panel-toggle:hover {
      background: rgba(255,255,255,0.4);
      transform: scale(1.1);
    }
    
    /* Profile Search */
    .profile-search-container {
      position: relative;
    }
    .profile-search-input {
      width: 100%;
      padding: 10px 40px 10px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.2s;
    }
    .profile-search-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .search-clear-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
      cursor: pointer;
      padding: 4px;
    }
    .search-clear-btn:hover {
      color: #6b7280;
    }
    
    /* Category Tabs */
    .category-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .category-tab {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .category-tab.frame { background: #dbeafe; color: #1e40af; }
    .category-tab.frame.active { border-color: #1e40af; }
    .category-tab.fixed-vent { background: #dcfce7; color: #166534; }
    .category-tab.fixed-vent.active { border-color: #166534; }
    .category-tab.operable-vent { background: #fef3c7; color: #92400e; }
    .category-tab.operable-vent.active { border-color: #92400e; }
    .category-tab.other { background: #f3e8ff; color: #7c3aed; }
    .category-tab.other.active { border-color: #7c3aed; }
    
    /* Table Styles */
    .data-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    .data-table th {
      padding: 12px 16px;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #6b7280;
      background: #f9fafb;
      border-bottom: 2px solid #e5e7eb;
    }
    .data-table th:first-child {
      text-align: left;
    }
    .data-table td {
      padding: 12px 16px;
      text-align: center;
      border-bottom: 1px solid #f3f4f6;
    }
    .data-table td:first-child {
      text-align: left;
    }
    .data-table tr:hover {
      background: #f9fafb;
    }
    
    /* Modern Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 56px;
      height: 28px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background-color: #e5e7eb;
      transition: .3s;
      border-radius: 28px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    input:checked + .toggle-slider {
      background-color: #f59e0b;
    }
    input:checked + .toggle-slider:before {
      transform: translateX(28px);
    }
    
    /* Button Styles */
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    }
    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .btn-secondary:hover {
      background: #e5e7eb;
    }
    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <%- include('../partials/_header.ejs') %>
  
  <div class="container mx-auto px-4 py-8 max-w-6xl">
    
    <!-- Page Header -->
    <div class="mb-8">
      <div class="flex items-center gap-3 mb-2">
        <a href="/admin/list-window-systems" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="text-3xl font-bold text-gray-900">Edit Window System</h1>
      </div>
      <p class="text-gray-500">Editing: <span class="font-semibold text-gray-700"><%= windowSystem.type %></span></p>
    </div>
    
    <!-- Step Navigation with Save Button -->
    <div class="flex items-center justify-between mb-6">
      <div class="step-nav" style="margin-bottom: 0;">
        <div class="step-item active" data-step="1" onclick="goToStep(1)">
          <span class="step-number">1</span>
          <span>Configuration</span>
        </div>
        <div class="step-item" data-step="2" onclick="goToStep(2)">
          <span class="step-number">2</span>
          <span>Profiles</span>
        </div>
        <div class="step-item" data-step="3" onclick="goToStep(3)">
          <span class="step-number">3</span>
          <span>Accessories</span>
        </div>
        <div class="step-item" data-step="4" onclick="goToStep(4)">
          <span class="step-number">4</span>
          <span>Glass</span>
        </div>
        <div class="step-item" data-step="5" onclick="goToStep(5)">
          <span class="step-number">5</span>
          <span>Others</span>
        </div>
      </div>
      <button type="button" onclick="saveAndExit()" class="px-5 py-2.5 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-xl shadow-lg shadow-green-500/30 transition-all flex items-center gap-2">
        <i class="fas fa-save"></i>
        Save & Exit
      </button>
    </div>
    
    <!-- Main Form -->
    <form id="window-form" action="/admin/edit/<%= windowSystem._id %>" method="POST">
      
      <!-- Step 1: Basic Configuration & Panel Preview -->
      <div id="step1-section" class="form-section active">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
          
          <!-- Window Type Name -->
          <div class="p-6 border-b border-gray-100">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-tag text-blue-500 mr-2"></i>Window Type Name
            </label>
            <input type="text" id="type" name="type" value="<%= windowSystem.type %>" 
                   class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-colors text-lg font-medium">
          </div>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 p-6">
            
            <!-- Left: Configuration Options -->
            <div class="space-y-6">
              
              <!-- Operation Type -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-cog text-blue-500 mr-2"></i>Operation Type
                </label>
                <select id="operationType" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-colors" onchange="updateOperationType()">
                  <option value="sliding">Sliding / Roller</option>
                  <option value="casement">Casement</option>
                  <option value="awning">Awning</option>
                  <option value="hopper">Hopper</option>
                  <option value="fixed">Fixed</option>
                  <option value="single-hung">Single Hung</option>
                  <option value="double-hung">Double Hung</option>
                  <option value="tilt-turn">Tilt & Turn</option>
                  <option value="french-door">French Door</option>
                </select>
              </div>
              
              <!-- Number of Panels -->
              <div id="panelCountSection">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-columns text-blue-500 mr-2"></i>Number of Panels
                </label>
                <select id="panelCount" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-colors" onchange="updatePanelCount()">
                  <option value="2">2 Panels</option>
                  <option value="3">3 Panels</option>
                  <option value="4">4 Panels</option>
                  <option value="5">5 Panels</option>
                  <option value="6">6 Panels</option>
                </select>
              </div>
              
              <!-- Panel Orientation -->
              <div id="orientationSection">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-arrows-alt text-blue-500 mr-2"></i>Panel Orientation
                </label>
                <select id="panelOrientation" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-colors" onchange="updatePanelPreview()">
                  <option value="horizontal">Horizontal</option>
                  <option value="vertical">Vertical</option>
                </select>
              </div>
              
              <!-- Panel Configuration -->
              <div id="panelConfigSection">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-th-large text-blue-500 mr-2"></i>Panel Configuration
                </label>
                <p class="text-xs text-gray-500 mb-3">Click panels in preview or buttons below to toggle: <strong>X</strong> = Operable, <strong>O</strong> = Fixed</p>
                <div id="panelButtons" class="flex flex-wrap gap-2">
                  <!-- Buttons generated dynamically -->
                </div>
              </div>
              
              <!-- Show Logo Toggle -->
              <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                <div>
                  <label class="text-sm font-semibold text-gray-700">Show VITRALUX Logo</label>
                  <p class="text-xs text-gray-500">Display logo watermark on glass</p>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="showLogo" checked onchange="updatePanelPreview()">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              
              <!-- French Door Options (hidden by default) -->
              <div id="frenchDoorConfig" style="display: none;" class="space-y-4 p-4 bg-pink-50 rounded-xl border border-pink-200">
                <h4 class="font-semibold text-pink-800"><i class="fas fa-door-open mr-2"></i>French Door Options</h4>
                
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm text-gray-700 mb-1">Door Type</label>
                    <select id="frenchDoorType" class="w-full px-3 py-2 border rounded-lg" onchange="updatePanelPreview()">
                      <option value="double">Double Door</option>
                      <option value="single">Single Door</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm text-gray-700 mb-1">Hinge Side</label>
                    <select id="frenchHingeSide" class="w-full px-3 py-2 border rounded-lg" onchange="updatePanelPreview()">
                      <option value="left">Left</option>
                      <option value="right">Right</option>
                    </select>
                  </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm text-gray-700 mb-1">Left Sidelites</label>
                    <input type="number" id="leftSidelites" min="0" max="4" value="0" class="w-full px-3 py-2 border rounded-lg" onchange="updatePanelPreview()">
                  </div>
                  <div>
                    <label class="block text-sm text-gray-700 mb-1">Right Sidelites</label>
                    <input type="number" id="rightSidelites" min="0" max="4" value="0" class="w-full px-3 py-2 border rounded-lg" onchange="updatePanelPreview()">
                  </div>
                </div>
                
                <div>
                  <label class="block text-sm text-gray-700 mb-1">Transom</label>
                  <select id="frenchTransom" class="w-full px-3 py-2 border rounded-lg" onchange="updatePanelPreview()">
                    <option value="none">None</option>
                    <option value="full">Full Width</option>
                    <option value="over-door">Over Door Only</option>
                  </select>
                </div>
              </div>
              
            </div>
            
            <!-- Right: Live Preview -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-3">
                <i class="fas fa-eye text-blue-500 mr-2"></i>Live Preview
              </label>
              <div class="bg-gradient-to-br from-slate-100 to-slate-200 rounded-xl p-6 flex items-center justify-center min-h-[300px]">
                <div id="panelPreviewContainer" class="preview-frame" style="width: 280px;">
                  <div id="panelPreview" class="preview-glass" style="display: flex; min-height: 200px;">
                    <!-- Preview panels rendered here -->
                  </div>
                </div>
              </div>
              <p class="text-xs text-gray-500 mt-3 text-center">Click on panels to toggle between Operable (X) and Fixed (O)</p>
            </div>
            
          </div>
          
        </div>
        
        <!-- Step Navigation -->
        <div class="mt-6 flex justify-end">
          <button type="button" onclick="goToStep(2)" class="btn-primary">
            Next: Profiles <i class="fas fa-arrow-right ml-2"></i>
          </button>
        </div>
      </div>
      
      <!-- Step 2: Profiles -->
      <div id="step2-section" class="form-section">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
          
          <div class="p-6 border-b border-gray-100">
            <h2 class="text-xl font-bold text-gray-900">
              <i class="fas fa-layer-group text-blue-500 mr-2"></i>Profiles Configuration
            </h2>
            <p class="text-gray-500 text-sm mt-1">Add aluminum profiles for this window system</p>
          </div>
          
          <!-- Add Profile Form -->
          <div class="p-6 border-b border-gray-100">
            <div class="category-tabs mb-4">
              <span class="text-sm text-gray-600 mr-2">Category:</span>
              <button type="button" class="category-tab frame active" onclick="setProfileCategory('frame')">
                <i class="fas fa-border-all mr-1"></i>Frame
              </button>
              <button type="button" class="category-tab fixed-vent" onclick="setProfileCategory('fixed-vent')">
                <i class="fas fa-square mr-1"></i>Fixed Vent
              </button>
              <button type="button" class="category-tab operable-vent" onclick="setProfileCategory('operable-vent')">
                <i class="fas fa-arrows-alt-h mr-1"></i>Operable Vent
              </button>
              <button type="button" class="category-tab other" onclick="setProfileCategory('other')">
                <i class="fas fa-ellipsis-h mr-1"></i>Other
              </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Profile</label>
                <!-- Searchable Select -->
                <div class="relative">
                  <div id="profile-select-wrapper" class="relative">
                    <input type="text" 
                           id="profile-search-input" 
                           placeholder="Search and select profile..." 
                           class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none pr-10" 
                           autocomplete="off"
                           readonly
                           style="cursor: pointer;">
                    <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                  </div>
                  <div id="profile-dropdown" class="hidden absolute z-50 w-full mt-1 bg-white border-2 border-gray-200 rounded-lg shadow-lg max-h-64 overflow-hidden">
                    <div class="p-2 border-b border-gray-200 sticky top-0 bg-white">
                      <input type="text" 
                             id="profile-search-filter" 
                             placeholder="Type to search..." 
                             class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                             autocomplete="off">
                    </div>
                    <div id="profile-options-list" class="overflow-y-auto max-h-56">
                  <% profiles.forEach(profile => { %>
                        <div class="profile-option px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0" 
                             data-value="<%= profile._id %>"
                             data-name="<%= profile.name.toLowerCase() %>"
                             data-color="<%= profile.color || '' %>">
                          <span class="font-medium"><%= profile.name %></span>
                          <% if (profile.color) { %>
                            <span class="text-xs text-gray-500 ml-2">(<%= profile.color %>)</span>
                          <% } %>
                        </div>
                  <% }); %>
                    </div>
                    <div id="profile-no-results" class="hidden px-3 py-2 text-sm text-gray-500 text-center">
                      No profiles found
                    </div>
                  </div>
                  <input type="hidden" id="profile-id" value="">
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Quantity Type</label>
                <select id="profile-quantity-type" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" onchange="toggleProfileQuantityType()">
                  <option value="fixed">Fixed Quantity</option>
                  <option value="equation">Equation</option>
                </select>
                
                <!-- Fixed Quantity Input -->
                <div id="profile-quantity-fixed-container" class="mt-2">
                <input type="number" id="profile-quantity" min="1" value="1" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>
                
                <!-- Quantity Equation Input -->
                <div id="profile-quantity-equation-container" class="mt-2 hidden">
                  <input type="text" id="profile-quantity-equation" placeholder="e.g., 4, (width / 24) + 1" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                  <div id="profile-quantity-equation-validation-message" class="mt-2 text-sm"></div>
                  <div id="profile-quantity-equation-preview" class="mt-2 text-xs text-gray-600"></div>
                  <div class="mt-3 p-3 bg-purple-50 rounded-lg border border-purple-100">
                    <p class="text-xs font-semibold text-purple-800 mb-2">
                      <i class="fas fa-info-circle mr-1"></i>Available Variables (click to insert):
                    </p>
                    <div class="flex flex-wrap gap-2 mb-3">
                      <button type="button" class="variable-btn px-3 py-1.5 bg-white rounded-md text-xs font-mono text-purple-700 border border-purple-300 hover:bg-purple-100 hover:border-purple-400 hover:shadow-sm transition-all cursor-pointer" onclick="insertVariable('width', 'profile-quantity-equation')">
                        width
                      </button>
                      <button type="button" class="variable-btn px-3 py-1.5 bg-white rounded-md text-xs font-mono text-purple-700 border border-purple-300 hover:bg-purple-100 hover:border-purple-400 hover:shadow-sm transition-all cursor-pointer" onclick="insertVariable('height', 'profile-quantity-equation')">
                        height
                      </button>
                      <button type="button" class="variable-btn px-3 py-1.5 bg-white rounded-md text-xs font-mono text-purple-700 border border-purple-300 hover:bg-purple-100 hover:border-purple-400 hover:shadow-sm transition-all cursor-pointer" onclick="insertVariable('perimeter', 'profile-quantity-equation')">
                        perimeter
                      </button>
                      <button type="button" class="variable-btn px-3 py-1.5 bg-white rounded-md text-xs font-mono text-purple-700 border border-purple-300 hover:bg-purple-100 hover:border-purple-400 hover:shadow-sm transition-all cursor-pointer" onclick="insertVariable('area', 'profile-quantity-equation')">
                        area
                      </button>
                    </div>
                    <div class="flex flex-wrap gap-1.5 mb-2">
                      <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' + ', 'profile-quantity-equation')">+</button>
                      <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' - ', 'profile-quantity-equation')">-</button>
                      <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' * ', 'profile-quantity-equation')">×</button>
                      <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' / ', 'profile-quantity-equation')">÷</button>
                      <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable('(', 'profile-quantity-equation')">(</button>
                      <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(')', 'profile-quantity-equation')">)</button>
                    </div>
                  </div>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Orientation</label>
                <select id="profile-orientation" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                  <option value="horizontal">Horizontal</option>
                  <option value="vertical">Vertical</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Position <span class="text-gray-400 text-xs font-normal">(Informative)</span></label>
                <input type="text" id="profile-position" placeholder="e.g., sill, stile, head, jamb, mullion..." class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Length Equation <span class="text-red-500">*</span></label>
                <input type="text" id="profile-length-equation" placeholder="e.g., width - 23, perimeter / 2" class="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" style="min-height: 50px;">
                <div id="profile-equation-validation-message" class="mt-2 text-sm"></div>
                <div id="profile-equation-preview" class="mt-2 text-xs text-gray-600"></div>
                <div class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-100">
                  <p class="text-xs font-semibold text-blue-800 mb-2">
                    <i class="fas fa-info-circle mr-1"></i>Available Variables (click to insert):
                  </p>
                  <div class="flex flex-wrap gap-2 mb-3">
                    <button type="button" class="variable-btn px-3 py-1.5 bg-white rounded-md text-xs font-mono text-blue-700 border border-blue-300 hover:bg-blue-100 hover:border-blue-400 hover:shadow-sm transition-all cursor-pointer" data-variable="width" onclick="insertVariable('width')">
                      width
                    </button>
                    <button type="button" class="variable-btn px-3 py-1.5 bg-white rounded-md text-xs font-mono text-blue-700 border border-blue-300 hover:bg-blue-100 hover:border-blue-400 hover:shadow-sm transition-all cursor-pointer" data-variable="height" onclick="insertVariable('height')">
                      height
                    </button>
                    <button type="button" class="variable-btn px-3 py-1.5 bg-white rounded-md text-xs font-mono text-blue-700 border border-blue-300 hover:bg-blue-100 hover:border-blue-400 hover:shadow-sm transition-all cursor-pointer" data-variable="perimeter" onclick="insertVariable('perimeter')">
                      perimeter
                    </button>
                    <button type="button" class="variable-btn px-3 py-1.5 bg-white rounded-md text-xs font-mono text-blue-700 border border-blue-300 hover:bg-blue-100 hover:border-blue-400 hover:shadow-sm transition-all cursor-pointer" data-variable="area" onclick="insertVariable('area')">
                      area
                    </button>
                  </div>
                  <div class="flex flex-wrap gap-1.5 mb-2">
                    <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' + ')">+</button>
                    <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' - ')">-</button>
                    <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' * ')">×</button>
                    <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' / ')">÷</button>
                    <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable('(')">(</button>
                    <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(')')">)</button>
                  </div>
                  <p class="text-xs text-blue-700 mb-1">
                    <strong>Examples:</strong> "width - 23", "perimeter / 2", "height * 2"
                  </p>
                  <p class="text-xs text-blue-600 font-semibold">
                    <i class="fas fa-ruler mr-1"></i>Result is in inches
                  </p>
                </div>
              </div>
            </div>
            
            <div class="mt-4 flex justify-end">
              <button type="button" onclick="addProfileEntry()" class="px-6 py-2 bg-green-500 hover:bg-green-600 text-white font-medium rounded-lg transition-colors">
                <i class="fas fa-plus mr-2"></i>Add Profile
              </button>
            </div>
          </div>
          
          <!-- Added Profiles Table -->
          <div class="p-6">
            <h3 class="font-semibold text-gray-700 mb-4">Added Profiles</h3>
            <div id="profiles-table-container">
              <!-- Tables rendered by category -->
            </div>
            <div id="profiles-empty-state" class="text-center py-8 text-gray-400">
              <i class="fas fa-layer-group text-4xl mb-3"></i>
              <p>No profiles added yet</p>
            </div>
          </div>
          
        </div>
        
        <!-- Step Navigation -->
        <div class="mt-6 flex justify-between">
          <button type="button" onclick="goToStep(1)" class="btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i>Previous
          </button>
          <button type="button" onclick="goToStep(3)" class="btn-primary">
            Next: Accessories <i class="fas fa-arrow-right ml-2"></i>
          </button>
        </div>
      </div>
      
      <!-- Step 3: Accessories -->
      <div id="step3-section" class="form-section">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
          
          <div class="p-6 border-b border-gray-100">
            <h2 class="text-xl font-bold text-gray-900">
              <i class="fas fa-tools text-blue-500 mr-2"></i>Accessories Configuration
            </h2>
            <p class="text-gray-500 text-sm mt-1">Add accessories for this window system</p>
          </div>
          
          <!-- Add Accessory Form -->
          <div class="p-6 border-b border-gray-100">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Accessory</label>
                <select id="accessory-id" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" onchange="updateAccessoryUnit()">
                  <option value="">Select Accessory</option>
                  <% accessories.forEach(accessory => { %>
                    <option value="<%= accessory._id %>" data-unit="<%= accessory.unit %>"><%= accessory.name %></option>
                  <% }); %>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                <input type="number" id="accessory-quantity" min="1" value="1" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                <input type="text" id="accessory-unit" readonly class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg bg-gray-50">
              </div>
            </div>
            
            <div class="mt-4 flex justify-end">
              <button type="button" onclick="addAccessoryEntry()" class="px-6 py-2 bg-green-500 hover:bg-green-600 text-white font-medium rounded-lg transition-colors">
                <i class="fas fa-plus mr-2"></i>Add Accessory
              </button>
            </div>
          </div>
          
          <!-- Added Accessories Table -->
          <div class="p-6">
            <h3 class="font-semibold text-gray-700 mb-4">Added Accessories</h3>
            <table class="data-table" id="accessories-table" style="display: none;">
              <thead>
                <tr>
                  <th>Accessory</th>
                  <th>Quantity</th>
                  <th>Unit</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="accessories-table-body">
              </tbody>
            </table>
            <div id="accessories-empty-state" class="text-center py-8 text-gray-400" style="display: block;">
              <i class="fas fa-tools text-4xl mb-3"></i>
              <p>No accessories added yet</p>
            </div>
          </div>
          
        </div>
        
        <!-- Step Navigation -->
        <div class="mt-6 flex justify-between">
          <button type="button" onclick="goToStep(2)" class="btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i>Previous
          </button>
          <button type="button" onclick="goToStep(4)" class="btn-primary">
            Next: Missile Type <i class="fas fa-arrow-right ml-2"></i>
          </button>
        </div>
      </div>
      
      <!-- Step 4: Glass Configuration -->
      <div id="step4-section" class="form-section">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
          <div class="p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Glass Configuration <span class="text-gray-400 text-lg font-normal">(Optional)</span></h2>
            <p class="text-gray-600 mb-6">Configure glass size calculation and missile impact types. Leave blank if your system has no glass.</p>
            
            <!-- Glass Size Equations -->
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">Glass Size Calculation</h3>
              
              <!-- Glass Width Equation -->
              <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
                <label for="glass-width-equation" class="block text-sm font-medium text-gray-700 mb-2">
                  Glass Width Equation <span class="text-gray-400 text-xs font-normal">(optional)</span>
                  <span class="text-xs text-gray-500 font-normal ml-2" id="glass-width-equation-unit-label">(Current unit: <span id="glass-width-equation-unit-display">inches</span>)</span>
                </label>
                <input type="text" id="glass-width-equation" name="glassWidthEquation" 
                       value="<%= windowSystem.glassWidthEquation || '' %>"
                       placeholder="e.g., width - 20, width - 20mm" 
                       class="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" 
                       style="min-height: 50px;">
                <p class="mt-2 text-xs text-gray-600">
                  <i class="fas fa-info-circle mr-1"></i>
                  Enter an equation to calculate glass width. Use variables: <code class="bg-gray-100 px-1 rounded">width</code>, <code class="bg-gray-100 px-1 rounded">height</code>, <code class="bg-gray-100 px-1 rounded">perimeter</code>, or <code class="bg-gray-100 px-1 rounded">area</code>.
                  <br>Numeric constants (e.g., 20, 38) are assumed to be in mm and will be converted to inches automatically.
                  <br>Example: <code class="bg-gray-100 px-1 rounded">width - 20</code> means glass width = window width - 20mm
                </p>
                <div id="glass-width-equation-preview" class="mt-2 text-sm text-gray-700 hidden">
                  <strong>Preview:</strong> <span id="glass-width-equation-preview-value"></span>
                </div>
                <div id="glass-width-equation-error" class="mt-2 text-sm text-red-600 hidden"></div>
              </div>
              
              <!-- Glass Height Equation -->
              <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
                <label for="glass-height-equation" class="block text-sm font-medium text-gray-700 mb-2">
                  Glass Height Equation <span class="text-gray-400 text-xs font-normal">(optional)</span>
                  <span class="text-xs text-gray-500 font-normal ml-2" id="glass-height-equation-unit-label">(Current unit: <span id="glass-height-equation-unit-display">inches</span>)</span>
                </label>
                <input type="text" id="glass-height-equation" name="glassHeightEquation" 
                       value="<%= windowSystem.glassHeightEquation || '' %>"
                       placeholder="e.g., height - 38, height - 38mm" 
                       class="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" 
                       style="min-height: 50px;">
                <p class="mt-2 text-xs text-gray-600">
                  <i class="fas fa-info-circle mr-1"></i>
                  Enter an equation to calculate glass height. Use variables: <code class="bg-gray-100 px-1 rounded">width</code>, <code class="bg-gray-100 px-1 rounded">height</code>, <code class="bg-gray-100 px-1 rounded">perimeter</code>, or <code class="bg-gray-100 px-1 rounded">area</code>.
                  <br>Numeric constants (e.g., 20, 38) are assumed to be in mm and will be converted to inches automatically.
                  <br>Example: <code class="bg-gray-100 px-1 rounded">height - 38</code> means glass height = window height - 38mm
                </p>
                <div id="glass-height-equation-preview" class="mt-2 text-sm text-gray-700 hidden">
                  <strong>Preview:</strong> <span id="glass-height-equation-preview-value"></span>
                </div>
                <div id="glass-height-equation-error" class="mt-2 text-sm text-red-600 hidden"></div>
              </div>
            </div>
            
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">Select Missile Impact Types</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="p-4 bg-gray-50 rounded-xl border-2 border-dashed border-red-200">
                  <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="missile-lmi" name="missileLMI" class="h-5 w-5 text-red-600 focus:ring-red-500 border-gray-300 rounded" onchange="toggleMissileType('LMI')"
                           <%= windowSystem.missileImpactConfiguration && windowSystem.missileImpactConfiguration.supportsLMI ? 'checked' : '' %>>
                    <div class="ml-3">
                      <span class="text-sm font-medium text-gray-700">Large Missile Impact (LMI)</span>
                      <p class="text-xs text-gray-500">Window system supports large missile impact resistance</p>
                    </div>
                  </label>
                </div>
                
                <div class="p-4 bg-gray-50 rounded-xl border-2 border-dashed border-red-200">
                  <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="missile-smi" name="missileSMI" class="h-5 w-5 text-red-600 focus:ring-red-500 border-gray-300 rounded" onchange="toggleMissileType('SMI')"
                           <%= windowSystem.missileImpactConfiguration && windowSystem.missileImpactConfiguration.supportsSMI ? 'checked' : '' %>>
                    <div class="ml-3">
                      <span class="text-sm font-medium text-gray-700">Small Missile Impact (SMI)</span>
                      <p class="text-xs text-gray-500">Window system supports small missile impact resistance</p>
                    </div>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- LMI Glass Selection -->
            <div id="lmi-glass-section" class="mb-6" style="display: <%= windowSystem.missileImpactConfiguration && windowSystem.missileImpactConfiguration.supportsLMI ? 'block' : 'none' %>;">
              <div class="p-4 bg-red-50 border border-red-200 rounded-xl mb-4">
                <h4 class="text-sm font-semibold text-red-800 mb-2">Large Missile Impact (LMI) - Available Glasses</h4>
                <p class="text-xs text-red-700">Select which glasses are available for LMI. Users will only see these glasses when they select LMI.</p>
              </div>
              <div class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-4 bg-white">
                <% if (glasses && glasses.length > 0) { %>
                  <% 
                    const lmiGlassIds = windowSystem.missileImpactConfiguration && windowSystem.missileImpactConfiguration.lmiGlasses 
                      ? windowSystem.missileImpactConfiguration.lmiGlasses.map(g => g && g._id ? g._id.toString() : g.toString())
                      : [];
                  %>
                  <% glasses.forEach(glass => { %>
                    <label class="flex items-center py-2 px-3 hover:bg-gray-50 rounded cursor-pointer">
                      <input type="checkbox" name="lmiGlasses[]" value="<%= glass._id %>" class="lmi-glass-checkbox h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded"
                             <%= lmiGlassIds.includes(glass._id.toString()) ? 'checked' : '' %>>
                      <div class="ml-3">
                        <span class="text-sm font-medium text-gray-700"><%= glass.glass_type %></span>
                        <p class="text-xs text-gray-500"><%= glass.description %></p>
                      </div>
                    </label>
                  <% }) %>
                <% } else { %>
                  <p class="text-sm text-gray-500">No glasses available. Please add glasses first.</p>
                <% } %>
              </div>
            </div>
            
            <!-- SMI Glass Selection -->
            <div id="smi-glass-section" class="mb-6" style="display: <%= windowSystem.missileImpactConfiguration && windowSystem.missileImpactConfiguration.supportsSMI ? 'block' : 'none' %>;">
              <div class="p-4 bg-red-50 border border-red-200 rounded-xl mb-4">
                <h4 class="text-sm font-semibold text-red-800 mb-2">Small Missile Impact (SMI) - Available Glasses</h4>
                <p class="text-xs text-red-700">Select which glasses are available for SMI. Users will only see these glasses when they select SMI.</p>
              </div>
              <div class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-4 bg-white">
                <% if (glasses && glasses.length > 0) { %>
                  <% 
                    const smiGlassIds = windowSystem.missileImpactConfiguration && windowSystem.missileImpactConfiguration.smiGlasses 
                      ? windowSystem.missileImpactConfiguration.smiGlasses.map(g => g && g._id ? g._id.toString() : g.toString())
                      : [];
                  %>
                  <% glasses.forEach(glass => { %>
                    <label class="flex items-center py-2 px-3 hover:bg-gray-50 rounded cursor-pointer">
                      <input type="checkbox" name="smiGlasses[]" value="<%= glass._id %>" class="smi-glass-checkbox h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded"
                             <%= smiGlassIds.includes(glass._id.toString()) ? 'checked' : '' %>>
                      <div class="ml-3">
                        <span class="text-sm font-medium text-gray-700"><%= glass.glass_type %></span>
                        <p class="text-xs text-gray-500"><%= glass.description %></p>
                      </div>
                    </label>
                  <% }) %>
                <% } else { %>
                  <p class="text-sm text-gray-500">No glasses available. Please add glasses first.</p>
                <% } %>
              </div>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
              <div class="flex items-start">
                <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                  <i class="fas fa-info-circle text-blue-600"></i>
                </div>
                <div>
                  <h4 class="text-sm font-semibold text-blue-800 mb-1">How it works</h4>
                  <p class="text-xs text-blue-700">
                    Enable the missile impact types this window system supports, then select which glasses are available for each type. When users quote, they'll select a missile type and only see the glasses you've configured for that type.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Step Navigation -->
        <div class="mt-6 flex justify-between items-center">
          <button type="button" onclick="goToStep(3)" class="btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i>Previous
          </button>
          <button type="button" onclick="goToStep(5)" class="btn-primary">
            Next: Others <i class="fas fa-arrow-right ml-2"></i>
          </button>
        </div>
      </div>
      
      <!-- Step 5: Others (Muntins & Flange) -->
      <div id="step5-section" class="form-section">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
          
          <!-- Final Step Banner -->
          <div class="p-4 bg-gradient-to-r from-green-500 to-emerald-600">
            <div class="flex items-center text-white">
              <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center mr-4">
                <i class="fas fa-flag-checkered text-xl"></i>
              </div>
              <div>
                <h3 class="font-bold text-lg">Final Step!</h3>
                <p class="text-green-100 text-sm">Configure muntins and flange, then save your changes</p>
              </div>
            </div>
          </div>
          
          <!-- Muntin Toggle -->
          <div class="p-6 border-b border-gray-100">
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <div class="w-12 h-12 bg-amber-100 rounded-xl flex items-center justify-center mr-4">
                  <i class="fas fa-th text-amber-600 text-xl"></i>
                </div>
                <div>
                  <h3 class="text-lg font-semibold text-gray-800">Decorative Muntins</h3>
                  <p class="text-sm text-gray-500">Add grid dividers to create multiple pane appearance</p>
                </div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="muntin-enabled" onchange="toggleMuntinConfiguration()"
                       <%= windowSystem.muntinConfiguration && windowSystem.muntinConfiguration.enabled ? 'checked' : '' %>>
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          
          <!-- Muntin Config (hidden by default) -->
          <div id="muntin-config-section" style="display: <%= windowSystem.muntinConfiguration && windowSystem.muntinConfiguration.enabled ? 'block' : 'none' %>;">
            <div class="p-6 bg-gray-50 border-b border-gray-100">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-layer-group text-amber-500 mr-2"></i>Muntin Profile
                  </label>
                  <select id="muntin-profile" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:outline-none">
                    <option value="">Select Muntin Profile</option>
                    <% profiles.forEach(profile => { %>
                      <option value="<%= profile._id %>"
                              <%= windowSystem.muntinConfiguration && windowSystem.muntinConfiguration.muntinProfile && windowSystem.muntinConfiguration.muntinProfile.toString() === profile._id.toString() ? 'selected' : '' %>>
                        <%= profile.name %>
                      </option>
                    <% }); %>
                  </select>
                </div>
                <div class="flex items-center">
                  <div class="p-4 bg-white rounded-xl border-2 border-dashed border-amber-200 w-full">
                    <label class="flex items-center cursor-pointer">
                      <input type="checkbox" id="muntin-show-to-user" class="h-5 w-5 text-amber-600 rounded"
                             <%= windowSystem.muntinConfiguration && windowSystem.muntinConfiguration.showToUser ? 'checked' : '' %>>
                      <div class="ml-3">
                        <span class="text-sm font-medium text-gray-700">User Configurable</span>
                        <p class="text-xs text-gray-500">Users can customize divisions when quoting</p>
                      </div>
                    </label>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Muntin Preview -->
            <div class="p-6">
              <div class="flex flex-col md:flex-row gap-6 items-center justify-center">
                <div class="text-center">
                  <p class="text-sm font-medium text-gray-600 mb-3"><i class="fas fa-eye text-amber-500 mr-1"></i> Preview</p>
                  <div class="p-2 rounded-lg shadow-xl" style="background: linear-gradient(145deg, #707070, #505050);">
                    <div class="w-40 h-40 relative overflow-hidden rounded" style="background: linear-gradient(180deg, rgba(186,230,253,0.8) 0%, rgba(147,197,253,0.6) 50%, rgba(186,230,253,0.7) 100%);">
                      <div class="absolute inset-0 flex items-center justify-center">
                        <div class="grid grid-cols-2 gap-0 w-full h-full">
                          <div class="border-r-2 border-b-2" style="border-color: #606060;"></div>
                          <div class="border-b-2" style="border-color: #606060;"></div>
                          <div class="border-r-2" style="border-color: #606060;"></div>
                          <div></div>
                        </div>
                      </div>
                      <div class="absolute inset-0 pointer-events-none" style="background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, transparent 50%);"></div>
                    </div>
                  </div>
                  <p class="text-xs text-gray-500 mt-3">2×2 Grid Pattern</p>
                </div>
                
                <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 max-w-sm">
                  <div class="flex items-start">
                    <div class="w-8 h-8 bg-amber-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                      <i class="fas fa-lightbulb text-amber-600"></i>
                    </div>
                    <div>
                      <h4 class="text-sm font-semibold text-amber-800 mb-1">How it works</h4>
                      <p class="text-xs text-amber-700">Users can set the number of horizontal and vertical divisions when quoting.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Disabled State -->
          <div id="muntin-disabled-message" class="p-8 text-center" style="display: <%= windowSystem.muntinConfiguration && windowSystem.muntinConfiguration.enabled ? 'none' : 'block' %>;">
            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <i class="fas fa-th-large text-gray-400 text-2xl"></i>
            </div>
            <h4 class="text-gray-600 font-medium mb-2">No Muntins</h4>
            <p class="text-sm text-gray-500 max-w-md mx-auto">Toggle the switch above to add decorative muntin grids.</p>
          </div>
          
          <!-- Flange Configuration Section -->
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 mt-6">
            <div class="p-6 border-b border-gray-100">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center mr-4">
                    <i class="fas fa-border-style text-blue-600 text-xl"></i>
                  </div>
                  <div>
                    <h3 class="text-lg font-semibold text-gray-800">Flange Configuration</h3>
                    <p class="text-sm text-gray-500">Configure window flange options</p>
                  </div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="flange-enabled" class="sr-only peer" onchange="toggleFlangeConfiguration()"
                         <%= windowSystem.flangeConfiguration && windowSystem.flangeConfiguration.hasFlange ? 'checked' : '' %>>
                  <div class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-blue-500"></div>
                  <span id="flange-toggle-label" class="ml-3 text-sm font-medium <%= windowSystem.flangeConfiguration && windowSystem.flangeConfiguration.hasFlange ? 'text-blue-600 font-semibold' : 'text-gray-500' %>">
                    <%= windowSystem.flangeConfiguration && windowSystem.flangeConfiguration.hasFlange ? 'Enabled' : 'No Flange' %>
                  </span>
                </label>
              </div>
            </div>
            
            <!-- Flange Configuration (Hidden by default) -->
            <div id="flange-config-section" style="display: <%= windowSystem.flangeConfiguration && windowSystem.flangeConfiguration.hasFlange ? 'block' : 'none' %>;">
              <div class="p-6 bg-gray-50 border-b border-gray-100">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label for="flange-size" class="block text-sm font-semibold text-gray-700 mb-2">
                      <i class="fas fa-ruler text-blue-500 mr-2"></i>Flange Size <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="flange-size" class="form-control w-full" placeholder="e.g., 1/2, 3/4, 1" maxlength="10"
                           value="<%= windowSystem.flangeConfiguration && windowSystem.flangeConfiguration.flangeSize ? windowSystem.flangeConfiguration.flangeSize : '' %>"
                           <%= windowSystem.flangeConfiguration && windowSystem.flangeConfiguration.hasFlange ? 'required' : '' %>>
                    <p class="text-xs text-gray-500 mt-2">Enter flange size (e.g., 1/2&quot;, 3/4&quot;, 1&quot;)</p>
                  </div>
                  
                  <div class="flex items-center">
                    <div class="p-4 bg-white rounded-xl border-2 border-dashed border-blue-200 w-full">
                      <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="flange-trimable" class="h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                               <%= windowSystem.flangeConfiguration && windowSystem.flangeConfiguration.isTrimable ? 'checked' : '' %>>
                        <div class="ml-3">
                          <span class="text-sm font-medium text-gray-700">Trimable</span>
                          <p class="text-xs text-gray-500">Users can choose to remove flange when quoting</p>
                        </div>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Disabled State Message -->
            <div id="flange-disabled-message" class="p-8 text-center" style="display: <%= windowSystem.flangeConfiguration && windowSystem.flangeConfiguration.hasFlange ? 'none' : 'block' %>;">
              <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-border-none text-gray-400 text-2xl"></i>
              </div>
              <h4 class="text-gray-600 font-medium mb-2">No Flange</h4>
              <p class="text-sm text-gray-500 max-w-md mx-auto">
                This window system will not have a flange. Toggle the switch above to add flange configuration.
              </p>
            </div>
          </div>
          
        </div>
        
        <!-- Final Actions -->
        <div class="mt-6 flex justify-between items-center">
          <button type="button" onclick="goToStep(4)" class="btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i>Previous
          </button>
          <button type="submit" class="btn-success text-lg px-8">
            <i class="fas fa-save mr-2"></i>Save Changes
          </button>
        </div>
      </div>
      
    </form>
    
    <!-- Back Link -->
    <div class="mt-8 text-center">
      <a href="/admin/list-window-systems" class="text-gray-500 hover:text-gray-700">
        <i class="fas fa-arrow-left mr-2"></i>Back to Window Systems
      </a>
    </div>
    
  </div>

  <%- include('../partials/_footer.ejs') %>

  <script type="application/json" id="window-system-data">
    <%- JSON.stringify(windowSystem) %>
  </script>
  
  <script>
    // Load existing data
    const windowSystemData = JSON.parse(document.getElementById('window-system-data').textContent);
    
    // Panel configuration
    let panelConfig = windowSystemData.panelConfiguration?.panels || ['O', 'O'];
    let panelRatios = windowSystemData.panelConfiguration?.panelRatios || panelConfig.map(() => 1);
    let showLogo = windowSystemData.panelConfiguration?.showLogo !== false;
    let currentCategory = 'frame';
    
    // Profiles and Accessories
    let lockedLengthUnit = null; // Initialize lockedLengthUnit variable
    let profiles = (windowSystemData.profiles || [])
      .filter(p => p && p.profile) // Filter out invalid entries
      .map(p => ({
        profileId: p.profile?._id || p.profile,
        profileName: p.profile?.name || 'Unknown',
        quantity: p.quantity || null,
        quantityEquation: p.quantityEquation || null,
        orientation: p.orientation || 'horizontal',
        position: p.position || null, // Position (informative)
        lengthDiscount: p.lengthDiscount || 0,
        lengthDiscountDisplay: p.lengthDiscountDisplay || String(p.lengthDiscount || 0),
        lengthEquation: p.lengthEquation || null,
        lengthUnit: p.lengthUnit || 'in',
        category: p.category || 'frame'
      }));
    
    console.log('Loaded profiles:', profiles);
    
    
    let accessoriesData = (windowSystemData.accessories || [])
      .filter(a => a && a.accessory) // Filter out invalid entries
      .map(a => ({
        accessoryId: a.accessory?._id || a.accessory,
        accessoryName: a.accessory?.name || 'Unknown',
        quantity: a.quantity || 1,
        unit: a.unit || 'unit'
      }));
    
    // Use different variable name to avoid conflict with EJS accessories variable
    let accessories = accessoriesData;
    
    console.log('Loaded accessories:', accessories);
    
    // Muntin configuration
    let muntinConfiguration = {
      enabled: windowSystemData.muntinConfiguration?.enabled || false,
      muntinProfile: windowSystemData.muntinConfiguration?.muntinProfile || null,
      showToUser: windowSystemData.muntinConfiguration?.showToUser || true
    };
    
    // Step Navigation
    function goToStep(step) {
      document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.step-item').forEach(s => {
        s.classList.remove('active');
        if (parseInt(s.dataset.step) < step) {
          s.classList.add('completed');
        } else {
          s.classList.remove('completed');
        }
      });
      
      document.getElementById(`step${step}-section`).classList.add('active');
      document.querySelector(`.step-item[data-step="${step}"]`).classList.add('active');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Save and Exit - submit form from any step
    function saveAndExit() {
      document.getElementById('window-form').requestSubmit();
    }
    
    // Initialize values from existing data
    function initializeFromData() {
      try {
        console.log('Initializing from data...');
        const config = windowSystemData.panelConfiguration || {};
        
        // Set operation type
        document.getElementById('operationType').value = config.operationType || 'sliding';
        
        // Set panel count
        document.getElementById('panelCount').value = panelConfig.length;
        
        // Set orientation
        document.getElementById('panelOrientation').value = config.orientation || 'horizontal';
        
        // Set show logo
        document.getElementById('showLogo').checked = showLogo;
        
        // French door settings
        if (config.operationType === 'french-door' && config.frenchDoor) {
          document.getElementById('frenchDoorType').value = config.frenchDoor.doorType || 'double';
          document.getElementById('frenchHingeSide').value = config.frenchDoor.hingeSide || 'right';
          document.getElementById('leftSidelites').value = config.frenchDoor.leftSidelites || 0;
          document.getElementById('rightSidelites').value = config.frenchDoor.rightSidelites || 0;
          document.getElementById('frenchTransom').value = config.frenchDoor.transom || 'none';
        }
        
        // Muntin settings
        if (muntinConfiguration.enabled) {
          document.getElementById('muntin-enabled').checked = true;
          if (muntinConfiguration.muntinProfile) {
            document.getElementById('muntin-profile').value = muntinConfiguration.muntinProfile;
          }
          document.getElementById('muntin-show-to-user').checked = muntinConfiguration.showToUser;
          toggleMuntinConfiguration();
        }
        
        // Set unit selector if there are existing profiles
        if (lockedLengthUnit) {
          setUnitSelector(lockedLengthUnit);
        }
        
        console.log('Updating operation type...');
        updateOperationType();
        
        console.log('Updating panel preview...');
        updatePanelPreview();
        
        console.log('Rendering profiles table...');
        renderProfilesTable();
        
        console.log('Rendering accessories table...');
        renderAccessoriesTable();
        
        console.log('Initialization complete!');
      } catch (error) {
        console.error('Error initializing:', error);
        alert('Error loading window system data: ' + error.message);
      }
    }
    
    // Set unit selector value
    function setUnitSelector(unit) {
      const unitSelect = document.getElementById('profile-length-unit');
      unitSelect.value = unit;
      lockedLengthUnit = unit;
      updateUnitMessage();
    }

    // Update unit message
    function updateUnitMessage() {
      const unit = document.getElementById('profile-length-unit').value;
      const msgEl = document.getElementById('unit-lock-message');
      if (profiles.length > 0) {
        msgEl.innerHTML = `<span class="text-blue-600"><i class="fas fa-info-circle mr-1"></i>Profiles displayed in ${unit === 'mm' ? 'mm' : 'inches'}</span>`;
      } else {
        msgEl.innerHTML = '';
      }
    }
    
    // When user changes unit dropdown
    function onUnitChange() {
      const newUnit = document.getElementById('profile-length-unit').value;
      const oldUnit = lockedLengthUnit || 'in';
      
      if (profiles.length > 0 && newUnit !== oldUnit) {
        // Convert all existing profiles to new unit
        profiles.forEach(profile => {
          const storedValue = parseFloat(profile.lengthDiscount);
          
          if (newUnit === 'mm') {
            // Convert inches to mm for display
            const mmValue = (storedValue * 25.4).toFixed(2);
            profile.lengthDiscountDisplay = mmValue;
          } else {
            // Show stored inches value
            profile.lengthDiscountDisplay = storedValue.toFixed(4);
          }
          profile.lengthUnit = newUnit;
        });
        
        renderProfilesTable();
      }
      
      lockedLengthUnit = newUnit;
      updateUnitMessage();
    }
    
    // Operation Type
    function updateOperationType() {
      const operationType = document.getElementById('operationType').value;
      const frenchDoorConfig = document.getElementById('frenchDoorConfig');
      const panelCountSection = document.getElementById('panelCountSection');
      const panelConfigSection = document.getElementById('panelConfigSection');
      const orientationSection = document.getElementById('orientationSection');
      
      if (operationType === 'french-door') {
        frenchDoorConfig.style.display = 'block';
        panelCountSection.style.display = 'none';
        panelConfigSection.style.display = 'none';
        orientationSection.style.display = 'none';
      } else {
        frenchDoorConfig.style.display = 'none';
        panelCountSection.style.display = 'block';
        panelConfigSection.style.display = 'block';
        orientationSection.style.display = 'block';
        
        // Lock orientation for specific types
        const orientationSelect = document.getElementById('panelOrientation');
        if (operationType === 'sliding') {
          orientationSelect.value = 'horizontal';
          orientationSelect.disabled = true;
        } else if (operationType === 'single-hung') {
          orientationSelect.value = 'vertical';
          orientationSelect.disabled = true;
        } else {
          orientationSelect.disabled = false;
        }
        
        // Fixed windows can only have O panels
        if (operationType === 'fixed') {
          panelConfig = panelConfig.map(() => 'O');
        }
      }
      
      updatePanelPreview();
    }
    
    // Panel Count
    function updatePanelCount() {
      const count = parseInt(document.getElementById('panelCount').value);
      const operationType = document.getElementById('operationType').value;
      
      while (panelConfig.length < count) {
        panelConfig.push('O');
        panelRatios.push(1);
      }
      while (panelConfig.length > count) {
        panelConfig.pop();
        panelRatios.pop();
      }
      
      if (operationType === 'fixed') {
        panelConfig = panelConfig.map(() => 'O');
      }
      
      updatePanelPreview();
    }
    
    // Toggle Panel
    function togglePanel(index) {
      const operationType = document.getElementById('operationType').value;
      if (operationType === 'fixed') return;
      
      panelConfig[index] = panelConfig[index] === 'O' ? 'X' : 'O';
      updatePanelPreview();
    }
    
    // Update Panel Preview
    function updatePanelPreview() {
      const operationType = document.getElementById('operationType').value;
      const orientation = document.getElementById('panelOrientation').value;
      const previewContainer = document.getElementById('panelPreview');
      const buttonsContainer = document.getElementById('panelButtons');
      showLogo = document.getElementById('showLogo').checked;
      
      if (operationType === 'french-door') {
        renderFrenchDoorPreview();
        buttonsContainer.innerHTML = '';
        return;
      }
      
      const isVertical = orientation === 'vertical';
      previewContainer.style.flexDirection = isVertical ? 'column' : 'row';
      previewContainer.innerHTML = '';
      buttonsContainer.innerHTML = '';
      
      panelConfig.forEach((panel, idx) => {
        // Create panel
        const panelDiv = document.createElement('div');
        panelDiv.className = 'preview-panel';
        panelDiv.style.flex = panelRatios[idx] || 1;
        panelDiv.style.cursor = 'pointer';
        panelDiv.onclick = () => togglePanel(idx);
        
        const label = document.createElement('span');
        label.className = `panel-label ${panel === 'X' ? 'operable' : ''}`;
        label.textContent = panel;
        panelDiv.appendChild(label);
        
        // Add logo
        if (showLogo) {
          const logo = document.createElement('div');
          logo.className = 'glass-logo';
          logo.textContent = 'VITRALUX';
          panelDiv.appendChild(logo);
        }
        
        // Add visual elements based on operation type
        if (panel === 'X') {
          if (operationType === 'casement') {
            // Hinges
            const hingeTop = document.createElement('div');
            hingeTop.style.cssText = 'position:absolute;left:2px;top:15%;width:6px;height:12px;background:linear-gradient(90deg,#505050,#808080,#505050);border-radius:2px;';
            panelDiv.appendChild(hingeTop);
            const hingeBottom = document.createElement('div');
            hingeBottom.style.cssText = 'position:absolute;left:2px;bottom:15%;width:6px;height:12px;background:linear-gradient(90deg,#505050,#808080,#505050);border-radius:2px;';
            panelDiv.appendChild(hingeBottom);
            // Handle
            const handle = document.createElement('div');
            handle.style.cssText = 'position:absolute;right:8px;top:50%;transform:translateY(-50%);width:4px;height:20px;background:linear-gradient(90deg,#606060,#a0a0a0,#606060);border-radius:2px;';
            panelDiv.appendChild(handle);
          } else if (operationType === 'sliding') {
            // Handle on outer edge
            const handleOnLeft = idx === 0;
            const handle = document.createElement('div');
            handle.style.cssText = `position:absolute;${handleOnLeft ? 'left' : 'right'}:6px;top:50%;transform:translateY(-50%);width:4px;height:24px;background:linear-gradient(90deg,#606060,#c0c0c0,#606060);border-radius:2px;box-shadow:1px 1px 3px rgba(0,0,0,0.3);`;
            panelDiv.appendChild(handle);
          } else if (operationType === 'single-hung') {
            // Lift handle
            const liftHandle = document.createElement('div');
            liftHandle.style.cssText = 'position:absolute;bottom:8px;left:50%;transform:translateX(-50%);width:30px;height:6px;background:linear-gradient(180deg,#707070,#a0a0a0,#707070);border-radius:3px;';
            panelDiv.appendChild(liftHandle);
          }
        }
        
        previewContainer.appendChild(panelDiv);
        
        // Add mullion between panels
        if (idx < panelConfig.length - 1) {
          const mullion = document.createElement('div');
          mullion.className = isVertical ? 'preview-mullion-h' : 'preview-mullion';
          mullion.style[isVertical ? 'height' : 'width'] = '6px';
          previewContainer.appendChild(mullion);
        }
        
        // Create button
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `px-4 py-2 rounded-lg font-medium transition-colors ${panel === 'X' ? 'bg-green-100 text-green-700 border-2 border-green-300' : 'bg-blue-100 text-blue-700 border-2 border-blue-300'}`;
        btn.textContent = `Panel ${idx + 1}: ${panel}`;
        btn.onclick = () => togglePanel(idx);
        buttonsContainer.appendChild(btn);
      });
    }
    
    // French Door Preview
    function renderFrenchDoorPreview() {
      const previewContainer = document.getElementById('panelPreview');
      const doorType = document.getElementById('frenchDoorType').value;
      const hingeSide = document.getElementById('frenchHingeSide').value;
      const leftSidelites = parseInt(document.getElementById('leftSidelites').value) || 0;
      const rightSidelites = parseInt(document.getElementById('rightSidelites').value) || 0;
      const transom = document.getElementById('frenchTransom').value;
      
      previewContainer.innerHTML = '';
      previewContainer.style.flexDirection = 'column';
      
      // Transom
      if (transom !== 'none') {
        const transomDiv = document.createElement('div');
        transomDiv.style.cssText = 'height:50px;display:flex;border-bottom:6px solid #707070;';
        
        if (transom === 'full' || leftSidelites > 0) {
          for (let i = 0; i < leftSidelites; i++) {
            const sideliteTransom = document.createElement('div');
            sideliteTransom.style.cssText = 'flex:1;background:linear-gradient(180deg,rgba(186,230,253,0.8),rgba(147,197,253,0.6));border-right:4px solid #707070;';
            transomDiv.appendChild(sideliteTransom);
          }
        }
        
        const doorTransom = document.createElement('div');
        doorTransom.style.cssText = `flex:${doorType === 'double' ? 2 : 1};background:linear-gradient(180deg,rgba(186,230,253,0.8),rgba(147,197,253,0.6));`;
        if (rightSidelites > 0 || (transom === 'full' && leftSidelites === 0 && rightSidelites === 0)) {
          doorTransom.style.borderRight = '4px solid #707070';
        }
        transomDiv.appendChild(doorTransom);
        
        if (transom === 'full' || rightSidelites > 0) {
          for (let i = 0; i < rightSidelites; i++) {
            const sideliteTransom = document.createElement('div');
            sideliteTransom.style.cssText = 'flex:1;background:linear-gradient(180deg,rgba(186,230,253,0.8),rgba(147,197,253,0.6));';
            if (i < rightSidelites - 1) sideliteTransom.style.borderRight = '4px solid #707070';
            transomDiv.appendChild(sideliteTransom);
          }
        }
        
        previewContainer.appendChild(transomDiv);
      }
      
      // Main content
      const mainContent = document.createElement('div');
      mainContent.style.cssText = 'flex:1;display:flex;min-height:150px;';
      
      // Left sidelites
      for (let i = 0; i < leftSidelites; i++) {
        const sidelite = document.createElement('div');
        sidelite.style.cssText = 'flex:1;background:linear-gradient(180deg,rgba(186,230,253,0.8),rgba(147,197,253,0.6));border-right:4px solid #707070;position:relative;';
        if (showLogo) {
          const logo = document.createElement('div');
          logo.className = 'glass-logo';
          logo.textContent = 'VITRALUX';
          sidelite.appendChild(logo);
        }
        mainContent.appendChild(sidelite);
      }
      
      // Door(s)
      if (doorType === 'double') {
        // Left door
        const leftDoor = createDoorPanel('left', true);
        mainContent.appendChild(leftDoor);
        // Mullion
        const mullion = document.createElement('div');
        mullion.style.cssText = 'width:6px;background:linear-gradient(180deg,#606060,#909090,#606060);';
        mainContent.appendChild(mullion);
        // Right door
        const rightDoor = createDoorPanel('right', true);
        mainContent.appendChild(rightDoor);
      } else {
        const singleDoor = createDoorPanel(hingeSide, false);
        mainContent.appendChild(singleDoor);
      }
      
      // Right sidelites
      for (let i = 0; i < rightSidelites; i++) {
        const sidelite = document.createElement('div');
        sidelite.style.cssText = 'flex:1;background:linear-gradient(180deg,rgba(186,230,253,0.8),rgba(147,197,253,0.6));border-left:4px solid #707070;position:relative;';
        if (showLogo) {
          const logo = document.createElement('div');
          logo.className = 'glass-logo';
          logo.textContent = 'VITRALUX';
          sidelite.appendChild(logo);
        }
        mainContent.appendChild(sidelite);
      }
      
      previewContainer.appendChild(mainContent);
    }
    
    function createDoorPanel(hingeSide, isDouble) {
      const door = document.createElement('div');
      door.style.cssText = `flex:${isDouble ? 1 : 2};background:linear-gradient(180deg,rgba(186,230,253,0.8),rgba(147,197,253,0.6));position:relative;`;
      
      // Handle
      const handleSide = hingeSide === 'left' ? 'right' : 'left';
      const handle = document.createElement('div');
      handle.style.cssText = `position:absolute;${handleSide}:12px;top:55%;width:8px;height:28px;background:linear-gradient(90deg,#505050,#909090,#505050);border-radius:4px;box-shadow:2px 2px 4px rgba(0,0,0,0.3);`;
      door.appendChild(handle);
      
      // Hinges
      const hingePositions = ['15%', '50%', '85%'];
      hingePositions.forEach(pos => {
        const hinge = document.createElement('div');
        hinge.style.cssText = `position:absolute;${hingeSide}:2px;top:${pos};width:8px;height:16px;background:linear-gradient(90deg,#404040,#707070,#404040);border-radius:2px;transform:translateY(-50%);`;
        door.appendChild(hinge);
      });
      
      if (showLogo) {
        const logo = document.createElement('div');
        logo.className = 'glass-logo';
        logo.textContent = 'VITRALUX';
        door.appendChild(logo);
      }
      
      return door;
    }
    
    // Profile Management
    function setProfileCategory(category) {
      currentCategory = category;
      document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.classList.contains(category)) {
          tab.classList.add('active');
        }
      });
    }
    
    // Profile searchable select functions
    function initProfileSearch() {
      const searchInput = document.getElementById('profile-search-input');
      const searchFilter = document.getElementById('profile-search-filter');
      const dropdown = document.getElementById('profile-dropdown');
      const optionsList = document.getElementById('profile-options-list');
      const noResults = document.getElementById('profile-no-results');
      const hiddenInput = document.getElementById('profile-id');
      const wrapper = document.getElementById('profile-select-wrapper');
      
      if (!searchInput || !dropdown) return; // Exit if elements don't exist
      
      // Store all profile options
      const allOptions = Array.from(optionsList.querySelectorAll('.profile-option'));
      
      // Toggle dropdown
      function toggleDropdown() {
        dropdown.classList.toggle('hidden');
        if (!dropdown.classList.contains('hidden')) {
          searchFilter.focus();
          filterOptions();
        }
      }
      
      // Filter options based on search
      function filterOptions() {
        const searchTerm = searchFilter.value.toLowerCase().trim();
      let visibleCount = 0;
      
        allOptions.forEach(option => {
          const name = option.dataset.name || '';
        const color = (option.dataset.color || '').toLowerCase();
          const matches = !searchTerm || name.includes(searchTerm) || color.includes(searchTerm);
          
        option.style.display = matches ? '' : 'none';
        if (matches) visibleCount++;
      });
      
        // Show/hide no results message
        noResults.classList.toggle('hidden', visibleCount > 0 || !searchTerm);
        optionsList.classList.toggle('hidden', visibleCount === 0 && searchTerm);
      }
      
      // Select a profile
      function selectProfile(optionElement) {
        const value = optionElement.dataset.value;
        const nameSpan = optionElement.querySelector('span.font-medium');
        const name = nameSpan ? nameSpan.textContent : optionElement.textContent.trim();
        
        hiddenInput.value = value;
        searchInput.value = name;
        dropdown.classList.add('hidden');
        searchFilter.value = '';
        filterOptions();
      }
      
      // Open dropdown when clicking on input or wrapper
      searchInput.addEventListener('click', function(e) {
        e.stopPropagation();
        if (dropdown.classList.contains('hidden')) {
          toggleDropdown();
        }
      });
      
      wrapper.addEventListener('click', function(e) {
        e.stopPropagation();
        if (e.target === searchInput || e.target === wrapper || e.target.closest('i.fa-chevron-down')) {
          if (dropdown.classList.contains('hidden')) {
            toggleDropdown();
          }
        }
      });
      
      // Prevent dropdown from closing when clicking inside it
      dropdown.addEventListener('click', function(e) {
        e.stopPropagation();
      });
      
      // Filter on search input
      searchFilter.addEventListener('input', filterOptions);
      
      // Handle option clicks
      allOptions.forEach(option => {
        option.addEventListener('click', function(e) {
          e.stopPropagation();
          selectProfile(this);
        });
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!wrapper.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.add('hidden');
        }
      });
      
      // Handle keyboard navigation
      searchFilter.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          dropdown.classList.add('hidden');
          searchInput.focus();
        } else if (e.key === 'Enter') {
          e.preventDefault();
          const firstVisible = optionsList.querySelector('.profile-option[style=""]');
          if (firstVisible) {
            selectProfile(firstVisible);
          }
        }
      });
    }
    
    // Validate profile length equation syntax and variables
    function validateLengthEquation(equation) {
      const validationMsg = document.getElementById('profile-equation-validation-message');
      const previewDiv = document.getElementById('profile-equation-preview');
      const input = document.getElementById('profile-length-equation');
      
      if (!equation || equation.trim() === '') {
        if (validationMsg) validationMsg.innerHTML = '';
        if (previewDiv) previewDiv.innerHTML = '';
        if (input) {
          input.classList.remove('border-red-500', 'border-green-500');
        }
        return { valid: false, message: '' };
      }
      
      const trimmed = equation.trim();
      const validVariables = ['width', 'height', 'perimeter', 'area'];
      
      // Check for invalid variable names (case-insensitive)
      const variablePattern = /\b([a-zA-Z_][a-zA-Z0-9_]*)\b/g;
      const foundVariables = [];
      let match;
      while ((match = variablePattern.exec(trimmed)) !== null) {
        const varName = match[1].toLowerCase();
        // Skip JavaScript keywords and math functions
        if (!['width', 'height', 'perimeter', 'area', 'sqrt', 'abs', 'round', 'floor', 'ceil', 'max', 'min', 'pow'].includes(varName)) {
          foundVariables.push(match[1]);
        }
      }
      
      // Filter out valid variables
      const invalidVars = foundVariables.filter(v => !validVariables.includes(v.toLowerCase()));
      
      if (invalidVars.length > 0) {
        const uniqueInvalid = [...new Set(invalidVars)];
        if (input) input.classList.add('border-red-500');
        if (input) input.classList.remove('border-green-500');
        if (validationMsg) {
          validationMsg.innerHTML = `<span class="text-red-600 font-medium">❌ Invalid variable(s): ${uniqueInvalid.join(', ')}</span><br><span class="text-red-500 text-xs">Valid variables are: width, height, perimeter, area</span>`;
        }
        if (previewDiv) previewDiv.innerHTML = '';
        return { valid: false, message: `Invalid variables: ${uniqueInvalid.join(', ')}` };
      }
      
      // Try to evaluate with sample values
      try {
        // Test with sample values: width=10, height=20
        const testWidth = 10;
        const testHeight = 20;
        const testPerimeter = 2 * (testWidth + testHeight);
        const testArea = testWidth * testHeight;
        
        let testExpression = trimmed;
        // Replace variables with test values (case-insensitive)
        testExpression = testExpression.replace(/\bwidth\b/gi, testWidth);
        testExpression = testExpression.replace(/\bheight\b/gi, testHeight);
        testExpression = testExpression.replace(/\bperimeter\b/gi, testPerimeter);
        testExpression = testExpression.replace(/\barea\b/gi, testArea);
        
        // Safe evaluation using Function constructor
        const result = Function('"use strict"; return (' + testExpression + ')')();
        
        if (typeof result !== 'number' || isNaN(result) || !isFinite(result)) {
          if (input) input.classList.add('border-red-500');
          if (input) input.classList.remove('border-green-500');
          if (validationMsg) {
            validationMsg.innerHTML = '<span class="text-red-600 font-medium">❌ Invalid equation syntax</span><br><span class="text-red-500 text-xs">The equation must evaluate to a valid number</span>';
          }
          if (previewDiv) previewDiv.innerHTML = '';
          return { valid: false, message: 'Invalid equation syntax' };
        }
        
        // Valid equation
        if (input) input.classList.add('border-green-500');
        if (input) input.classList.remove('border-red-500');
        if (validationMsg) {
          validationMsg.innerHTML = '<span class="text-green-600 font-medium">✓ Valid equation</span>';
        }
        
        // Show preview with sample calculation
        if (previewDiv) {
          previewDiv.innerHTML = `<span class="text-gray-600">Preview (width=10, height=20): <strong>${result.toFixed(2)} in</strong></span>`;
        }
        return { valid: true, message: '', result: result };
      } catch (error) {
        if (input) input.classList.add('border-red-500');
        if (input) input.classList.remove('border-green-500');
        if (validationMsg) {
          validationMsg.innerHTML = '<span class="text-red-600 font-medium">❌ Invalid equation syntax</span><br><span class="text-red-500 text-xs">Check your math operators and parentheses</span>';
        }
        if (previewDiv) previewDiv.innerHTML = '';
        return { valid: false, message: 'Invalid equation syntax: ' + error.message };
      }
    }
    
    // Glass size equation validation (similar to length equation)
    // dimensionType: 'width' or 'height' to determine which input/error elements to use
    function validateGlassSizeEquation(equation, dimensionType = 'width') {
      const validationMsg = document.getElementById(`glass-${dimensionType}-equation-error`);
      const previewDiv = document.getElementById(`glass-${dimensionType}-equation-preview`);
      const input = document.getElementById(`glass-${dimensionType}-equation`);
      
      // Get current global unit preference
      const globalUnit = window.globalPreferences?.unit || localStorage.getItem('globalUnit') || 'inches';
      const isMM = globalUnit === 'mm';
      const unitLabel = isMM ? 'mm' : 'in';
      const unitLabelFull = isMM ? 'millimeters' : 'inches';
      
      if (!equation || equation.trim() === '') {
        if (validationMsg) {
          validationMsg.classList.add('hidden');
          validationMsg.textContent = '';
        }
        if (previewDiv) {
          previewDiv.classList.add('hidden');
          previewDiv.innerHTML = '';
        }
        if (input) {
          input.classList.remove('border-red-500', 'border-green-500');
        }
        return { valid: false, message: '' };
      }
      
      const trimmed = equation.trim();
      const validVariables = ['width', 'height', 'perimeter', 'area'];
      
      // Check for invalid variable names (case-insensitive)
      const variablePattern = /\b([a-zA-Z_][a-zA-Z0-9_]*)\b/g;
      const foundVariables = [];
      let match;
      while ((match = variablePattern.exec(trimmed)) !== null) {
        const varName = match[1].toLowerCase();
        // Skip JavaScript keywords and math functions
        if (!['width', 'height', 'perimeter', 'area', 'sqrt', 'abs', 'round', 'floor', 'ceil', 'max', 'min', 'pow'].includes(varName)) {
          foundVariables.push(match[1]);
        }
      }
      
      // Filter out valid variables
      const invalidVars = foundVariables.filter(v => !validVariables.includes(v.toLowerCase()));
      
      if (invalidVars.length > 0) {
        const uniqueInvalid = [...new Set(invalidVars)];
        if (input) input.classList.add('border-red-500');
        if (input) input.classList.remove('border-green-500');
        if (validationMsg) {
          validationMsg.textContent = `Invalid variable(s): ${uniqueInvalid.join(', ')}. Valid variables are: width, height, perimeter, area`;
          validationMsg.classList.remove('hidden');
        }
        if (previewDiv) previewDiv.classList.add('hidden');
        return { valid: false, message: `Invalid variables: ${uniqueInvalid.join(', ')}` };
      }
      
      // Try to evaluate with sample values
      try {
        // Test with sample values in the current unit
        // Base values in inches: width=10, height=20
        let testWidth, testHeight;
        if (isMM) {
          // Convert to mm: 10 inches = 254 mm, 20 inches = 508 mm
          testWidth = 254;
          testHeight = 508;
        } else {
          testWidth = 10;
          testHeight = 20;
        }
        const testPerimeter = 2 * (testWidth + testHeight);
        const testArea = testWidth * testHeight;
        
        let testExpression = trimmed;
        
        // Convert numeric constants from mm to inches (equations are written with mm constants)
        const variableNames = ['width', 'height', 'perimeter', 'area'];
        const placeholders = {};
        variableNames.forEach((varName, index) => {
          const placeholder = `__VAR${index}__`;
          placeholders[placeholder] = varName;
          testExpression = testExpression.replace(new RegExp(`\\b${varName}\\b`, 'gi'), placeholder);
        });

        testExpression = testExpression.replace(/\b(\d+\.?\d*)\b/g, (match, number, offset, fullString) => {
          const numValue = parseFloat(number);
          if (isNaN(numValue)) {
            return match;
          }

          // Check if this number is a multiplier (right operand in * or /)
          if (offset > 0) {
            const beforeChar = fullString[offset - 1];
            if (beforeChar === '*' || beforeChar === '/') {
              return match; // Don't convert multipliers
            }
          }
          
          // Convert mm to inches
          const converted = numValue / 25.4;
          return converted.toString();
        });

        // Restore variable names
        Object.keys(placeholders).forEach(placeholder => {
          testExpression = testExpression.replace(new RegExp(placeholder, 'g'), placeholders[placeholder]);
        });
        
        // Replace variables with test values (case-insensitive)
        // Note: testWidth and testHeight are already in the correct unit, but we need to convert to inches for evaluation
        const testWidthInches = isMM ? testWidth / 25.4 : testWidth;
        const testHeightInches = isMM ? testHeight / 25.4 : testHeight;
        const testPerimeterInches = 2 * (testWidthInches + testHeightInches);
        const testAreaInches = testWidthInches * testHeightInches;
        
        testExpression = testExpression.replace(/\bwidth\b/gi, testWidthInches);
        testExpression = testExpression.replace(/\bheight\b/gi, testHeightInches);
        testExpression = testExpression.replace(/\bperimeter\b/gi, testPerimeterInches);
        testExpression = testExpression.replace(/\barea\b/gi, testAreaInches);
        
        // Safe evaluation using Function constructor
        const result = Function('"use strict"; return (' + testExpression + ')')();
        
        if (typeof result !== 'number' || isNaN(result) || !isFinite(result)) {
          if (input) input.classList.add('border-red-500');
          if (input) input.classList.remove('border-green-500');
          if (validationMsg) {
            validationMsg.textContent = 'Invalid equation syntax. The equation must evaluate to a valid number.';
            validationMsg.classList.remove('hidden');
          }
          if (previewDiv) previewDiv.classList.add('hidden');
          return { valid: false, message: 'Invalid equation syntax' };
        }
        
        // Valid equation
        if (input) input.classList.add('border-green-500');
        if (input) input.classList.remove('border-red-500');
        if (validationMsg) {
          validationMsg.classList.add('hidden');
        }
        
        // Show preview with sample calculation
        if (previewDiv) {
          const displayResult = result.toFixed(2);
          previewDiv.innerHTML = `Preview (width=${testWidth} ${unitLabel}, height=${testHeight} ${unitLabel}): <strong>${displayResult} in</strong>`;
          previewDiv.classList.remove('hidden');
        }
        return { valid: true, message: '', result: result };
      } catch (error) {
        if (input) input.classList.add('border-red-500');
        if (input) input.classList.remove('border-green-500');
        if (validationMsg) {
          validationMsg.textContent = 'Invalid equation syntax: ' + error.message;
          validationMsg.classList.remove('hidden');
        }
        if (previewDiv) previewDiv.classList.add('hidden');
        return { valid: false, message: error.message };
      }
    }
    
    // Update glass size equation unit display when global unit changes
    function updateGlassSizeEquationUnitDisplay() {
      const globalUnit = window.globalPreferences?.unit || localStorage.getItem('globalUnit') || 'inches';
      const isMM = globalUnit === 'mm';
      const unitLabel = isMM ? 'mm' : 'in';
      const unitLabelFull = isMM ? 'millimeters' : 'inches';
      
      // Update width equation unit display
      const widthUnitDisplay = document.getElementById('glass-width-equation-unit-display');
      if (widthUnitDisplay) {
        widthUnitDisplay.textContent = unitLabelFull;
      }
      
      // Update height equation unit display
      const heightUnitDisplay = document.getElementById('glass-height-equation-unit-display');
      if (heightUnitDisplay) {
        heightUnitDisplay.textContent = unitLabelFull;
      }
      
      // Re-validate if there are values
      const widthEquationInput = document.getElementById('glass-width-equation');
      if (widthEquationInput && widthEquationInput.value.trim()) {
        validateGlassSizeEquation(widthEquationInput.value, 'width');
      }
      
      const heightEquationInput = document.getElementById('glass-height-equation');
      if (heightEquationInput && heightEquationInput.value.trim()) {
        validateGlassSizeEquation(heightEquationInput.value, 'height');
      }
    }

    // Function to insert variable/operator into equation field
    function insertVariable(variable, inputId = 'profile-length-equation') {
      const equationInput = document.getElementById(inputId);
      if (!equationInput) {
        console.error('Equation input field not found:', inputId);
        return;
      }
      
      // Focus the input if it's not focused
      if (document.activeElement !== equationInput) {
        equationInput.focus();
      }
      
      const start = equationInput.selectionStart || 0;
      const end = equationInput.selectionEnd || 0;
      const currentValue = equationInput.value;
      
      // Insert the variable at cursor position
      const newValue = currentValue.substring(0, start) + variable + currentValue.substring(end);
      equationInput.value = newValue;
      
      // Set cursor position after inserted text
      const newCursorPos = start + variable.length;
      setTimeout(() => {
        equationInput.setSelectionRange(newCursorPos, newCursorPos);
        equationInput.focus();
      }, 10);
      
      // Trigger input event to run validation
      equationInput.dispatchEvent(new Event('input', { bubbles: true }));
    }

    function toggleProfileQuantityType() {
      const quantityType = document.getElementById('profile-quantity-type').value;
      const fixedContainer = document.getElementById('profile-quantity-fixed-container');
      const equationContainer = document.getElementById('profile-quantity-equation-container');
      
      if (quantityType === 'equation') {
        fixedContainer.style.display = 'none';
        equationContainer.style.display = 'block';
        document.getElementById('profile-quantity').value = '';
        
        // Add validation listener to equation input
        setTimeout(() => {
          const equationInput = document.getElementById('profile-quantity-equation');
          if (equationInput) {
            // Remove existing listeners by cloning and replacing
            const newInput = equationInput.cloneNode(true);
            equationInput.parentNode.replaceChild(newInput, equationInput);
            
            // Add debounced validation
            let validationTimeout;
            newInput.addEventListener('input', function() {
              clearTimeout(validationTimeout);
              validationTimeout = setTimeout(() => {
                validateProfileQuantityEquation(this.value);
              }, 300);
            });
            
            // Validate on blur
            newInput.addEventListener('blur', function() {
              validateProfileQuantityEquation(this.value);
            });
          }
        }, 10);
      } else {
        fixedContainer.style.display = 'block';
        equationContainer.style.display = 'none';
        document.getElementById('profile-quantity-equation').value = '';
        
        // Clear validation messages
        const validationMsg = document.getElementById('profile-quantity-equation-validation-message');
        const previewDiv = document.getElementById('profile-quantity-equation-preview');
        if (validationMsg) validationMsg.innerHTML = '';
        if (previewDiv) previewDiv.innerHTML = '';
        const qtyEqInput = document.getElementById('profile-quantity-equation');
        if (qtyEqInput) {
          qtyEqInput.classList.remove('border-red-500', 'border-green-500');
        }
      }
    }

    // Validate profile quantity equation
    function validateProfileQuantityEquation(equation) {
      const validationMsg = document.getElementById('profile-quantity-equation-validation-message');
      const previewDiv = document.getElementById('profile-quantity-equation-preview');
      const input = document.getElementById('profile-quantity-equation');
      
      if (!equation || equation.trim() === '') {
        if (validationMsg) validationMsg.innerHTML = '';
        if (previewDiv) previewDiv.innerHTML = '';
        if (input) {
          input.classList.remove('border-red-500', 'border-green-500');
        }
        return { valid: false, message: '' };
      }
      
      const trimmed = equation.trim();
      const validVariables = ['width', 'height', 'perimeter', 'area'];
      
      // Check for invalid variable names (case-insensitive)
      const variablePattern = /\b([a-zA-Z_][a-zA-Z0-9_]*)\b/g;
      const foundVariables = [];
      let match;
      while ((match = variablePattern.exec(trimmed)) !== null) {
        const varName = match[1].toLowerCase();
        // Skip JavaScript keywords and math functions
        if (!['width', 'height', 'perimeter', 'area', 'sqrt', 'abs', 'round', 'floor', 'ceil', 'max', 'min', 'pow'].includes(varName)) {
          foundVariables.push(match[1]);
        }
      }
      
      if (foundVariables.length > 0) {
        const errorMsg = `Invalid variable(s): ${foundVariables.join(', ')}. Use: width, height, perimeter, area`;
        if (validationMsg) {
          validationMsg.innerHTML = `<span class="text-red-600"><i class="fas fa-exclamation-circle mr-1"></i>${errorMsg}</span>`;
        }
        if (input) {
          input.classList.add('border-red-500');
          input.classList.remove('border-green-500');
        }
        if (previewDiv) previewDiv.innerHTML = '';
        return { valid: false, message: errorMsg };
      }
      
      // Try to evaluate the equation with sample values
      try {
        const testWidth = 48;
        const testHeight = 60;
        const testPerimeter = 2 * (testWidth + testHeight);
        const testArea = testWidth * testHeight;
        
        // Replace variables with test values (case-insensitive)
        let testEquation = trimmed;
        testEquation = testEquation.replace(/\bwidth\b/gi, testWidth);
        testEquation = testEquation.replace(/\bheight\b/gi, testHeight);
        testEquation = testEquation.replace(/\bperimeter\b/gi, testPerimeter);
        testEquation = testEquation.replace(/\barea\b/gi, testArea);
        
        // Evaluate using Function constructor (safer than eval)
        const result = Function('"use strict"; return (' + testEquation + ')')();
        
        if (typeof result !== 'number' || isNaN(result) || !isFinite(result)) {
          throw new Error('Equation does not evaluate to a valid number');
        }
        
        // Quantity should be positive
        if (result < 0) {
          const errorMsg = 'Quantity equation must evaluate to a positive number';
          if (validationMsg) {
            validationMsg.innerHTML = `<span class="text-red-600"><i class="fas fa-exclamation-circle mr-1"></i>${errorMsg}</span>`;
          }
          if (input) {
            input.classList.add('border-red-500');
            input.classList.remove('border-green-500');
          }
          if (previewDiv) previewDiv.innerHTML = '';
          return { valid: false, message: errorMsg };
        }
        
        // Success
        const roundedResult = Math.round(result);
        if (validationMsg) {
          validationMsg.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>Valid equation</span>`;
        }
        if (previewDiv) {
          previewDiv.innerHTML = `<span class="text-gray-600">Preview: For a ${testWidth}" × ${testHeight}" window, quantity = <strong>${roundedResult}</strong></span>`;
        }
        if (input) {
          input.classList.remove('border-red-500');
          input.classList.add('border-green-500');
        }
        return { valid: true, message: 'Valid equation' };
      } catch (error) {
        const errorMsg = `Invalid equation syntax: ${error.message}`;
        if (validationMsg) {
          validationMsg.innerHTML = `<span class="text-red-600"><i class="fas fa-exclamation-circle mr-1"></i>${errorMsg}</span>`;
        }
        if (input) {
          input.classList.add('border-red-500');
          input.classList.remove('border-green-500');
        }
        if (previewDiv) previewDiv.innerHTML = '';
        return { valid: false, message: errorMsg };
      }
    }

    // Initialize equation validation and profile search on page load
    document.addEventListener('DOMContentLoaded', function() {
      initProfileSearch();
      
      // Initialize glass size equation unit display
      updateGlassSizeEquationUnitDisplay();
      
      // Listen for unit changes
      window.addEventListener('unitChanged', function(event) {
        updateGlassSizeEquationUnitDisplay();
      });
      
      // Glass width equation validation
      const glassWidthEquationInput = document.getElementById('glass-width-equation');
      if (glassWidthEquationInput) {
        let glassWidthEquationTimeout;
        glassWidthEquationInput.addEventListener('input', function() {
          clearTimeout(glassWidthEquationTimeout);
          glassWidthEquationTimeout = setTimeout(() => {
            validateGlassSizeEquation(this.value, 'width');
          }, 300);
        });
        
        glassWidthEquationInput.addEventListener('blur', function() {
          validateGlassSizeEquation(this.value, 'width');
        });
      }
      
      // Glass height equation validation
      const glassHeightEquationInput = document.getElementById('glass-height-equation');
      if (glassHeightEquationInput) {
        let glassHeightEquationTimeout;
        glassHeightEquationInput.addEventListener('input', function() {
          clearTimeout(glassHeightEquationTimeout);
          glassHeightEquationTimeout = setTimeout(() => {
            validateGlassSizeEquation(this.value, 'height');
          }, 300);
        });
        
        glassHeightEquationInput.addEventListener('blur', function() {
          validateGlassSizeEquation(this.value, 'height');
        });
      }
      
      const equationInput = document.getElementById('profile-length-equation');
      if (equationInput) {
        // Add debounced validation
        let validationTimeout;
        equationInput.addEventListener('input', function() {
          clearTimeout(validationTimeout);
          validationTimeout = setTimeout(() => {
            validateLengthEquation(this.value);
          }, 300);
        });
        
        // Validate on blur
        equationInput.addEventListener('blur', function() {
          validateLengthEquation(this.value);
        });
      }
    });
    
    function addProfileEntry() {
      const hiddenInput = document.getElementById('profile-id');
      const searchInput = document.getElementById('profile-search-input');
      const profileId = hiddenInput.value;
      
      // Get profile name from the selected option
      let profileName = searchInput.value || '';
      if (profileId) {
        const selectedOption = document.querySelector(`.profile-option[data-value="${profileId}"]`);
        if (selectedOption) {
          const nameSpan = selectedOption.querySelector('span.font-medium');
          profileName = nameSpan ? nameSpan.textContent : selectedOption.textContent.trim();
        }
      }
      
      const quantityType = document.getElementById('profile-quantity-type').value;
      const quantity = document.getElementById('profile-quantity').value;
      const quantityEquation = document.getElementById('profile-quantity-equation').value;
      const orientation = document.getElementById('profile-orientation').value;
      const position = document.getElementById('profile-position').value;
      const lengthEquation = document.getElementById('profile-length-equation').value;
      
      if (!profileId) {
        alert('Please select a profile');
        return;
      }
      
      // Validate quantity based on type
      if (quantityType === 'fixed') {
        if (!quantity || quantity <= 0) {
          alert('Please enter a valid quantity');
          return;
        }
      } else {
        if (!quantityEquation || quantityEquation.trim() === '') {
          alert('Please enter a quantity equation');
          return;
        }
        // Validate quantity equation
        const qtyValidation = validateProfileQuantityEquation(quantityEquation);
        if (!qtyValidation.valid) {
          alert(qtyValidation.message || 'Please enter a valid quantity equation. Check that you are using correct variable names (width, height, perimeter, area)');
          return;
        }
      }
      
      if (!lengthEquation || lengthEquation.trim() === '') {
        alert('Please enter a length equation');
        return;
      }
      
      // Validate length equation before adding
      const validation = validateLengthEquation(lengthEquation);
      if (!validation.valid) {
        alert(validation.message || 'Please enter a valid equation. Check that you are using correct variable names (width, height, perimeter, area)');
        return;
      }

      const profileEntry = {
        profileId,
        profileName,
        quantity: quantityType === 'fixed' ? parseInt(quantity) : null,
        quantityEquation: quantityType === 'equation' ? quantityEquation.trim() : null,
        orientation,
        position: position || null, // Position (informative)
        lengthEquation: lengthEquation.trim(),
        category: currentCategory
      };
      
      profiles.push(profileEntry);
      
      // Reset form
      hiddenInput.value = '';
      searchInput.value = '';
      document.getElementById('profile-quantity-type').value = 'fixed';
      document.getElementById('profile-quantity').value = '1';
      document.getElementById('profile-quantity-equation').value = '';
      document.getElementById('profile-orientation').selectedIndex = 0;
      document.getElementById('profile-position').value = '';
      document.getElementById('profile-length-equation').value = '';
      toggleProfileQuantityType(); // Reset UI state
      
      // Clear validation messages
      const validationMsg = document.getElementById('profile-equation-validation-message');
      const previewDiv = document.getElementById('profile-equation-preview');
      if (validationMsg) validationMsg.innerHTML = '';
      if (previewDiv) previewDiv.innerHTML = '';
      const eqInput = document.getElementById('profile-length-equation');
      if (eqInput) {
        eqInput.classList.remove('border-red-500', 'border-green-500');
      }
      
      // Clear quantity equation validation
      const qtyValidationMsg = document.getElementById('profile-quantity-equation-validation-message');
      const qtyPreviewDiv = document.getElementById('profile-quantity-equation-preview');
      if (qtyValidationMsg) qtyValidationMsg.innerHTML = '';
      if (qtyPreviewDiv) qtyPreviewDiv.innerHTML = '';
      const qtyEqInput = document.getElementById('profile-quantity-equation');
      if (qtyEqInput) {
        qtyEqInput.classList.remove('border-red-500', 'border-green-500');
      }
      
      renderProfilesTable();
    }
    
    function renderProfilesTable() {
      const container = document.getElementById('profiles-table-container');
      const emptyState = document.getElementById('profiles-empty-state');
      
      if (profiles.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      
      const categories = [
        { id: 'frame', name: 'Frame', icon: 'fa-border-all', color: 'blue' },
        { id: 'fixed-vent', name: 'Fixed Vent', icon: 'fa-square', color: 'green' },
        { id: 'operable-vent', name: 'Operable Vent', icon: 'fa-arrows-alt-h', color: 'yellow' },
        { id: 'other', name: 'Other', icon: 'fa-ellipsis-h', color: 'purple' }
      ];
      
      let html = '';
      categories.forEach(cat => {
        const catProfiles = profiles.filter(p => p.category === cat.id);
        if (catProfiles.length === 0) return;
        
        html += `
          <div class="mb-6">
            <h4 class="text-sm font-semibold text-gray-600 mb-2">
              <i class="fas ${cat.icon} text-${cat.color}-500 mr-2"></i>${cat.name}
            </h4>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Profile</th>
                  <th>Qty</th>
                  <th>Orientation</th>
                  <th>Position</th>
                  <th>Length Equation</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        catProfiles.forEach((profile, idx) => {
          const globalIdx = profiles.indexOf(profile);
          
          // Display length equation
          const lengthDisplay = `<span class="text-blue-600 font-mono text-sm">${profile.lengthEquation || 'N/A'}</span>`;
          
          html += `
            <tr>
              <td class="font-medium">${profile.profileName}</td>
              <td>${profile.quantityEquation ? 
                `<code class="px-2 py-1 bg-purple-50 text-purple-700 rounded text-sm font-mono border border-purple-200" title="Quantity Equation">${profile.quantityEquation}</code>` :
                `<input type="number" min="1" step="1" value="${profile.quantity}" 
                   class="w-16 text-center px-2 py-1 rounded text-sm font-medium bg-gray-100 text-gray-800 border border-gray-300 hover:border-blue-400 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-colors"
                   onchange="updateProfileQuantity(${globalIdx}, this.value)"
                   title="Click to edit quantity">`
              }</td>
              <td class="capitalize">${profile.orientation}</td>
              <td>${profile.position ? 
                `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800 capitalize">${profile.position}</span>` : 
                `<span class="text-xs text-gray-400">-</span>`
              }</td>
              <td>${lengthDisplay}</td>
              <td>
                <button type="button" onclick="removeProfile(${globalIdx})" class="text-red-500 hover:text-red-700">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });
        
        html += '</tbody></table></div>';
      });
      
      container.innerHTML = html;
    }
    
    function removeProfile(index) {
      profiles.splice(index, 1);
      
      // Clear unit lock if all profiles removed
      if (profiles.length === 0) {
        lockedLengthUnit = null;
      }
      
      updateUnitMessage();
      renderProfilesTable();
    }
    
    function updateProfileQuantity(index, newQuantity) {
      const qty = parseInt(newQuantity, 10);
      if (!isNaN(qty) && qty >= 1) {
        profiles[index].quantity = qty;
      } else {
        // Reset to previous value if invalid
        renderProfilesTable();
      }
    }
    
    // Accessory Management
    function updateAccessoryUnit() {
      const select = document.getElementById('accessory-id');
      const unit = select.options[select.selectedIndex]?.dataset.unit || '';
      document.getElementById('accessory-unit').value = unit;
    }
    
    function addAccessoryEntry() {
      const select = document.getElementById('accessory-id');
      const accessoryId = select.value;
      const accessoryName = select.options[select.selectedIndex]?.text || '';
      const quantity = document.getElementById('accessory-quantity').value;
      const unit = document.getElementById('accessory-unit').value;
      
      if (!accessoryId || !quantity) {
        alert('Please select an accessory and enter quantity');
        return;
      }
      
      accessories.push({
        accessoryId,
        accessoryName,
        quantity: parseInt(quantity),
        unit
      });
      
      select.value = '';
      document.getElementById('accessory-quantity').value = '1';
      document.getElementById('accessory-unit').value = '';
      
      renderAccessoriesTable();
    }
    
    function renderAccessoriesTable() {
      console.log('renderAccessoriesTable called, count:', accessories ? accessories.length : 0);
      
      const tableBody = document.getElementById('accessories-table-body');
      const emptyState = document.getElementById('accessories-empty-state');
      const table = document.getElementById('accessories-table');
      
      if (!tableBody || !emptyState || !table) {
        console.error('Accessories table elements not found');
        return;
      }
      
      if (!accessories || accessories.length === 0) {
        tableBody.innerHTML = '';
        emptyState.style.display = 'block';
        table.style.display = 'none';
        console.log('No accessories, showing empty state');
        return;
      }
      
      emptyState.style.display = 'none';
      table.style.display = 'table';
      
      let html = '';
      for (let i = 0; i < accessories.length; i++) {
        const acc = accessories[i];
        html += '<tr>';
        html += '<td class="font-medium">' + (acc.accessoryName || 'Unknown') + '</td>';
        html += '<td>' + (acc.quantity || 1) + '</td>';
        html += '<td>' + (acc.unit || 'unit') + '</td>';
        html += '<td><button type="button" onclick="removeAccessory(' + i + ')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td>';
        html += '</tr>';
      }
      tableBody.innerHTML = html;
      console.log('Accessories table rendered:', accessories.length, 'items');
    }
    
    function removeAccessory(index) {
      accessories.splice(index, 1);
      renderAccessoriesTable();
    }
    
    // Muntin Configuration
    function toggleMuntinConfiguration() {
      const enabled = document.getElementById('muntin-enabled').checked;
      const configSection = document.getElementById('muntin-config-section');
      const disabledMessage = document.getElementById('muntin-disabled-message');
      
      muntinConfiguration.enabled = enabled;
      
      if (enabled) {
        configSection.style.display = 'block';
        disabledMessage.style.display = 'none';
      } else {
        configSection.style.display = 'none';
        disabledMessage.style.display = 'block';
      }
    }
    
    // Missile Type Configuration
    function toggleMissileType(type) {
      const checkbox = document.getElementById(`missile-${type.toLowerCase()}`);
      const section = document.getElementById(`${type.toLowerCase()}-glass-section`);
      
      if (checkbox && section) {
        section.style.display = checkbox.checked ? 'block' : 'none';
      }
    }
    
    // Flange Configuration
    function toggleFlangeConfiguration() {
      const enabled = document.getElementById('flange-enabled').checked;
      const configSection = document.getElementById('flange-config-section');
      const disabledMessage = document.getElementById('flange-disabled-message');
      const toggleLabel = document.getElementById('flange-toggle-label');
      const flangeSizeInput = document.getElementById('flange-size');
      
      if (enabled) {
        configSection.style.display = 'block';
        disabledMessage.style.display = 'none';
        // Make flange size required when enabled
        if (flangeSizeInput) {
          flangeSizeInput.setAttribute('required', 'required');
        }
        if (toggleLabel) {
          toggleLabel.textContent = 'Enabled';
          toggleLabel.classList.remove('text-gray-500');
          toggleLabel.classList.add('text-blue-600', 'font-semibold');
        }
      } else {
        configSection.style.display = 'none';
        disabledMessage.style.display = 'block';
        // Remove required attribute when disabled
        if (flangeSizeInput) {
          flangeSizeInput.removeAttribute('required');
          flangeSizeInput.value = ''; // Clear the value when disabled
        }
        if (toggleLabel) {
          toggleLabel.textContent = 'No Flange';
          toggleLabel.classList.remove('text-blue-600', 'font-semibold');
          toggleLabel.classList.add('text-gray-500');
        }
      }
    }
    
    // Form Submission
    document.getElementById('window-form').addEventListener('submit', function(e) {
      console.log('=== Form Submit Started ===');
      e.preventDefault();
      
      // Validate form
      const windowType = document.getElementById('type').value.trim();
      if (!windowType) {
        alert('Please enter a window type');
        return;
      }
      
      if (profiles.length === 0) {
        alert('Please add at least one profile');
        return;
      }
      
      // Validate that all profiles have length equations
      const invalidProfiles = profiles.filter(p => !p.lengthEquation || p.lengthEquation.trim() === '');
      if (invalidProfiles.length > 0) {
        alert('Please ensure all profiles have valid length equations');
        return;
      }
      
      const form = e.target;
      
      // Remove any existing hidden inputs to prevent duplicates
      form.querySelectorAll('input[name="panelConfiguration"]').forEach(el => el.remove());
      form.querySelectorAll('input[name="profiles"]').forEach(el => el.remove());
      form.querySelectorAll('input[name="accessories"]').forEach(el => el.remove());
      form.querySelectorAll('input[name="muntinConfiguration"]').forEach(el => el.remove());
      form.querySelectorAll('input[name="flangeConfiguration"]').forEach(el => el.remove());
      form.querySelectorAll('input[name="missileImpactConfiguration"]').forEach(el => el.remove());
      form.querySelectorAll('input[name="glassRestrictions"]').forEach(el => el.remove());
      
      // Get current values from the form
      const currentOperationType = document.getElementById('operationType').value;
      const currentOrientation = document.getElementById('panelOrientation').value;
      
      console.log('Current operation type:', currentOperationType);
      console.log('Current orientation:', currentOrientation);
      console.log('Current panelConfig:', panelConfig);
      console.log('Current showLogo:', showLogo);
      
      // Panel Configuration
      const panelConfigData = {
        panels: panelConfig,
        panelRatios: panelRatios,
        orientation: currentOrientation,
        operationType: currentOperationType,
        showLogo: showLogo
      };
      
      if (panelConfigData.operationType === 'french-door') {
        panelConfigData.frenchDoor = {
          doorType: document.getElementById('frenchDoorType').value,
          hingeSide: document.getElementById('frenchHingeSide').value,
          leftSidelites: parseInt(document.getElementById('leftSidelites').value) || 0,
          rightSidelites: parseInt(document.getElementById('rightSidelites').value) || 0,
          transom: document.getElementById('frenchTransom').value
        };
      }
      
      console.log('=== Saving panel config ===', JSON.stringify(panelConfigData, null, 2));
      
      // Add hidden inputs
      const panelConfigInput = document.createElement('input');
      panelConfigInput.type = 'hidden';
      panelConfigInput.name = 'panelConfiguration';
      panelConfigInput.value = JSON.stringify(panelConfigData);
      form.appendChild(panelConfigInput);
      
      // Prepare profiles with all necessary data
      const profilesData = profiles.map(p => ({
        profileId: p.profileId,
        profileName: p.profileName,
        quantity: p.quantity,
        quantityEquation: p.quantityEquation || null,
        orientation: p.orientation,
        position: p.position || null, // Position (informative)
        lengthDiscount: p.lengthDiscount,
        lengthDiscountDisplay: p.lengthDiscountDisplay,
        lengthEquation: p.lengthEquation || null,
        lengthUnit: p.lengthUnit,
        category: p.category,
        showToUser: p.showToUser || false
      }));
      
      const profilesInput = document.createElement('input');
      profilesInput.type = 'hidden';
      profilesInput.name = 'profiles';
      profilesInput.value = JSON.stringify(profilesData);
      form.appendChild(profilesInput);
      
      const accessoriesInput = document.createElement('input');
      accessoriesInput.type = 'hidden';
      accessoriesInput.name = 'accessories';
      accessoriesInput.value = JSON.stringify(accessories);
      form.appendChild(accessoriesInput);
      
      // Muntin configuration
      muntinConfiguration.muntinProfile = document.getElementById('muntin-profile').value || null;
      muntinConfiguration.showToUser = document.getElementById('muntin-show-to-user').checked;
      
      const muntinInput = document.createElement('input');
      muntinInput.type = 'hidden';
      muntinInput.name = 'muntinConfiguration';
      muntinInput.value = JSON.stringify(muntinConfiguration);
      form.appendChild(muntinInput);
      
      // Flange configuration
      const hasFlange = document.getElementById('flange-enabled').checked;
      const flangeSize = document.getElementById('flange-size').value || null;
      
      // Validate flange size is provided when flange is enabled
      if (hasFlange && !flangeSize) {
        alert('Please enter a flange size when flange configuration is enabled.');
        e.preventDefault();
        return false;
      }
      
      const flangeConfiguration = {
        hasFlange: hasFlange,
        flangeSize: flangeSize,
        isTrimable: document.getElementById('flange-trimable').checked
      };
      
      const flangeInput = document.createElement('input');
      flangeInput.type = 'hidden';
      flangeInput.name = 'flangeConfiguration';
      flangeInput.value = JSON.stringify(flangeConfiguration);
      form.appendChild(flangeInput);
      
      // Glass size equations
      const glassWidthEquation = document.getElementById('glass-width-equation')?.value.trim() || null;
      const glassHeightEquation = document.getElementById('glass-height-equation')?.value.trim() || null;
      
      // Validate glass width equation only if provided (glass is optional)
      if (glassWidthEquation) {
        const glassWidthValidation = validateGlassSizeEquation(glassWidthEquation, 'width');
        if (!glassWidthValidation.valid) {
          alert('Please enter a valid glass width equation. ' + (glassWidthValidation.message || ''));
          goToStep(4);
          e.preventDefault();
          return false;
        }
      }
      
      // Validate glass height equation only if provided (glass is optional)
      if (glassHeightEquation) {
        const glassHeightValidation = validateGlassSizeEquation(glassHeightEquation, 'height');
        if (!glassHeightValidation.valid) {
          alert('Please enter a valid glass height equation. ' + (glassHeightValidation.message || ''));
          goToStep(4);
          e.preventDefault();
          return false;
        }
      }
      
      // Add glass size equations to form
      if (glassWidthEquation) {
        const glassWidthEquationInput = document.createElement('input');
        glassWidthEquationInput.type = 'hidden';
        glassWidthEquationInput.name = 'glassWidthEquation';
        glassWidthEquationInput.value = glassWidthEquation;
        form.appendChild(glassWidthEquationInput);
      }
      
      if (glassHeightEquation) {
        const glassHeightEquationInput = document.createElement('input');
        glassHeightEquationInput.type = 'hidden';
        glassHeightEquationInput.name = 'glassHeightEquation';
        glassHeightEquationInput.value = glassHeightEquation;
        form.appendChild(glassHeightEquationInput);
      }
      
      // Missile impact configuration
      const lmiGlassCheckboxes = document.querySelectorAll('.lmi-glass-checkbox:checked');
      const smiGlassCheckboxes = document.querySelectorAll('.smi-glass-checkbox:checked');
      
      const missileImpactConfiguration = {
        supportsLMI: document.getElementById('missile-lmi').checked,
        supportsSMI: document.getElementById('missile-smi').checked,
        lmiGlasses: Array.from(lmiGlassCheckboxes).map(cb => cb.value),
        smiGlasses: Array.from(smiGlassCheckboxes).map(cb => cb.value)
      };
      
      const missileInput = document.createElement('input');
      missileInput.type = 'hidden';
      missileInput.name = 'missileImpactConfiguration';
      missileInput.value = JSON.stringify(missileImpactConfiguration);
      form.appendChild(missileInput);
      
      // Empty glass restrictions for now
      const glassInput = document.createElement('input');
      glassInput.type = 'hidden';
      glassInput.name = 'glassRestrictions';
      glassInput.value = JSON.stringify([]);
      form.appendChild(glassInput);
      
      // Submit the form
      console.log('Submitting form...');
      form.submit();
    });
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      try {
        initializeFromData();
        
        // Initialize length discount unit from global preference (if not locked)
        const unitSelect = document.getElementById('profile-length-unit');
        if (unitSelect && window.globalPreferences) {
          const globalUnit = window.globalPreferences.unit || 'inches';
          const unitValue = globalUnit === 'mm' ? 'mm' : 'in';
          
          // Only set if not locked
          if (!lockedLengthUnit) {
            unitSelect.value = unitValue;
          }
          
          // Listen to global unit changes and re-render table
          window.addEventListener('unitChanged', (event) => {
            const newUnit = event.detail.unit === 'mm' ? 'mm' : 'in';
            if (!lockedLengthUnit) { // Only update if not locked
              unitSelect.value = newUnit;
            }
            // Re-render table to update displayed units
            renderProfilesTable();
          });
        }
      } catch (e) {
        console.error('Initialization error:', e);
      }
    });
    
    // Also try to initialize immediately in case DOMContentLoaded already fired
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      setTimeout(function() {
        try {
          if (!window._initialized) {
            window._initialized = true;
            initializeFromData();
          }
        } catch (e) {
          console.error('Delayed initialization error:', e);
        }
      }, 100);
    }
  </script>
</body>
</html>
