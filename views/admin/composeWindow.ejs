<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/_head.ejs') %>
  <title>Create Window System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  
  <style>
    /* Enhanced Step Indicators */
    .step-active { 
      background: linear-gradient(135deg, #3b82f6, #1d4ed8); 
      color: white; 
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
      transform: scale(1.05);
      transition: all 0.3s ease;
    }
    .step-complete { 
      background: linear-gradient(135deg, #10b981, #059669); 
      color: white; 
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
      transition: all 0.3s ease;
    }
    .step-inactive { 
      background: linear-gradient(135deg, #f3f4f6, #e5e7eb); 
      color: #6b7280; 
      border: 1px solid #d1d5db;
      transition: all 0.3s ease;
    }
    
    /* Enhanced Form Sections */
    .form-section { 
      display: none; 
      animation: fadeInUp 0.5s ease-out;
    }
    .form-section.active { 
      display: block; 
    }
    
    /* Profile Search Styles */
    #profile-search {
      transition: all 0.2s ease;
    }
    #profile-search:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    #profile-id option {
      padding: 8px 12px;
    }
    
    /* Component Category Buttons */
    .component-cat-btn {
      padding: 0.5rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 0.5rem;
      background: white;
      color: #6b7280;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .component-cat-btn:hover {
      border-color: #3b82f6;
      color: #3b82f6;
    }
    .component-cat-btn.active {
      background: #3b82f6;
      border-color: #3b82f6;
      color: white;
    }
    #cat-frame.active { background: #2563eb; border-color: #2563eb; }
    #cat-fixed.active { background: #7c3aed; border-color: #7c3aed; }
    #cat-operable.active { background: #059669; border-color: #059669; }
    #cat-other.active { background: #6b7280; border-color: #6b7280; }
    
    /* Profile Category Headers */
    .profile-category-header {
      background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
      padding: 0.75rem 1rem;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #d1d5db;
    }
    .profile-category-header.frame { border-left: 4px solid #2563eb; }
    .profile-category-header.fixed-vent { border-left: 4px solid #7c3aed; }
    .profile-category-header.operable-vent { border-left: 4px solid #059669; }
    .profile-category-header.other { border-left: 4px solid #6b7280; }
    
    /* Note: Removed .hidden override to allow Tailwind responsive classes to work */
    
    .form-section {
      margin-bottom: 2rem;
      padding: 2rem;
      border: 2px solid #e5e7eb;
      border-radius: 1rem;
      background: linear-gradient(135deg, #ffffff, #f8fafc);
      position: relative;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    
    .form-section.active {
      border-color: #3b82f6;
      box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.3);
      transform: translateY(-2px);
    }
    
    /* Enhanced Form Controls */
    .form-control {
      transition: all 0.3s ease;
      border: 2px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 0.875rem 1rem;
      font-size: 1rem;
      background: white;
    }
    
    .form-control:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      outline: none;
      transform: translateY(-1px);
    }
    
    /* Enhanced Buttons */
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      border: none;
      padding: 0.875rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
      background: linear-gradient(135deg, #2563eb, #1e40af);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #6b7280, #4b5563);
      color: white;
      border: none;
      padding: 0.875rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
      transform: translateY(-2px);
      background: linear-gradient(135deg, #4b5563, #374151);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      padding: 0.875rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }
    
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
    }
    
    /* Enhanced Info Boxes */
    .info-box {
      background: linear-gradient(135deg, #eff6ff, #dbeafe);
      border: 1px solid #bfdbfe;
      border-radius: 1rem;
      padding: 1.5rem;
      margin: 1.5rem 0;
      position: relative;
      overflow: hidden;
    }
    
    .info-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    }
    
    /* Enhanced Tables */
    .enhanced-table {
      background: white;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
    }
    
    .enhanced-table th {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      padding: 1rem;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
    }
    
    .enhanced-table td {
      padding: 1rem;
      border-bottom: 1px solid #f3f4f6;
      transition: background-color 0.2s ease;
    }
    
    .enhanced-table tr:hover td {
      background-color: #f8fafc;
    }
    
    /* Enhanced Help Tooltips */
    .help-tooltip { 
      position: relative; 
      display: inline-block; 
    }
    
    .help-tooltip .tooltip-text {
      visibility: hidden;
      width: 250px;
      background: linear-gradient(135deg, #1f2937, #374151);
      color: #fff;
      text-align: center;
      border-radius: 0.75rem;
      padding: 0.75rem;
      position: absolute;
      z-index: 1000;
      bottom: 125%;
      left: 50%;
      margin-left: -125px;
      opacity: 0;
      transition: all 0.3s ease;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      font-size: 0.875rem;
      line-height: 1.4;
    }
    
    .help-tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
      transform: translateY(-5px);
    }
    
    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }
    
    /* Enhanced Step Progress */
    .step-progress {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      border: 1px solid #e5e7eb;
    }
    
    .step-progress h3 {
      color: #1f2937;
      font-weight: 700;
      margin-bottom: 1rem;
      text-align: center;
    }
    
    /* Enhanced Form Labels */
    .form-label {
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
      display: block;
      font-size: 0.95rem;
    }
    
    /* Enhanced Section Headers */
    .section-header {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      padding: 1.5rem;
      border-radius: 1rem 1rem 0 0;
      margin: -2rem -2rem 2rem -2rem;
      position: relative;
      overflow: hidden;
    }
    
    .section-header::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100px;
      height: 100px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      transform: translate(30px, -30px);
    }
    
    .section-header h2 {
      margin: 0;
      font-weight: 700;
      font-size: 1.5rem;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .form-section {
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }
      
      .section-header {
        padding: 1rem;
        margin: -1.5rem -1.5rem 1.5rem -1.5rem;
      }
      
      .section-header h2 {
        font-size: 1.25rem;
      }
    }
    
    /* Enhanced Visual Effects */
    .step-indicator {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }
    
    .step-indicator:hover {
      transform: translateY(-2px);
    }
    
    /* Enhanced Form Section Transitions */
    .form-section {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Enhanced Button Interactions */
    .btn-primary:active,
    .btn-secondary:active,
    .btn-success:active {
      transform: translateY(0);
    }
    
    /* Enhanced Table Row Interactions */
    .enhanced-table tr {
      transition: all 0.2s ease;
    }
    
    .enhanced-table tr:hover {
      transform: translateX(2px);
    }
    
    /* Enhanced Section Header Animation */
    .section-header::before {
      animation: float 6s ease-in-out infinite;
    }
    
    @keyframes float {
      0%, 100% {
        transform: translate(30px, -30px);
      }
      50% {
        transform: translate(20px, -20px);
      }
    }
    
    /* Draggable mullion styles */
    .cursor-ew-resize:active,
    .cursor-ns-resize:active {
      background-color: #3b82f6 !important;
    }
    
    #panelPreview.select-none {
      user-select: none;
    }
    
    #panelPreview.select-none [data-mullion-index] {
      background-color: #3b82f6;
    }
    
    /* Pulsing animation for draggable mullions */
    .draggable-mullion {
      animation: mullionPulse 2s ease-in-out 3;
    }
    
    @keyframes mullionPulse {
      0%, 100% {
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.3), inset 0 -1px 0 rgba(0,0,0,0.2);
      }
      50% {
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.3), inset 0 -1px 0 rgba(0,0,0,0.2), 0 0 8px rgba(59, 130, 246, 0.6);
      }
    }
    
    .draggable-mullion:hover {
      animation: none;
    }
    
    /* Resizable preview styles */
    #resizablePreview {
      border: 2px dashed transparent;
      transition: border-color 0.2s;
    }
    
    #resizablePreview:hover {
      border-color: rgba(59, 130, 246, 0.3);
    }
    
    #resizablePreview::-webkit-resizer {
      background: linear-gradient(135deg, transparent 50%, rgba(107, 114, 128, 0.5) 50%);
      border-radius: 0 0 4px 0;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <%- include('../partials/_header.ejs') %>
  <div class="container mx-auto py-8 px-4 max-w-6xl flex-grow">
    <!-- Page Header -->
    <div class="mb-6">
      <div class="flex items-center gap-3 mb-2">
        <a href="/admin/list-window-systems" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="text-3xl font-bold text-gray-900">Create New Window System</h1>
        <!-- Auto-save indicator -->
        <span id="autosave-indicator" class="hidden ml-auto text-xs text-green-600 bg-green-50 px-2 py-1 rounded-full flex items-center gap-1">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
          Draft saved
        </span>
      </div>
      <p class="text-gray-500">Configure a new window system template <span class="text-xs text-gray-400">(Auto-saves your progress)</span></p>
    </div>
    
    <!-- Enhanced Step Indicator -->
    <div class="step-progress">
      <h3 class="text-lg font-semibold text-gray-700 mb-6">Progress</h3>
      <div class="flex justify-center space-x-2">
        <div id="step1-indicator" class="step-indicator step-active rounded-xl py-3 px-6 flex items-center font-medium">
          <span class="mr-3 text-lg font-bold">1</span> Window Type
        </div>
        <div id="step2-indicator" class="step-indicator step-inactive rounded-xl py-3 px-6 flex items-center font-medium">
          <span class="mr-3 text-lg font-bold">2</span> Profiles
        </div>
        <div id="step3-indicator" class="step-indicator step-inactive rounded-xl py-3 px-6 flex items-center font-medium">
          <span class="mr-3 text-lg font-bold">3</span> Accessories
        </div>
        <div id="step4-indicator" class="step-indicator step-inactive rounded-xl py-3 px-6 flex items-center font-medium">
          <span class="mr-3 text-lg font-bold">4</span> Glass
        </div>
        <div id="step5-indicator" class="step-indicator step-inactive rounded-xl py-3 px-6 flex items-center font-medium">
          <span class="mr-3 text-lg font-bold">5</span> Others
        </div>
      </div>
    </div>
    
    <div class="bg-gradient-to-br from-white to-gray-50 shadow-2xl rounded-3xl p-8 border border-gray-100">
      <form id="window-form" action="/admin/compose-window/compose" method="POST">
        
        <!-- Step 1: Window Type -->
        <div id="step1-section" class="form-section active">
          <div class="section-header">
            <h2>Step 1: Basic Information</h2>
          </div>
          
          <div class="grid grid-cols-1 gap-6">
            <!-- Window Type -->
            <div class="mb-4">
              <label for="type" class="form-label">
                Window Type Name
                <span class="help-tooltip ml-2">
                  <i class="fas fa-question-circle text-blue-500"></i>
                  <span class="tooltip-text">Enter the type of window system you are creating (e.g., OXXO Horizontal Roller, Fixed Window)</span>
                </span>
              </label>
              <div class="relative">
                <input type="text" id="type" name="type" class="form-control w-full" placeholder="e.g., OXXO Horizontal Roller" required>
                <span id="name-check-status" class="absolute right-3 top-1/2 transform -translate-y-1/2 hidden">
                  <i class="fas fa-spinner fa-spin text-gray-400"></i>
                </span>
              </div>
              <p id="name-error" class="text-red-500 text-sm mt-1 hidden">
                <i class="fas fa-exclamation-circle mr-1"></i>
                <span id="name-error-text"></span>
              </p>
              <p id="name-success" class="text-green-500 text-sm mt-1 hidden">
                <i class="fas fa-check-circle mr-1"></i>Name is available
              </p>
            </div>
            
            <!-- Panel Configuration -->
            <div class="mb-4 p-4 bg-gradient-to-r from-indigo-50 to-blue-50 border border-indigo-200 rounded-xl">
              <h4 class="text-lg font-semibold text-indigo-800 mb-4">
                <i class="fas fa-th-large mr-2"></i>Panel Configuration
              </h4>
              <p class="text-sm text-indigo-600 mb-4">Define the panel layout for dynamic window preview. Use X for Operable (sliding/opening) panels and O for Fixed panels.</p>
              
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <label for="operationType" class="form-label">Operation Type</label>
                  <select id="operationType" class="form-control w-full">
                    <option value="sliding">Sliding / Roller</option>
                    <option value="casement">Casement</option>
                    <option value="awning">Awning</option>
                    <option value="hopper">Hopper</option>
                    <option value="fixed">Fixed</option>
                    <option value="single-hung">Single Hung</option>
                    <option value="double-hung">Double Hung</option>
                    <option value="tilt-turn">Tilt & Turn</option>
                    <option value="french-door">French Door</option>
                  </select>
                </div>
                
                <div>
                  <label for="panelOrientation" class="form-label">Panel Orientation</label>
                  <select id="panelOrientation" class="form-control w-full">
                    <option value="horizontal">Horizontal</option>
                    <option value="vertical">Vertical</option>
                  </select>
                </div>
                
                <div>
                  <label for="panelCount" class="form-label">Number of Panels</label>
                  <input type="number" id="panelCount" min="1" max="8" value="2" class="form-control w-full" onchange="validateAndUpdatePanels()">
                </div>
              </div>
              
              <!-- French Door Configuration (only shows when french-door is selected) -->
              <div id="frenchDoorConfig" class="mt-4 p-4 bg-purple-50 border border-purple-200 rounded-xl" style="display: none;">
                <h4 class="text-lg font-semibold text-purple-800 mb-4">
                  <i class="fas fa-door-open mr-2"></i>French Door Configuration
                </h4>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <!-- Door Type -->
                  <div>
                    <label for="doorType" class="form-label">Door Type</label>
                    <select id="doorType" class="form-control w-full" onchange="updateFrenchDoorPreview()">
                      <option value="single">Single Door</option>
                      <option value="double" selected>Double Door</option>
                    </select>
                  </div>
                  
                  <!-- Door Hinge Side (only for single door) -->
                  <div id="hingeSideContainer" style="display: none;">
                    <label for="hingeSide" class="form-label">Hinge Side</label>
                    <select id="hingeSide" class="form-control w-full" onchange="updateFrenchDoorPreview()">
                      <option value="left">Left (Opens Right)</option>
                      <option value="right">Right (Opens Left)</option>
                    </select>
                  </div>
                  
                  <!-- Left Sidelites -->
                  <div>
                    <label for="leftSidelites" class="form-label">Left Sidelites</label>
                    <input type="number" id="leftSidelites" min="0" max="4" value="0" class="form-control w-full" onchange="updateFrenchDoorPreview()">
                  </div>
                  
                  <!-- Right Sidelites -->
                  <div>
                    <label for="rightSidelites" class="form-label">Right Sidelites</label>
                    <input type="number" id="rightSidelites" min="0" max="4" value="0" class="form-control w-full" onchange="updateFrenchDoorPreview()">
                  </div>
                  
                  <!-- Transom -->
                  <div>
                    <label for="transom" class="form-label">Transom</label>
                    <select id="transom" class="form-control w-full" onchange="updateFrenchDoorPreview()">
                      <option value="none">None</option>
                      <option value="full">Full Width</option>
                      <option value="over-door">Over Door Only</option>
                    </select>
                  </div>
                  
                  <!-- Vitralux Logo Toggle -->
                  <div class="col-span-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" id="frenchDoorLogo" class="w-4 h-4 rounded" checked onchange="updateFrenchDoorPreview()">
                      <span class="text-sm text-gray-700">Show VITRALUX logo on glass</span>
                    </label>
                  </div>
                </div>
                
                <p class="text-xs text-purple-600 mt-3">
                  <i class="fas fa-info-circle mr-1"></i>
                  French doors will automatically configure panels based on your selections above.
                </p>
              </div>
              
              <!-- Panel Layout Builder -->
              <div class="mb-4">
                <label class="form-label">Panel Layout (click to toggle O/X)</label>
                <div id="panelLayoutBuilder" class="flex gap-2 flex-wrap">
                  <!-- Panels will be generated here -->
                </div>
                <p class="text-xs text-gray-500 mt-2">
                  <span class="inline-block w-4 h-4 bg-green-500 rounded mr-1 align-middle"></span> X = Operable (opens/slides)
                  <span class="inline-block w-4 h-4 bg-gray-400 rounded ml-3 mr-1 align-middle"></span> O = Fixed
                </p>
                
                <!-- Logo Toggle -->
                <div class="mt-3 flex items-center">
                  <input type="checkbox" id="showLogoCheckbox" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" onchange="toggleLogo()">
                  <label for="showLogoCheckbox" class="ml-2 text-sm text-gray-600">Show Vitralux logo on glass</label>
                </div>
              </div>
              
<!-- Live Preview -->
              <div class="mt-6 p-6 bg-gray-50 rounded-xl border border-gray-200">
                <label class="text-center block mb-4 text-lg font-semibold text-gray-700">
                  <i class="fas fa-eye mr-2 text-gray-500"></i>Live Preview
                </label>
                
                <!-- Window Frame Container -->
                <div id="panelPreviewContainer" class="flex justify-center items-center py-4">
                  <!-- Resizable wrapper -->
                  <div id="resizablePreview" class="relative" style="resize: both; overflow: hidden; min-width: 280px; min-height: 180px; width: 360px; height: 260px; max-width: 600px; max-height: 450px;">
                    <!-- Aluminum Frame -->
                    <div class="p-1.5 rounded-sm shadow-lg h-full w-full" style="background: linear-gradient(145deg, #909090 0%, #707070 20%, #585858 50%, #707070 80%, #909090 100%);">
                      <!-- Glass Area -->
                      <div id="panelPreview" class="flex overflow-hidden h-full w-full">
                        <!-- Preview panels will be generated here -->
                      </div>
                    </div>
                    <!-- Resize indicator -->
                    <div class="absolute bottom-0 right-0 w-4 h-4 cursor-se-resize flex items-center justify-center" style="color: rgba(255,255,255,0.6);">
                      <i class="fas fa-expand-alt text-xs"></i>
                    </div>
                  </div>
                </div>
                
                <!-- Resize hint -->
                <p class="text-xs text-gray-500 text-center mt-1">
                  <i class="fas fa-expand-arrows-alt mr-1"></i>Drag corner to resize preview
                </p>
                
                <!-- Label and Controls -->
                <div class="text-center mt-4">
                  <p id="panelConfigLabel" class="text-lg font-semibold text-gray-800">OO - 2 Panel Sliding</p>
                  <button type="button" id="resetRatiosBtn" onclick="resetPanelRatios()" 
                          class="mt-2 px-4 py-1.5 bg-blue-100 hover:bg-blue-200 text-blue-700 text-sm rounded-full transition-all" style="display: none;">
                    <i class="fas fa-undo mr-1"></i>Reset to equal sizes
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-8 flex justify-between items-center">
            <a href="/admin" class="btn-secondary px-6 py-3">
              <i class="fas fa-arrow-left mr-2"></i>Back to Admin
            </a>
            <button type="button" id="to-step2-btn" class="btn-primary px-6 py-3">
              Next Step<i class="fas fa-arrow-right ml-2"></i>
            </button>
          </div>
        </div>
        
        <!-- Step 2: Profiles -->
        <div id="step2-section" class="form-section">
          <div class="section-header mb-6">
            <div class="flex items-center gap-3">
              <div class="flex-shrink-0 w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-lg">
                2
              </div>
              <div>
                <h2 class="text-2xl font-bold text-gray-900">Step 2: Profiles</h2>
                <p class="text-sm text-gray-500 mt-1">Configure the profiles that make up this window system</p>
              </div>
            </div>
          </div>
          
          <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 rounded-lg p-5 mb-6 shadow-sm">
            <div class="flex items-start">
              <div class="flex-shrink-0">
                <i class="fas fa-info-circle text-blue-500 text-2xl"></i>
              </div>
              <div class="ml-4">
                <h4 class="text-lg font-semibold text-blue-900 mb-2">Profile Configuration</h4>
                <p class="text-blue-800 text-sm leading-relaxed">
                  Add profiles that compose this window system. Each profile requires a length equation using variables like <code class="bg-white px-1.5 py-0.5 rounded text-xs font-mono">width</code>, <code class="bg-white px-1.5 py-0.5 rounded text-xs font-mono">height</code>, <code class="bg-white px-1.5 py-0.5 rounded text-xs font-mono">perimeter</code>, or <code class="bg-white px-1.5 py-0.5 rounded text-xs font-mono">area</code>.
                </p>
              </div>
            </div>
          </div>

          <!-- Profiles Section -->
          <div id="profiles-section" class="mb-8">
            <!-- Component Category Selector Card -->
            <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6 mb-6">
              <div class="mb-4">
                <label class="text-sm font-semibold text-gray-700 mb-3 block">
                  <i class="fas fa-tags mr-2 text-blue-500"></i>Component Category
                </label>
                <div class="flex gap-3 flex-wrap">
                  <button type="button" id="cat-frame" class="component-cat-btn active" onclick="selectProfileCategory('frame')">
                    <i class="fas fa-border-all mr-2"></i>Frame
                  </button>
                  <button type="button" id="cat-fixed" class="component-cat-btn" onclick="selectProfileCategory('fixed-vent')">
                    <i class="fas fa-square mr-2"></i>Fixed Vent
                  </button>
                  <button type="button" id="cat-operable" class="component-cat-btn" onclick="selectProfileCategory('operable-vent')">
                    <i class="fas fa-window-maximize mr-2"></i>Operable Vent
                  </button>
                  <button type="button" id="cat-other" class="component-cat-btn" onclick="selectProfileCategory('other')">
                    <i class="fas fa-ellipsis-h mr-2"></i>Other
                  </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">Select which part of the window this profile belongs to</p>
              </div>
            </div>

            <!-- Add Profile Form Card -->
            <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6 mb-6">
              <h3 class="text-lg font-semibold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-plus-circle mr-2 text-blue-500"></i>Add New Profile
              </h3>
              
              <!-- Profile Selection Row -->
              <div class="mb-6 pb-6 border-b border-gray-200">
                <label for="profile-id" class="text-sm font-semibold text-gray-700 mb-2 block">
                  <i class="fas fa-search mr-2 text-gray-400"></i>Profile Type
                </label>
                <div class="relative">
                  <div id="profile-select-wrapper" class="relative">
                    <input type="text" 
                           id="profile-search-input" 
                           placeholder="Search and select profile..." 
                           class="form-control w-full pr-10" 
                           autocomplete="off"
                           readonly
                           style="cursor: pointer;">
                    <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                  </div>
                  <div id="profile-dropdown" class="hidden absolute z-50 w-full mt-1 bg-white border-2 border-gray-200 rounded-lg shadow-lg max-h-64 overflow-hidden">
                    <div class="p-2 border-b border-gray-200 sticky top-0 bg-white">
                      <input type="text" 
                             id="profile-search-filter" 
                             placeholder="Type to search..." 
                             class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                             autocomplete="off">
                    </div>
                    <div id="profile-options-list" class="overflow-y-auto max-h-56">
                      <% profiles.forEach(profile => { %>
                        <div class="profile-option px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0" 
                             data-value="<%= profile._id %>"
                             data-name="<%= profile.name.toLowerCase() %>"
                             data-color="<%= profile.color || '' %>">
                          <span class="font-medium"><%= profile.name %></span>
                          <% if (profile.color) { %>
                            <span class="text-xs text-gray-500 ml-2">(<%= profile.color %>)</span>
                          <% } %>
                        </div>
                      <% }); %>
                    </div>
                    <div id="profile-no-results" class="hidden px-3 py-2 text-sm text-gray-500 text-center">
                      No profiles found
                    </div>
                  </div>
                  <input type="hidden" id="profile-id" value="">
                </div>
              </div>

              <!-- Configuration Fields Row -->
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- Quantity Section -->
                <div>
                  <label for="profile-quantity-type" class="text-sm font-semibold text-gray-700 mb-2 block">
                    <i class="fas fa-hashtag mr-2 text-gray-400"></i>Quantity Type
                  </label>
                  <select id="profile-quantity-type" class="form-control w-full" onchange="toggleProfileQuantityType()">
                    <option value="fixed">Fixed Quantity</option>
                    <option value="equation">Equation</option>
                  </select>
                  
                  <!-- Fixed Quantity Input -->
                  <div id="profile-quantity-fixed-container" class="mt-2">
                    <input type="number" id="profile-quantity" value="1" placeholder="1" min="1" class="form-control w-full">
                  </div>
                  
                  <!-- Quantity Equation Input -->
                  <div id="profile-quantity-equation-container" class="mt-2 hidden">
                    <input type="text" id="profile-quantity-equation" placeholder="e.g., 4, (width / 24) + 1" class="form-control w-full">
                    <div id="profile-quantity-equation-validation-message" class="mt-2 text-sm"></div>
                    <div id="profile-quantity-equation-preview" class="mt-2 text-xs text-gray-600"></div>
                    <div class="mt-3 p-3 bg-purple-50 rounded-lg border border-purple-100">
                      <p class="text-xs font-semibold text-purple-800 mb-2">
                        <i class="fas fa-info-circle mr-1"></i>Available Variables (click to insert):
                      </p>
                      <div class="flex flex-wrap gap-2 mb-3">
                        <button type="button" class="variable-btn px-3 py-1.5 bg-white rounded-md text-xs font-mono text-purple-700 border border-purple-300 hover:bg-purple-100 hover:border-purple-400 hover:shadow-sm transition-all cursor-pointer" onclick="insertVariable('width', 'profile-quantity-equation')">
                          width
                        </button>
                        <button type="button" class="variable-btn px-3 py-1.5 bg-white rounded-md text-xs font-mono text-purple-700 border border-purple-300 hover:bg-purple-100 hover:border-purple-400 hover:shadow-sm transition-all cursor-pointer" onclick="insertVariable('height', 'profile-quantity-equation')">
                          height
                        </button>
                        <button type="button" class="variable-btn px-3 py-1.5 bg-white rounded-md text-xs font-mono text-purple-700 border border-purple-300 hover:bg-purple-100 hover:border-purple-400 hover:shadow-sm transition-all cursor-pointer" onclick="insertVariable('perimeter', 'profile-quantity-equation')">
                          perimeter
                        </button>
                        <button type="button" class="variable-btn px-3 py-1.5 bg-white rounded-md text-xs font-mono text-purple-700 border border-purple-300 hover:bg-purple-100 hover:border-purple-400 hover:shadow-sm transition-all cursor-pointer" onclick="insertVariable('area', 'profile-quantity-equation')">
                          area
                        </button>
                      </div>
                      <div class="flex flex-wrap gap-1.5 mb-2">
                        <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' + ', 'profile-quantity-equation')">+</button>
                        <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' - ', 'profile-quantity-equation')">-</button>
                        <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' * ', 'profile-quantity-equation')">×</button>
                        <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' / ', 'profile-quantity-equation')">÷</button>
                        <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable('(', 'profile-quantity-equation')">(</button>
                        <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(')', 'profile-quantity-equation')">)</button>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div>
                  <label for="profile-orientation" class="text-sm font-semibold text-gray-700 mb-2 block">
                    <i class="fas fa-arrows-alt mr-2 text-gray-400"></i>Orientation
                  </label>
                  <select id="profile-orientation" class="form-control w-full">
                    <option value="" disabled selected>Select orientation</option>
                    <option value="horizontal">Horizontal</option>
                    <option value="vertical">Vertical</option>
                  </select>
                </div>
                
                <div>
                  <label for="profile-position" class="text-sm font-semibold text-gray-700 mb-2 block">
                    <i class="fas fa-map-marker-alt mr-2 text-gray-400"></i>Position <span class="text-gray-400 text-xs font-normal">(Informative)</span>
                  </label>
                  <input type="text" id="profile-position" placeholder="e.g., sill, stile, head, jamb, mullion..." class="form-control w-full">
                </div>
                
                <div>
                  <label for="profile-show-to-user" class="text-sm font-semibold text-gray-700 mb-2 block">
                    <i class="fas fa-user-cog mr-2 text-gray-400"></i>User Settings
                  </label>
                  <div class="flex items-center h-10 bg-gray-50 rounded-lg px-3 border border-gray-200">
                    <input type="checkbox" id="profile-show-to-user" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="profile-show-to-user" class="ml-3 text-sm text-gray-700 cursor-pointer">Allow users to modify</label>
                  </div>
                </div>
              </div>

              <!-- Length Equation Section -->
              <div class="mb-6 pb-6 border-b border-gray-200">
                <label for="profile-length-equation" class="text-sm font-semibold text-gray-700 mb-2 block">
                  <i class="fas fa-calculator mr-2 text-blue-500"></i>Length Equation <span class="text-red-500">*</span> <span id="length-equation-unit-label" class="text-gray-500 text-xs font-normal">(in <span id="length-equation-unit">inches</span>)</span>
                </label>
                <input type="text" id="profile-length-equation" placeholder="e.g., width - 23, perimeter / 2" class="form-control w-full text-lg py-3 px-4" style="min-height: 50px;">
                <div id="profile-equation-validation-message" class="mt-2 text-sm"></div>
                <div id="profile-equation-preview" class="mt-2 text-xs text-gray-600"></div>
                <div class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-100">
                  <p class="text-xs font-semibold text-blue-800 mb-2">
                    <i class="fas fa-info-circle mr-1"></i>Available Variables (click to insert):
                  </p>
                  <div class="flex flex-wrap gap-2 mb-3">
                    <button type="button" class="variable-btn px-3 py-1.5 bg-white rounded-md text-xs font-mono text-blue-700 border border-blue-300 hover:bg-blue-100 hover:border-blue-400 hover:shadow-sm transition-all cursor-pointer" data-variable="width" onclick="insertVariable('width')">
                      width
                    </button>
                    <button type="button" class="variable-btn px-3 py-1.5 bg-white rounded-md text-xs font-mono text-blue-700 border border-blue-300 hover:bg-blue-100 hover:border-blue-400 hover:shadow-sm transition-all cursor-pointer" data-variable="height" onclick="insertVariable('height')">
                      height
                    </button>
                    <button type="button" class="variable-btn px-3 py-1.5 bg-white rounded-md text-xs font-mono text-blue-700 border border-blue-300 hover:bg-blue-100 hover:border-blue-400 hover:shadow-sm transition-all cursor-pointer" data-variable="perimeter" onclick="insertVariable('perimeter')">
                      perimeter
                    </button>
                    <button type="button" class="variable-btn px-3 py-1.5 bg-white rounded-md text-xs font-mono text-blue-700 border border-blue-300 hover:bg-blue-100 hover:border-blue-400 hover:shadow-sm transition-all cursor-pointer" data-variable="area" onclick="insertVariable('area')">
                      area
                    </button>
                  </div>
                  <div class="flex flex-wrap gap-1.5 mb-2">
                    <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' + ')">+</button>
                    <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' - ')">-</button>
                    <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' * ')">×</button>
                    <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' / ')">÷</button>
                    <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable('(')">(</button>
                    <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(')')">)</button>
                  </div>
                  <p class="text-xs text-blue-700 mb-1">
                    <strong>Examples:</strong> "width - 23", "perimeter / 2", "height * 2"
                  </p>
                  <p class="text-xs text-blue-600 font-semibold" id="length-equation-result-unit">
                    <i class="fas fa-ruler mr-1"></i>Result is in <span id="length-equation-result-unit-text">inches</span>
                  </p>
                </div>
              </div>
              
              <!-- Add Button -->
              <div class="flex justify-end">
                <button type="button" onclick="addProfileEntry()" class="btn-success px-8 py-3 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex items-center">
                  <i class="fas fa-plus mr-2"></i>Add Profile
                </button>
              </div>
            </div>

            <!-- Added Profiles Table Card -->
            <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                  <i class="fas fa-list mr-2 text-blue-500"></i>Added Profiles
                  <span id="profiles-count-badge" class="ml-3 px-2 py-1 bg-blue-100 text-blue-700 text-xs font-semibold rounded-full">0</span>
                </h3>
              </div>
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Profile</th>
                      <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Quantity</th>
                      <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Orientation</th>
                      <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Position</th>
                      <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Length Equation</th>
                      <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">User Config</th>
                      <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Action</th>
                    </tr>
                  </thead>
                  <tbody id="profiles-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Rows will be dynamically added here -->
                  </tbody>
                </table>
              </div>
              <div id="profiles-empty-state" class="text-center py-12 text-gray-400">
                <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
                <p class="text-sm font-medium">No profiles added yet</p>
                <p class="text-xs mt-1">Add at least one profile to continue</p>
              </div>
            </div>
          </div>

          <div class="mt-8 pt-6 border-t border-gray-200 flex justify-between items-center bg-gray-50 -mx-6 -mb-6 px-6 pb-6 rounded-b-xl">
            <button type="button" id="back-to-step1-btn" class="btn-secondary px-6 py-3 rounded-lg shadow-sm hover:shadow-md transition-all">
              <i class="fas fa-arrow-left mr-2"></i>Previous Step
            </button>
            <button type="button" id="to-step3-btn" class="btn-primary px-8 py-3 rounded-lg shadow-md hover:shadow-lg transition-all">
              Next Step<i class="fas fa-arrow-right ml-2"></i>
            </button>
          </div>
        </div>
        
        <!-- Step 3: Accessories -->
        <div id="step3-section" class="form-section">
          <div class="section-header">
            <h2>Step 3: Accessories</h2>
          </div>
          
          <div class="info-box">
            <div class="flex items-start">
              <i class="fas fa-info-circle text-blue-500 text-xl mr-3 mt-1"></i>
              <div>
                <h4 class="font-semibold text-blue-800 mb-1">Accessory Configuration</h4>
                <p class="text-blue-700">
                  Add any accessories needed for this window system. The unit will be automatically set based on the selected accessory.
                </p>
              </div>
            </div>
          </div>

          <div id="accessories-section" class="mb-8">
            <div class="p-4 bg-gray-50 rounded-lg shadow-sm mb-4">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <label for="accessory-id" class="form-label">Accessory Type</label>
                  <select id="accessory-id" class="form-control w-full">
                    <option value="">Select Accessory</option>
                    <% accessories.forEach(accessory => { %>
                      <option value="<%= accessory._id %>" data-unit="<%= accessory.unit %>"><%= accessory.name %></option>
                    <% }); %>
                  </select>
                </div>
                
                <div>
                  <label for="accessory-unit" class="form-label">Unit</label>
                  <input type="text" id="accessory-unit" placeholder="Unit" class="form-control w-full bg-gray-50" readonly>
                </div>
                
                <div>
                  <label for="accessory-show-to-user" class="form-label">User Configurable</label>
                  <div class="flex items-center mt-2">
                    <input type="checkbox" id="accessory-show-to-user" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="accessory-show-to-user" class="ml-2 text-sm text-gray-700">Show to users</label>
                  </div>
                  <p class="text-xs text-gray-500 mt-1">Allow users to modify this accessory</p>
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="accessory-quantity-type" class="form-label">Quantity Type</label>
                  <select id="accessory-quantity-type" class="form-control w-full" onchange="toggleAccessoryQuantityType()">
                    <option value="fixed">Fixed Quantity</option>
                    <option value="equation">Equation</option>
                  </select>
                </div>
                
                <div id="accessory-quantity-fixed-container">
                  <label for="accessory-quantity" class="form-label">Quantity</label>
                  <input type="number" id="accessory-quantity" placeholder="Qty" min="1" class="form-control w-full">
                </div>
                
                <div id="accessory-quantity-equation-container" style="display: none;" class="md:col-span-2">
                  <label for="accessory-quantity-equation" class="form-label">Quantity Equation</label>
                  <input type="text" id="accessory-quantity-equation" placeholder="e.g., 5 * height, 2 * perimeter" class="form-control w-full">
                  <div id="equation-validation-message" class="mt-2 text-sm"></div>
                  <div id="equation-preview" class="mt-2 text-xs text-gray-600"></div>
                  <div class="mt-3 p-3 bg-green-50 rounded-lg border border-green-100">
                    <p class="text-xs font-semibold text-green-800 mb-2">
                      <i class="fas fa-info-circle mr-1"></i>Available Variables (click to insert):
                    </p>
                    <div class="flex flex-wrap gap-2 mb-3">
                      <button type="button" class="variable-btn px-3 py-1.5 bg-white rounded-md text-xs font-mono text-green-700 border border-green-300 hover:bg-green-100 hover:border-green-400 hover:shadow-sm transition-all cursor-pointer" onclick="insertVariable('width', 'accessory-quantity-equation')">
                        width
                      </button>
                      <button type="button" class="variable-btn px-3 py-1.5 bg-white rounded-md text-xs font-mono text-green-700 border border-green-300 hover:bg-green-100 hover:border-green-400 hover:shadow-sm transition-all cursor-pointer" onclick="insertVariable('height', 'accessory-quantity-equation')">
                        height
                      </button>
                      <button type="button" class="variable-btn px-3 py-1.5 bg-white rounded-md text-xs font-mono text-green-700 border border-green-300 hover:bg-green-100 hover:border-green-400 hover:shadow-sm transition-all cursor-pointer" onclick="insertVariable('perimeter', 'accessory-quantity-equation')">
                        perimeter
                      </button>
                      <button type="button" class="variable-btn px-3 py-1.5 bg-white rounded-md text-xs font-mono text-green-700 border border-green-300 hover:bg-green-100 hover:border-green-400 hover:shadow-sm transition-all cursor-pointer" onclick="insertVariable('area', 'accessory-quantity-equation')">
                        area
                      </button>
                    </div>
                    <div class="flex flex-wrap gap-1.5 mb-2">
                      <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' + ', 'accessory-quantity-equation')">+</button>
                      <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' - ', 'accessory-quantity-equation')">-</button>
                      <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' * ', 'accessory-quantity-equation')">×</button>
                      <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' / ', 'accessory-quantity-equation')">÷</button>
                      <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable('(', 'accessory-quantity-equation')">(</button>
                      <button type="button" class="operator-btn px-2 py-1 bg-white rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(')', 'accessory-quantity-equation')">)</button>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Advanced Configuration (only show when user configurable is checked) -->
              <div id="accessory-advanced-config" class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4 pt-4 border-t border-gray-200" style="display: none;">
                <div>
                  <label for="accessory-component-group-select" class="block text-gray-700 font-medium mb-1">Component Group:</label>
                  <select id="accessory-component-group-select" class="form-control shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" onchange="toggleCustomGroupInput()">
                    <option value="">Select a group...</option>
                    <% componentGroups.forEach(group => { %>
                      <option value="<%= group.name %>"><%= group.displayName %></option>
                    <% }); %>
                    <option value="custom">Custom (Type your own)</option>
                  </select>
                  <input type="text" id="accessory-component-group-custom" placeholder="Enter custom group name" class="form-control shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500 mt-2" style="display: none;">
                  <input type="hidden" id="accessory-component-group" value="">
                  <p class="text-xs text-gray-500 mt-1">Group related components together for user selection</p>
                </div>
                
                <div>
                  <label for="accessory-selection-type" class="block text-gray-700 font-medium mb-1">Selection Type:</label>
                  <select id="accessory-selection-type" class="form-control shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
                    <option value="quantity">Quantity (Default)</option>
                    <option value="single">Single Choice</option>
                    <option value="multiple">Multiple Choice</option>
                  </select>
                  <p class="text-xs text-gray-500 mt-1">How users can select this component</p>
                </div>
                
                <div>
                  <label for="accessory-is-default" class="block text-gray-700 font-medium mb-1">Default Choice:</label>
                  <div class="flex items-center mt-2">
                    <input type="checkbox" id="accessory-is-default" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="accessory-is-default" class="ml-2 text-sm text-gray-700">Default selection</label>
                  </div>
                  <p class="text-xs text-gray-500 mt-1">Pre-select this in choice groups</p>
                </div>
              </div>
              
              <div class="mt-4 text-right">
                <button type="button" onclick="addAccessoryEntry()" class="btn-success px-6 py-3">
                  <i class="fas fa-plus mr-2"></i>Add Accessory
                </button>
              </div>
            </div>

            <!-- Table to display added accessories -->
            <div class="mt-6 overflow-x-auto">
              <h3 class="text-lg font-medium text-gray-700 mb-3">Added Accessories</h3>
              <table class="enhanced-table min-w-full">
                <thead>
                  <tr>
                    <th>Accessory</th>
                    <th>Quantity</th>
                    <th>Unit</th>
                    <th>User Config</th>
                    <th>Choice Group</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="accessories-table-body">
                  <!-- Rows will be dynamically added here -->
                </tbody>
              </table>
              <div id="accessories-empty-state" class="text-center py-8 text-gray-500 italic bg-gray-50 rounded-lg mt-4">
                No accessories added yet.
              </div>
            </div>
          </div>

          <div class="mt-8 flex justify-between items-center">
            <button type="button" id="back-to-step2-btn" class="btn-secondary px-6 py-3">
              <i class="fas fa-arrow-left mr-2"></i>Previous Step
            </button>
            <button type="button" id="to-step4-btn" class="btn-primary px-6 py-3">
              Next Step<i class="fas fa-arrow-right ml-2"></i>
            </button>
          </div>
        </div>
        
        <!-- Step 4: Glass Configuration -->
        <div id="step4-section" class="form-section">
          <div class="section-header">
            <h2>Step 4: Glass Configuration <span class="text-green-200 text-sm font-normal">(Optional)</span></h2>
            <p class="text-green-100 text-sm">Configure glass size calculation and missile impact types. Skip this step if your system has no glass.</p>
          </div>
          
          <div class="bg-white rounded-xl shadow-lg border border-gray-200">
            <div class="p-6">
              <!-- Glass Size Equations -->
              <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Glass Size Calculation</h3>
                
                <!-- Glass Width Equation -->
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
                  <label for="glass-width-equation" class="block text-sm font-medium text-gray-700 mb-2">
                    Glass Width Equation <span class="text-gray-400 text-xs font-normal">(optional)</span>
                    <span class="text-xs text-gray-500 font-normal ml-2" id="glass-width-equation-unit-label">(Current unit: <span id="glass-width-equation-unit-display">inches</span>)</span>
                  </label>
                  <input type="text" id="glass-width-equation" name="glassWidthEquation" 
                         placeholder="e.g., width - 20, width - 20mm" 
                         class="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" 
                         style="min-height: 50px;">
                  
                  <!-- Variable & Operator Buttons for Glass Width -->
                  <div class="mt-3 p-3 bg-white rounded-lg border border-blue-100">
                    <p class="text-xs font-semibold text-blue-800 mb-2">
                      <i class="fas fa-info-circle mr-1"></i>Available Variables (click to insert):
                    </p>
                    <div class="flex flex-wrap gap-2 mb-3">
                      <button type="button" class="variable-btn px-3 py-1.5 bg-blue-50 rounded-md text-xs font-mono text-blue-700 border border-blue-300 hover:bg-blue-100 hover:border-blue-400 hover:shadow-sm transition-all cursor-pointer" onclick="insertVariable('width', 'glass-width-equation')">
                        width
                      </button>
                      <button type="button" class="variable-btn px-3 py-1.5 bg-blue-50 rounded-md text-xs font-mono text-blue-700 border border-blue-300 hover:bg-blue-100 hover:border-blue-400 hover:shadow-sm transition-all cursor-pointer" onclick="insertVariable('height', 'glass-width-equation')">
                        height
                      </button>
                      <button type="button" class="variable-btn px-3 py-1.5 bg-blue-50 rounded-md text-xs font-mono text-blue-700 border border-blue-300 hover:bg-blue-100 hover:border-blue-400 hover:shadow-sm transition-all cursor-pointer" onclick="insertVariable('perimeter', 'glass-width-equation')">
                        perimeter
                      </button>
                      <button type="button" class="variable-btn px-3 py-1.5 bg-blue-50 rounded-md text-xs font-mono text-blue-700 border border-blue-300 hover:bg-blue-100 hover:border-blue-400 hover:shadow-sm transition-all cursor-pointer" onclick="insertVariable('area', 'glass-width-equation')">
                        area
                      </button>
                    </div>
                    <div class="flex flex-wrap gap-1.5 mb-2">
                      <button type="button" class="operator-btn px-2 py-1 bg-gray-50 rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' + ', 'glass-width-equation')">+</button>
                      <button type="button" class="operator-btn px-2 py-1 bg-gray-50 rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' - ', 'glass-width-equation')">-</button>
                      <button type="button" class="operator-btn px-2 py-1 bg-gray-50 rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' * ', 'glass-width-equation')">×</button>
                      <button type="button" class="operator-btn px-2 py-1 bg-gray-50 rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' / ', 'glass-width-equation')">÷</button>
                      <button type="button" class="operator-btn px-2 py-1 bg-gray-50 rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable('(', 'glass-width-equation')">(</button>
                      <button type="button" class="operator-btn px-2 py-1 bg-gray-50 rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(')', 'glass-width-equation')">)</button>
                    </div>
                    <p class="text-xs text-blue-700">
                      <strong>Examples:</strong> "width - 20", "width - 38", "width * 0.9"
                    </p>
                  </div>
                  
                  <p class="mt-2 text-xs text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    Numeric constants (e.g., 20, 38) are assumed to be in mm and will be converted to inches automatically.
                  </p>
                  <div id="glass-width-equation-preview" class="mt-2 text-sm text-gray-700 hidden">
                    <strong>Preview:</strong> <span id="glass-width-equation-preview-value"></span>
                  </div>
                  <div id="glass-width-equation-error" class="mt-2 text-sm text-red-600 hidden"></div>
                </div>
                
                <!-- Glass Height Equation -->
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
                  <label for="glass-height-equation" class="block text-sm font-medium text-gray-700 mb-2">
                    Glass Height Equation <span class="text-gray-400 text-xs font-normal">(optional)</span>
                    <span class="text-xs text-gray-500 font-normal ml-2" id="glass-height-equation-unit-label">(Current unit: <span id="glass-height-equation-unit-display">inches</span>)</span>
                  </label>
                  <input type="text" id="glass-height-equation" name="glassHeightEquation" 
                         placeholder="e.g., height - 38, height - 38mm" 
                         class="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" 
                         style="min-height: 50px;">
                  
                  <!-- Variable & Operator Buttons for Glass Height -->
                  <div class="mt-3 p-3 bg-white rounded-lg border border-blue-100">
                    <p class="text-xs font-semibold text-blue-800 mb-2">
                      <i class="fas fa-info-circle mr-1"></i>Available Variables (click to insert):
                    </p>
                    <div class="flex flex-wrap gap-2 mb-3">
                      <button type="button" class="variable-btn px-3 py-1.5 bg-blue-50 rounded-md text-xs font-mono text-blue-700 border border-blue-300 hover:bg-blue-100 hover:border-blue-400 hover:shadow-sm transition-all cursor-pointer" onclick="insertVariable('width', 'glass-height-equation')">
                        width
                      </button>
                      <button type="button" class="variable-btn px-3 py-1.5 bg-blue-50 rounded-md text-xs font-mono text-blue-700 border border-blue-300 hover:bg-blue-100 hover:border-blue-400 hover:shadow-sm transition-all cursor-pointer" onclick="insertVariable('height', 'glass-height-equation')">
                        height
                      </button>
                      <button type="button" class="variable-btn px-3 py-1.5 bg-blue-50 rounded-md text-xs font-mono text-blue-700 border border-blue-300 hover:bg-blue-100 hover:border-blue-400 hover:shadow-sm transition-all cursor-pointer" onclick="insertVariable('perimeter', 'glass-height-equation')">
                        perimeter
                      </button>
                      <button type="button" class="variable-btn px-3 py-1.5 bg-blue-50 rounded-md text-xs font-mono text-blue-700 border border-blue-300 hover:bg-blue-100 hover:border-blue-400 hover:shadow-sm transition-all cursor-pointer" onclick="insertVariable('area', 'glass-height-equation')">
                        area
                      </button>
                    </div>
                    <div class="flex flex-wrap gap-1.5 mb-2">
                      <button type="button" class="operator-btn px-2 py-1 bg-gray-50 rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' + ', 'glass-height-equation')">+</button>
                      <button type="button" class="operator-btn px-2 py-1 bg-gray-50 rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' - ', 'glass-height-equation')">-</button>
                      <button type="button" class="operator-btn px-2 py-1 bg-gray-50 rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' * ', 'glass-height-equation')">×</button>
                      <button type="button" class="operator-btn px-2 py-1 bg-gray-50 rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(' / ', 'glass-height-equation')">÷</button>
                      <button type="button" class="operator-btn px-2 py-1 bg-gray-50 rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable('(', 'glass-height-equation')">(</button>
                      <button type="button" class="operator-btn px-2 py-1 bg-gray-50 rounded text-xs font-mono text-gray-700 border border-gray-300 hover:bg-gray-100 transition-all cursor-pointer" onclick="insertVariable(')', 'glass-height-equation')">)</button>
                    </div>
                    <p class="text-xs text-blue-700">
                      <strong>Examples:</strong> "height - 38", "height - 20", "height * 0.9"
                    </p>
                  </div>
                  
                  <p class="mt-2 text-xs text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    Numeric constants (e.g., 20, 38) are assumed to be in mm and will be converted to inches automatically.
                  </p>
                  <div id="glass-height-equation-preview" class="mt-2 text-sm text-gray-700 hidden">
                    <strong>Preview:</strong> <span id="glass-height-equation-preview-value"></span>
                  </div>
                  <div id="glass-height-equation-error" class="mt-2 text-sm text-red-600 hidden"></div>
                </div>
              </div>
              
              <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Select Missile Impact Types</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="p-4 bg-gray-50 rounded-xl border-2 border-dashed border-red-200">
                    <label class="flex items-center cursor-pointer">
                      <input type="checkbox" id="missile-lmi" name="missileLMI" class="h-5 w-5 text-red-600 focus:ring-red-500 border-gray-300 rounded" onchange="toggleMissileType('LMI')">
                      <div class="ml-3">
                        <span class="text-sm font-medium text-gray-700">Large Missile Impact (LMI)</span>
                        <p class="text-xs text-gray-500">Window system supports large missile impact resistance</p>
                      </div>
                    </label>
                  </div>
                  
                  <div class="p-4 bg-gray-50 rounded-xl border-2 border-dashed border-red-200">
                    <label class="flex items-center cursor-pointer">
                      <input type="checkbox" id="missile-smi" name="missileSMI" class="h-5 w-5 text-red-600 focus:ring-red-500 border-gray-300 rounded" onchange="toggleMissileType('SMI')">
                      <div class="ml-3">
                        <span class="text-sm font-medium text-gray-700">Small Missile Impact (SMI)</span>
                        <p class="text-xs text-gray-500">Window system supports small missile impact resistance</p>
                      </div>
                    </label>
                  </div>
                </div>
              </div>
              
              <!-- LMI Glass Selection -->
              <div id="lmi-glass-section" class="mb-6" style="display: none;">
                <div class="p-4 bg-red-50 border border-red-200 rounded-xl mb-4">
                  <h4 class="text-sm font-semibold text-red-800 mb-2">Large Missile Impact (LMI) - Available Glasses</h4>
                  <p class="text-xs text-red-700">Select which glasses are available for LMI. Users will only see these glasses when they select LMI.</p>
                </div>
                <div class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-4 bg-white">
                  <% if (typeof glasses !== 'undefined' && glasses.length > 0) { %>
                    <% glasses.forEach(glass => { %>
                      <label class="flex items-center py-2 px-3 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="checkbox" name="lmiGlasses[]" value="<%= glass._id %>" class="lmi-glass-checkbox h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                        <div class="ml-3">
                          <span class="text-sm font-medium text-gray-700"><%= glass.glass_type %></span>
                          <p class="text-xs text-gray-500"><%= glass.description %></p>
                        </div>
                      </label>
                    <% }) %>
                  <% } else { %>
                    <p class="text-sm text-gray-500">No glasses available. Please add glasses first.</p>
                  <% } %>
                </div>
              </div>
              
              <!-- SMI Glass Selection -->
              <div id="smi-glass-section" class="mb-6" style="display: none;">
                <div class="p-4 bg-red-50 border border-red-200 rounded-xl mb-4">
                  <h4 class="text-sm font-semibold text-red-800 mb-2">Small Missile Impact (SMI) - Available Glasses</h4>
                  <p class="text-xs text-red-700">Select which glasses are available for SMI. Users will only see these glasses when they select SMI.</p>
                </div>
                <div class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-4 bg-white">
                  <% if (typeof glasses !== 'undefined' && glasses.length > 0) { %>
                    <% glasses.forEach(glass => { %>
                      <label class="flex items-center py-2 px-3 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="checkbox" name="smiGlasses[]" value="<%= glass._id %>" class="smi-glass-checkbox h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                        <div class="ml-3">
                          <span class="text-sm font-medium text-gray-700"><%= glass.glass_type %></span>
                          <p class="text-xs text-gray-500"><%= glass.description %></p>
                        </div>
                      </label>
                    <% }) %>
                  <% } else { %>
                    <p class="text-sm text-gray-500">No glasses available. Please add glasses first.</p>
                  <% } %>
                </div>
              </div>
              
              <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                <div class="flex items-start">
                  <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                    <i class="fas fa-info-circle text-blue-600"></i>
                  </div>
                  <div>
                    <h4 class="text-sm font-semibold text-blue-800 mb-1">How it works</h4>
                    <p class="text-xs text-blue-700">
                      Enable the missile impact types this window system supports, then select which glasses are available for each type. When users quote, they'll select a missile type and only see the glasses you've configured for that type.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-8 flex justify-between items-center">
            <button type="button" id="back-to-step3-btn" class="btn-secondary px-6 py-3">
              <i class="fas fa-arrow-left mr-2"></i>Previous Step
            </button>
            <button type="button" id="to-step5-btn" class="btn-primary px-6 py-3">
              Next Step
              <i class="fas fa-arrow-right ml-2"></i>
            </button>
          </div>
        </div>
        
        <!-- Step 5: Others (Muntin Configuration) -->
        <div id="step5-section" class="form-section">
          <div class="section-header">
            <h2>Step 5: Others</h2>
          </div>
          
          <!-- Final Step Banner -->
          <div class="mb-6 p-4 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl shadow-lg">
            <div class="flex items-center justify-between">
              <div class="flex items-center text-white">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center mr-4">
                  <i class="fas fa-flag-checkered text-xl"></i>
                </div>
                <div>
                  <h3 class="font-bold text-lg">Final Step!</h3>
                  <p class="text-green-100 text-sm">Configure muntins (optional) and create your window system</p>
                </div>
              </div>
              <div class="hidden md:block text-white/80">
                <i class="fas fa-th-large text-4xl"></i>
              </div>
            </div>
          </div>

          <!-- Main Muntin Card -->
          <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            
            <!-- Enable Muntins Toggle -->
            <div id="muntin-toggle-section" class="p-6 border-b border-gray-100">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <div class="w-12 h-12 bg-amber-100 rounded-xl flex items-center justify-center mr-4">
                    <i class="fas fa-th text-amber-600 text-xl"></i>
                  </div>
                  <div>
                    <h3 class="text-lg font-semibold text-gray-800">Decorative Muntins</h3>
                    <p class="text-sm text-gray-500">Add grid dividers to create multiple pane appearance</p>
                  </div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="muntin-enabled" class="sr-only peer" onchange="toggleMuntinConfiguration()">
                  <div class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-amber-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-amber-500"></div>
                  <span id="muntin-toggle-label" class="ml-3 text-sm font-medium text-gray-500">Disabled</span>
                </label>
              </div>
            </div>
            
            <!-- Muntin Configuration (Hidden by default) -->
            <div id="muntin-config-section" style="display: none;">
              
              <!-- Profile Selection -->
              <div class="p-6 bg-gray-50 border-b border-gray-100">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label for="muntin-profile" class="block text-sm font-semibold text-gray-700 mb-2">
                      <i class="fas fa-layer-group text-amber-500 mr-2"></i>Muntin Profile
                    </label>
                    <select id="muntin-profile" class="form-control w-full">
                      <option value="">Select Muntin Profile</option>
                      <% if (profiles.filter(p => p.isMuntin).length > 0) { %>
                        <% profiles.forEach(profile => { %>
                          <% if (profile.isMuntin) { %>
                            <option value="<%= profile._id %>">
                              <%= profile.name %>
                            </option>
                          <% } %>
                        <% }); %>
                      <% } else { %>
                        <% profiles.forEach(profile => { %>
                          <option value="<%= profile._id %>">
                            <%= profile.name %>
                          </option>
                        <% }); %>
                      <% } %>
                    </select>
                    <p class="text-xs text-gray-500 mt-2">Select the aluminum profile for muntin bars</p>
                  </div>
                  
                  <div class="flex items-center">
                    <div class="p-4 bg-white rounded-xl border-2 border-dashed border-amber-200 w-full">
                      <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="muntin-show-to-user" class="h-5 w-5 text-amber-600 focus:ring-amber-500 border-gray-300 rounded">
                        <div class="ml-3">
                          <span class="text-sm font-medium text-gray-700">User Configurable</span>
                          <p class="text-xs text-gray-500">Users can customize divisions when quoting</p>
                        </div>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Visual Preview -->
              <div class="p-6">
                <div class="flex flex-col md:flex-row gap-6 items-center justify-center">
                  
                  <!-- Preview Window -->
                  <div class="text-center">
                    <p class="text-sm font-medium text-gray-600 mb-3">
                      <i class="fas fa-eye text-amber-500 mr-1"></i> Preview
                    </p>
                    <div class="relative inline-block">
                      <!-- Window Frame -->
                      <div class="p-2 rounded-lg shadow-xl" style="background: linear-gradient(145deg, #707070, #505050);">
                        <!-- Glass with Muntins -->
                        <div id="muntin-preview-grid" class="w-40 h-40 relative overflow-hidden rounded" style="background: linear-gradient(180deg, rgba(186,230,253,0.8) 0%, rgba(147,197,253,0.6) 50%, rgba(186,230,253,0.7) 100%);">
                          <!-- Muntin bars will be rendered here -->
                          <div class="absolute inset-0 flex items-center justify-center">
                            <div class="grid grid-cols-2 gap-0 w-full h-full">
                              <div class="border-r-2 border-b-2" style="border-color: #606060;"></div>
                              <div class="border-b-2" style="border-color: #606060;"></div>
                              <div class="border-r-2" style="border-color: #606060;"></div>
                              <div></div>
                            </div>
                          </div>
                          <!-- Glass reflection -->
                          <div class="absolute inset-0 pointer-events-none" style="background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, transparent 50%);"></div>
                        </div>
                      </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-3" id="muntin-preview-text">2×2 Grid Pattern</p>
                  </div>
                  
                  <!-- Info Card -->
                  <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 max-w-sm">
                    <div class="flex items-start">
                      <div class="w-8 h-8 bg-amber-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                        <i class="fas fa-lightbulb text-amber-600"></i>
                      </div>
                      <div>
                        <h4 class="text-sm font-semibold text-amber-800 mb-1">How it works</h4>
                        <p class="text-xs text-amber-700">
                          When users quote this window, they'll be able to set the number of horizontal and vertical divisions to create their desired grid pattern.
                        </p>
                      </div>
                    </div>
                  </div>
                  
                </div>
              </div>
              
            </div>
            
            <!-- Disabled State Message -->
            <div id="muntin-disabled-message" class="p-8 text-center">
              <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-th-large text-gray-400 text-2xl"></i>
              </div>
              <h4 class="text-gray-600 font-medium mb-2">No Muntins</h4>
              <p class="text-sm text-gray-500 max-w-md mx-auto">
                This window system will have clean, unobstructed glass panels. Toggle the switch above to add decorative muntin grids.
              </p>
            </div>
            
          </div>
          
          <!-- Flange Configuration Section -->
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 mt-6">
            <div class="p-6 border-b border-gray-100">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center mr-4">
                    <i class="fas fa-border-style text-blue-600 text-xl"></i>
                  </div>
                  <div>
                    <h3 class="text-lg font-semibold text-gray-800">Flange Configuration</h3>
                    <p class="text-sm text-gray-500">Configure window flange options</p>
                  </div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="flange-enabled" class="sr-only peer" onchange="toggleFlangeConfiguration()">
                  <div class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-blue-500"></div>
                  <span id="flange-toggle-label" class="ml-3 text-sm font-medium text-gray-500">No Flange</span>
                </label>
              </div>
            </div>
            
            <!-- Flange Configuration (Hidden by default) -->
            <div id="flange-config-section" style="display: none;">
              <div class="p-6 bg-gray-50 border-b border-gray-100">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label for="flange-size" class="block text-sm font-semibold text-gray-700 mb-2">
                      <i class="fas fa-ruler text-blue-500 mr-2"></i>Flange Size
                    </label>
                    <input type="text" id="flange-size" class="form-control w-full" placeholder="e.g., 1/2, 3/4, 1" maxlength="10">
                    <p class="text-xs text-gray-500 mt-2">Enter flange size (e.g., 1/2&quot;, 3/4&quot;, 1&quot;)</p>
                  </div>
                  
                  <div class="flex items-center">
                    <div class="p-4 bg-white rounded-xl border-2 border-dashed border-blue-200 w-full">
                      <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="flange-trimable" class="h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <div class="ml-3">
                          <span class="text-sm font-medium text-gray-700">Trimable</span>
                          <p class="text-xs text-gray-500">Users can choose to remove flange when quoting</p>
                        </div>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Disabled State Message -->
            <div id="flange-disabled-message" class="p-8 text-center">
              <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-border-none text-gray-400 text-2xl"></i>
              </div>
              <h4 class="text-gray-600 font-medium mb-2">No Flange</h4>
              <p class="text-sm text-gray-500 max-w-md mx-auto">
                This window system will not have a flange. Toggle the switch above to add flange configuration.
              </p>
            </div>
          </div>
          
          <div class="mt-8 flex justify-between items-center">
            <button type="button" id="back-to-step4-btn" class="btn-secondary px-6 py-3">
              <i class="fas fa-arrow-left mr-2"></i>Previous Step
            </button>
            <button type="submit" class="btn-success px-8 py-3 text-lg font-bold">
              <i class="fas fa-check mr-2"></i>Create Window System
            </button>
          </div>
        </div>
      </form>
      
      <div class="mt-8 text-center">
        <a href="/admin" class="inline-flex items-center px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition duration-200 font-medium">
          <i class="fas fa-arrow-circle-left mr-2"></i>Back to Admin Console
        </a>
      </div>
    </div>
  </div>
  <%- include('../partials/_footer.ejs') %>

  <script>
    let profiles = [];
    let accessories = [];
    let currentStep = 1;
    let panelConfig = ['O', 'O']; // Default panel configuration (O = Fixed)
    let selectedProfileCategory = 'frame'; // Default category for profiles
    
    // ============================================
    // AUTO-SAVE FUNCTIONALITY
    // ============================================
    const DRAFT_STORAGE_KEY = 'vlx_compose_window_draft';
    let hasUnsavedChanges = false;
    let autoSaveTimeout = null;
    
    // Save draft to localStorage
    function saveDraft() {
      // Get panel ratios if available
      let panelRatios = null;
      try {
        if (typeof getPanelRatios === 'function') {
          panelRatios = getPanelRatios();
        }
      } catch(e) {}
      
      const draftData = {
        timestamp: Date.now(),
        // Step 1: Basic Info
        windowName: document.getElementById('type')?.value || '',
        operationType: document.getElementById('operationType')?.value || 'sliding',
        panelOrientation: document.getElementById('panelOrientation')?.value || 'horizontal',
        panelCount: document.getElementById('panelCount')?.value || 2,
        panelConfig: panelConfig,
        panelRatios: panelRatios,
        showLogo: document.getElementById('showLogoCheckbox')?.checked || false,
        // French door config
        frenchDoorType: document.getElementById('doorType')?.value || 'double',
        frenchHingeSide: document.getElementById('hingeSide')?.value || 'left',
        frenchLeftSidelites: document.getElementById('leftSidelites')?.value || 0,
        frenchRightSidelites: document.getElementById('rightSidelites')?.value || 0,
        frenchTransom: document.getElementById('transom')?.value || 'none',
        frenchDoorLogo: document.getElementById('frenchDoorLogo')?.checked || false,
        // Step 2: Profiles
        profiles: profiles,
        selectedProfileCategory: selectedProfileCategory,
        // Step 3: Accessories
        accessories: accessories,
        // Step 4: Glass Config (missileImpact)
        glassWidthEquation: document.getElementById('glass-width-equation')?.value || '',
        glassHeightEquation: document.getElementById('glass-height-equation')?.value || '',
        // Step 5: Others (Flange)
        hasFlange: document.getElementById('has-flange')?.checked || false,
        flangeSize: document.getElementById('flange-size')?.value || '',
        isTrimable: document.getElementById('is-trimable')?.checked || false,
        // Current progress
        currentStep: currentStep
      };
      
      try {
        localStorage.setItem(DRAFT_STORAGE_KEY, JSON.stringify(draftData));
        hasUnsavedChanges = false;
        showAutoSaveIndicator();
      } catch (e) {
        console.warn('Could not save draft:', e);
      }
    }
    
    // Schedule auto-save (debounced)
    function scheduleAutoSave() {
      hasUnsavedChanges = true;
      clearTimeout(autoSaveTimeout);
      autoSaveTimeout = setTimeout(saveDraft, 2000); // Save after 2 seconds of inactivity
    }
    
    // Show auto-save indicator
    function showAutoSaveIndicator() {
      const indicator = document.getElementById('autosave-indicator');
      if (indicator) {
        indicator.classList.remove('hidden');
        indicator.textContent = 'Draft saved';
        setTimeout(() => {
          indicator.classList.add('hidden');
        }, 2000);
      }
    }
    
    // Restore draft from localStorage
    function restoreDraft() {
      try {
        const savedDraft = localStorage.getItem(DRAFT_STORAGE_KEY);
        if (!savedDraft) return false;
        
        const draft = JSON.parse(savedDraft);
        
        // Check if draft is older than 24 hours
        const maxAge = 24 * 60 * 60 * 1000; // 24 hours
        if (Date.now() - draft.timestamp > maxAge) {
          clearDraft();
          return false;
        }
        
        // Check if draft has meaningful data
        const hasData = draft.windowName || draft.profiles?.length > 0 || draft.accessories?.length > 0;
        if (!hasData) return false;
        
        return draft;
      } catch (e) {
        console.warn('Could not restore draft:', e);
        return false;
      }
    }
    
    // Apply restored draft data to form
    function applyDraft(draft) {
      // Restore Step 1: Basic Info
      if (document.getElementById('type')) {
        document.getElementById('type').value = draft.windowName || '';
      }
      if (document.getElementById('operationType')) {
        document.getElementById('operationType').value = draft.operationType || 'sliding';
        // Trigger change event to update UI (shows/hides French door config)
        document.getElementById('operationType').dispatchEvent(new Event('change'));
      }
      if (document.getElementById('panelOrientation')) {
        document.getElementById('panelOrientation').value = draft.panelOrientation || 'horizontal';
      }
      if (document.getElementById('panelCount')) {
        document.getElementById('panelCount').value = draft.panelCount || 2;
      }
      if (document.getElementById('showLogoCheckbox')) {
        document.getElementById('showLogoCheckbox').checked = draft.showLogo !== false;
      }
      
      // Restore panel config array
      panelConfig = draft.panelConfig || ['O', 'O'];
      
      // Restore French door config
      if (document.getElementById('doorType')) {
        document.getElementById('doorType').value = draft.frenchDoorType || 'double';
      }
      if (document.getElementById('hingeSide')) {
        document.getElementById('hingeSide').value = draft.frenchHingeSide || 'left';
      }
      if (document.getElementById('leftSidelites')) {
        document.getElementById('leftSidelites').value = draft.frenchLeftSidelites || 0;
      }
      if (document.getElementById('rightSidelites')) {
        document.getElementById('rightSidelites').value = draft.frenchRightSidelites || 0;
      }
      if (document.getElementById('transom')) {
        document.getElementById('transom').value = draft.frenchTransom || 'none';
      }
      if (document.getElementById('frenchDoorLogo')) {
        document.getElementById('frenchDoorLogo').checked = draft.frenchDoorLogo !== false;
      }
      
      // Restore Step 2: Profiles
      profiles = draft.profiles || [];
      selectedProfileCategory = draft.selectedProfileCategory || 'frame';
      
      // Restore Step 3: Accessories
      accessories = draft.accessories || [];
      
      // Restore Step 4: Glass equations
      if (document.getElementById('glass-width-equation')) {
        document.getElementById('glass-width-equation').value = draft.glassWidthEquation || '';
      }
      if (document.getElementById('glass-height-equation')) {
        document.getElementById('glass-height-equation').value = draft.glassHeightEquation || '';
      }
      
      // Restore Step 5: Flange config
      if (document.getElementById('has-flange')) {
        document.getElementById('has-flange').checked = draft.hasFlange || false;
      }
      if (document.getElementById('flange-size')) {
        document.getElementById('flange-size').value = draft.flangeSize || '';
      }
      if (document.getElementById('is-trimable')) {
        document.getElementById('is-trimable').checked = draft.isTrimable || false;
      }
      
      // Update UI after short delay to ensure DOM is ready
      setTimeout(() => {
        // Rebuild panel layout buttons
        if (typeof validateAndUpdatePanels === 'function') {
          validateAndUpdatePanels();
        }
        // Update preview with restored panel config
        if (typeof updatePanelPreview === 'function') {
          updatePanelPreview();
        }
        // Restore panel ratios if saved
        if (draft.panelRatios && typeof setPanelRatios === 'function') {
          setPanelRatios(draft.panelRatios);
        }
        // Render tables
        renderProfilesTable();
        renderAccessoriesTable();
        updateEmptyStates();
        // Update French door preview if applicable
        if (draft.operationType === 'french-door' && typeof updateFrenchDoorPreview === 'function') {
          updateFrenchDoorPreview();
        }
      }, 100);
    }
    
    // Clear draft from localStorage
    function clearDraft() {
      localStorage.removeItem(DRAFT_STORAGE_KEY);
      hasUnsavedChanges = false;
      hideDraftRecoveryBar();
    }
    
    // Show draft recovery notification bar
    function showDraftRecoveryBar(draft) {
      const bar = document.createElement('div');
      bar.id = 'draft-recovery-bar';
      bar.className = 'fixed top-0 left-0 right-0 bg-amber-500 text-white px-4 py-3 shadow-lg z-50 flex items-center justify-between';
      
      const timestamp = new Date(draft.timestamp);
      const timeAgo = getTimeAgo(timestamp);
      
      bar.innerHTML = `
        <div class="flex items-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <span class="font-medium">Unsaved draft found from ${timeAgo}</span>
          <span class="text-amber-100 text-sm">${draft.windowName ? `"${draft.windowName}"` : 'Unnamed window'} - ${draft.profiles?.length || 0} profiles, ${draft.accessories?.length || 0} accessories</span>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="restoreAndApplyDraft()" class="bg-white text-amber-600 px-4 py-1.5 rounded font-medium hover:bg-amber-50 transition-colors">
            Restore Draft
          </button>
          <button onclick="discardDraft()" class="bg-amber-600 text-white px-4 py-1.5 rounded font-medium hover:bg-amber-700 border border-amber-400 transition-colors">
            Start Fresh
          </button>
        </div>
      `;
      
      document.body.insertBefore(bar, document.body.firstChild);
      // Push content down
      document.body.style.paddingTop = '60px';
    }
    
    function hideDraftRecoveryBar() {
      const bar = document.getElementById('draft-recovery-bar');
      if (bar) {
        bar.remove();
        document.body.style.paddingTop = '';
      }
    }
    
    function restoreAndApplyDraft() {
      const draft = restoreDraft();
      if (draft) {
        applyDraft(draft);
        hideDraftRecoveryBar();
        showAlert('Draft restored successfully!', 'success');
      }
    }
    
    function discardDraft() {
      clearDraft();
      showAlert('Draft discarded. Starting fresh.', 'info');
    }
    
    function getTimeAgo(date) {
      const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
      if (seconds < 60) return 'just now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
      const days = Math.floor(hours / 24);
      return `${days} day${days > 1 ? 's' : ''} ago`;
    }
    
    // Warn before leaving page with unsaved changes
    window.addEventListener('beforeunload', function(e) {
      // Save draft before leaving
      if (hasUnsavedChanges || profiles.length > 0 || accessories.length > 0) {
        saveDraft();
      }
      
      // Only show warning if there's meaningful unsaved data
      if (profiles.length > 0 || accessories.length > 0 || document.getElementById('type')?.value.trim()) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        return e.returnValue;
      }
    });
    
    // Setup auto-save listeners on form inputs
    function setupAutoSaveListeners() {
      // List of input IDs to monitor for changes (using correct IDs from the form)
      const inputIds = [
        // Step 1: Basic Info
        'type', 'operationType', 'panelOrientation', 'panelCount', 'showLogoCheckbox',
        // French door config
        'doorType', 'hingeSide', 'leftSidelites', 'rightSidelites', 'transom', 'frenchDoorLogo',
        // Step 4: Glass config
        'glass-width-equation', 'glass-height-equation',
        // Step 5: Flange config
        'has-flange', 'flange-size', 'is-trimable'
      ];
      
      inputIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', scheduleAutoSave);
          el.addEventListener('change', scheduleAutoSave);
        }
      });
    }
    
    // Profile category selection
    function selectProfileCategory(category) {
      selectedProfileCategory = category;
      
      // Update button states
      document.querySelectorAll('.component-cat-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`cat-${category.replace('-vent', '')}`).classList.add('active');
    }
    
    function getCategoryLabel(category) {
      switch(category) {
        case 'frame': return 'Frame';
        case 'fixed-vent': return 'Fixed Vent';
        case 'operable-vent': return 'Operable Vent';
        case 'other': return 'Other';
        default: return category;
      }
    }
    
    function getCategoryIcon(category) {
      switch(category) {
        case 'frame': return '<i class="fas fa-border-all text-blue-600"></i>';
        case 'fixed-vent': return '<i class="fas fa-square text-purple-600"></i>';
        case 'operable-vent': return '<i class="fas fa-window-maximize text-green-600"></i>';
        case 'other': return '<i class="fas fa-ellipsis-h text-gray-600"></i>';
        default: return '<i class="fas fa-square text-gray-500"></i>';
      }
    }
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      try {
        // Check for saved draft
        const savedDraft = restoreDraft();
        if (savedDraft) {
          showDraftRecoveryBar(savedDraft);
        }
        
        // Hook up auto-save to form changes
        setupAutoSaveListeners();
        
        // Initialize length equation unit display
        updateLengthEquationUnitDisplay();
        
        // Listen for unit changes
        window.addEventListener('unitChanged', function(event) {
          updateLengthEquationUnitDisplay();
          updateGlassSizeEquationUnitDisplay();
        });
        
        // Glass width equation validation
        const glassWidthEquationInput = document.getElementById('glass-width-equation');
        if (glassWidthEquationInput) {
          let glassWidthEquationTimeout;
          glassWidthEquationInput.addEventListener('input', function() {
            clearTimeout(glassWidthEquationTimeout);
            glassWidthEquationTimeout = setTimeout(() => {
              validateGlassSizeEquation(this.value, 'width');
            }, 300);
          });
          
          glassWidthEquationInput.addEventListener('blur', function() {
            validateGlassSizeEquation(this.value, 'width');
          });
        }
        
        // Glass height equation validation
        const glassHeightEquationInput = document.getElementById('glass-height-equation');
        if (glassHeightEquationInput) {
          let glassHeightEquationTimeout;
          glassHeightEquationInput.addEventListener('input', function() {
            clearTimeout(glassHeightEquationTimeout);
            glassHeightEquationTimeout = setTimeout(() => {
              validateGlassSizeEquation(this.value, 'height');
            }, 300);
          });
          
          glassHeightEquationInput.addEventListener('blur', function() {
            validateGlassSizeEquation(this.value, 'height');
          });
        }
        
        updateEmptyStates();
        setupStepNavigation();
        setupAdvancedConfigToggle();
        initializePanelConfiguration();
        
        // Initialize first step - ensure only step 1 is visible
        document.getElementById('step1-section').style.display = 'block';
        document.getElementById('step2-section').style.display = 'none';
        document.getElementById('step3-section').style.display = 'none';
        document.getElementById('step4-section').style.display = 'none';
        if (document.getElementById('step5-section')) {
          document.getElementById('step5-section').style.display = 'none';
        }
        
        // Call goToStep to set up indicators
        goToStep(1);
        

      } catch (error) {
        console.error('Error during page initialization:', error);

      }
    });
    
    // Panel Configuration Functions
    function initializePanelConfiguration() {
      updateFrenchDoorVisibility(); // Show/hide special config panels based on operation type
      enforceMinimumPanels(); // Apply orientation and panel count rules
      updatePanelInputs();
    }
    
    // Validate panel count before updating
    function validateAndUpdatePanels() {
      const operationType = document.getElementById('operationType').value;
      const panelCountInput = document.getElementById('panelCount');
      const minPanels = getMinPanelsForOperationType(operationType);
      
      if (parseInt(panelCountInput.value) < minPanels) {
        panelCountInput.value = minPanels;
        const typeNames = { 'sliding': 'Sliding', 'single-hung': 'Single Hung', 'double-hung': 'Double Hung' };
        showAlert(`${typeNames[operationType] || operationType} windows require at least ${minPanels} panels.`);
      }
      
      updatePanelInputs();
    }
    
    // Get minimum panels required for operation type
    function getMinPanelsForOperationType(operationType) {
      switch(operationType) {
        case 'sliding':
        case 'single-hung':
        case 'double-hung':
          return 2; // These window types need at least 2 panels
        default:
          return 1;
      }
    }
    
    // Panel size ratios (for windows with multiple panels)
    let panelRatios = [1, 1]; // Default equal ratios for 2 panels
    let isDragging = false;
    let dragIndex = -1;
    let dragStartPos = 0;
    let dragStartRatios = [];
    let showLogo = true; // Toggle for Vitralux logo
    
    // Toggle logo visibility
    function toggleLogo() {
      showLogo = document.getElementById('showLogoCheckbox').checked;
      updatePanelPreview();
    }
    
    // French Door configuration
    let frenchDoorConfig = {
      doorType: 'double',
      hingeSide: 'left',
      leftSidelites: 0,
      rightSidelites: 0,
      transom: 'none'
    };
    
    // Show/hide French Door config
    function updateFrenchDoorVisibility() {
      const operationType = document.getElementById('operationType').value;
      const frenchDoorConfigSection = document.getElementById('frenchDoorConfig');
      const panelSection = document.getElementById('panelLayoutBuilder').parentElement;
      const panelCountDiv = document.getElementById('panelCount').parentElement;
      
      // Hide all special configs first
      frenchDoorConfigSection.style.display = 'none';
      panelSection.style.display = 'block';
      panelCountDiv.style.display = 'block';
      
      if (operationType === 'french-door') {
        frenchDoorConfigSection.style.display = 'block';
        panelSection.style.display = 'none'; // Hide manual panel layout for french doors
        panelCountDiv.style.display = 'none';
        updateFrenchDoorPreview();
      }
    }
    
    // Update French Door preview
    function updateFrenchDoorPreview() {
      frenchDoorConfig.doorType = document.getElementById('doorType').value;
      frenchDoorConfig.hingeSide = document.getElementById('hingeSide').value;
      frenchDoorConfig.leftSidelites = parseInt(document.getElementById('leftSidelites').value) || 0;
      frenchDoorConfig.rightSidelites = parseInt(document.getElementById('rightSidelites').value) || 0;
      frenchDoorConfig.transom = document.getElementById('transom').value;
      
      // Show/hide hinge side selector based on door type
      const hingeSideContainer = document.getElementById('hingeSideContainer');
      if (frenchDoorConfig.doorType === 'single') {
        hingeSideContainer.style.display = 'block';
      } else {
        hingeSideContainer.style.display = 'none';
      }
      
      // Build panel config based on French Door settings
      panelConfig = [];
      panelRatios = [];
      
      // Add left sidelites
      for (let i = 0; i < frenchDoorConfig.leftSidelites; i++) {
        panelConfig.push('O'); // Sidelites are fixed
        panelRatios.push(0.4);
      }
      
      // Add door(s)
      if (frenchDoorConfig.doorType === 'single') {
        panelConfig.push('X'); // Single door is operable
        panelRatios.push(1);
      } else {
        panelConfig.push('X'); // Left door
        panelConfig.push('X'); // Right door
        panelRatios.push(1);
        panelRatios.push(1);
      }
      
      // Add right sidelites
      for (let i = 0; i < frenchDoorConfig.rightSidelites; i++) {
        panelConfig.push('O'); // Sidelites are fixed
        panelRatios.push(0.4);
      }
      
      // Set orientation to horizontal for main panels
      document.getElementById('panelOrientation').value = 'horizontal';
      
      updatePanelPreview();
    }
    
    // Render French Door preview with transom support
    function renderFrenchDoorPreview(preview, label) {
      preview.innerHTML = '';
      preview.style.flexDirection = 'column';
      
      const hasTransom = frenchDoorConfig.transom !== 'none';
      const leftSideliteCount = frenchDoorConfig.leftSidelites;
      const rightSideliteCount = frenchDoorConfig.rightSidelites;
      const hasLeftSidelite = leftSideliteCount > 0;
      const hasRightSidelite = rightSideliteCount > 0;
      const isDouble = frenchDoorConfig.doorType === 'double';
      const transomOverDoorOnly = frenchDoorConfig.transom === 'over-door';
      
      // Get the French door logo setting and update the global showLogo
      const frenchDoorLogoCheckbox = document.getElementById('frenchDoorLogo');
      showLogo = frenchDoorLogoCheckbox ? frenchDoorLogoCheckbox.checked : true;
      
      // For "over-door" transom, we need a different layout where sidelites are full height
      if (hasTransom && transomOverDoorOnly && (hasLeftSidelite || hasRightSidelite)) {
        // Complex layout: sidelites full height, transom only over doors
        const mainRow = document.createElement('div');
        mainRow.className = 'flex w-full flex-1';
        mainRow.style.minHeight = '220px';
        
        // Left sidelites (full height)
        for (let i = 0; i < leftSideliteCount; i++) {
          const leftSidelite = createGlassPanel('O', false, false);
          leftSidelite.style.flex = '0.4';
          leftSidelite.innerHTML += '<div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 text-xs text-blue-600/50 font-medium">SIDELITE</div>';
          mainRow.appendChild(leftSidelite);
          
          const mullion = createAluminumMullion('vertical');
          mainRow.appendChild(mullion);
        }
        
        // Door section with transom above
        const doorSection = document.createElement('div');
        doorSection.className = 'flex flex-col';
        doorSection.style.flex = isDouble ? '2' : '1';
        
        // Transom
        const transomRow = document.createElement('div');
        transomRow.className = 'flex w-full';
        transomRow.style.height = '60px';
        transomRow.style.flexShrink = '0';
        
        const doorTransom = createGlassPanel('O', false, true);
        doorTransom.style.flex = '1';
        doorTransom.innerHTML += '<div class="absolute inset-0 flex items-center justify-center"><span class="text-xs text-blue-600/60 font-medium">TRANSOM</span></div>';
        transomRow.appendChild(doorTransom);
        doorSection.appendChild(transomRow);
        
        // Horizontal mullion
        const hMullion = createAluminumMullion('horizontal');
        doorSection.appendChild(hMullion);
        
        // Doors row
        const doorsRow = document.createElement('div');
        doorsRow.className = 'flex w-full flex-1';
        
        if (isDouble) {
          const leftDoor = createDoorPanel('left');
          leftDoor.style.flex = '1';
          doorsRow.appendChild(leftDoor);
          
          const centerMullion = createAluminumMullion('vertical');
          doorsRow.appendChild(centerMullion);
          
          const rightDoor = createDoorPanel('right');
          rightDoor.style.flex = '1';
          doorsRow.appendChild(rightDoor);
        } else {
          const door = createDoorPanel('single');
          door.style.flex = '1';
          doorsRow.appendChild(door);
        }
        
        doorSection.appendChild(doorsRow);
        mainRow.appendChild(doorSection);
        
        // Right sidelites (full height)
        for (let i = 0; i < rightSideliteCount; i++) {
          const mullion = createAluminumMullion('vertical');
          mainRow.appendChild(mullion);
          
          const rightSidelite = createGlassPanel('O', false, false);
          rightSidelite.style.flex = '0.4';
          rightSidelite.innerHTML += '<div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 text-xs text-blue-600/50 font-medium">SIDELITE</div>';
          mainRow.appendChild(rightSidelite);
        }
        
        preview.appendChild(mainRow);
      } else {
        // Standard layout: transom row (if any) + door row
        
        // Transom row (full width, if enabled)
        if (hasTransom && !transomOverDoorOnly) {
          const transomRow = document.createElement('div');
          transomRow.className = 'flex w-full';
          transomRow.style.height = '60px';
          transomRow.style.flexShrink = '0';
          
          // Left sidelite transoms
          for (let i = 0; i < leftSideliteCount; i++) {
            const leftTransom = createGlassPanel('O', false, true);
            leftTransom.style.flex = '0.4';
            transomRow.appendChild(leftTransom);
            
            const mullion = createAluminumMullion('vertical');
            transomRow.appendChild(mullion);
          }
          
          // Transom over door(s)
          const doorTransom = createGlassPanel('O', false, true);
          doorTransom.style.flex = isDouble ? '2' : '1';
          doorTransom.innerHTML += '<div class="absolute inset-0 flex items-center justify-center"><span class="text-xs text-blue-600/60 font-medium">TRANSOM</span></div>';
          transomRow.appendChild(doorTransom);
          
          // Right sidelite transoms
          for (let i = 0; i < rightSideliteCount; i++) {
            const mullion = createAluminumMullion('vertical');
            transomRow.appendChild(mullion);
            
            const rightTransom = createGlassPanel('O', false, true);
            rightTransom.style.flex = '0.4';
            transomRow.appendChild(rightTransom);
          }
          
          preview.appendChild(transomRow);
          
          // Horizontal mullion between transom and doors
          const hMullion = createAluminumMullion('horizontal');
          preview.appendChild(hMullion);
        }
        
        // Main door row
        const doorRow = document.createElement('div');
        doorRow.className = 'flex w-full flex-1';
        doorRow.style.minHeight = '160px';
        
        // Left sidelites
        for (let i = 0; i < leftSideliteCount; i++) {
          const leftSidelite = createGlassPanel('O', false, false);
          leftSidelite.style.flex = '0.4';
          leftSidelite.innerHTML += '<div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 text-xs text-blue-600/50 font-medium">SIDELITE</div>';
          doorRow.appendChild(leftSidelite);
          
          const mullion = createAluminumMullion('vertical');
          doorRow.appendChild(mullion);
        }
        
        // Door(s)
        if (isDouble) {
          // Left door
          const leftDoor = createDoorPanel('left');
          leftDoor.style.flex = '1';
          doorRow.appendChild(leftDoor);
          
          // Center mullion between doors
          const centerMullion = createAluminumMullion('vertical');
          doorRow.appendChild(centerMullion);
          
          // Right door
          const rightDoor = createDoorPanel('right');
          rightDoor.style.flex = '1';
          doorRow.appendChild(rightDoor);
        } else {
          // Single door
          const door = createDoorPanel('single');
          door.style.flex = '1';
          doorRow.appendChild(door);
        }
        
        // Right sidelites
        for (let i = 0; i < rightSideliteCount; i++) {
          const mullion = createAluminumMullion('vertical');
          doorRow.appendChild(mullion);
          
          const rightSidelite = createGlassPanel('O', false, false);
          rightSidelite.style.flex = '0.4';
          rightSidelite.innerHTML += '<div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 text-xs text-blue-600/50 font-medium">SIDELITE</div>';
          doorRow.appendChild(rightSidelite);
        }
        
        preview.appendChild(doorRow);
      }
      
      // Update label
      const doorDesc = isDouble ? 'Double' : 'Single';
      let extras = [];
      const totalSidelites = leftSideliteCount + rightSideliteCount;
      if (totalSidelites > 0) {
        if (leftSideliteCount > 0 && rightSideliteCount > 0) {
          extras.push(`${totalSidelites} Sidelites (${leftSideliteCount}L + ${rightSideliteCount}R)`);
        } else if (leftSideliteCount > 0) {
          extras.push(`${leftSideliteCount} Left Sidelite${leftSideliteCount > 1 ? 's' : ''}`);
        } else {
          extras.push(`${rightSideliteCount} Right Sidelite${rightSideliteCount > 1 ? 's' : ''}`);
        }
      }
      if (hasTransom) {
        extras.push(transomOverDoorOnly ? 'Transom (Over Door)' : 'Transom');
      }
      label.textContent = `${doorDesc} French Door${extras.length > 0 ? ' + ' + extras.join(' + ') : ''}`;
      
      // Hide drag hint for French doors
      updateDragHint(false);
    }
    
    // Render Casement window preview with hinges and handles
    function renderCasementPreview(preview, label, orientation) {
      preview.innerHTML = '';
      preview.style.flexDirection = orientation === 'horizontal' ? 'row' : 'column';
      
      panelConfig.forEach((type, index) => {
        const isOperable = type === 'X';
        const panel = document.createElement('div');
        panel.className = 'relative min-w-[50px] min-h-[50px] flex items-center justify-center overflow-hidden';
        panel.dataset.panelIndex = index;
        panel.style.flex = `${panelRatios[index]} 0 0%`;
        
        // Glass background
        panel.style.background = isOperable 
          ? 'linear-gradient(180deg, rgba(186,230,253,0.75) 0%, rgba(147,197,253,0.55) 50%, rgba(186,230,253,0.65) 100%)'
          : 'linear-gradient(180deg, rgba(191,219,254,0.8) 0%, rgba(147,197,253,0.6) 50%, rgba(191,219,254,0.7) 100%)';
        
        // Determine hinge and handle positions for casement
        // Alternate hinge sides for multi-panel casements (first panel hinges left, second right, etc.)
        const hingeOnLeft = index % 2 === 0;
        
        let casementHardware = '';
        if (isOperable) {
          if (orientation === 'horizontal') {
            // Horizontal layout - hinges on left or right side
            casementHardware = `
              <!-- Hinges (3 hinges on the hinge side) -->
              <div class="absolute ${hingeOnLeft ? 'left-0.5' : 'right-0.5'} top-3 w-1.5 h-3 rounded-sm" style="background: linear-gradient(90deg, #707070, #a0a0a0, #707070); box-shadow: 0 1px 2px rgba(0,0,0,0.3);"></div>
              <div class="absolute ${hingeOnLeft ? 'left-0.5' : 'right-0.5'} top-1/2 transform -translate-y-1/2 w-1.5 h-3 rounded-sm" style="background: linear-gradient(90deg, #707070, #a0a0a0, #707070); box-shadow: 0 1px 2px rgba(0,0,0,0.3);"></div>
              <div class="absolute ${hingeOnLeft ? 'left-0.5' : 'right-0.5'} bottom-3 w-1.5 h-3 rounded-sm" style="background: linear-gradient(90deg, #707070, #a0a0a0, #707070); box-shadow: 0 1px 2px rgba(0,0,0,0.3);"></div>
              
              <!-- Handle/Crank on opposite side -->
              <div class="absolute ${hingeOnLeft ? 'right-2' : 'left-2'} top-1/2 transform -translate-y-1/2 flex flex-col items-center">
                <div class="w-1.5 h-6 rounded-full" style="background: linear-gradient(90deg, #909090, #c0c0c0, #909090); box-shadow: 1px 1px 2px rgba(0,0,0,0.3);"></div>
                <div class="w-3 h-1.5 rounded-full mt-0.5" style="background: linear-gradient(180deg, #909090, #c0c0c0, #909090); box-shadow: 1px 1px 2px rgba(0,0,0,0.3);"></div>
              </div>
              
              <!-- Swing direction indicator (subtle arc) -->
              <div class="absolute ${hingeOnLeft ? 'right-0' : 'left-0'} top-1 ${hingeOnLeft ? 'border-r-2' : 'border-l-2'} border-green-500/40 h-3 w-3" style="border-radius: ${hingeOnLeft ? '0 100% 100% 0' : '100% 0 0 100%'};"></div>
              <div class="absolute ${hingeOnLeft ? 'right-0' : 'left-0'} bottom-1 ${hingeOnLeft ? 'border-r-2' : 'border-l-2'} border-green-500/40 h-3 w-3" style="border-radius: ${hingeOnLeft ? '0 100% 100% 0' : '100% 0 0 100%'};"></div>
            `;
          } else {
            // Vertical layout - hinges on top or bottom
            const hingeOnTop = index % 2 === 0;
            casementHardware = `
              <!-- Hinges (3 hinges on the hinge side) -->
              <div class="absolute ${hingeOnTop ? 'top-0.5' : 'bottom-0.5'} left-3 h-1.5 w-3 rounded-sm" style="background: linear-gradient(180deg, #707070, #a0a0a0, #707070); box-shadow: 0 1px 2px rgba(0,0,0,0.3);"></div>
              <div class="absolute ${hingeOnTop ? 'top-0.5' : 'bottom-0.5'} left-1/2 transform -translate-x-1/2 h-1.5 w-3 rounded-sm" style="background: linear-gradient(180deg, #707070, #a0a0a0, #707070); box-shadow: 0 1px 2px rgba(0,0,0,0.3);"></div>
              <div class="absolute ${hingeOnTop ? 'top-0.5' : 'bottom-0.5'} right-3 h-1.5 w-3 rounded-sm" style="background: linear-gradient(180deg, #707070, #a0a0a0, #707070); box-shadow: 0 1px 2px rgba(0,0,0,0.3);"></div>
              
              <!-- Handle on opposite side -->
              <div class="absolute ${hingeOnTop ? 'bottom-2' : 'top-2'} left-1/2 transform -translate-x-1/2 flex items-center">
                <div class="h-1.5 w-6 rounded-full" style="background: linear-gradient(180deg, #909090, #c0c0c0, #909090); box-shadow: 1px 1px 2px rgba(0,0,0,0.3);"></div>
              </div>
              
              <!-- Swing direction indicator -->
              <div class="absolute ${hingeOnTop ? 'bottom-0' : 'top-0'} left-1 ${hingeOnTop ? 'border-b-2' : 'border-t-2'} border-green-500/40 h-3 w-3" style="border-radius: ${hingeOnTop ? '0 0 100% 100%' : '100% 100% 0 0'};"></div>
              <div class="absolute ${hingeOnTop ? 'bottom-0' : 'top-0'} right-1 ${hingeOnTop ? 'border-b-2' : 'border-t-2'} border-green-500/40 h-3 w-3" style="border-radius: ${hingeOnTop ? '0 0 100% 100%' : '100% 100% 0 0'};"></div>
            `;
          }
        }
        
        panel.innerHTML = `
          <!-- Glass effects -->
          <div class="absolute inset-0 pointer-events-none" style="background: linear-gradient(180deg, rgba(96,165,250,0.25) 0%, rgba(147,197,253,0.15) 30%, transparent 60%);"></div>
          <div class="absolute inset-0 pointer-events-none" style="background: linear-gradient(135deg, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0.2) 20%, transparent 40%);"></div>
          <div class="absolute inset-0 pointer-events-none" style="box-shadow: inset 0 0 20px rgba(30,64,175,0.1);"></div>
          
          ${isOperable ? casementHardware : ''}
          
          <!-- Vitralux logo -->
          ${showLogo ? '<div class="absolute bottom-1 right-1 pointer-events-none" style="font-size: 7px; font-weight: 600; color: rgba(30,64,175,0.35); letter-spacing: 0.5px; font-family: Arial, sans-serif;">VITRALUX</div>' : ''}
          
          <!-- Panel label -->
          <div class="relative z-10 flex flex-col items-center">
            <span class="text-2xl font-bold drop-shadow-sm" style="color: ${isOperable ? 'rgba(22,101,52,0.8)' : 'rgba(30,64,175,0.7)'};">${type}</span>
            <span class="text-xs mt-0.5 font-medium" style="color: ${isOperable ? 'rgba(22,101,52,0.7)' : 'rgba(30,64,175,0.6)'};">${isOperable ? 'Operable' : 'Fixed'}</span>
          </div>
        `;
        
        // Add mullion between panels
        if (index < panelConfig.length - 1) {
          const mullion = document.createElement('div');
          mullion.className = orientation === 'horizontal' 
            ? 'w-2 self-stretch flex-shrink-0' 
            : 'h-2 w-full flex-shrink-0';
          mullion.style.background = 'linear-gradient(90deg, #606060 0%, #808080 30%, #909090 50%, #808080 70%, #606060 100%)';
          mullion.style.boxShadow = 'inset 0 1px 0 rgba(255,255,255,0.3), inset 0 -1px 0 rgba(0,0,0,0.2)';
          
          preview.appendChild(panel);
          preview.appendChild(mullion);
        } else {
          preview.appendChild(panel);
        }
      });
      
      // Update label
      const configString = panelConfig.join('');
      const operableCount = panelConfig.filter(p => p === 'X').length;
      const fixedCount = panelConfig.filter(p => p === 'O').length;
      label.textContent = `${configString} - ${panelConfig.length} Panel Casement (${operableCount} Operable, ${fixedCount} Fixed)`;
      
      // Hide drag hint for casement (no draggable dividers)
      updateDragHint(false);
    }
    
    // Render Sliding/Roller window preview with handles and draggable dividers
    function renderSlidingPreview(preview, label, orientation) {
      preview.innerHTML = '';
      preview.style.flexDirection = orientation === 'horizontal' ? 'row' : 'column';
      
      panelConfig.forEach((type, index) => {
        const isOperable = type === 'X';
        const panel = document.createElement('div');
        panel.className = 'relative min-w-[50px] min-h-[50px] flex items-center justify-center overflow-hidden';
        panel.dataset.panelIndex = index;
        panel.style.flex = `${panelRatios[index]} 0 0%`;
        
        // Glass background
        panel.style.background = isOperable 
          ? 'linear-gradient(180deg, rgba(186,230,253,0.75) 0%, rgba(147,197,253,0.55) 50%, rgba(186,230,253,0.65) 100%)'
          : 'linear-gradient(180deg, rgba(191,219,254,0.8) 0%, rgba(147,197,253,0.6) 50%, rgba(191,219,254,0.7) 100%)';
        
        // Determine handle position for sliding windows
        let slidingHandle = '';
        if (isOperable) {
          if (orientation === 'horizontal') {
            // Place handle on the outer edge (away from meeting rail)
            const hasFixedOnLeft = index > 0 && panelConfig[index - 1] === 'O';
            const hasFixedOnRight = index < panelConfig.length - 1 && panelConfig[index + 1] === 'O';
            const handleOnRight = hasFixedOnLeft || (!hasFixedOnRight && index > 0);
            
            slidingHandle = `
              <!-- Sliding handle (vertical bar) -->
              <div class="absolute ${handleOnRight ? 'right-2' : 'left-2'} top-1/2 transform -translate-y-1/2 flex flex-col items-center">
                <div class="w-1.5 h-10 rounded-full" style="background: linear-gradient(90deg, #808080 0%, #c0c0c0 30%, #e0e0e0 50%, #c0c0c0 70%, #808080 100%); box-shadow: 1px 2px 4px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.5);"></div>
              </div>
              <!-- Rail indicator at top and bottom -->
              <div class="absolute top-0.5 left-1 right-1 h-0.5 rounded-full" style="background: linear-gradient(90deg, #606060, #909090, #606060);"></div>
              <div class="absolute bottom-0.5 left-1 right-1 h-0.5 rounded-full" style="background: linear-gradient(90deg, #606060, #909090, #606060);"></div>
            `;
          } else {
            // Vertical sliding (like single hung) - handle at the bottom
            slidingHandle = `
              <!-- Sliding handle (horizontal bar) -->
              <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 flex items-center">
                <div class="h-1.5 w-10 rounded-full" style="background: linear-gradient(180deg, #808080 0%, #c0c0c0 30%, #e0e0e0 50%, #c0c0c0 70%, #808080 100%); box-shadow: 1px 2px 4px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.5);"></div>
              </div>
              
              <!-- Rail indicator at left and right -->
              <div class="absolute left-0.5 top-1 bottom-1 w-0.5 rounded-full" style="background: linear-gradient(180deg, #606060, #909090, #606060);"></div>
              <div class="absolute right-0.5 top-1 bottom-1 w-0.5 rounded-full" style="background: linear-gradient(180deg, #606060, #909090, #606060);"></div>
            `;
          }
        }
        
        // Sliding direction indicator
        const slidingIndicator = isOperable ? (
          orientation === 'horizontal' 
            ? '<div class="absolute bottom-1 left-1/2 transform -translate-x-1/2 flex items-center justify-center bg-white/70 text-green-700 rounded-full shadow-sm border border-green-300/50 w-5 h-5"><i class="fas fa-arrows-alt-h text-xs"></i></div>'
            : '<div class="absolute right-1 top-1/2 transform -translate-y-1/2 flex items-center justify-center bg-white/70 text-green-700 rounded-full shadow-sm border border-green-300/50 w-5 h-5"><i class="fas fa-arrows-alt-v text-xs"></i></div>'
        ) : '';
        
        panel.innerHTML = `
          <!-- Glass effects -->
          <div class="absolute inset-0 pointer-events-none" style="background: linear-gradient(180deg, rgba(96,165,250,0.25) 0%, rgba(147,197,253,0.15) 30%, transparent 60%);"></div>
          <div class="absolute inset-0 pointer-events-none" style="background: linear-gradient(135deg, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0.2) 20%, transparent 40%);"></div>
          <div class="absolute inset-0 pointer-events-none" style="box-shadow: inset 0 0 20px rgba(30,64,175,0.1);"></div>
          
          ${isOperable ? slidingHandle : ''}
          
          <!-- Vitralux logo -->
          ${showLogo ? '<div class="absolute bottom-1 right-1 pointer-events-none" style="font-size: 7px; font-weight: 600; color: rgba(30,64,175,0.35); letter-spacing: 0.5px; font-family: Arial, sans-serif;">VITRALUX</div>' : ''}
          
          <!-- Panel label -->
          <div class="relative z-10 flex flex-col items-center">
            <span class="text-2xl font-bold drop-shadow-sm" style="color: ${isOperable ? 'rgba(22,101,52,0.8)' : 'rgba(30,64,175,0.7)'};">${type}</span>
            <span class="text-xs mt-0.5 font-medium" style="color: ${isOperable ? 'rgba(22,101,52,0.7)' : 'rgba(30,64,175,0.6)'};">${isOperable ? 'Operable' : 'Fixed'}</span>
          </div>
          
          ${slidingIndicator}
        `;
        
        // Add mullion between panels - make it draggable for sliding windows
        if (index < panelConfig.length - 1) {
          const mullion = document.createElement('div');
          mullion.dataset.mullionIndex = index;
          
          // Draggable mullion with aluminum effect
          mullion.className = orientation === 'horizontal' 
            ? 'w-4 self-stretch flex-shrink-0 cursor-ew-resize transition-all duration-200 flex items-center justify-center draggable-mullion' 
            : 'h-4 w-full flex-shrink-0 cursor-ns-resize transition-all duration-200 flex items-center justify-center draggable-mullion';
          mullion.style.background = 'linear-gradient(90deg, #606060 0%, #808080 30%, #909090 50%, #808080 70%, #606060 100%)';
          mullion.style.boxShadow = 'inset 0 1px 0 rgba(255,255,255,0.3), inset 0 -1px 0 rgba(0,0,0,0.2)';
          mullion.title = 'Drag to resize panels';
          
          // Add grip dots indicator
          const gripDots = orientation === 'horizontal' 
            ? '<div class="flex flex-col gap-0.5 opacity-60"><div class="w-1 h-1 bg-white rounded-full"></div><div class="w-1 h-1 bg-white rounded-full"></div><div class="w-1 h-1 bg-white rounded-full"></div></div>'
            : '<div class="flex gap-0.5 opacity-60"><div class="w-1 h-1 bg-white rounded-full"></div><div class="w-1 h-1 bg-white rounded-full"></div><div class="w-1 h-1 bg-white rounded-full"></div></div>';
          mullion.innerHTML = gripDots;
          
          mullion.onmouseenter = () => { 
            mullion.style.background = 'linear-gradient(90deg, #3b82f6 0%, #60a5fa 30%, #93c5fd 50%, #60a5fa 70%, #3b82f6 100%)';
            mullion.style.transform = orientation === 'horizontal' ? 'scaleX(1.3)' : 'scaleY(1.3)';
          };
          mullion.onmouseleave = () => { 
            if (!isDragging) {
              mullion.style.background = 'linear-gradient(90deg, #606060 0%, #808080 30%, #909090 50%, #808080 70%, #606060 100%)';
              mullion.style.transform = 'scale(1)';
            }
          };
          
          // Add drag handlers
          mullion.addEventListener('mousedown', (e) => startDrag(e, index, orientation));
          
          preview.appendChild(panel);
          preview.appendChild(mullion);
        } else {
          preview.appendChild(panel);
        }
      });
      
      // Update label
      const configString = panelConfig.join('');
      const operableCount = panelConfig.filter(p => p === 'X').length;
      const fixedCount = panelConfig.filter(p => p === 'O').length;
      label.textContent = `${configString} - ${panelConfig.length} Panel Sliding (${operableCount} Operable, ${fixedCount} Fixed)`;
      
      // Show drag hint for sliding windows
      updateDragHint(true);
    }
    
    // Render Single Hung window preview with proper sash appearance
    function renderSingleHungPreview(preview, label) {
      preview.innerHTML = '';
      preview.style.flexDirection = 'column'; // Single hung is always vertical
      
      // Single hung always has 2 panels: top (usually fixed) and bottom (usually operable)
      // The bottom sash slides up over the fixed top sash
      
      panelConfig.forEach((type, index) => {
        const isOperable = type === 'X';
        const isTopSash = index === 0;
        const isBottomSash = index === panelConfig.length - 1;
        
        const panel = document.createElement('div');
        panel.className = 'relative min-h-[60px] flex items-center justify-center overflow-hidden';
        panel.dataset.panelIndex = index;
        panel.style.flex = `${panelRatios[index]} 0 0%`;
        
        // Glass background
        panel.style.background = isOperable 
          ? 'linear-gradient(180deg, rgba(186,230,253,0.75) 0%, rgba(147,197,253,0.55) 50%, rgba(186,230,253,0.65) 100%)'
          : 'linear-gradient(180deg, rgba(191,219,254,0.8) 0%, rgba(147,197,253,0.6) 50%, rgba(191,219,254,0.7) 100%)';
        
        let sashHardware = '';
        
        if (isOperable) {
          // Operable sash (typically bottom) - has lift handles and can slide up
          sashHardware = `
            <!-- Lift handles at bottom of operable sash -->
            <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 flex items-center gap-6">
              <!-- Left lift handle -->
              <div class="w-8 h-1.5 rounded-full" style="background: linear-gradient(180deg, #808080 0%, #c0c0c0 30%, #e0e0e0 50%, #c0c0c0 70%, #808080 100%); box-shadow: 0 2px 3px rgba(0,0,0,0.3);"></div>
              <!-- Right lift handle -->
              <div class="w-8 h-1.5 rounded-full" style="background: linear-gradient(180deg, #808080 0%, #c0c0c0 30%, #e0e0e0 50%, #c0c0c0 70%, #808080 100%); box-shadow: 0 2px 3px rgba(0,0,0,0.3);"></div>
            </div>
            
            <!-- Sash lock at top of operable panel (meeting rail) -->
            <div class="absolute top-1 left-1/2 transform -translate-x-1/2 flex items-center gap-1">
              <div class="w-4 h-2 rounded-sm" style="background: linear-gradient(180deg, #909090, #c0c0c0, #909090); box-shadow: 0 1px 2px rgba(0,0,0,0.3);"></div>
            </div>
            
            <!-- Up arrow indicator showing it slides up -->
            <div class="absolute right-2 top-1/2 transform -translate-y-1/2 flex items-center justify-center bg-white/70 text-green-700 rounded-full shadow-sm border border-green-300/50 w-5 h-5">
              <i class="fas fa-arrow-up text-xs"></i>
            </div>
            
            <!-- Rail grooves on sides -->
            <div class="absolute left-0.5 top-1 bottom-1 w-0.5 rounded-full" style="background: linear-gradient(180deg, #505050, #707070, #505050);"></div>
            <div class="absolute right-0.5 top-1 bottom-1 w-0.5 rounded-full" style="background: linear-gradient(180deg, #505050, #707070, #505050);"></div>
          `;
        } else {
          // Fixed sash - just has rail grooves
          sashHardware = `
            <!-- Rail grooves on sides (fixed sash has track for operable sash) -->
            <div class="absolute left-0.5 top-1 bottom-1 w-0.5 rounded-full" style="background: linear-gradient(180deg, #606060, #808080, #606060);"></div>
            <div class="absolute right-0.5 top-1 bottom-1 w-0.5 rounded-full" style="background: linear-gradient(180deg, #606060, #808080, #606060);"></div>
          `;
        }
        
        panel.innerHTML = `
          <!-- Glass effects -->
          <div class="absolute inset-0 pointer-events-none" style="background: linear-gradient(180deg, rgba(96,165,250,0.25) 0%, rgba(147,197,253,0.15) 30%, transparent 60%);"></div>
          <div class="absolute inset-0 pointer-events-none" style="background: linear-gradient(135deg, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0.2) 20%, transparent 40%);"></div>
          <div class="absolute inset-0 pointer-events-none" style="box-shadow: inset 0 0 20px rgba(30,64,175,0.1);"></div>
          
          ${sashHardware}
          
          <!-- Vitralux logo -->
          ${showLogo ? '<div class="absolute bottom-1 right-1 pointer-events-none" style="font-size: 7px; font-weight: 600; color: rgba(30,64,175,0.35); letter-spacing: 0.5px; font-family: Arial, sans-serif;">VITRALUX</div>' : ''}
          
          <!-- Panel label -->
          <div class="relative z-10 flex flex-col items-center">
            <span class="text-2xl font-bold drop-shadow-sm" style="color: ${isOperable ? 'rgba(22,101,52,0.8)' : 'rgba(30,64,175,0.7)'};">${type}</span>
            <span class="text-xs mt-0.5 font-medium" style="color: ${isOperable ? 'rgba(22,101,52,0.7)' : 'rgba(30,64,175,0.6)'};">${isOperable ? 'Operable' : 'Fixed'}</span>
          </div>
        `;
        
        // Add meeting rail (mullion) between sashes - this is thicker and more prominent
        if (index < panelConfig.length - 1) {
          const meetingRail = document.createElement('div');
          meetingRail.dataset.mullionIndex = index;
          
          // Draggable meeting rail
          meetingRail.className = 'h-4 w-full flex-shrink-0 cursor-ns-resize transition-all duration-200 flex items-center justify-center draggable-mullion';
          meetingRail.style.background = 'linear-gradient(180deg, #505050 0%, #707070 20%, #808080 50%, #707070 80%, #505050 100%)';
          meetingRail.style.boxShadow = 'inset 0 1px 0 rgba(255,255,255,0.2), inset 0 -1px 0 rgba(0,0,0,0.3), 0 2px 4px rgba(0,0,0,0.2)';
          meetingRail.title = 'Drag to resize sashes';
          
          // Add grip dots
          meetingRail.innerHTML = '<div class="flex gap-0.5 opacity-60"><div class="w-1 h-1 bg-white rounded-full"></div><div class="w-1 h-1 bg-white rounded-full"></div><div class="w-1 h-1 bg-white rounded-full"></div></div>';
          
          meetingRail.onmouseenter = () => { 
            meetingRail.style.background = 'linear-gradient(180deg, #3b82f6 0%, #60a5fa 30%, #93c5fd 50%, #60a5fa 70%, #3b82f6 100%)';
            meetingRail.style.transform = 'scaleY(1.3)';
          };
          meetingRail.onmouseleave = () => { 
            if (!isDragging) {
              meetingRail.style.background = 'linear-gradient(180deg, #505050 0%, #707070 20%, #808080 50%, #707070 80%, #505050 100%)';
              meetingRail.style.transform = 'scale(1)';
            }
          };
          
          meetingRail.addEventListener('mousedown', (e) => startDrag(e, index, 'vertical'));
          
          preview.appendChild(panel);
          preview.appendChild(meetingRail);
        } else {
          preview.appendChild(panel);
        }
      });
      
      // Update label
      const configString = panelConfig.join('');
      const operableCount = panelConfig.filter(p => p === 'X').length;
      const fixedCount = panelConfig.filter(p => p === 'O').length;
      label.textContent = `${configString} - Single Hung (${operableCount} Operable, ${fixedCount} Fixed)`;
      
      // Show drag hint
      updateDragHint(true);
    }
    
    // Create a door panel that looks like a door
    function createDoorPanel(position) {
      const door = document.createElement('div');
      door.className = 'relative flex items-center justify-center overflow-hidden';
      door.style.background = 'linear-gradient(180deg, rgba(191,219,254,0.8) 0%, rgba(147,197,253,0.6) 50%, rgba(191,219,254,0.7) 100%)';
      
      // Determine handle and hinge positions
      let handleSide, hingeSide;
      if (position === 'single') {
        // For single door, use the configured hinge side
        hingeSide = frenchDoorConfig.hingeSide;
        handleSide = hingeSide === 'left' ? 'right' : 'left';
      } else if (position === 'left') {
        // Left door of double: hinges on left, handle on right
        hingeSide = 'left';
        handleSide = 'right';
      } else {
        // Right door of double: hinges on right, handle on left
        hingeSide = 'right';
        handleSide = 'left';
      }
      
      // Glass effects
      door.innerHTML = `
        <div class="absolute inset-0 pointer-events-none" style="background: linear-gradient(180deg, rgba(96,165,250,0.25) 0%, rgba(147,197,253,0.15) 30%, transparent 60%);"></div>
        <div class="absolute inset-0 pointer-events-none" style="background: linear-gradient(135deg, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0.2) 20%, transparent 40%);"></div>
        <div class="absolute inset-0 pointer-events-none" style="box-shadow: inset 0 0 20px rgba(30,64,175,0.1);"></div>
        
        <!-- Door handle -->
        <div class="absolute ${handleSide === 'right' ? 'right-3' : 'left-3'} top-1/2 transform -translate-y-1/2 flex flex-col items-center gap-1">
          <div class="w-2 h-8 rounded-full" style="background: linear-gradient(90deg, #a0a0a0 0%, #d0d0d0 50%, #a0a0a0 100%); box-shadow: 1px 1px 3px rgba(0,0,0,0.3);"></div>
        </div>
        
        <!-- Door hinge indicators -->
        <div class="absolute ${hingeSide === 'right' ? 'right-1' : 'left-1'} top-4 w-1.5 h-4 rounded-sm" style="background: linear-gradient(90deg, #808080, #b0b0b0, #808080);"></div>
        <div class="absolute ${hingeSide === 'right' ? 'right-1' : 'left-1'} bottom-4 w-1.5 h-4 rounded-sm" style="background: linear-gradient(90deg, #808080, #b0b0b0, #808080);"></div>
        
        <!-- Door label -->
        <div class="relative z-10 flex flex-col items-center">
          <span class="text-2xl font-bold drop-shadow-sm" style="color: rgba(22,101,52,0.8);">X</span>
          <span class="text-xs mt-0.5 font-medium" style="color: rgba(22,101,52,0.7);">Door</span>
        </div>
        
        <!-- Vitralux logo -->
        ${showLogo ? '<div class="absolute bottom-1 right-1 pointer-events-none" style="font-size: 6px; font-weight: 600; color: rgba(30,64,175,0.35); letter-spacing: 0.5px; font-family: Arial, sans-serif;">VITRALUX</div>' : ''}
      `;
      
      return door;
    }
    
    // Create a glass panel (for sidelites and transoms)
    function createGlassPanel(type, isOperable, isTransom) {
      const panel = document.createElement('div');
      panel.className = 'relative flex items-center justify-center overflow-hidden';
      panel.style.background = 'linear-gradient(180deg, rgba(191,219,254,0.8) 0%, rgba(147,197,253,0.6) 50%, rgba(191,219,254,0.7) 100%)';
      
      panel.innerHTML = `
        <div class="absolute inset-0 pointer-events-none" style="background: linear-gradient(180deg, rgba(96,165,250,0.25) 0%, rgba(147,197,253,0.15) 30%, transparent 60%);"></div>
        <div class="absolute inset-0 pointer-events-none" style="background: linear-gradient(135deg, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0.2) 20%, transparent 40%);"></div>
        <div class="absolute inset-0 pointer-events-none" style="box-shadow: inset 0 0 20px rgba(30,64,175,0.1);"></div>
        ${!isTransom ? `<div class="relative z-10 flex flex-col items-center">
          <span class="text-lg font-bold drop-shadow-sm" style="color: rgba(30,64,175,0.7);">${type}</span>
          <span class="text-xs font-medium" style="color: rgba(30,64,175,0.6);">Fixed</span>
        </div>` : ''}
        ${showLogo && !isTransom ? '<div class="absolute bottom-1 right-1 pointer-events-none" style="font-size: 6px; font-weight: 600; color: rgba(30,64,175,0.35); letter-spacing: 0.5px; font-family: Arial, sans-serif;">VITRALUX</div>' : ''}
      `;
      
      return panel;
    }
    
    // Create aluminum mullion
    function createAluminumMullion(direction) {
      const mullion = document.createElement('div');
      mullion.className = direction === 'vertical' ? 'w-2 self-stretch flex-shrink-0' : 'h-2 w-full flex-shrink-0';
      mullion.style.background = 'linear-gradient(90deg, #606060 0%, #808080 30%, #909090 50%, #808080 70%, #606060 100%)';
      mullion.style.boxShadow = 'inset 0 1px 0 rgba(255,255,255,0.3), inset 0 -1px 0 rgba(0,0,0,0.2)';
      return mullion;
    }
    
    function updatePanelInputs() {
      const count = parseInt(document.getElementById('panelCount').value) || 2;
      const builder = document.getElementById('panelLayoutBuilder');
      
      // Adjust panel config array
      while (panelConfig.length < count) {
        panelConfig.push('O'); // Default new panels to Fixed (O)
      }
      while (panelConfig.length > count) {
        panelConfig.pop();
      }
      
      // Adjust panel ratios array
      while (panelRatios.length < count) {
        panelRatios.push(1); // Default new panels to ratio 1
      }
      while (panelRatios.length > count) {
        panelRatios.pop();
      }
      
      // Build panel buttons
      builder.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const isOperable = panelConfig[i] === 'X'; // X = Operable, O = Fixed
        const button = document.createElement('button');
        button.type = 'button';
        button.className = `panel-toggle w-20 h-24 rounded-lg border-2 flex flex-col items-center justify-center font-bold text-lg transition-all ${
          isOperable 
            ? 'bg-green-500 border-green-600 text-white shadow-lg' 
            : 'bg-gray-200 border-gray-400 text-gray-700'
        }`;
        button.innerHTML = `
          <span class="text-2xl">${panelConfig[i]}</span>
          <span class="text-xs mt-1">${isOperable ? 'Operable' : 'Fixed'}</span>
        `;
        button.onclick = () => togglePanel(i);
        builder.appendChild(button);
      }
      
      updatePanelPreview();
    }
    
    function togglePanel(index) {
      const operationType = document.getElementById('operationType').value;
      
      // Fixed operation type cannot have operable panels
      if (operationType === 'fixed') {
        showAlert('Fixed windows cannot have operable panels. All panels must be fixed.');
        return;
      }
      
      panelConfig[index] = panelConfig[index] === 'X' ? 'O' : 'X'; // Toggle between X (Operable) and O (Fixed)
      updatePanelInputs();
    }
    
    function updatePanelPreview() {
      const preview = document.getElementById('panelPreview');
      const label = document.getElementById('panelConfigLabel');
      const orientation = document.getElementById('panelOrientation').value;
      const operationType = document.getElementById('operationType').value;
      
      // Special handling for French Door
      if (operationType === 'french-door') {
        renderFrenchDoorPreview(preview, label);
        return;
      }
      
      // Special handling for Casement
      if (operationType === 'casement') {
        renderCasementPreview(preview, label, orientation);
        return;
      }
      
      // Special handling for Sliding/Roller
      if (operationType === 'sliding') {
        renderSlidingPreview(preview, label, orientation);
        return;
      }
      
      // Special handling for Single Hung
      if (operationType === 'single-hung') {
        renderSingleHungPreview(preview, label);
        return;
      }
      
      // Set flex direction based on orientation
      preview.style.flexDirection = orientation === 'horizontal' ? 'row' : 'column';
      
      // Check if we should allow draggable dividers
      const allowDraggableDividers = (operationType === 'sliding' || operationType === 'single-hung') && panelConfig.length >= 2;
      
      // Build preview panels
      preview.innerHTML = '';
      panelConfig.forEach((type, index) => {
        const isOperable = type === 'X'; // X = Operable, O = Fixed
        const panel = document.createElement('div');
        panel.className = 'relative min-w-[50px] min-h-[50px] flex items-center justify-center overflow-hidden';
        panel.dataset.panelIndex = index;
        
        // Use panel ratios for sizing
        panel.style.flex = `${panelRatios[index]} 0 0%`;
        
        // Realistic glass effect - blue tint with transparency
        panel.style.background = isOperable 
          ? 'linear-gradient(180deg, rgba(186,230,253,0.75) 0%, rgba(147,197,253,0.55) 50%, rgba(186,230,253,0.65) 100%)'
          : 'linear-gradient(180deg, rgba(191,219,254,0.8) 0%, rgba(147,197,253,0.6) 50%, rgba(191,219,254,0.7) 100%)';
        
        // Add panel content with glass reflection effect
        panel.innerHTML = `
          <!-- Sky reflection on glass -->
          <div class="absolute inset-0 pointer-events-none" style="background: linear-gradient(180deg, rgba(96,165,250,0.25) 0%, rgba(147,197,253,0.15) 30%, transparent 60%);"></div>
          <!-- Glass shine/reflection -->
          <div class="absolute inset-0 pointer-events-none" style="background: linear-gradient(135deg, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0.2) 20%, transparent 40%);"></div>
          <!-- Subtle inner shadow for depth -->
          <div class="absolute inset-0 pointer-events-none" style="box-shadow: inset 0 0 20px rgba(30,64,175,0.1);"></div>
          <!-- Vitralux logo watermark -->
          ${showLogo ? '<div class="absolute bottom-1 right-1 pointer-events-none" style="font-size: 7px; font-weight: 600; color: rgba(30,64,175,0.35); letter-spacing: 0.5px; font-family: Arial, sans-serif;">VITRALUX</div>' : ''}
          <!-- Panel label -->
          <div class="relative z-10 flex flex-col items-center">
            <span class="text-2xl font-bold drop-shadow-sm" style="color: ${isOperable ? 'rgba(22,101,52,0.8)' : 'rgba(30,64,175,0.7)'};">${type}</span>
            <span class="text-xs mt-0.5 font-medium" style="color: ${isOperable ? 'rgba(22,101,52,0.7)' : 'rgba(30,64,175,0.6)'};">${isOperable ? 'Operable' : 'Fixed'}</span>
          </div>
          ${isOperable ? getOperationIndicator(operationType, orientation) : ''}
        `;
        
        // Add mullion (divider) between panels except for last
        if (index < panelConfig.length - 1) {
          const mullion = document.createElement('div');
          mullion.dataset.mullionIndex = index;
          
          if (allowDraggableDividers) {
            // Draggable mullion with darker aluminum effect and grip indicator
            mullion.className = orientation === 'horizontal' 
              ? 'w-4 self-stretch flex-shrink-0 cursor-ew-resize transition-all duration-200 flex items-center justify-center draggable-mullion' 
              : 'h-4 w-full flex-shrink-0 cursor-ns-resize transition-all duration-200 flex items-center justify-center draggable-mullion';
            mullion.style.background = 'linear-gradient(90deg, #606060 0%, #808080 30%, #909090 50%, #808080 70%, #606060 100%)';
            mullion.style.boxShadow = 'inset 0 1px 0 rgba(255,255,255,0.3), inset 0 -1px 0 rgba(0,0,0,0.2)';
            mullion.title = 'Drag to resize panels';
            
            // Add grip dots indicator
            const gripDots = orientation === 'horizontal' 
              ? '<div class="flex flex-col gap-0.5 opacity-60"><div class="w-1 h-1 bg-white rounded-full"></div><div class="w-1 h-1 bg-white rounded-full"></div><div class="w-1 h-1 bg-white rounded-full"></div></div>'
              : '<div class="flex gap-0.5 opacity-60"><div class="w-1 h-1 bg-white rounded-full"></div><div class="w-1 h-1 bg-white rounded-full"></div><div class="w-1 h-1 bg-white rounded-full"></div></div>';
            mullion.innerHTML = gripDots;
            
            mullion.onmouseenter = () => { 
              mullion.style.background = 'linear-gradient(90deg, #3b82f6 0%, #60a5fa 30%, #93c5fd 50%, #60a5fa 70%, #3b82f6 100%)';
              mullion.style.transform = orientation === 'horizontal' ? 'scaleX(1.3)' : 'scaleY(1.3)';
            };
            mullion.onmouseleave = () => { 
              if (!isDragging) {
                mullion.style.background = 'linear-gradient(90deg, #606060 0%, #808080 30%, #909090 50%, #808080 70%, #606060 100%)';
                mullion.style.transform = 'scale(1)';
              }
            };
            
            // Add drag handlers
            mullion.addEventListener('mousedown', (e) => startDrag(e, index, orientation));
          } else {
            // Non-draggable mullion with darker aluminum effect
            mullion.className = orientation === 'horizontal' 
              ? 'w-2 self-stretch flex-shrink-0' 
              : 'h-2 w-full flex-shrink-0';
            mullion.style.background = 'linear-gradient(90deg, #606060 0%, #808080 30%, #909090 50%, #808080 70%, #606060 100%)';
            mullion.style.boxShadow = 'inset 0 1px 0 rgba(255,255,255,0.3), inset 0 -1px 0 rgba(0,0,0,0.2)';
          }
          
          preview.appendChild(panel);
          preview.appendChild(mullion);
        } else {
          preview.appendChild(panel);
        }
      });
      
      // Update label
      const configString = panelConfig.join('');
      const operationLabel = {
        'sliding': 'Sliding',
        'casement': 'Casement',
        'awning': 'Awning',
        'hopper': 'Hopper',
        'fixed': 'Fixed',
        'single-hung': 'Single Hung',
        'double-hung': 'Double Hung',
        'tilt-turn': 'Tilt & Turn',
        'french-door': 'French Door'
      }[operationType] || operationType;
      
      // Build label text
      let labelText = `${configString} - ${panelConfig.length} Panel ${operationLabel}`;
      
      // Add French Door details
      if (operationType === 'french-door') {
        const doorDesc = frenchDoorConfig.doorType === 'single' ? 'Single' : 'Double';
        let extras = [];
        if (frenchDoorConfig.sidelites !== 'none') {
          extras.push(frenchDoorConfig.sidelites === 'both' ? 'Sidelites' : `${frenchDoorConfig.sidelites.charAt(0).toUpperCase() + frenchDoorConfig.sidelites.slice(1)} Sidelite`);
        }
        if (frenchDoorConfig.transom !== 'none') {
          extras.push('Transom');
        }
        labelText = `${doorDesc} French Door${extras.length > 0 ? ' + ' + extras.join(' + ') : ''}`;
      }
      // Add ratio info for windows with custom ratios
      else if (allowDraggableDividers && !areRatiosEqual()) {
        labelText += ` (${formatRatiosAsFractions(panelRatios)})`;
      }
      
      label.textContent = labelText;
      
      // Show drag hint for sliding windows
      updateDragHint(allowDraggableDividers);
    }
    
    // Check if all ratios are equal
    function areRatiosEqual() {
      if (panelRatios.length <= 1) return true;
      const first = panelRatios[0];
      return panelRatios.every(r => Math.abs(r - first) < 0.05);
    }
    
    // Format ratios as percentage string
    function formatRatiosAsFractions(ratios) {
      const total = ratios.reduce((a, b) => a + b, 0);
      const percentages = ratios.map(r => Math.round((r / total) * 100));
      return percentages.map(p => `${p}%`).join(' | ');
    }
    
    // Show/hide drag hint and reset button
    function updateDragHint(show) {
      let hint = document.getElementById('dragHint');
      const resetBtn = document.getElementById('resetRatiosBtn');
      
      if (show) {
        if (!hint) {
          hint = document.createElement('div');
          hint.id = 'dragHint';
          hint.className = 'mt-3 flex items-center justify-center gap-2 px-4 py-2 bg-blue-50 border border-blue-200 rounded-lg text-blue-700 text-sm';
          hint.innerHTML = '<i class="fas fa-arrows-alt-h text-blue-500"></i><span>Drag the <strong>dividers</strong> to resize panels</span><i class="fas fa-arrows-alt-h text-blue-500"></i>';
          document.getElementById('panelConfigLabel').after(hint);
        }
        hint.style.display = 'flex';
        
        // Show reset button only if ratios are not equal
        if (resetBtn) {
          resetBtn.style.display = areRatiosEqual() ? 'none' : 'inline-block';
        }
      } else {
        if (hint) hint.style.display = 'none';
        if (resetBtn) resetBtn.style.display = 'none';
      }
    }
    
    // Drag functions for resizing panels
    function startDrag(e, mullionIndex, orientation) {
      e.preventDefault();
      isDragging = true;
      dragIndex = mullionIndex;
      dragStartPos = orientation === 'horizontal' ? e.clientX : e.clientY;
      dragStartRatios = [...panelRatios];
      
      document.addEventListener('mousemove', onDrag);
      document.addEventListener('mouseup', stopDrag);
      
      // Add dragging class to preview
      document.getElementById('panelPreview').classList.add('select-none');
    }
    
    function onDrag(e) {
      if (!isDragging || dragIndex < 0) return;
      
      const preview = document.getElementById('panelPreview');
      const orientation = document.getElementById('panelOrientation').value;
      const previewSize = orientation === 'horizontal' ? preview.offsetWidth : preview.offsetHeight;
      const currentPos = orientation === 'horizontal' ? e.clientX : e.clientY;
      
      // Calculate the delta as a proportion of the preview size
      const delta = (currentPos - dragStartPos) / previewSize;
      
      // Calculate total ratio before the mullion and after
      const totalRatio = dragStartRatios.reduce((a, b) => a + b, 0);
      
      // Adjust the ratios of panels on either side of the mullion
      const leftRatio = dragStartRatios[dragIndex];
      const rightRatio = dragStartRatios[dragIndex + 1];
      const combinedRatio = leftRatio + rightRatio;
      
      // Calculate new ratios based on drag
      let newLeftRatio = leftRatio + (delta * totalRatio);
      let newRightRatio = rightRatio - (delta * totalRatio);
      
      // Clamp ratios to minimum of 0.3
      const minRatio = 0.3;
      if (newLeftRatio < minRatio) {
        newLeftRatio = minRatio;
        newRightRatio = combinedRatio - minRatio;
      }
      if (newRightRatio < minRatio) {
        newRightRatio = minRatio;
        newLeftRatio = combinedRatio - minRatio;
      }
      
      // Update ratios
      panelRatios[dragIndex] = newLeftRatio;
      panelRatios[dragIndex + 1] = newRightRatio;
      
      // Update preview without rebuilding (just update flex values)
      updatePanelFlexValues();
    }
    
    function stopDrag() {
      isDragging = false;
      dragIndex = -1;
      document.removeEventListener('mousemove', onDrag);
      document.removeEventListener('mouseup', stopDrag);
      
      // Remove dragging class
      document.getElementById('panelPreview').classList.remove('select-none');
      
      // Rebuild preview to update label
      updatePanelPreview();
    }
    
    // Update only flex values without rebuilding DOM
    function updatePanelFlexValues() {
      const preview = document.getElementById('panelPreview');
      const panels = preview.querySelectorAll('[data-panel-index]');
      
      panels.forEach((panel, index) => {
        panel.style.flex = `${panelRatios[index]} 0 0%`;
      });
      
      // Update label with current ratios
      const label = document.getElementById('panelConfigLabel');
      const configString = panelConfig.join('');
      const operationType = document.getElementById('operationType').value;
      const operationLabel = {
        'sliding': 'Sliding',
        'casement': 'Casement',
        'awning': 'Awning',
        'hopper': 'Hopper',
        'fixed': 'Fixed',
        'single-hung': 'Single Hung',
        'double-hung': 'Double Hung',
        'tilt-turn': 'Tilt & Turn',
        'french-door': 'French Door'
      }[operationType] || operationType;
      
      let labelText = `${configString} - ${panelConfig.length} Panel ${operationLabel}`;
      if (!areRatiosEqual()) {
        labelText += ` (${formatRatiosAsFractions(panelRatios)})`;
      }
      label.textContent = labelText;
    }
    
    // Reset panel ratios to equal
    function resetPanelRatios() {
      panelRatios = panelConfig.map(() => 1);
      updatePanelPreview();
    }
    
    function getOperationIndicator(type, orientation) {
      // Add visual indicators for different operation types - subtle style
      const baseClass = 'absolute flex items-center justify-center bg-white/70 text-green-700 rounded-full shadow-sm border border-green-300/50';
      switch(type) {
        case 'sliding':
          return orientation === 'horizontal' 
            ? `<div class="${baseClass} bottom-2 left-1/2 transform -translate-x-1/2 w-5 h-5"><i class="fas fa-arrows-alt-h text-xs"></i></div>`
            : `<div class="${baseClass} right-2 top-1/2 transform -translate-y-1/2 w-5 h-5"><i class="fas fa-arrows-alt-v text-xs"></i></div>`;
        case 'casement':
          return `<div class="${baseClass} top-2 right-2 w-5 h-5"><i class="fas fa-external-link-alt text-xs" style="transform: rotate(-45deg);"></i></div>`;
        case 'awning':
          return `<div class="${baseClass} top-2 left-1/2 transform -translate-x-1/2 w-5 h-5"><i class="fas fa-arrow-up text-xs"></i></div>`;
        case 'hopper':
          return `<div class="${baseClass} bottom-2 left-1/2 transform -translate-x-1/2 w-5 h-5"><i class="fas fa-arrow-down text-xs"></i></div>`;
        case 'single-hung':
        case 'double-hung':
          return `<div class="${baseClass} right-2 top-1/2 transform -translate-y-1/2 w-5 h-5"><i class="fas fa-arrows-alt-v text-xs"></i></div>`;
        case 'tilt-turn':
          return `<div class="${baseClass} top-2 right-2 w-5 h-5"><i class="fas fa-sync-alt text-xs"></i></div>`;
        case 'french-door':
          return `<div class="${baseClass} bottom-2 left-1/2 transform -translate-x-1/2 w-5 h-5"><i class="fas fa-door-open text-xs"></i></div>`;
        default:
          return '';
      }
    }
    
    // Enforce minimum panels and orientation when operation type changes
    function enforceMinimumPanels() {
      const operationType = document.getElementById('operationType').value;
      const panelCountInput = document.getElementById('panelCount');
      const panelOrientationSelect = document.getElementById('panelOrientation');
      const minPanels = getMinPanelsForOperationType(operationType);
      
      // Update minimum attribute
      panelCountInput.min = minPanels;
      
      // Enforce orientation based on operation type
      if (operationType === 'sliding') {
        // Sliding/Roller can only be horizontal
        panelOrientationSelect.value = 'horizontal';
        panelOrientationSelect.disabled = true;
        panelOrientationSelect.title = 'Sliding/Roller windows are always horizontal';
        panelOrientationSelect.classList.add('bg-gray-100', 'cursor-not-allowed');
      } else if (operationType === 'single-hung') {
        // Single Hung can only be vertical
        panelOrientationSelect.value = 'vertical';
        panelOrientationSelect.disabled = true;
        panelOrientationSelect.title = 'Single Hung windows are always vertical';
        panelOrientationSelect.classList.add('bg-gray-100', 'cursor-not-allowed');
      } else if (operationType === 'double-hung') {
        // Double Hung defaults to vertical but can be changed
        panelOrientationSelect.value = 'vertical';
        panelOrientationSelect.disabled = false;
        panelOrientationSelect.title = '';
        panelOrientationSelect.classList.remove('bg-gray-100', 'cursor-not-allowed');
      } else if (operationType === 'fixed') {
        // Fixed windows: all panels must be fixed (O)
        panelOrientationSelect.disabled = false;
        panelOrientationSelect.title = '';
        panelOrientationSelect.classList.remove('bg-gray-100', 'cursor-not-allowed');
        
        // Set all panels to fixed (O)
        for (let i = 0; i < panelConfig.length; i++) {
          panelConfig[i] = 'O';
        }
        updatePanelInputs();
      } else {
        // Other types: enable orientation selection
        panelOrientationSelect.disabled = false;
        panelOrientationSelect.title = '';
        panelOrientationSelect.classList.remove('bg-gray-100', 'cursor-not-allowed');
      }
      
      // If current count is less than minimum, update it
      if (parseInt(panelCountInput.value) < minPanels) {
        panelCountInput.value = minPanels;
        updatePanelInputs();
        const typeNames = { 'sliding': 'Sliding', 'single-hung': 'Single Hung', 'double-hung': 'Double Hung' };
        showAlert(`${typeNames[operationType] || operationType} windows require at least ${minPanels} panels.`);
      }
    }
    
    // Add event listeners for panel configuration changes
    document.getElementById('panelOrientation')?.addEventListener('change', updatePanelPreview);
    document.getElementById('operationType')?.addEventListener('change', function() {
      updateFrenchDoorVisibility();
      enforceMinimumPanels();
      updatePanelPreview();
    });
    
    // Setup advanced configuration toggle
    function setupAdvancedConfigToggle() {
      try {
        const showToUserCheckbox = document.getElementById('accessory-show-to-user');
        const advancedConfig = document.getElementById('accessory-advanced-config');
        
        if (showToUserCheckbox && advancedConfig) {
          showToUserCheckbox.addEventListener('change', function() {
            if (this.checked) {
              advancedConfig.style.display = 'grid';
            } else {
              advancedConfig.style.display = 'none';
              // Reset advanced config fields when hiding
              const componentGroupSelect = document.getElementById('accessory-component-group-select');
              const componentGroupCustom = document.getElementById('accessory-component-group-custom');
              const componentGroup = document.getElementById('accessory-component-group');
              const selectionType = document.getElementById('accessory-selection-type');
              const isDefault = document.getElementById('accessory-is-default');
              
              if (componentGroupSelect) componentGroupSelect.value = '';
              if (componentGroupCustom) {
                componentGroupCustom.style.display = 'none';
                componentGroupCustom.value = '';
              }
              if (componentGroup) componentGroup.value = '';
              if (selectionType) selectionType.value = 'quantity';
              if (isDefault) isDefault.checked = false;
            }
          });
        }
      } catch (error) {
        console.error('Error in setupAdvancedConfigToggle:', error);
      }
    }
    
    // Toggle between dropdown and custom input for component groups
    function toggleCustomGroupInput() {
      const select = document.getElementById('accessory-component-group-select');
      const customInput = document.getElementById('accessory-component-group-custom');
      const hiddenInput = document.getElementById('accessory-component-group');
      
      if (select.value === 'custom') {
        customInput.style.display = 'block';
        customInput.focus();
        hiddenInput.value = customInput.value;
      } else {
        customInput.style.display = 'none';
        customInput.value = '';
        hiddenInput.value = select.value;
      }
    }
    
    // Update hidden input when custom text changes
    document.addEventListener('DOMContentLoaded', function() {
      const customInput = document.getElementById('accessory-component-group-custom');
      const hiddenInput = document.getElementById('accessory-component-group');
      
      customInput.addEventListener('input', function() {
        hiddenInput.value = this.value;
      });
    });
    
    // Muntin Configuration
    let flangeConfiguration = {
      hasFlange: false,
      flangeSize: null,
      isTrimable: false
    };
    
    let missileImpactConfiguration = {
      supportsLMI: false,
      supportsSMI: false,
      lmiGlasses: [],
      smiGlasses: []
    };
    
    // Toggle missile type glass selection sections
    function toggleMissileType(type) {
      const checkbox = document.getElementById(`missile-${type.toLowerCase()}`);
      const section = document.getElementById(`${type.toLowerCase()}-glass-section`);
      
      if (checkbox.checked) {
        section.style.display = 'block';
        if (type === 'LMI') {
          missileImpactConfiguration.supportsLMI = true;
        } else {
          missileImpactConfiguration.supportsSMI = true;
        }
      } else {
        section.style.display = 'none';
        if (type === 'LMI') {
          missileImpactConfiguration.supportsLMI = false;
          missileImpactConfiguration.lmiGlasses = [];
          // Uncheck all LMI glass checkboxes
          document.querySelectorAll('.lmi-glass-checkbox').forEach(cb => cb.checked = false);
        } else {
          missileImpactConfiguration.supportsSMI = false;
          missileImpactConfiguration.smiGlasses = [];
          // Uncheck all SMI glass checkboxes
          document.querySelectorAll('.smi-glass-checkbox').forEach(cb => cb.checked = false);
        }
      }
    }
    
    // Update glass selections when checkboxes change
    document.addEventListener('DOMContentLoaded', function() {
      // LMI glass checkboxes
      document.querySelectorAll('.lmi-glass-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          if (this.checked) {
            if (!missileImpactConfiguration.lmiGlasses.includes(this.value)) {
              missileImpactConfiguration.lmiGlasses.push(this.value);
            }
          } else {
            missileImpactConfiguration.lmiGlasses = missileImpactConfiguration.lmiGlasses.filter(id => id !== this.value);
          }
        });
      });
      
      // SMI glass checkboxes
      document.querySelectorAll('.smi-glass-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          if (this.checked) {
            if (!missileImpactConfiguration.smiGlasses.includes(this.value)) {
              missileImpactConfiguration.smiGlasses.push(this.value);
            }
          } else {
            missileImpactConfiguration.smiGlasses = missileImpactConfiguration.smiGlasses.filter(id => id !== this.value);
          }
        });
      });
    });
    
    let muntinConfiguration = {
      enabled: false,
      muntinProfile: null,
      showToUser: true
    };

    function toggleFlangeConfiguration() {
      const enabled = document.getElementById('flange-enabled').checked;
      const configSection = document.getElementById('flange-config-section');
      const disabledMessage = document.getElementById('flange-disabled-message');
      const toggleLabel = document.getElementById('flange-toggle-label');
      
      if (enabled) {
        configSection.style.display = 'block';
        disabledMessage.style.display = 'none';
        toggleLabel.textContent = 'Enabled';
        toggleLabel.classList.remove('text-gray-500');
        toggleLabel.classList.add('text-blue-600', 'font-semibold');
        flangeConfiguration.hasFlange = true;
      } else {
        configSection.style.display = 'none';
        disabledMessage.style.display = 'block';
        toggleLabel.textContent = 'No Flange';
        toggleLabel.classList.remove('text-blue-600', 'font-semibold');
        toggleLabel.classList.add('text-gray-500');
        flangeConfiguration.hasFlange = false;
        flangeConfiguration.flangeSize = null;
        flangeConfiguration.isTrimable = false;
      }
    }
    
    function toggleMuntinConfiguration() {
      const enabled = document.getElementById('muntin-enabled').checked;
      const configSection = document.getElementById('muntin-config-section');
      const disabledMessage = document.getElementById('muntin-disabled-message');
      const toggleLabel = document.getElementById('muntin-toggle-label');
      
      muntinConfiguration.enabled = enabled;
      
      if (enabled) {
        configSection.style.display = 'block';
        disabledMessage.style.display = 'none';
        toggleLabel.textContent = 'Enabled';
        toggleLabel.classList.remove('text-gray-500');
        toggleLabel.classList.add('text-amber-600', 'font-semibold');
      } else {
        configSection.style.display = 'none';
        disabledMessage.style.display = 'block';
        toggleLabel.textContent = 'Disabled';
        toggleLabel.classList.add('text-gray-500');
        toggleLabel.classList.remove('text-amber-600', 'font-semibold');
      }
    }

    function updateMuntinPreview() {
      const previewGrid = document.getElementById('muntin-preview-grid');
      const previewText = document.getElementById('muntin-preview-text');
      
      // Generate a simple preview grid
      previewGrid.innerHTML = '';
      const cell = document.createElement('div');
      cell.style.position = 'absolute';
      cell.style.left = '0%';
      cell.style.top = '0%';
      cell.style.width = '100%';
      cell.style.height = '100%';
      cell.style.border = '1px solid #6b7280';
      cell.style.backgroundColor = '#e5e7eb';
      previewGrid.appendChild(cell);
      
      // Update preview text
      const typeLabel = type.charAt(0).toUpperCase() + type.slice(1);
      previewText.textContent = `1x1 ${typeLabel} Grid (User configurable)`;
    }

    // Step navigation
    function setupStepNavigation() {
      try {
        // Step 1 to Step 2
        const toStep2Btn = document.getElementById('to-step2-btn');
        if (toStep2Btn) {
          toStep2Btn.addEventListener('click', async function() {
            console.log('Step 2 button clicked');
            const windowType = document.getElementById('type').value.trim();
            console.log('Window type value:', windowType);
            if (!windowType) {
              showAlert('Please enter a window type before proceeding.');
              return;
            }
            
            // Check if name is valid (not taken)
            if (!isNameValid) {
              // Do a final check before proceeding
              try {
                const response = await fetch(`/admin/check-window-name?name=${encodeURIComponent(windowType)}`);
                const data = await response.json();
                
                if (data.exists) {
                  showAlert(data.message || 'This window type name is already taken. Please choose a different name.');
                  document.getElementById('type').focus();
                  return;
                }
              } catch (error) {
                console.error('Error checking name:', error);
              }
            }
            
            console.log('Calling goToStep(2)');
            goToStep(2);
          });
        }
        
        // Step 2 to Step 1
        const backToStep1Btn = document.getElementById('back-to-step1-btn');
        if (backToStep1Btn) {
          backToStep1Btn.addEventListener('click', function() {
            goToStep(1);
          });
        }
        
        // Step 2 to Step 3
        const toStep3Btn = document.getElementById('to-step3-btn');
        if (toStep3Btn) {
          toStep3Btn.addEventListener('click', function() {
            if (profiles.length === 0) {
              showAlert('Please add at least one profile before proceeding.');
              return;
            }
            goToStep(3);
          });
        }
        
        // Step 3 to Step 2
        const backToStep2Btn = document.getElementById('back-to-step2-btn');
        if (backToStep2Btn) {
          backToStep2Btn.addEventListener('click', function() {
            goToStep(2);
          });
        }
        
        // Step 3 to Step 4
        const toStep4Btn = document.getElementById('to-step4-btn');
        if (toStep4Btn) {
          toStep4Btn.addEventListener('click', function() {
            goToStep(4);
          });
        }
        
        // Step 4 to Step 3
        const backToStep3Btn = document.getElementById('back-to-step3-btn');
        if (backToStep3Btn) {
          backToStep3Btn.addEventListener('click', function() {
            goToStep(3);
          });
        }
        
        // Step 4 to Step 5
        const toStep5Btn = document.getElementById('to-step5-btn');
        if (toStep5Btn) {
          toStep5Btn.addEventListener('click', function() {
            goToStep(5);
          });
        }
        
        // Step 5 to Step 4
        const backToStep4Btn = document.getElementById('back-to-step4-btn');
        if (backToStep4Btn) {
          backToStep4Btn.addEventListener('click', function() {
            goToStep(4);
          });
        }
        
      } catch (error) {
        console.error('Error in setupStepNavigation:', error);
      }
    }
    
    function goToStep(step) {
      console.log('goToStep called with step:', step);
      
      // Simple approach: hide all, show only current
      document.getElementById('step1-section').style.display = 'none';
      document.getElementById('step2-section').style.display = 'none';
      document.getElementById('step3-section').style.display = 'none';
      document.getElementById('step4-section').style.display = 'none';
      if (document.getElementById('step5-section')) {
        document.getElementById('step5-section').style.display = 'none';
      }
      
      // Show only the current step
      const currentSection = document.getElementById(`step${step}-section`);
      if (currentSection) {
        console.log(`Showing step ${step}`);
        currentSection.style.display = 'block';
      }
      
      // Update step indicators (5 steps)
      for (let i = 1; i <= 5; i++) {
        const indicator = document.getElementById(`step${i}-indicator`);
        if (indicator) {
          if (i < step) {
            indicator.classList.remove('step-inactive', 'step-active');
            indicator.classList.add('step-complete');
          } else if (i === step) {
            indicator.classList.remove('step-inactive', 'step-complete');
            indicator.classList.add('step-active');
          } else {
            indicator.classList.remove('step-active', 'step-complete');
            indicator.classList.add('step-inactive');
          }
        }
      }
      
      currentStep = step;
      
      // Scroll to the current step
      if (currentSection) {
        currentSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }
    
    // Show alert message
    function showAlert(message) {
      const alertDiv = document.createElement('div');
      alertDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded shadow-lg z-50 animate-bounce';
      alertDiv.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${message}`;
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 3000);
    }
    
    // Update empty state messages
    function updateEmptyStates() {
      try {
        // Profiles
        const profilesEmpty = document.getElementById('profiles-empty-state');
        if (profilesEmpty) {
          if (profiles.length > 0) {
            profilesEmpty.style.display = 'none';
          } else {
            profilesEmpty.style.display = 'block';
          }
        }
        
        // Accessories
        const accessoriesEmpty = document.getElementById('accessories-empty-state');
        if (accessoriesEmpty) {
          if (accessories.length > 0) {
            accessoriesEmpty.style.display = 'none';
          } else {
            accessoriesEmpty.style.display = 'block';
          }
        }
      } catch (error) {
        console.error('Error in updateEmptyStates:', error);
      }
    }

    // Profile searchable select functions
    function initProfileSearch() {
      const searchInput = document.getElementById('profile-search-input');
      const searchFilter = document.getElementById('profile-search-filter');
      const dropdown = document.getElementById('profile-dropdown');
      const optionsList = document.getElementById('profile-options-list');
      const noResults = document.getElementById('profile-no-results');
      const hiddenInput = document.getElementById('profile-id');
      const wrapper = document.getElementById('profile-select-wrapper');
      
      if (!searchInput || !dropdown) return; // Exit if elements don't exist
      
      // Store all profile options
      const allOptions = Array.from(optionsList.querySelectorAll('.profile-option'));
      
      // Toggle dropdown
      function toggleDropdown() {
        dropdown.classList.toggle('hidden');
        if (!dropdown.classList.contains('hidden')) {
          searchFilter.focus();
          filterOptions();
        }
      }
      
      // Filter options based on search
      function filterOptions() {
        const searchTerm = searchFilter.value.toLowerCase().trim();
        let visibleCount = 0;
        
        allOptions.forEach(option => {
          const name = option.dataset.name || '';
          const color = (option.dataset.color || '').toLowerCase();
          const matches = !searchTerm || name.includes(searchTerm) || color.includes(searchTerm);
          
          option.style.display = matches ? '' : 'none';
          if (matches) visibleCount++;
        });
        
        // Show/hide no results message
        noResults.classList.toggle('hidden', visibleCount > 0 || !searchTerm);
        optionsList.classList.toggle('hidden', visibleCount === 0 && searchTerm);
      }
      
      // Select a profile
      function selectProfile(optionElement) {
        const value = optionElement.dataset.value;
        const nameSpan = optionElement.querySelector('span.font-medium');
        const name = nameSpan ? nameSpan.textContent : optionElement.textContent.trim();
        
        hiddenInput.value = value;
        searchInput.value = name;
        dropdown.classList.add('hidden');
        searchFilter.value = '';
        filterOptions();
      }
      
      // Open dropdown when clicking on input or wrapper
      searchInput.addEventListener('click', function(e) {
        e.stopPropagation();
        if (dropdown.classList.contains('hidden')) {
          toggleDropdown();
        }
      });
      
      wrapper.addEventListener('click', function(e) {
        e.stopPropagation();
        if (e.target === searchInput || e.target === wrapper || e.target.closest('i.fa-chevron-down')) {
          if (dropdown.classList.contains('hidden')) {
            toggleDropdown();
          }
        }
      });
      
      // Prevent dropdown from closing when clicking inside it
      dropdown.addEventListener('click', function(e) {
        e.stopPropagation();
      });
      
      // Filter on search input
      searchFilter.addEventListener('input', filterOptions);
      
      // Handle option clicks
      allOptions.forEach(option => {
        option.addEventListener('click', function(e) {
          e.stopPropagation();
          selectProfile(this);
        });
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!wrapper.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.add('hidden');
        }
      });
      
      // Handle keyboard navigation
      searchFilter.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          dropdown.classList.add('hidden');
          searchInput.focus();
        } else if (e.key === 'Enter') {
          e.preventDefault();
          const firstVisible = optionsList.querySelector('.profile-option[style=""]');
          if (firstVisible) {
            selectProfile(firstVisible);
          }
        }
      });
    }
    
    function getProfileTypeIcon(profileName) {
      const name = profileName.toLowerCase();
      
      // Detect profile type from name patterns
      if (name.includes('frame') || name.includes('marco')) {
        return { symbol: '🔲', type: 'Frame' };
      } else if (name.includes('sash') || name.includes('hoja') || name.includes('leaf')) {
        return { symbol: '🪟', type: 'Sash' };
      } else if (name.includes('mullion') || name.includes('parteluz') || name.includes('division')) {
        return { symbol: '┃', type: 'Mullion' };
      } else if (name.includes('rail') || name.includes('riel') || name.includes('carril')) {
        return { symbol: '═', type: 'Rail' };
      } else if (name.includes('stile') || name.includes('montante')) {
        return { symbol: '║', type: 'Stile' };
      } else if (name.includes('muntin') || name.includes('barra')) {
        return { symbol: '╬', type: 'Muntin' };
      } else if (name.includes('sill') || name.includes('umbral')) {
        return { symbol: '▬', type: 'Sill' };
      } else if (name.includes('head') || name.includes('cabezal')) {
        return { symbol: '▀', type: 'Head' };
      } else if (name.includes('jamb') || name.includes('jamba')) {
        return { symbol: '▐', type: 'Jamb' };
      } else if (name.includes('interlock') || name.includes('cierre')) {
        return { symbol: '⟷', type: 'Interlock' };
      } else if (name.includes('adaptor') || name.includes('adapter') || name.includes('adaptador')) {
        return { symbol: '⊏', type: 'Adaptor' };
      } else if (name.includes('glazing') || name.includes('bead') || name.includes('junquillo')) {
        return { symbol: '◫', type: 'Glazing Bead' };
      } else {
        return { symbol: '▪', type: 'Profile' };
      }
    }
    
    // Window Name Validation
    let nameCheckTimeout = null;
    let isNameValid = false;
    
    function initWindowNameValidation() {
      const nameInput = document.getElementById('type');
      const statusIcon = document.getElementById('name-check-status');
      const errorMsg = document.getElementById('name-error');
      const errorText = document.getElementById('name-error-text');
      const successMsg = document.getElementById('name-success');
      
      nameInput.addEventListener('input', function() {
        // Clear previous timeout
        if (nameCheckTimeout) {
          clearTimeout(nameCheckTimeout);
        }
        
        // Reset status
        hideNameStatus();
        isNameValid = false;
        
        const name = this.value.trim();
        
        if (!name) {
          return;
        }
        
        // Show loading indicator
        statusIcon.classList.remove('hidden');
        statusIcon.innerHTML = '<i class="fas fa-spinner fa-spin text-gray-400"></i>';
        
        // Debounce - wait 500ms after user stops typing
        nameCheckTimeout = setTimeout(() => {
          checkWindowName(name);
        }, 500);
      });
      
      // Also check on blur
      nameInput.addEventListener('blur', function() {
        const name = this.value.trim();
        if (name && !isNameValid) {
          checkWindowName(name);
        }
      });
    }
    
    async function checkWindowName(name) {
      const statusIcon = document.getElementById('name-check-status');
      const errorMsg = document.getElementById('name-error');
      const errorText = document.getElementById('name-error-text');
      const successMsg = document.getElementById('name-success');
      const nameInput = document.getElementById('type');
      
      try {
        const response = await fetch(`/admin/check-window-name?name=${encodeURIComponent(name)}`);
        const data = await response.json();
        
        statusIcon.classList.add('hidden');
        
        if (data.exists) {
          // Name is taken
          isNameValid = false;
          errorText.textContent = data.message || 'This name is already taken.';
          errorMsg.classList.remove('hidden');
          successMsg.classList.add('hidden');
          nameInput.classList.add('border-red-500');
          nameInput.classList.remove('border-green-500');
          
          // Show check icon in status
          statusIcon.classList.remove('hidden');
          statusIcon.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
        } else {
          // Name is available
          isNameValid = true;
          errorMsg.classList.add('hidden');
          successMsg.classList.remove('hidden');
          nameInput.classList.remove('border-red-500');
          nameInput.classList.add('border-green-500');
          
          // Show success icon in status
          statusIcon.classList.remove('hidden');
          statusIcon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
          
          // Hide success message after 3 seconds
          setTimeout(() => {
            successMsg.classList.add('hidden');
          }, 3000);
        }
      } catch (error) {
        console.error('Error checking window name:', error);
        statusIcon.classList.add('hidden');
      }
    }
    
    function hideNameStatus() {
      const statusIcon = document.getElementById('name-check-status');
      const errorMsg = document.getElementById('name-error');
      const successMsg = document.getElementById('name-success');
      const nameInput = document.getElementById('type');
      
      statusIcon.classList.add('hidden');
      errorMsg.classList.add('hidden');
      successMsg.classList.add('hidden');
      nameInput.classList.remove('border-red-500', 'border-green-500');
    }
    
    // Function to insert variable/operator into equation field
    function insertVariable(variable, inputId = 'profile-length-equation') {
      const equationInput = document.getElementById(inputId);
      if (!equationInput) {
        console.error('Equation input field not found:', inputId);
        return;
      }
      
      // Focus the input if it's not focused
      if (document.activeElement !== equationInput) {
        equationInput.focus();
      }
      
      const start = equationInput.selectionStart || 0;
      const end = equationInput.selectionEnd || 0;
      const currentValue = equationInput.value;
      
      // Insert the variable at cursor position
      const newValue = currentValue.substring(0, start) + variable + currentValue.substring(end);
      equationInput.value = newValue;
      
      // Set cursor position after inserted text
      const newCursorPos = start + variable.length;
      setTimeout(() => {
        equationInput.setSelectionRange(newCursorPos, newCursorPos);
        equationInput.focus();
      }, 10);
      
      // Trigger input event to run validation
      equationInput.dispatchEvent(new Event('input', { bubbles: true }));
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      initWindowNameValidation();
      initProfileSearch();
      
      // Initialize equation validation
      const equationInput = document.getElementById('profile-length-equation');
      if (equationInput) {
        // Add debounced validation
        let validationTimeout;
        equationInput.addEventListener('input', function() {
          clearTimeout(validationTimeout);
          validationTimeout = setTimeout(() => {
            validateLengthEquation(this.value);
          }, 300);
        });
        
        // Validate on blur
        equationInput.addEventListener('blur', function() {
          validateLengthEquation(this.value);
        });
      }
    });
    
    // Profile functions
    function addProfileEntry() {
      const hiddenInput = document.getElementById('profile-id');
      const searchInput = document.getElementById('profile-search-input');
      const profileId = hiddenInput.value;
      
      // Get profile name from the selected option
      let profileName = searchInput.value || '';
      if (profileId) {
        const selectedOption = document.querySelector(`.profile-option[data-value="${profileId}"]`);
        if (selectedOption) {
          const nameSpan = selectedOption.querySelector('span.font-medium');
          profileName = nameSpan ? nameSpan.textContent : selectedOption.textContent.trim();
        }
      }
      
      const quantityType = document.getElementById('profile-quantity-type').value;
      const quantity = document.getElementById('profile-quantity').value;
      const quantityEquation = document.getElementById('profile-quantity-equation').value;
      const orientation = document.getElementById('profile-orientation').value;
      const position = document.getElementById('profile-position').value;
      const lengthEquation = document.getElementById('profile-length-equation').value;
      const showToUser = document.getElementById('profile-show-to-user').checked;

      if (!profileId) {
        showAlert('Please select a profile');
        return;
      }
      
      // Validate quantity based on type
      if (quantityType === 'fixed') {
        if (!quantity || quantity <= 0) {
          showAlert('Please enter a valid quantity');
          return;
        }
      } else {
        if (!quantityEquation || quantityEquation.trim() === '') {
          showAlert('Please enter a quantity equation');
          return;
        }
        // Validate quantity equation
        const qtyValidation = validateProfileQuantityEquation(quantityEquation);
        if (!qtyValidation.valid) {
          showAlert(qtyValidation.message || 'Please enter a valid quantity equation. Check that you are using correct variable names (width, height, perimeter, area)');
          return;
        }
      }
      
      if (!orientation) {
        showAlert('Please select an orientation');
        return;
      }
      
      if (!lengthEquation || lengthEquation.trim() === '') {
        showAlert('Please enter a length equation');
        return;
      }
      
      // Validate length equation before adding
      const validation = validateLengthEquation(lengthEquation);
      if (!validation.valid) {
        showAlert(validation.message || 'Please enter a valid equation. Check that you are using correct variable names (width, height, perimeter, area)');
        return;
      }

      const profileEntry = {
        profileId, 
        profileName, 
        quantity: quantityType === 'fixed' ? parseInt(quantity) : null,
        quantityEquation: quantityType === 'equation' ? quantityEquation.trim() : null,
        orientation, 
        position: position || null, // Position (informative)
        lengthEquation: lengthEquation.trim(),
        showToUser,
        category: selectedProfileCategory // Store which component this profile belongs to 
      };

      profiles.push(profileEntry);
      renderProfilesTable();
      scheduleAutoSave();
      
      // Reset form inputs
      hiddenInput.value = '';
      searchInput.value = '';
      document.getElementById('profile-quantity-type').value = 'fixed';
      document.getElementById('profile-quantity').value = '';
      document.getElementById('profile-quantity-equation').value = '';
      document.getElementById('profile-orientation').selectedIndex = 0;
      document.getElementById('profile-position').value = '';
      document.getElementById('profile-length-equation').value = '';
      document.getElementById('profile-show-to-user').checked = false;
      toggleProfileQuantityType(); // Reset UI state
      
      // Clear validation messages
      const validationMsg = document.getElementById('profile-equation-validation-message');
      const previewDiv = document.getElementById('profile-equation-preview');
      if (validationMsg) validationMsg.innerHTML = '';
      if (previewDiv) previewDiv.innerHTML = '';
      const eqInput = document.getElementById('profile-length-equation');
      if (eqInput) {
        eqInput.classList.remove('border-red-500', 'border-green-500');
      }
      
      // Clear quantity equation validation
      const qtyValidationMsg = document.getElementById('profile-quantity-equation-validation-message');
      const qtyPreviewDiv = document.getElementById('profile-quantity-equation-preview');
      if (qtyValidationMsg) qtyValidationMsg.innerHTML = '';
      if (qtyPreviewDiv) qtyPreviewDiv.innerHTML = '';
      const qtyEqInput = document.getElementById('profile-quantity-equation');
      if (qtyEqInput) {
        qtyEqInput.classList.remove('border-red-500', 'border-green-500');
      }
      
      updateEmptyStates();
    }
    

    function renderProfilesTable() {
      const tableBody = document.getElementById('profiles-table-body');
      const emptyState = document.getElementById('profiles-empty-state');
      const countBadge = document.getElementById('profiles-count-badge');
      
      tableBody.innerHTML = '';
      
      // Update count badge
      if (countBadge) {
        countBadge.textContent = profiles.length;
      }
      
      // Show/hide empty state
      if (profiles.length === 0) {
        if (emptyState) emptyState.style.display = 'block';
        if (tableBody.closest('.overflow-x-auto')) {
          tableBody.closest('.overflow-x-auto').style.display = 'none';
        }
        return;
      } else {
        if (emptyState) emptyState.style.display = 'none';
        if (tableBody.closest('.overflow-x-auto')) {
          tableBody.closest('.overflow-x-auto').style.display = 'block';
        }
      }
      
      // Group profiles by category
      const categories = ['frame', 'fixed-vent', 'operable-vent', 'other'];
      const groupedProfiles = {};
      
      categories.forEach(cat => {
        groupedProfiles[cat] = profiles
          .map((profile, index) => ({ ...profile, originalIndex: index }))
          .filter(p => (p.category || 'frame') === cat);
      });
      
      // Render each category
      categories.forEach(category => {
        const categoryProfiles = groupedProfiles[category];
        if (categoryProfiles.length === 0) return;
        
        // Category header
        const headerRow = `
          <tr>
            <td colspan="7" class="px-4 py-3 bg-gradient-to-r from-gray-50 to-gray-100 border-t-2 border-b-2 border-gray-200">
              <div class="flex items-center">
                ${getCategoryIcon(category)}
                <span class="ml-2 font-semibold text-gray-700">${getCategoryLabel(category)}</span>
                <span class="ml-3 px-2 py-0.5 bg-white text-xs font-medium text-gray-600 rounded-full border border-gray-300">${categoryProfiles.length} profile${categoryProfiles.length > 1 ? 's' : ''}</span>
              </div>
            </td>
          </tr>
        `;
        tableBody.insertAdjacentHTML('beforeend', headerRow);
        
        // Profile rows for this category
        categoryProfiles.forEach((profile, idx) => {
          const userConfigStatus = profile.showToUser ? 
            '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"><i class="fas fa-check-circle mr-1"></i>User Config</span>' : 
            '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600"><i class="fas fa-lock mr-1"></i>Auto</span>';
          
          // Display length equation
          const lengthDisplay = `<code class="px-2 py-1 bg-blue-50 text-blue-700 rounded text-sm font-mono border border-blue-200">${profile.lengthEquation || 'N/A'}</code>`;
          
          const icon = getProfileTypeIcon(profile.profileName);
          
          const row = `
            <tr class="hover:bg-gray-50 transition-colors">
              <td class="px-4 py-3 whitespace-nowrap">
                <div class="flex items-center gap-2">
                  <span class="text-lg" title="${icon.type}">${icon.symbol}</span>
                  <span class="font-medium text-gray-900">${profile.profileName}</span>
                </div>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-center">
                ${profile.quantityEquation ? 
                  `<code class="px-2 py-1 bg-purple-50 text-purple-700 rounded text-sm font-mono border border-purple-200" title="Quantity Equation">${profile.quantityEquation}</code>` :
                  `<input type="number" min="1" step="1" value="${profile.quantity}" 
                     class="w-16 text-center px-2 py-1 rounded text-sm font-medium bg-gray-100 text-gray-800 border border-gray-300 hover:border-blue-400 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-colors"
                     onchange="updateProfileQuantity(${profile.originalIndex}, this.value)"
                     title="Click to edit quantity">`
                }
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-center">
                <span class="text-sm text-gray-600 capitalize">${profile.orientation}</span>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-center">
                ${profile.position ? 
                  `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800 capitalize">${profile.position}</span>` : 
                  `<span class="text-xs text-gray-400">-</span>`
                }
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-center">${lengthDisplay}</td>
              <td class="px-4 py-3 whitespace-nowrap text-center">${userConfigStatus}</td>
              <td class="px-4 py-3 whitespace-nowrap text-center">
                <button type="button" class="inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md text-white bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors" onclick="removeProfile(${profile.originalIndex})">
                  <i class="fas fa-trash mr-1.5"></i>Remove
                </button>
              </td>
            </tr>
          `;
          tableBody.insertAdjacentHTML('beforeend', row);
        });
      });
    }

    function removeProfile(index) {
      profiles.splice(index, 1);
      renderProfilesTable();
      updateEmptyStates();
      scheduleAutoSave();
    }
    
    function updateProfileQuantity(index, newQuantity) {
      const qty = parseInt(newQuantity, 10);
      if (!isNaN(qty) && qty >= 1) {
        profiles[index].quantity = qty;
        scheduleAutoSave();
      } else {
        // Reset to previous value if invalid
        renderProfilesTable();
      }
    }

    // Validate equation syntax and variables
    function validateEquation(equation) {
      const validationMsg = document.getElementById('equation-validation-message');
      const previewDiv = document.getElementById('equation-preview');
      const input = document.getElementById('accessory-quantity-equation');
      
      if (!equation || equation.trim() === '') {
        if (validationMsg) validationMsg.innerHTML = '';
        if (previewDiv) previewDiv.innerHTML = '';
        if (input) {
          input.classList.remove('border-red-500', 'border-green-500');
        }
        return { valid: false, message: '' };
      }
      
      const trimmed = equation.trim();
      const validVariables = ['width', 'height', 'perimeter', 'area'];
      
      // Check for invalid variable names (case-insensitive)
      const variablePattern = /\b([a-zA-Z_][a-zA-Z0-9_]*)\b/g;
      const foundVariables = [];
      let match;
      while ((match = variablePattern.exec(trimmed)) !== null) {
        const varName = match[1].toLowerCase();
        // Skip JavaScript keywords and math functions
        if (!['width', 'height', 'perimeter', 'area', 'sqrt', 'abs', 'round', 'floor', 'ceil', 'max', 'min', 'pow'].includes(varName)) {
          foundVariables.push(match[1]);
        }
      }
      
      // Filter out valid variables
      const invalidVars = foundVariables.filter(v => !validVariables.includes(v.toLowerCase()));
      
      if (invalidVars.length > 0) {
        const uniqueInvalid = [...new Set(invalidVars)];
        if (input) input.classList.add('border-red-500');
        if (input) input.classList.remove('border-green-500');
        if (validationMsg) {
          validationMsg.innerHTML = `<span class="text-red-600 font-medium">❌ Invalid variable(s): ${uniqueInvalid.join(', ')}</span><br><span class="text-red-500 text-xs">Valid variables are: width, height, perimeter, area</span>`;
        }
        if (previewDiv) previewDiv.innerHTML = '';
        return { valid: false, message: `Invalid variables: ${uniqueInvalid.join(', ')}` };
      }
      
      // Try to evaluate with sample values
      try {
        // Test with sample values: width=10, height=20
        const testWidth = 10;
        const testHeight = 20;
        const testPerimeter = 2 * (testWidth + testHeight);
        const testArea = testWidth * testHeight;
        
        let testExpression = trimmed;
        // Replace variables with test values (case-insensitive)
        testExpression = testExpression.replace(/\bwidth\b/gi, testWidth);
        testExpression = testExpression.replace(/\bheight\b/gi, testHeight);
        testExpression = testExpression.replace(/\bperimeter\b/gi, testPerimeter);
        testExpression = testExpression.replace(/\barea\b/gi, testArea);
        
        // Safe evaluation using Function constructor
        const result = Function('"use strict"; return (' + testExpression + ')')();
        
        if (typeof result !== 'number' || isNaN(result) || !isFinite(result)) {
          if (input) input.classList.add('border-red-500');
          if (input) input.classList.remove('border-green-500');
          if (validationMsg) {
            validationMsg.innerHTML = '<span class="text-red-600 font-medium">❌ Invalid equation syntax</span><br><span class="text-red-500 text-xs">The equation must evaluate to a valid number</span>';
          }
          if (previewDiv) previewDiv.innerHTML = '';
          return { valid: false, message: 'Invalid equation syntax' };
        }
        
        // Valid equation
        if (input) input.classList.add('border-green-500');
        if (input) input.classList.remove('border-red-500');
        if (validationMsg) {
          validationMsg.innerHTML = '<span class="text-green-600 font-medium">✓ Valid equation</span>';
        }
        
        // Show preview with sample calculation
        if (previewDiv) {
          previewDiv.innerHTML = `<span class="text-gray-600">Preview (width=10, height=20): <strong>${result.toFixed(2)}</strong></span>`;
        }
        return { valid: true, message: '', result: result };
      } catch (error) {
        if (input) input.classList.add('border-red-500');
        if (input) input.classList.remove('border-green-500');
        if (validationMsg) {
          validationMsg.innerHTML = '<span class="text-red-600 font-medium">❌ Invalid equation syntax</span><br><span class="text-red-500 text-xs">Check your math operators and parentheses</span>';
        }
        if (previewDiv) previewDiv.innerHTML = '';
        return { valid: false, message: 'Invalid equation syntax: ' + error.message };
      }
    }

    // Validate profile length equation syntax and variables
    function validateLengthEquation(equation) {
      const validationMsg = document.getElementById('profile-equation-validation-message');
      const previewDiv = document.getElementById('profile-equation-preview');
      const input = document.getElementById('profile-length-equation');
      
      // Get current global unit preference
      const globalUnit = window.globalPreferences?.unit || localStorage.getItem('globalUnit') || 'inches';
      const isMM = globalUnit === 'mm';
      const unitLabel = isMM ? 'mm' : 'in';
      const unitLabelFull = isMM ? 'millimeters' : 'inches';
      
      if (!equation || equation.trim() === '') {
        if (validationMsg) validationMsg.innerHTML = '';
        if (previewDiv) previewDiv.innerHTML = '';
        if (input) {
          input.classList.remove('border-red-500', 'border-green-500');
        }
        return { valid: false, message: '' };
      }
      
      const trimmed = equation.trim();
      const validVariables = ['width', 'height', 'perimeter', 'area'];
      
      // Check for invalid variable names (case-insensitive)
      const variablePattern = /\b([a-zA-Z_][a-zA-Z0-9_]*)\b/g;
      const foundVariables = [];
      let match;
      while ((match = variablePattern.exec(trimmed)) !== null) {
        const varName = match[1].toLowerCase();
        // Skip JavaScript keywords and math functions
        if (!['width', 'height', 'perimeter', 'area', 'sqrt', 'abs', 'round', 'floor', 'ceil', 'max', 'min', 'pow'].includes(varName)) {
          foundVariables.push(match[1]);
        }
      }
      
      // Filter out valid variables
      const invalidVars = foundVariables.filter(v => !validVariables.includes(v.toLowerCase()));
      
      if (invalidVars.length > 0) {
        const uniqueInvalid = [...new Set(invalidVars)];
        if (input) input.classList.add('border-red-500');
        if (input) input.classList.remove('border-green-500');
        if (validationMsg) {
          validationMsg.innerHTML = `<span class="text-red-600 font-medium">❌ Invalid variable(s): ${uniqueInvalid.join(', ')}</span><br><span class="text-red-500 text-xs">Valid variables are: width, height, perimeter, area</span>`;
        }
        if (previewDiv) previewDiv.innerHTML = '';
        return { valid: false, message: `Invalid variables: ${uniqueInvalid.join(', ')}` };
      }
      
      // Try to evaluate with sample values
      try {
        // Test with sample values in the current unit
        // Base values in inches: width=10, height=20
        let testWidth, testHeight;
        if (isMM) {
          // Convert to mm: 10 inches = 254 mm, 20 inches = 508 mm
          testWidth = 254;
          testHeight = 508;
        } else {
          testWidth = 10;
          testHeight = 20;
        }
        const testPerimeter = 2 * (testWidth + testHeight);
        const testArea = testWidth * testHeight;
        
        let testExpression = trimmed;
        // Replace variables with test values (case-insensitive)
        testExpression = testExpression.replace(/\bwidth\b/gi, testWidth);
        testExpression = testExpression.replace(/\bheight\b/gi, testHeight);
        testExpression = testExpression.replace(/\bperimeter\b/gi, testPerimeter);
        testExpression = testExpression.replace(/\barea\b/gi, testArea);
        
        // Safe evaluation using Function constructor
        // Note: The result will be in the same unit as the input (since variables are in that unit)
        const result = Function('"use strict"; return (' + testExpression + ')')();
        
        if (typeof result !== 'number' || isNaN(result) || !isFinite(result)) {
          if (input) input.classList.add('border-red-500');
          if (input) input.classList.remove('border-green-500');
          if (validationMsg) {
            validationMsg.innerHTML = '<span class="text-red-600 font-medium">❌ Invalid equation syntax</span><br><span class="text-red-500 text-xs">The equation must evaluate to a valid number</span>';
          }
          if (previewDiv) previewDiv.innerHTML = '';
          return { valid: false, message: 'Invalid equation syntax' };
        }
        
        // Valid equation
        if (input) input.classList.add('border-green-500');
        if (input) input.classList.remove('border-red-500');
        if (validationMsg) {
          validationMsg.innerHTML = '<span class="text-green-600 font-medium">✓ Valid equation</span>';
        }
        
        // Show preview with sample calculation in the current unit
        if (previewDiv) {
          const displayResult = result.toFixed(2);
          previewDiv.innerHTML = `<span class="text-gray-600">Preview (width=${testWidth} ${unitLabel}, height=${testHeight} ${unitLabel}): <strong>${displayResult} ${unitLabel}</strong></span>`;
        }
        return { valid: true, message: '', result: result };
      } catch (error) {
        if (input) input.classList.add('border-red-500');
        if (input) input.classList.remove('border-green-500');
        if (validationMsg) {
          validationMsg.innerHTML = '<span class="text-red-600 font-medium">❌ Invalid equation syntax</span><br><span class="text-red-500 text-xs">Check your math operators and parentheses</span>';
        }
        if (previewDiv) previewDiv.innerHTML = '';
        return { valid: false, message: 'Invalid equation syntax: ' + error.message };
      }
    }
    
    // Glass size equation validation (similar to length equation)
    // dimensionType: 'width' or 'height' to determine which input/error elements to use
    function validateGlassSizeEquation(equation, dimensionType = 'width') {
      const validationMsg = document.getElementById(`glass-${dimensionType}-equation-error`);
      const previewDiv = document.getElementById(`glass-${dimensionType}-equation-preview`);
      const input = document.getElementById(`glass-${dimensionType}-equation`);
      
      // Get current global unit preference
      const globalUnit = window.globalPreferences?.unit || localStorage.getItem('globalUnit') || 'inches';
      const isMM = globalUnit === 'mm';
      const unitLabel = isMM ? 'mm' : 'in';
      const unitLabelFull = isMM ? 'millimeters' : 'inches';
      
      if (!equation || equation.trim() === '') {
        if (validationMsg) {
          validationMsg.classList.add('hidden');
          validationMsg.textContent = '';
        }
        if (previewDiv) {
          previewDiv.classList.add('hidden');
          previewDiv.innerHTML = '';
        }
        if (input) {
          input.classList.remove('border-red-500', 'border-green-500');
        }
        return { valid: false, message: '' };
      }
      
      const trimmed = equation.trim();
      const validVariables = ['width', 'height', 'perimeter', 'area'];
      
      // Check for invalid variable names (case-insensitive)
      const variablePattern = /\b([a-zA-Z_][a-zA-Z0-9_]*)\b/g;
      const foundVariables = [];
      let match;
      while ((match = variablePattern.exec(trimmed)) !== null) {
        const varName = match[1].toLowerCase();
        // Skip JavaScript keywords and math functions
        if (!['width', 'height', 'perimeter', 'area', 'sqrt', 'abs', 'round', 'floor', 'ceil', 'max', 'min', 'pow'].includes(varName)) {
          foundVariables.push(match[1]);
        }
      }
      
      // Filter out valid variables
      const invalidVars = foundVariables.filter(v => !validVariables.includes(v.toLowerCase()));
      
      if (invalidVars.length > 0) {
        const uniqueInvalid = [...new Set(invalidVars)];
        if (input) input.classList.add('border-red-500');
        if (input) input.classList.remove('border-green-500');
        if (validationMsg) {
          validationMsg.textContent = `Invalid variable(s): ${uniqueInvalid.join(', ')}. Valid variables are: width, height, perimeter, area`;
          validationMsg.classList.remove('hidden');
        }
        if (previewDiv) previewDiv.classList.add('hidden');
        return { valid: false, message: `Invalid variables: ${uniqueInvalid.join(', ')}` };
      }
      
      // Try to evaluate with sample values
      try {
        // Test with sample values in the current unit
        // Base values in inches: width=10, height=20
        let testWidth, testHeight;
        if (isMM) {
          // Convert to mm: 10 inches = 254 mm, 20 inches = 508 mm
          testWidth = 254;
          testHeight = 508;
        } else {
          testWidth = 10;
          testHeight = 20;
        }
        const testPerimeter = 2 * (testWidth + testHeight);
        const testArea = testWidth * testHeight;
        
        let testExpression = trimmed;
        
        // Convert numeric constants from mm to inches (equations are written with mm constants)
        const variableNames = ['width', 'height', 'perimeter', 'area'];
        const placeholders = {};
        variableNames.forEach((varName, index) => {
          const placeholder = `__VAR${index}__`;
          placeholders[placeholder] = varName;
          testExpression = testExpression.replace(new RegExp(`\\b${varName}\\b`, 'gi'), placeholder);
        });

        testExpression = testExpression.replace(/\b(\d+\.?\d*)\b/g, (match, number, offset, fullString) => {
          const numValue = parseFloat(number);
          if (isNaN(numValue)) {
            return match;
          }

          // Check if this number is a multiplier (right operand in * or /)
          if (offset > 0) {
            const beforeChar = fullString[offset - 1];
            if (beforeChar === '*' || beforeChar === '/') {
              return match; // Don't convert multipliers
            }
          }
          
          // Convert mm to inches
          const converted = numValue / 25.4;
          return converted.toString();
        });

        // Restore variable names
        Object.keys(placeholders).forEach(placeholder => {
          testExpression = testExpression.replace(new RegExp(placeholder, 'g'), placeholders[placeholder]);
        });
        
        // Replace variables with test values (case-insensitive)
        // Note: testWidth and testHeight are already in the correct unit, but we need to convert to inches for evaluation
        const testWidthInches = isMM ? testWidth / 25.4 : testWidth;
        const testHeightInches = isMM ? testHeight / 25.4 : testHeight;
        const testPerimeterInches = 2 * (testWidthInches + testHeightInches);
        const testAreaInches = testWidthInches * testHeightInches;
        
        testExpression = testExpression.replace(/\bwidth\b/gi, testWidthInches);
        testExpression = testExpression.replace(/\bheight\b/gi, testHeightInches);
        testExpression = testExpression.replace(/\bperimeter\b/gi, testPerimeterInches);
        testExpression = testExpression.replace(/\barea\b/gi, testAreaInches);
        
        // Safe evaluation using Function constructor
        const result = Function('"use strict"; return (' + testExpression + ')')();
        
        if (typeof result !== 'number' || isNaN(result) || !isFinite(result)) {
          if (input) input.classList.add('border-red-500');
          if (input) input.classList.remove('border-green-500');
          if (validationMsg) {
            validationMsg.textContent = 'Invalid equation syntax. The equation must evaluate to a valid number.';
            validationMsg.classList.remove('hidden');
          }
          if (previewDiv) previewDiv.classList.add('hidden');
          return { valid: false, message: 'Invalid equation syntax' };
        }
        
        // Valid equation
        if (input) input.classList.add('border-green-500');
        if (input) input.classList.remove('border-red-500');
        if (validationMsg) {
          validationMsg.classList.add('hidden');
        }
        
        // Show preview with sample calculation
        if (previewDiv) {
          const displayResult = result.toFixed(2);
          previewDiv.innerHTML = `Preview (width=${testWidth} ${unitLabel}, height=${testHeight} ${unitLabel}): <strong>${displayResult} in</strong>`;
          previewDiv.classList.remove('hidden');
        }
        return { valid: true, message: '', result: result };
      } catch (error) {
        if (input) input.classList.add('border-red-500');
        if (input) input.classList.remove('border-green-500');
        if (validationMsg) {
          validationMsg.textContent = 'Invalid equation syntax: ' + error.message;
          validationMsg.classList.remove('hidden');
        }
        if (previewDiv) previewDiv.classList.add('hidden');
        return { valid: false, message: error.message };
      }
    }
    
    // Update glass size equation unit display when global unit changes
    function updateGlassSizeEquationUnitDisplay() {
      const globalUnit = window.globalPreferences?.unit || localStorage.getItem('globalUnit') || 'inches';
      const isMM = globalUnit === 'mm';
      const unitLabel = isMM ? 'mm' : 'in';
      const unitLabelFull = isMM ? 'millimeters' : 'inches';
      
      // Update width equation unit display
      const widthUnitDisplay = document.getElementById('glass-width-equation-unit-display');
      if (widthUnitDisplay) {
        widthUnitDisplay.textContent = unitLabelFull;
      }
      
      // Update height equation unit display
      const heightUnitDisplay = document.getElementById('glass-height-equation-unit-display');
      if (heightUnitDisplay) {
        heightUnitDisplay.textContent = unitLabelFull;
      }
      
      // Re-validate if there are values
      const widthEquationInput = document.getElementById('glass-width-equation');
      if (widthEquationInput && widthEquationInput.value.trim()) {
        validateGlassSizeEquation(widthEquationInput.value, 'width');
      }
      
      const heightEquationInput = document.getElementById('glass-height-equation');
      if (heightEquationInput && heightEquationInput.value.trim()) {
        validateGlassSizeEquation(heightEquationInput.value, 'height');
      }
    }
    
    // Update length equation unit display based on global preferences
    function updateLengthEquationUnitDisplay() {
      const globalUnit = window.globalPreferences?.unit || localStorage.getItem('globalUnit') || 'inches';
      const isMM = globalUnit === 'mm';
      const unitLabel = isMM ? 'mm' : 'in';
      const unitLabelFull = isMM ? 'millimeters' : 'inches';
      
      // Update label
      const unitLabelSpan = document.getElementById('length-equation-unit');
      const resultUnitSpan = document.getElementById('length-equation-result-unit-text');
      if (unitLabelSpan) unitLabelSpan.textContent = unitLabelFull;
      if (resultUnitSpan) resultUnitSpan.textContent = unitLabelFull;
      
      // Re-validate if there's a current equation
      const equationInput = document.getElementById('profile-length-equation');
      if (equationInput && equationInput.value.trim()) {
        validateLengthEquation(equationInput.value);
      }
    }

    // Initialize equation validation on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize unit display
      updateLengthEquationUnitDisplay();
      
      // Listen for unit changes
      window.addEventListener('unitChanged', function(event) {
        updateLengthEquationUnitDisplay();
      });
      
      const equationInput = document.getElementById('profile-length-equation');
      if (equationInput) {
        // Add debounced validation
        let validationTimeout;
        equationInput.addEventListener('input', function() {
          clearTimeout(validationTimeout);
          validationTimeout = setTimeout(() => {
            validateLengthEquation(this.value);
          }, 300);
        });
        
        // Validate on blur
        equationInput.addEventListener('blur', function() {
          validateLengthEquation(this.value);
        });
      }
    });

    // Toggle between fixed quantity and equation
    function toggleProfileQuantityType() {
      const quantityType = document.getElementById('profile-quantity-type').value;
      const fixedContainer = document.getElementById('profile-quantity-fixed-container');
      const equationContainer = document.getElementById('profile-quantity-equation-container');
      
      if (quantityType === 'equation') {
        fixedContainer.style.display = 'none';
        equationContainer.style.display = 'block';
        document.getElementById('profile-quantity').value = '';
        
        // Add validation listener to equation input
        setTimeout(() => {
          const equationInput = document.getElementById('profile-quantity-equation');
          if (equationInput) {
            // Remove existing listeners by cloning and replacing
            const newInput = equationInput.cloneNode(true);
            equationInput.parentNode.replaceChild(newInput, equationInput);
            
            // Add debounced validation
            let validationTimeout;
            newInput.addEventListener('input', function() {
              clearTimeout(validationTimeout);
              validationTimeout = setTimeout(() => {
                validateProfileQuantityEquation(this.value);
              }, 300);
            });
            
            // Validate on blur
            newInput.addEventListener('blur', function() {
              validateProfileQuantityEquation(this.value);
            });
          }
        }, 10);
      } else {
        fixedContainer.style.display = 'block';
        equationContainer.style.display = 'none';
        document.getElementById('profile-quantity-equation').value = '';
        
        // Clear validation messages
        const validationMsg = document.getElementById('profile-quantity-equation-validation-message');
        const previewDiv = document.getElementById('profile-quantity-equation-preview');
        if (validationMsg) validationMsg.innerHTML = '';
        if (previewDiv) previewDiv.innerHTML = '';
        const qtyEqInput = document.getElementById('profile-quantity-equation');
        if (qtyEqInput) {
          qtyEqInput.classList.remove('border-red-500', 'border-green-500');
        }
      }
    }

    // Validate profile quantity equation
    function validateProfileQuantityEquation(equation) {
      const validationMsg = document.getElementById('profile-quantity-equation-validation-message');
      const previewDiv = document.getElementById('profile-quantity-equation-preview');
      const input = document.getElementById('profile-quantity-equation');
      
      if (!equation || equation.trim() === '') {
        if (validationMsg) validationMsg.innerHTML = '';
        if (previewDiv) previewDiv.innerHTML = '';
        if (input) {
          input.classList.remove('border-red-500', 'border-green-500');
        }
        return { valid: false, message: '' };
      }
      
      const trimmed = equation.trim();
      const validVariables = ['width', 'height', 'perimeter', 'area'];
      
      // Check for invalid variable names (case-insensitive)
      const variablePattern = /\b([a-zA-Z_][a-zA-Z0-9_]*)\b/g;
      const foundVariables = [];
      let match;
      while ((match = variablePattern.exec(trimmed)) !== null) {
        const varName = match[1].toLowerCase();
        // Skip JavaScript keywords and math functions
        if (!['width', 'height', 'perimeter', 'area', 'sqrt', 'abs', 'round', 'floor', 'ceil', 'max', 'min', 'pow'].includes(varName)) {
          foundVariables.push(match[1]);
        }
      }
      
      if (foundVariables.length > 0) {
        const errorMsg = `Invalid variable(s): ${foundVariables.join(', ')}. Use: width, height, perimeter, area`;
        if (validationMsg) {
          validationMsg.innerHTML = `<span class="text-red-600"><i class="fas fa-exclamation-circle mr-1"></i>${errorMsg}</span>`;
        }
        if (input) {
          input.classList.add('border-red-500');
          input.classList.remove('border-green-500');
        }
        if (previewDiv) previewDiv.innerHTML = '';
        return { valid: false, message: errorMsg };
      }
      
      // Try to evaluate the equation with sample values
      try {
        const testWidth = 48;
        const testHeight = 60;
        const testPerimeter = 2 * (testWidth + testHeight);
        const testArea = testWidth * testHeight;
        
        // Replace variables with test values (case-insensitive)
        let testEquation = trimmed;
        testEquation = testEquation.replace(/\bwidth\b/gi, testWidth);
        testEquation = testEquation.replace(/\bheight\b/gi, testHeight);
        testEquation = testEquation.replace(/\bperimeter\b/gi, testPerimeter);
        testEquation = testEquation.replace(/\barea\b/gi, testArea);
        
        // Evaluate using Function constructor (safer than eval)
        const result = Function('"use strict"; return (' + testEquation + ')')();
        
        if (typeof result !== 'number' || isNaN(result) || !isFinite(result)) {
          throw new Error('Equation does not evaluate to a valid number');
        }
        
        // Quantity should be positive
        if (result < 0) {
          const errorMsg = 'Quantity equation must evaluate to a positive number';
          if (validationMsg) {
            validationMsg.innerHTML = `<span class="text-red-600"><i class="fas fa-exclamation-circle mr-1"></i>${errorMsg}</span>`;
          }
          if (input) {
            input.classList.add('border-red-500');
            input.classList.remove('border-green-500');
          }
          if (previewDiv) previewDiv.innerHTML = '';
          return { valid: false, message: errorMsg };
        }
        
        // Success
        const roundedResult = Math.round(result);
        if (validationMsg) {
          validationMsg.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>Valid equation</span>`;
        }
        if (previewDiv) {
          previewDiv.innerHTML = `<span class="text-gray-600">Preview: For a ${testWidth}" × ${testHeight}" window, quantity = <strong>${roundedResult}</strong></span>`;
        }
        if (input) {
          input.classList.remove('border-red-500');
          input.classList.add('border-green-500');
        }
        return { valid: true, message: 'Valid equation' };
      } catch (error) {
        const errorMsg = `Invalid equation syntax: ${error.message}`;
        if (validationMsg) {
          validationMsg.innerHTML = `<span class="text-red-600"><i class="fas fa-exclamation-circle mr-1"></i>${errorMsg}</span>`;
        }
        if (input) {
          input.classList.add('border-red-500');
          input.classList.remove('border-green-500');
        }
        if (previewDiv) previewDiv.innerHTML = '';
        return { valid: false, message: errorMsg };
      }
    }

    function toggleAccessoryQuantityType() {
      const quantityType = document.getElementById('accessory-quantity-type').value;
      const fixedContainer = document.getElementById('accessory-quantity-fixed-container');
      const equationContainer = document.getElementById('accessory-quantity-equation-container');
      
      if (quantityType === 'equation') {
        fixedContainer.style.display = 'none';
        equationContainer.style.display = 'block';
        document.getElementById('accessory-quantity').value = '';
        
        // Add validation listener to equation input
        setTimeout(() => {
          const equationInput = document.getElementById('accessory-quantity-equation');
          if (equationInput) {
            // Remove existing listeners by cloning and replacing
            const newInput = equationInput.cloneNode(true);
            equationInput.parentNode.replaceChild(newInput, equationInput);
            
            // Add debounced validation
            let validationTimeout;
            newInput.addEventListener('input', function() {
              clearTimeout(validationTimeout);
              validationTimeout = setTimeout(() => {
                validateEquation(this.value);
              }, 300);
            });
            
            // Validate on blur
            newInput.addEventListener('blur', function() {
              validateEquation(this.value);
            });
          }
        }, 100);
      } else {
        fixedContainer.style.display = 'block';
        equationContainer.style.display = 'none';
        const eqInput = document.getElementById('accessory-quantity-equation');
        if (eqInput) eqInput.value = '';
        const validationMsg = document.getElementById('equation-validation-message');
        if (validationMsg) validationMsg.innerHTML = '';
        const previewDiv = document.getElementById('equation-preview');
        if (previewDiv) previewDiv.innerHTML = '';
        if (eqInput) {
          eqInput.classList.remove('border-red-500', 'border-green-500');
        }
      }
    }

    // Accessory functions
    function addAccessoryEntry() {
      const accessorySelect = document.getElementById('accessory-id');
      const accessoryId = accessorySelect.value;
      const accessoryName = accessorySelect.options[accessorySelect.selectedIndex]?.text || '';
      const quantityType = document.getElementById('accessory-quantity-type').value;
      const quantity = document.getElementById('accessory-quantity').value;
      const quantityEquation = document.getElementById('accessory-quantity-equation').value;
      const unit = document.getElementById('accessory-unit').value;
      const showToUser = document.getElementById('accessory-show-to-user').checked;
      
      // Get advanced configuration fields
      const componentGroup = document.getElementById('accessory-component-group').value;
      const selectionType = document.getElementById('accessory-selection-type').value;
      const isDefault = document.getElementById('accessory-is-default').checked;

      if (!accessoryId) {
        showAlert('Please select an accessory');
        return;
      }
      
      if (quantityType === 'fixed') {
        if (!quantity || quantity <= 0) {
          showAlert('Please enter a valid quantity');
          return;
        }
      } else {
        if (!quantityEquation || quantityEquation.trim() === '') {
          showAlert('Please enter a valid equation');
          return;
        }
        
        // Validate equation before adding
        const validation = validateEquation(quantityEquation);
        if (!validation.valid) {
          showAlert(validation.message || 'Please enter a valid equation. Check that you are using correct variable names (width, height, perimeter, area)');
          return;
        }
      }

      const accessoryEntry = { 
        accessoryId, 
        accessoryName, 
        unit, 
        showToUser,
        componentGroup: componentGroup || null,
        selectionType,
        isDefault
      };
      
      if (quantityType === 'fixed') {
        accessoryEntry.quantity = parseFloat(quantity);
        accessoryEntry.quantityEquation = null;
      } else {
        accessoryEntry.quantity = null;
        accessoryEntry.quantityEquation = quantityEquation.trim();
      }
      
      accessories.push(accessoryEntry);
      renderAccessoriesTable();
      scheduleAutoSave();
      
      // Reset form inputs
      accessorySelect.selectedIndex = 0;
      document.getElementById('accessory-quantity').value = '';
      document.getElementById('accessory-quantity-equation').value = '';
      document.getElementById('accessory-unit').value = '';
      document.getElementById('accessory-show-to-user').checked = false;
      document.getElementById('accessory-quantity-type').value = 'fixed';
      toggleAccessoryQuantityType();
      document.getElementById('accessory-component-group-select').value = '';
      document.getElementById('accessory-component-group-custom').style.display = 'none';
      document.getElementById('accessory-component-group-custom').value = '';
      document.getElementById('accessory-component-group').value = '';
      document.getElementById('accessory-selection-type').value = 'quantity';
      document.getElementById('accessory-is-default').checked = false;
      
      // Hide advanced config
      document.getElementById('accessory-advanced-config').style.display = 'none';
      
      updateEmptyStates();
    }

    function renderAccessoriesTable() {
      const tableBody = document.getElementById('accessories-table-body');
      tableBody.innerHTML = '';
      accessories.forEach((accessory, index) => {
        const userConfigStatus = accessory.showToUser ? 
          '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">User Configurable</span>' : 
          '<span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full">Auto-managed</span>';
        
        // Choice group information
        let choiceGroupInfo = '<span class="text-gray-400">-</span>';
        if (accessory.showToUser && accessory.componentGroup) {
          const selectionTypeLabel = {
            'single': 'Single Choice',
            'multiple': 'Multiple Choice', 
            'quantity': 'Quantity'
          }[accessory.selectionType] || 'Quantity';
          
          const defaultMarker = accessory.isDefault ? ' ⭐' : '';
          choiceGroupInfo = `
            <div class="text-sm">
              <strong>${accessory.componentGroup}</strong><br>
              <span class="text-xs text-gray-600">${selectionTypeLabel}${defaultMarker}</span>
            </div>
          `;
        }
        
        const quantityDisplay = accessory.quantityEquation 
          ? `<span class="text-blue-600 font-mono text-sm" title="Equation: ${accessory.quantityEquation}">${accessory.quantityEquation}</span>`
          : accessory.quantity;
        
        const row = `
          <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
            <td class="py-3 px-4 border-b">${accessory.accessoryName}</td>
            <td class="py-3 px-4 border-b">${quantityDisplay}</td>
            <td class="py-3 px-4 border-b">${accessory.unit}</td>
            <td class="py-3 px-4 border-b">${userConfigStatus}</td>
            <td class="py-3 px-4 border-b">${choiceGroupInfo}</td>
            <td class="py-3 px-4 border-b">
              <button type="button" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition duration-200" onclick="removeAccessory(${index})">
                <i class="fas fa-trash mr-1"></i>Remove
              </button>
            </td>
          </tr>
        `;
        tableBody.insertAdjacentHTML('beforeend', row);
      });
    }

    function removeAccessory(index) {
      accessories.splice(index, 1);
      renderAccessoriesTable();
      updateEmptyStates();
      scheduleAutoSave();
    }

    // Attach event listeners and ensure correct data is sent on form submission
    document.getElementById('accessory-id').addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      if (selectedOption && selectedOption.getAttribute('data-unit')) {
        const unit = selectedOption.getAttribute('data-unit');
        document.getElementById('accessory-unit').value = unit || '';
      } else {
        document.getElementById('accessory-unit').value = '';
      }
    });

    // Add event listeners for muntin configuration
    document.addEventListener('DOMContentLoaded', function() {
      // Muntin profile selection
      const muntinProfileSelect = document.getElementById('muntin-profile');
      if (muntinProfileSelect) {
        muntinProfileSelect.addEventListener('change', function() {
          const selectedOption = this.options[this.selectedIndex];
          if (selectedOption && selectedOption.value) {
            muntinConfiguration.muntinProfile = selectedOption.value;
          }
        });
      }
      
      // Muntin checkbox
      const muntinShowToUser = document.getElementById('muntin-show-to-user');
      if (muntinShowToUser) {
        muntinShowToUser.addEventListener('change', function() {
          muntinConfiguration.showToUser = this.checked;
        });
      }
    });

    function updateMuntinConfiguration() {
      // Update enabled state
      const muntinEnabledCheckbox = document.getElementById('muntin-enabled');
      if (muntinEnabledCheckbox) {
        muntinConfiguration.enabled = muntinEnabledCheckbox.checked;
      }
      
      // Update showToUser if muntins are enabled
      if (muntinConfiguration.enabled) {
        const showToUserCheckbox = document.getElementById('muntin-show-to-user');
        if (showToUserCheckbox) {
          muntinConfiguration.showToUser = showToUserCheckbox.checked;
        }
        
        // Update muntin profile
        const muntinProfileSelect = document.getElementById('muntin-profile');
        if (muntinProfileSelect && muntinProfileSelect.value) {
          muntinConfiguration.muntinProfile = muntinProfileSelect.value;
        } else {
          muntinConfiguration.muntinProfile = null;
        }
      } else {
        muntinConfiguration.muntinProfile = null;
        muntinConfiguration.showToUser = false;
      }
    }

    document.getElementById('window-form').addEventListener('submit', async function(event) {
      event.preventDefault();
      
      console.log('Form submission started...');
      
      try {
        // Validate form
        const windowType = document.getElementById('type').value.trim();
        if (!windowType) {
          showAlert('Please enter a window type');
          goToStep(1);
          return;
        }
        
        // Final check if name is taken
        try {
          const response = await fetch(`/admin/check-window-name?name=${encodeURIComponent(windowType)}`);
          const data = await response.json();
          
          if (data.exists) {
            showAlert(data.message || 'This window type name is already taken. Please choose a different name.');
            goToStep(1);
            document.getElementById('type').focus();
            return;
          }
        } catch (error) {
          console.error('Error checking name:', error);
        }
        
        if (profiles.length === 0) {
          showAlert('Please add at least one profile');
          goToStep(2);
          return;
        }
        
        // Validate that all profiles have length equations
        const invalidProfiles = profiles.filter(p => !p.lengthEquation || p.lengthEquation.trim() === '');
        if (invalidProfiles.length > 0) {
          showAlert('Please ensure all profiles have valid length equations');
          goToStep(2);
          return;
        }
        
        console.log('Updating muntin configuration...');
        // Update muntin configuration before submission
        try {
          updateMuntinConfiguration();
        } catch (error) {
          console.error('Error updating muntin configuration:', error);
          // Continue anyway, muntins might not be enabled
        }
      
      // Update flange configuration before submission
      if (flangeConfiguration.hasFlange) {
        flangeConfiguration.flangeSize = document.getElementById('flange-size').value.trim() || null;
        flangeConfiguration.isTrimable = document.getElementById('flange-trimable').checked;
      }
      
      // Update glass size equations before submission
      const glassWidthEquation = document.getElementById('glass-width-equation')?.value.trim() || null;
      const glassHeightEquation = document.getElementById('glass-height-equation')?.value.trim() || null;
      
      // Validate glass width equation only if provided (glass is optional)
      if (glassWidthEquation) {
        const glassWidthValidation = validateGlassSizeEquation(glassWidthEquation, 'width');
        if (!glassWidthValidation.valid) {
          showAlert('Please enter a valid glass width equation. ' + (glassWidthValidation.message || ''));
          goToStep(4);
          return;
        }
      }
      
      // Validate glass height equation only if provided (glass is optional)
      if (glassHeightEquation) {
        const glassHeightValidation = validateGlassSizeEquation(glassHeightEquation, 'height');
        if (!glassHeightValidation.valid) {
          showAlert('Please enter a valid glass height equation. ' + (glassHeightValidation.message || ''));
          goToStep(4);
          return;
        }
      }
      
      // Update missile impact configuration before submission
      missileImpactConfiguration.supportsLMI = document.getElementById('missile-lmi').checked;
      missileImpactConfiguration.supportsSMI = document.getElementById('missile-smi').checked;
      
      // Collect selected glass IDs for each missile type
      const lmiGlassCheckboxes = document.querySelectorAll('.lmi-glass-checkbox:checked');
      missileImpactConfiguration.lmiGlasses = Array.from(lmiGlassCheckboxes).map(cb => cb.value);
      
      const smiGlassCheckboxes = document.querySelectorAll('.smi-glass-checkbox:checked');
      missileImpactConfiguration.smiGlasses = Array.from(smiGlassCheckboxes).map(cb => cb.value);
      
      // Add hidden fields
      const form = event.target;
      
      // Clear existing hidden inputs if any
      const existingInputs = form.querySelectorAll('input[type="hidden"]');
      existingInputs.forEach(input => {
        if (['profiles', 'accessories', 'muntinConfiguration', 'flangeConfiguration', 'missileImpactConfiguration', 'glassWidthEquation', 'glassHeightEquation'].includes(input.name)) {
          input.remove();
        }
      });
      
      const profilesInput = document.createElement('input');
      profilesInput.type = 'hidden';
      profilesInput.name = 'profiles';
      profilesInput.value = JSON.stringify(profiles);
      form.appendChild(profilesInput);

      const accessoriesInput = document.createElement('input');
      accessoriesInput.type = 'hidden';
      accessoriesInput.name = 'accessories';
      accessoriesInput.value = JSON.stringify(accessories);
      form.appendChild(accessoriesInput);
      
      const muntinConfigurationInput = document.createElement('input');
      muntinConfigurationInput.type = 'hidden';
      muntinConfigurationInput.name = 'muntinConfiguration';
      muntinConfigurationInput.value = JSON.stringify(muntinConfiguration);
      form.appendChild(muntinConfigurationInput);
      
      // Add panel configuration
      const operationType = document.getElementById('operationType').value;
      const panelConfiguration = {
        panels: panelConfig,
        panelRatios: panelRatios,
        orientation: document.getElementById('panelOrientation').value,
        operationType: operationType,
        hasMullion: true,
        mullionWidth: 2,
        showLogo: showLogo
      };
      
      // Add French Door specific config if applicable
      if (operationType === 'french-door') {
        panelConfiguration.frenchDoor = {
          doorType: document.getElementById('doorType').value,
          hingeSide: document.getElementById('hingeSide').value,
          leftSidelites: parseInt(document.getElementById('leftSidelites').value) || 0,
          rightSidelites: parseInt(document.getElementById('rightSidelites').value) || 0,
          transom: document.getElementById('transom').value,
          showLogo: document.getElementById('frenchDoorLogo').checked
        };
      }
      
      const panelConfigurationInput = document.createElement('input');
      panelConfigurationInput.type = 'hidden';
      panelConfigurationInput.name = 'panelConfiguration';
      panelConfigurationInput.value = JSON.stringify(panelConfiguration);
      form.appendChild(panelConfigurationInput);
      
      // Add flange configuration
      const flangeConfigurationInput = document.createElement('input');
      flangeConfigurationInput.type = 'hidden';
      flangeConfigurationInput.name = 'flangeConfiguration';
      flangeConfigurationInput.value = JSON.stringify(flangeConfiguration);
      form.appendChild(flangeConfigurationInput);
      
      // Add missile impact configuration
      const missileImpactConfigurationInput = document.createElement('input');
      missileImpactConfigurationInput.type = 'hidden';
      missileImpactConfigurationInput.name = 'missileImpactConfiguration';
      missileImpactConfigurationInput.value = JSON.stringify(missileImpactConfiguration);
      form.appendChild(missileImpactConfigurationInput);
      
      console.log('Form data prepared, submitting...');
      console.log('Profiles:', profiles.length);
      console.log('Accessories:', accessories.length);
      console.log('Muntin Config:', muntinConfiguration);
      
      // Clear draft since we're successfully submitting
      clearDraft();
      
      // Submit the form
      form.submit();
      } catch (error) {
        console.error('Error during form submission:', error);
        showAlert('An error occurred while submitting the form. Please check the console for details.');
      }
    });


  </script>
</body>
</html>

