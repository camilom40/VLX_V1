<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/_head.ejs') %>
    <title>Edit Accessory: <%= accessory.name %></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'DM Sans', sans-serif; background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%); }
        
        .main-card {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 20px 25px -5px rgba(0,0,0,0.05);
            border: 1px solid rgba(226,232,240,0.8);
        }
        
        .form-section {
            background: linear-gradient(to right, #fafbfc, #fff);
            border-radius: 1rem;
            padding: 1.25rem;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        .form-section:hover { border-color: #cbd5e1; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        .section-icon {
            width: 2.25rem; height: 2.25rem;
            border-radius: 0.625rem;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.75rem;
            border-radius: 0.625rem;
            border: 2px solid #e2e8f0;
            background: #f8fafc;
            color: #1e293b;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        .form-input:hover { border-color: #cbd5e1; background: #fff; }
        .form-input:focus { outline: none; border-color: #3b82f6; background: #fff; box-shadow: 0 0 0 4px rgba(59,130,246,0.1); }
        
        .form-input-simple {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.625rem;
            border: 2px solid #e2e8f0;
            background: #f8fafc;
            color: #1e293b;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        .form-input-simple:hover { border-color: #cbd5e1; background: #fff; }
        .form-input-simple:focus { outline: none; border-color: #3b82f6; background: #fff; box-shadow: 0 0 0 4px rgba(59,130,246,0.1); }
        
        .input-with-icon { position: relative; width: 100%; }
        .input-icon {
            position: absolute; left: 0.875rem; top: 50%; transform: translateY(-50%);
            color: #64748b; pointer-events: none; z-index: 10; transition: color 0.2s;
        }
        .input-with-icon:focus-within .input-icon { color: #3b82f6; }
        .input-icon svg { width: 1.125rem; height: 1.125rem; }
        
        select.form-input {
            appearance: none; cursor: pointer; padding-right: 2.5rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.125rem;
        }
        
        .input-suffix {
            position: absolute; right: 0; top: 0; height: 100%;
            padding: 0 0.875rem; display: flex; align-items: center;
            background: linear-gradient(to right, #e2e8f0, #f1f5f9);
            color: #475569; font-weight: 600; font-size: 0.8rem;
            border-top-right-radius: 0.625rem; border-bottom-right-radius: 0.625rem;
            border: 2px solid #e2e8f0; border-left: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white; font-weight: 600; padding: 0.75rem 1.75rem;
            border-radius: 0.625rem; box-shadow: 0 4px 14px rgba(59,130,246,0.4);
            transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem;
        }
        .btn-primary:hover { background: linear-gradient(135deg, #2563eb, #1d4ed8); box-shadow: 0 6px 20px rgba(59,130,246,0.5); transform: translateY(-2px); }
        
        .btn-secondary {
            background: #f1f5f9; color: #475569; font-weight: 600;
            padding: 0.75rem 1.25rem; border-radius: 0.625rem;
            border: 2px solid #e2e8f0; transition: all 0.3s ease;
            display: inline-flex; align-items: center; gap: 0.5rem;
        }
        .btn-secondary:hover { background: #e2e8f0; border-color: #cbd5e1; }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white; font-weight: 600; padding: 0.75rem 1.25rem;
            border-radius: 0.625rem; box-shadow: 0 4px 14px rgba(239,68,68,0.3);
            transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem;
        }
        .btn-danger:hover { background: linear-gradient(135deg, #dc2626, #b91c1c); transform: translateY(-2px); }
        
        .required-badge {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e; font-size: 0.6rem; font-weight: 700;
            padding: 0.2rem 0.4rem; border-radius: 0.3rem;
            margin-left: 0.4rem; text-transform: uppercase; letter-spacing: 0.05em;
        }
        
        .help-text { color: #64748b; font-size: 0.75rem; margin-top: 0.375rem; }
        .error-text { color: #dc2626; font-size: 0.75rem; margin-top: 0.375rem; display: none; }
        
        .image-upload-area {
            border: 2px dashed #cbd5e1; border-radius: 0.875rem; padding: 1.5rem;
            text-align: center; background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            cursor: pointer; transition: all 0.3s ease;
        }
        .image-upload-area:hover, .image-upload-area.active { border-color: #3b82f6; background: linear-gradient(135deg, #eff6ff, #dbeafe); }
        
        .current-image-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 2px solid #e2e8f0;
            border-radius: 1rem;
            padding: 1rem;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <%- include('../partials/_header.ejs') %>
    
    <main class="flex-grow container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Page Header -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Edit Accessory</h1>
                        <p class="text-gray-500 text-sm">Updating: <span class="font-medium text-amber-600"><%= accessory.name %></span></p>
                    </div>
                </div>
                <a href="/admin/accessories" class="btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back
                </a>
            </div>

            <!-- Main Form Card -->
            <div class="main-card p-6 mb-5">
                <form id="editAccessoryForm" action="/admin/accessories/update/<%= accessory._id %>" method="POST" enctype="multipart/form-data">
                    
                    <!-- Row 1: Name and Reference Number -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- Name field -->
                        <div class="form-section">
                            <div class="flex items-center gap-2.5 mb-3">
                                <div class="section-icon bg-blue-100 text-blue-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                    </svg>
                                </div>
                                <div>
                                    <label for="name" class="font-semibold text-gray-800 text-sm">Accessory Name</label>
                                    <span class="required-badge">Required</span>
                                </div>
                            </div>
                            <div class="input-with-icon">
                                <div class="input-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                    </svg>
                                </div>
                                <input type="text" id="name" name="name" value="<%= accessory.name %>" required class="form-input" 
                                    placeholder="e.g., Window Hinge" maxlength="50">
                            </div>
                            <p id="nameError" class="error-text"><span id="nameErrorText">Name is required</span></p>
                            <p class="help-text">e.g., Window Hinge, Corner Joint</p>
                        </div>

                        <!-- Reference Number field -->
                        <div class="form-section">
                            <div class="flex items-center gap-2.5 mb-3">
                                <div class="section-icon bg-indigo-100 text-indigo-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                                    </svg>
                                </div>
                                <div>
                                    <label for="referenceNumber" class="font-semibold text-gray-800 text-sm">Reference Number</label>
                                    <span class="required-badge">Required</span>
                                </div>
                            </div>
                            <div class="input-with-icon">
                                <div class="input-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                                    </svg>
                                </div>
                                <input type="text" id="referenceNumber" name="referenceNumber" value="<%= accessory.referenceNumber || '' %>" required class="form-input" 
                                    placeholder="e.g., ACC-001" maxlength="50">
                            </div>
                            <p id="referenceNumberError" class="error-text">Required field</p>
                            <p class="help-text">e.g., WIN-HINGE-23</p>
                        </div>
                    </div>

                    <!-- Row 2: Provider and Unit -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- Provider Name field -->
                        <div class="form-section">
                            <div class="flex items-center gap-2.5 mb-3">
                                <div class="section-icon bg-purple-100 text-purple-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                    </svg>
                                </div>
                                <div>
                                    <label for="providerName" class="font-semibold text-gray-800 text-sm">Provider Company</label>
                                    <span class="text-gray-400 text-xs ml-1.5">Optional</span>
                                </div>
                            </div>
                            <div class="input-with-icon">
                                <div class="input-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                    </svg>
                                </div>
                                <input type="text" id="providerName" name="providerName" value="<%= accessory.providerName || '' %>" class="form-input" 
                                    placeholder="Supplier name" maxlength="100">
                            </div>
                            <p class="help-text">Manufacturer or supplier</p>
                        </div>

                        <!-- Unit field -->
                        <div class="form-section">
                            <div class="flex items-center gap-2.5 mb-3">
                                <div class="section-icon bg-sky-100 text-sky-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
                                    </svg>
                                </div>
                                <div>
                                    <label for="unit" class="font-semibold text-gray-800 text-sm">Unit Type</label>
                                    <span class="required-badge">Required</span>
                                </div>
                            </div>
                            <div class="input-with-icon">
                                <div class="input-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
                                    </svg>
                                </div>
                                <input type="text" id="unit" name="unit" value="<%= accessory.unit %>" required class="form-input" 
                                    placeholder="e.g., piece, set, meter">
                            </div>
                            <p class="help-text">How this item is measured</p>
                        </div>
                    </div>

                    <!-- Row 3: Price and Weight -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- Price field -->
                        <div class="form-section">
                            <div class="flex items-center gap-2.5 mb-3">
                                <div class="section-icon bg-emerald-100 text-emerald-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <label for="price" class="font-semibold text-gray-800 text-sm">Price Per Unit</label>
                                    <span class="required-badge">Required</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <div class="flex items-center px-3 bg-gradient-to-r from-emerald-50 to-emerald-100 rounded-l-lg border border-gray-200 border-r-0">
                                    <span class="text-sm font-semibold text-emerald-700" id="currencySymbol">USD</span>
                                </div>
                                <div class="flex-1">
                                    <input type="text" id="price" name="price" inputmode="decimal" required 
                                        class="form-input-simple w-full" placeholder="0.00"
                                        data-stored-price="<%= accessory.price %>">
                                    <input type="hidden" id="currency" name="currency" value="USD">
                                </div>
                                <div class="flex items-center px-3 bg-gray-50 rounded-r-lg border border-gray-200 border-l-0">
                                    <span class="text-sm text-gray-600" id="priceUnitSuffix">/unit</span>
                                </div>
                            </div>
                            <p class="help-text" id="priceHelpText">Enter price in <span id="priceCurrencyLabel">USD</span> per unit. Stored as USD.</p>
                            <p id="priceError" class="error-text">Must be positive</p>
                        </div>

                        <!-- Weight field -->
                        <div class="form-section">
                            <div class="flex items-center gap-2.5 mb-3">
                                <div class="section-icon bg-amber-100 text-amber-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
                                    </svg>
                                </div>
                                <div>
                                    <label for="weight" class="font-semibold text-gray-800 text-sm">Weight</label>
                                    <span class="text-gray-400 text-xs ml-1.5">Optional</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <div class="flex-1 input-with-icon">
                                    <div class="input-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
                                        </svg>
                                    </div>
                                    <input type="number" id="weight" name="weight" step="0.01" min="0" value="<%= accessory.weight || '' %>" 
                                        class="form-input !pr-14" placeholder="0.00">
                                    <div class="input-suffix" id="weightUnit">kg</div>
                                </div>
                                <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 border border-gray-200">
                                    <button type="button" id="weightUnitToggle" class="text-xs font-semibold text-gray-600 hover:text-gray-800 transition-colors">
                                        <span id="weightUnitLabel">kg</span>
                                    </button>
                                    <div class="w-px h-4 bg-gray-300"></div>
                                    <button type="button" id="weightUnitToggleLbs" class="text-xs font-semibold text-gray-400 hover:text-gray-600 transition-colors">
                                        <span>lbs</span>
                                    </button>
                                </div>
                            </div>
                            <p id="weightError" class="error-text">Must be positive</p>
                        </div>
                    </div>

                    <!-- Image Upload field -->
                    <div class="form-section mb-4">
                        <div class="flex items-center gap-2.5 mb-3">
                            <div class="section-icon bg-pink-100 text-pink-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <div>
                                <label class="font-semibold text-gray-800 text-sm">Accessory Image</label>
                                <span class="text-gray-400 text-xs ml-1.5">Optional</span>
                            </div>
                        </div>
                        
                        <% if (accessory.image && accessory.image.trim() !== '') { %>
                            <!-- Current Image Display -->
                            <div id="currentImageContainer" class="current-image-card mb-3">
                                <div class="flex items-center gap-4">
                                    <img id="currentImage" src="/uploads/accessories/<%= accessory.image %>" 
                                         alt="<%= accessory.name %>" 
                                         class="w-20 h-20 object-cover rounded-lg shadow-md">
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-gray-700 mb-1">Current Image</p>
                                        <p class="text-xs text-gray-500 mb-2"><%= accessory.image %></p>
                                        <div class="flex gap-2">
                                            <button type="button" id="replaceImageBtn" class="text-xs px-3 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors inline-flex items-center gap-1">
                                                <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                                </svg>
                                                Replace
                                            </button>
                                            <button type="button" id="removeImageBtn" class="text-xs px-3 py-1.5 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors inline-flex items-center gap-1">
                                                <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                </svg>
                                                Remove
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% } %>
                        
                        <div id="imageUploadArea" class="image-upload-area <%= accessory.image && accessory.image.trim() !== '' ? 'hidden' : '' %>">
                            <input type="file" id="image" name="image" accept="image/*" class="hidden">
                            <div id="uploadPrompt">
                                <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-gradient-to-br from-blue-100 to-indigo-100 flex items-center justify-center">
                                    <svg class="h-6 w-6 text-blue-500" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </div>
                                <p class="text-gray-600 text-sm mb-1">
                                    <span class="font-semibold text-blue-600">Click to upload</span> or drag and drop
                                </p>
                                <p class="text-xs text-gray-400">PNG, JPG, JPEG up to 5MB</p>
                            </div>
                            <div id="imagePreview" class="hidden">
                                <img id="previewImg" src="" alt="Preview" class="mx-auto max-h-32 rounded-lg shadow-lg">
                                <p id="fileName" class="mt-2 text-sm text-gray-600 font-medium"></p>
                                <button type="button" id="cancelImageBtn" class="mt-2 text-red-500 hover:text-red-700 text-sm font-medium inline-flex items-center gap-1">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                    Cancel
                                </button>
                            </div>
                        </div>
                        <input type="hidden" id="removeImageFlag" name="removeImage" value="false">
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-between items-center pt-5 mt-5 border-t border-gray-100">
                        <!-- Delete button -->
                        <form action="/admin/accessories/delete/<%= accessory._id %>" method="post" class="inline" id="deleteForm">
                            <button type="button" id="deleteButton" class="btn-danger">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Delete
                            </button>
                        </form>
                        
                        <div class="flex gap-3">
                            <a href="/admin/accessories" class="btn-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                                Cancel
                            </a>
                            <button type="submit" id="submitBtn" class="btn-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                Save Changes
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </main>
    
    <%- include('../partials/_footer.ejs') %>
    
    <script>
        // Exchange rate from server (COP per USD)
        const exchangeRate = <%= typeof exchangeRate !== 'undefined' ? exchangeRate : 4000 %>;
        
        // Current currency state
        let currentCurrency = 'USD';
        
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('editAccessoryForm');
            const nameInput = document.getElementById('name');
            const nameError = document.getElementById('nameError');
            const priceInput = document.getElementById('price');
            const priceError = document.getElementById('priceError');
            const weightInput = document.getElementById('weight');
            const weightError = document.getElementById('weightError');
            const referenceNumberInput = document.getElementById('referenceNumber');
            const referenceNumberError = document.getElementById('referenceNumberError');
            const deleteButton = document.getElementById('deleteButton');
            const currencyHidden = document.getElementById('currency');
            
            // Image elements
            const imageInput = document.getElementById('image');
            const imageUploadArea = document.getElementById('imageUploadArea');
            const uploadPrompt = document.getElementById('uploadPrompt');
            const imagePreview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            const fileName = document.getElementById('fileName');
            const cancelImageBtn = document.getElementById('cancelImageBtn');
            const replaceImageBtn = document.getElementById('replaceImageBtn');
            const removeImageBtn = document.getElementById('removeImageBtn');
            const currentImageContainer = document.getElementById('currentImageContainer');
            const removeImageFlag = document.getElementById('removeImageFlag');
            
            // Initialize currency from global preferences
            currentCurrency = window.globalPreferences?.currency || localStorage.getItem('globalCurrency') || 'USD';
            
            // Format number with commas (integer part only)
            function formatNumberWithCommas(value) {
                if (!value) return '';
                let numStr = value.toString().replace(/,/g, '');
                if (numStr === '' || numStr === '.') return numStr;
                if (!/^\d*\.?\d*$/.test(numStr)) return value.toString();
                
                const hasDecimal = numStr.includes('.');
                const parts = numStr.split('.');
                const integerPart = parts[0] || '';
                const decimalPart = parts.length > 1 ? parts[1] : '';
                
                let formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                
                if (hasDecimal) {
                    return decimalPart !== '' ? formattedInteger + '.' + decimalPart : formattedInteger + '.';
                }
                return formattedInteger;
            }
            
            // Remove commas from number
            function removeCommas(value) {
                return value.toString().replace(/,/g, '');
            }
            
            // Update currency display
            function updateCurrencyDisplay() {
                const currencySymbol = document.getElementById('currencySymbol');
                const priceCurrencyLabel = document.getElementById('priceCurrencyLabel');
                
                if (currentCurrency === 'COP') {
                    currencySymbol.textContent = 'COP';
                    priceCurrencyLabel.textContent = 'COP';
                } else {
                    currencySymbol.textContent = 'USD';
                    priceCurrencyLabel.textContent = 'USD';
                }
            }
            
            // Initialize price from stored value
            function initializePriceFromStored() {
                const storedPrice = parseFloat(priceInput.dataset.storedPrice) || 0;
                let displayPrice = storedPrice;
                
                // Convert to COP if that's the current currency
                if (currentCurrency === 'COP') {
                    displayPrice = storedPrice * exchangeRate;
                }
                
                if (displayPrice > 0) {
                    priceInput.value = formatNumberWithCommas(displayPrice.toFixed(2));
                }
            }
            
            // Initialize display
            updateCurrencyDisplay();
            initializePriceFromStored();
            
            // Real-time comma formatting for price input
            priceInput.addEventListener('input', function(e) {
                const input = e.target;
                const oldValue = input.value;
                const cursorPos = input.selectionStart;
                
                const beforeCursor = oldValue.substring(0, cursorPos);
                const digitCountBefore = beforeCursor.replace(/[^\d]/g, '').length;
                
                let raw = oldValue.replace(/[^\d.]/g, '');
                
                const dotPos = raw.indexOf('.');
                if (dotPos >= 0) {
                    raw = raw.substring(0, dotPos) + '.' + raw.substring(dotPos + 1).replace(/\./g, '');
                }
                
                if (raw === '') {
                    return;
                }
                
                const formatted = formatNumberWithCommas(raw);
                input.value = formatted;
                
                let newCursorPos = 0;
                let digitsSeen = 0;
                for (let i = 0; i < formatted.length; i++) {
                    if (formatted[i].match(/\d/)) {
                        digitsSeen++;
                    }
                    if (digitsSeen >= digitCountBefore) {
                        newCursorPos = i + 1;
                        break;
                    }
                    newCursorPos = i + 1;
                }
                
                setTimeout(() => {
                    try {
                        input.setSelectionRange(newCursorPos, newCursorPos);
                    } catch(e) {}
                }, 0);
                
                // Also validate
                validatePrice();
            });
            
            // Listen for currency changes
            window.addEventListener('currencyChanged', function(event) {
                const newCurrency = event.detail.currency;
                const currentPriceStr = removeCommas(priceInput.value);
                const currentPrice = parseFloat(currentPriceStr) || 0;
                
                if (currentPrice > 0) {
                    let newPrice;
                    if (currentCurrency === 'USD' && newCurrency === 'COP') {
                        newPrice = (currentPrice * exchangeRate).toFixed(2);
                    } else if (currentCurrency === 'COP' && newCurrency === 'USD') {
                        newPrice = (currentPrice / exchangeRate).toFixed(4);
                    } else {
                        newPrice = currentPrice.toFixed(4);
                    }
                    priceInput.value = formatNumberWithCommas(newPrice);
                }
                
                currentCurrency = newCurrency;
                updateCurrencyDisplay();
            });
            
            // Validation functions
            let nameValidationTimeout;
            let isCheckingName = false;
            const accessoryId = '<%= accessory._id %>';
            
            async function validateName() {
                const name = nameInput.value.trim();
                const nameErrorText = document.getElementById('nameErrorText');
                
                if (!name) {
                    nameErrorText.textContent = 'Name is required';
                    nameError.style.display = 'block';
                    nameInput.style.borderColor = '#f87171';
                    return false;
                }
                
                // Clear previous timeout
                clearTimeout(nameValidationTimeout);
                
                // Debounce the API call
                return new Promise((resolve) => {
                    nameValidationTimeout = setTimeout(async () => {
                        if (isCheckingName) return resolve(false);
                        isCheckingName = true;
                        
                        try {
                            const response = await fetch(`/admin/accessories/check-name/${encodeURIComponent(name)}?excludeId=${accessoryId}`);
                            const data = await response.json();
                            
                            if (data.exists) {
                                nameErrorText.textContent = 'This accessory name is already taken';
                                nameError.style.display = 'block';
                                nameInput.style.borderColor = '#f87171';
                                isCheckingName = false;
                                resolve(false);
                            } else {
                                nameError.style.display = 'none';
                                nameInput.style.borderColor = '';
                                isCheckingName = false;
                                resolve(true);
                            }
                        } catch (error) {
                            console.error('Error checking name:', error);
                            // On error, allow submission (server will catch duplicates)
                            nameError.style.display = 'none';
                            nameInput.style.borderColor = '';
                            isCheckingName = false;
                            resolve(true);
                        }
                    }, 500); // Wait 500ms after user stops typing
                });
            }
            
            function validateReferenceNumber() {
                if (referenceNumberInput.value.trim().length === 0) {
                    referenceNumberError.style.display = 'block';
                    referenceNumberInput.style.borderColor = '#f87171';
                    return false;
                } else {
                    referenceNumberError.style.display = 'none';
                    referenceNumberInput.style.borderColor = '';
                    return true;
                }
            }
            
            function validatePrice() {
                const priceStr = removeCommas(priceInput.value);
                const price = parseFloat(priceStr);
                if (priceStr && (isNaN(price) || price < 0)) {
                    priceError.style.display = 'block';
                    priceInput.style.borderColor = '#f87171';
                    return false;
                } else {
                    priceError.style.display = 'none';
                    priceInput.style.borderColor = '';
                    return true;
                }
            }
            
            function validateWeight() {
                if (weightInput.value.trim() === '') return true;
                const weight = parseFloat(weightInput.value);
                if (isNaN(weight) || weight < 0) {
                    weightError.style.display = 'block';
                    weightInput.style.borderColor = '#f87171';
                    return false;
                } else {
                    weightError.style.display = 'none';
                    weightInput.style.borderColor = '';
                    return true;
                }
            }
            
            // Update price unit suffix based on unit input
            const unitInput = document.getElementById('unit');
            function updatePriceUnitSuffix() {
                const priceUnitSuffix = document.getElementById('priceUnitSuffix');
                const unitValue = unitInput.value.trim();
                priceUnitSuffix.textContent = unitValue ? '/' + unitValue : '/unit';
            }
            
            // Initialize price unit suffix
            updatePriceUnitSuffix();
            
            // Update suffix when unit input changes
            unitInput.addEventListener('input', updatePriceUnitSuffix);
            
            // Validation listeners
            nameInput.addEventListener('input', validateName);
            referenceNumberInput.addEventListener('input', validateReferenceNumber);
            weightInput.addEventListener('input', validateWeight);
            
            // Weight unit conversion
            // For accessories: kg to lbs (1 kg = 2.20462 lbs)
            const KG_TO_LBS = 2.20462;
            const LBS_TO_KG = 0.453592; // inverse
            let weightUnit = 'kg'; // 'kg' or 'lbs'
            
            const weightUnitLabel = document.getElementById('weightUnitLabel');
            const weightUnitSuffix = document.getElementById('weightUnit');
            const weightUnitToggle = document.getElementById('weightUnitToggle');
            const weightUnitToggleLbs = document.getElementById('weightUnitToggleLbs');
            
            function updateWeightUnitDisplay() {
                if (weightUnit === 'kg') {
                    weightUnitSuffix.textContent = 'kg';
                    weightUnitToggle.classList.remove('text-gray-400');
                    weightUnitToggle.classList.add('text-gray-600');
                    weightUnitToggleLbs.classList.remove('text-gray-600');
                    weightUnitToggleLbs.classList.add('text-gray-400');
                } else {
                    weightUnitSuffix.textContent = 'lbs';
                    weightUnitToggle.classList.remove('text-gray-600');
                    weightUnitToggle.classList.add('text-gray-400');
                    weightUnitToggleLbs.classList.remove('text-gray-400');
                    weightUnitToggleLbs.classList.add('text-gray-600');
                }
            }
            
            weightUnitToggle.addEventListener('click', function() {
                if (weightUnit === 'lbs') {
                    // Convert from lbs to kg
                    const currentValue = parseFloat(weightInput.value);
                    if (!isNaN(currentValue) && currentValue > 0) {
                        weightInput.value = (currentValue * LBS_TO_KG).toFixed(2);
                    }
                    weightUnit = 'kg';
                    updateWeightUnitDisplay();
                }
            });
            
            weightUnitToggleLbs.addEventListener('click', function() {
                if (weightUnit === 'kg') {
                    // Convert from kg to lbs
                    const currentValue = parseFloat(weightInput.value);
                    if (!isNaN(currentValue) && currentValue > 0) {
                        weightInput.value = (currentValue * KG_TO_LBS).toFixed(2);
                    }
                    weightUnit = 'lbs';
                    updateWeightUnitDisplay();
                }
            });
            
            updateWeightUnitDisplay();
            
            // Convert values before form submission
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Check for duplicate name before submitting
                const nameCheck = await validateName();
                if (!nameCheck) {
                    nameInput.focus();
                    return;
                }
                
                // Convert weight to kg if in lbs
                if (weightInput && weightUnit === 'lbs') {
                    const lbsValue = parseFloat(weightInput.value);
                    if (!isNaN(lbsValue) && lbsValue > 0) {
                        weightInput.value = (lbsValue * LBS_TO_KG).toFixed(2);
                    }
                }
                
                // Convert price to USD before submission
                let priceValue = parseFloat(removeCommas(priceInput.value));
                if (!isNaN(priceValue) && priceValue > 0 && currentCurrency === 'COP') {
                    priceValue = priceValue / exchangeRate;
                }
                priceInput.value = priceValue.toFixed(4);
                
                // Always store as USD
                currencyHidden.value = 'USD';
                
                // Submit the form
                form.submit();
            });
            
            // Image handling
            if (imageUploadArea) {
                imageUploadArea.addEventListener('click', () => imageInput.click());
                
                imageUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    imageUploadArea.classList.add('active');
                });
                
                imageUploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    imageUploadArea.classList.remove('active');
                });
                
                imageUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    imageUploadArea.classList.remove('active');
                    if (e.dataTransfer.files.length > 0) handleImageFile(e.dataTransfer.files[0]);
                });
            }
            
            if (imageInput) {
                imageInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) handleImageFile(e.target.files[0]);
                });
            }
            
            if (replaceImageBtn) {
                replaceImageBtn.addEventListener('click', () => imageInput.click());
            }
            
            if (removeImageBtn) {
                removeImageBtn.addEventListener('click', () => {
                    if (confirm('Remove current image?')) {
                        currentImageContainer.classList.add('hidden');
                        imageUploadArea.classList.remove('hidden');
                        removeImageFlag.value = 'true';
                        imageInput.value = '';
                    }
                });
            }
            
            if (cancelImageBtn) {
                cancelImageBtn.addEventListener('click', () => {
                    imageInput.value = '';
                    uploadPrompt.classList.remove('hidden');
                    imagePreview.classList.add('hidden');
                    if (currentImageContainer) {
                        currentImageContainer.classList.remove('hidden');
                        imageUploadArea.classList.add('hidden');
                    }
                    removeImageFlag.value = 'false';
                });
            }
            
            function handleImageFile(file) {
                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file');
                    return;
                }
                if (file.size > 5 * 1024 * 1024) {
                    alert('Image size must be less than 5MB');
                    return;
                }
                
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                imageInput.files = dataTransfer.files;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    fileName.textContent = file.name;
                    uploadPrompt.classList.add('hidden');
                    imagePreview.classList.remove('hidden');
                    imageUploadArea.classList.remove('hidden');
                    if (currentImageContainer) currentImageContainer.classList.add('hidden');
                    removeImageFlag.value = 'false';
                };
                reader.readAsDataURL(file);
            }
            
            // Delete button
            deleteButton.addEventListener('click', function() {
                if (confirm(`Delete "${nameInput.value.trim()}"?`)) {
                    document.getElementById('deleteForm').submit();
                }
            });
        });
    </script>
</body>
</html>
